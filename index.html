<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Film Tracker</title>
  
  <link rel="icon" href="https://www.svgrepo.com/show/164284/movie-clapper-open.svg" type="image/svg+xml">
  
  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <style>
    :root {
      --primary: #3A86FF;
      --secondary: #00B4D8;
      --danger: #ff4444;
      --reset: #e74c3c;
      --success: #228b22;
      --warning: #ffbe0b;
      --bg-color: #f4f7fa;
      --card-bg: white;
      --text-color: #1a1a1a;
      --text-secondary: #666;
      --border-color: #e0e0e0;
      --section-tint: rgba(58, 134, 255, 0.05);
      --tv-accent: #2a9d8f; /* Colore per notifiche TV Show */
    }

    body.dark {
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-color: #f5f5f5;
      --text-secondary: #aaa;
      --border-color: #333;
      --section-tint: rgba(58, 134, 255, 0.08);
    }

    html {
      scroll-behavior: smooth;
    }
    
    .tracker-switch {
        display: flex;
        background-color: rgba(128,128,128,0.1);
        border-radius: 8px;
        padding: 4px;
        border: 1px solid var(--border-color);
    }
    .tracker-switch-btn {
        padding: 0.25rem 0.75rem;
        text-decoration: none;
        color: var(--text-secondary);
        border-radius: 6px;
        transition: all 0.2s ease;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }
    .tracker-switch-btn.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .tracker-switch-btn:not(.active):hover {
        background-color: var(--section-tint);
        color: var(--text-color);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-spinner {
      animation: spin 1s linear infinite;
    }

    .user-select-none {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }
    
    #appLoader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg-color);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        transition: opacity 0.3s;
    }
    #appLoader i {
        font-size: 3rem;
        color: var(--primary);
    }

    .top-bar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; }
    .top-bar-left { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .top-bar-left h1 { margin: 0; font-size: 1.75rem; letter-spacing: -1px; color: var(--primary); }
    .top-bar-right { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
    .search-box { max-width: 300px; }
    .filter-select { max-width: 180px; }

    .stats-panel { background-color: var(--section-tint); padding: 1rem; border-radius: 12px; margin-bottom: 2rem; }
    .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; }
    .stat-item { background: var(--card-bg); padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--border-color); transition: background 0.2s; }
    .stat-item:hover { background: rgba(58, 134, 255, 0.1); }
    .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--primary); }
    .stat-label { font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); margin-top: 0.25rem; }

    .media-card { background: var(--card-bg); border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); width: 180px; transition: all 0.2s ease-out; position: relative; border: 1px solid var(--border-color); animation: fadeIn 0.5s ease-out both; cursor: pointer; display: flex; flex-direction: column; }
    .media-card:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.15); }
    .media-card.is-stat-contributor { border-top: 2px dashed var(--primary); }
    .media-card.is-duplicate { opacity: 0.65; }
    .media-poster { width: 100%; aspect-ratio: 2 / 3; object-fit: cover; object-position: center top; background-color: var(--border-color); display: block; }
    .media-info { padding: 0.75rem; flex-grow: 1; display: flex; flex-direction: column; }
    .media-title { font-size: 0.9rem; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-color); font-weight: 600; }
    .media-meta { font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem; display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
    
    .media-ratings { display: flex; gap: 0.25rem; margin-top: 0.5rem; flex-wrap: nowrap; }
    .rating-badge { display: inline-flex; align-items: center; gap: 0.2rem; background: rgba(0,0,0,0.05); padding: 0.2rem 0.4rem; border-radius: 12px; font-size: 0.75rem; }
    body.dark .rating-badge { background: rgba(255, 255, 255, 0.08); }
    .rating-icon { width: 14px; height: 14px; object-fit: contain; }
    
    .card-actions { position: absolute; top: 8px; right: 8px; display: flex; flex-direction: column; gap: 0.5rem; opacity: 0; transform: translateX(10px); transition: opacity 0.2s, transform 0.2s; pointer-events: none; }
    .media-card:hover .card-actions { opacity: 1; transform: translateX(0); pointer-events: all; }
    .card-btn { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); color: white; border: none; cursor: pointer; font-size: 0.8rem; transition: background 0.2s; }
    .card-btn:hover { background: rgba(0,0,0,0.8); }

    .favorite-btn { position: absolute; top: 8px; left: 8px; width: 30px; height: 30px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; opacity: 0; }
    .media-card:hover .favorite-btn { opacity: 1; }
    .favorite-btn.is-favorite { color: #e74c3c; background: rgba(255,255,255,0.8); opacity: 1; }
    
    .media-section { background: var(--section-tint); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; transition: opacity 0.4s, transform 0.4s; }
     .media-section.hidden { opacity: 0; transform: scale(0.98); height: 0; overflow: hidden; margin: 0; padding: 0; pointer-events: none; }
    .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1.5rem; margin-top: 1rem; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin: 0 0 1rem 0; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); position: relative; }
    .section-header::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100px; height: 2px; background: linear-gradient(90deg, var(--primary), var(--secondary)); }
    .section-title { color: var(--text-color); margin: 0; font-size: 1.25rem; letter-spacing: -0.5px; font-weight: 700; }
    
    .btn { padding: 0.5rem 1rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; box-sizing: border-box; height: 38px; }
    .btn-small { padding: 0.25rem 0.75rem; height: auto; font-size: 0.8rem; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: var(--secondary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-reset { background: var(--reset); color: white; }
    .btn-warning { background: var(--warning); color: #1a1a1a; }

    .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-open { overflow: hidden; }
    .modal-content { background: var(--card-bg); border-radius: 12px; padding: 1.5rem; width: 90%; max-width: 800px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    
    input, select { padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color); font-size: 1rem; box-sizing: border-box; margin: 0; height: 38px; transition: border-color 0.2s, box-shadow 0.2s; }
    input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(58, 134, 255, 0.2); }
    .tmdb-results-container { max-height: 250px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem; margin-top: 1rem; }
    .tmdb-result-item:hover { background: rgba(0,0,0,0.05); }

    @media (max-width: 1200px) { .top-bar { flex-direction: column; align-items: stretch; } .top-bar-right { justify-content: flex-start; } }
    @media (max-width: 768px) { body { padding: 0.5rem; } .top-bar { flex-direction: column; align-items: stretch; } .media-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); } }
    
    .context-menu { position: fixed; background: var(--card-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1001; min-width: 240px; padding: 0.5rem 0; border: 1px solid var(--border-color); opacity: 0; transform: translateY(-10px); transition: opacity 0.15s, transform 0.15s; }
    .context-menu.visible { opacity: 1; transform: translateY(0); }
    .context-menu-item { padding: 0.75rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; font-size: 0.9rem; }
    .context-menu-item i { width: 18px; text-align: center; }
    .context-menu-item:hover { background: var(--primary); color: white; }
    .context-menu-divider { height: 1px; background: var(--border-color); margin: 0.25rem 0; }
    
    .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-secondary); border: 2px dashed var(--border-color); border-radius: 8px; margin-top: 1rem; }
    .empty-state > i { font-size: 2.5rem; margin-bottom: 1rem; }
    .add-film-from-empty { margin-top: 1rem; width: auto; white-space: nowrap; }
    
    #confirmModal .modal-content { max-width: 400px; } #confirmModalBody { margin: 1rem 0; }
    #confirmModalButtons { display: flex; justify-content: flex-end; gap: 0.5rem; }

    .auth-container { position: relative; }
    .auth-form { position: absolute; top: calc(100% + 8px); right: 0; background: var(--card-bg); border-radius: 12px; padding: 1.5rem; width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 1001; display: none; }
    .auth-form.active { display: block; }
    .auth-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; }
    .auth-tab { padding: 0.75rem 1rem; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 2px solid transparent; }
    .auth-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .auth-form-container { display: none; } .auth-form-container.active { display: block; }
    .auth-form-container input { width: 100%; margin-bottom: 1rem; }
    .auth-form-buttons { display: flex; justify-content: flex-end; margin-top: 1rem; }

    .notification-bell-container { position: relative; }
    .notification-badge { position: absolute; top: -5px; right: -5px; background-color: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; font-weight: 700; display: flex; justify-content: center; align-items: center; border: 2px solid var(--bg-color); transform: scale(0); transition: transform 0.2s ease-out; }
    .notification-badge.visible { transform: scale(1); }
    .notification-dropdown { position: absolute; top: calc(100% + 8px); right: 0; background: var(--card-bg); border-radius: 12px; width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 1001; display: none; border: 1px solid var(--border-color); overflow: hidden; max-height: 400px; flex-direction: column; }
    .notification-dropdown.visible { display: flex; }
    .notification-header { padding: 0.75rem 1rem; font-weight: 600; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
    .notification-list { flex: 1; max-height: 300px; overflow-y: auto; }
    .notification-footer { padding: 0.5rem; text-align: center; border-top: 1px solid var(--border-color); flex-shrink: 0; }
    .notification-item { padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; font-size: 0.9rem; }
    .notification-item:hover { background-color: var(--section-tint); }
    .notification-item i { width: 16px; text-align: center; }
    .notification-item i.film-notification { color: var(--primary); }
    .notification-item i.tv-notification { color: var(--tv-accent); }
    .notification-item-text { flex: 1; }
    .no-notifications { padding: 1.5rem; text-align: center; color: var(--text-secondary); }
    .notification { position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 8px; background: var(--card-bg); box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1002; display: none; }
    .notification.success { border-left: 4px solid var(--success); } .notification.error { border-left: 4px solid var(--danger); } .notification.warning { border-left: 4px solid var(--warning); }

    .modal-footer { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
    .management-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
    .tab-btn { padding: 0.75rem 1.5rem; background: transparent; border: none; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 2px solid transparent; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-btn:hover:not(.active) { color: var(--text-color); }
    .tab-content { display: none; } .tab-content.active { display: block; }
    .add-media-form { display: flex; flex-direction: column; gap: 1rem; }
    .form-row { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
    .form-row input, .form-row select { flex: 1; min-width: 200px; }
    .form-row .btn { flex-shrink: 0; }

    .management-section { margin-top: 1rem; }
    .management-form { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
    .management-form input { flex: 1; }
    .management-list { max-height: 300px; overflow-y: auto; }
    .management-card { display: flex; align-items: center; padding: 0.75rem; border-radius: 8px; background: var(--bg-color); margin-bottom: 0.5rem; }
    .management-card > div:first-child { flex: 1; display:flex; align-items: center; }
    .management-card-actions { display: flex; gap: 0.5rem; }
    .management-card-actions .btn { padding: 0; justify-content: center; height: 32px; width: 32px; }
    #categoriesList .management-card-actions .btn { background: var(--secondary); color: white; border: none; }
    #categoriesList .management-card-actions .btn.btn-danger { background: var(--danger); }
    #categoriesList .management-card-actions .btn:hover { opacity: 0.85; }
    .category-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 0.75rem; flex-shrink: 0; }
    .category-dot-watchlist { background: #00B4D8; } .category-dot-watched { background: #228b22; }
    .category-dot-0 { background: #3A86FF; } .category-dot-1 { background: #FF006E; } .category-dot-2 { background: #8338EC; } 
    .category-dot-3 { background: #FFBE0B; } .category-dot-4 { background: #FB5607; } .category-dot-5 { background: #00B4D8; }
    .category-name { font-weight: 600; }
    .friend-email { font-weight: 600; }
    .friend-id { font-size: 0.8rem; color: var(--text-secondary); }
    
    #friendsList .management-card-actions .btn { background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-color); }
    #friendsList .management-card-actions .btn.visit-friend-films-btn:hover { background-color: var(--primary); color: white; border-color: var(--primary); }
    #friendsList .management-card-actions .btn.visit-friend-tv-btn:hover { background-color: #2a9d8f; color: white; border-color: #2a9d8f; }
    #friendsList .management-card-actions .btn.remove-friend-btn:hover { background-color: var(--danger); color: white; border-color: var(--danger); }

    #posterModal .modal-content { max-width: 90vw; max-height: 90vh; display: flex; flex-direction: column; overflow-y: auto; }
    .poster-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; padding: 0.5rem; }
    .poster-option { position: relative; cursor: pointer; transition: transform 0.2s; border: 3px solid transparent; border-radius: 8px; overflow: hidden; }
    .poster-option:hover { transform: scale(1.05); }
    .poster-option.selected { border-color: var(--primary); }
    .poster-option img { width: 100%; height: auto; display: block; }
    .poster-current-indicator { position: absolute; top: 5px; left: 5px; background: var(--success); color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
    .poster-language-badge { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
    
    #rewatchModal .modal-content { max-width: 450px; text-align: center; }
    #rewatchModalTitle { margin-top: 0; }
    #rewatchQuickButtons { display: flex; gap: 0.5rem; justify-content: center; margin: 1.5rem 0; }
    .quick-rewatch-btn { padding: 0; width: 45px; height: 45px; justify-content: center; }
    .quick-rewatch-btn.active { background: var(--primary); color: white; }
    .custom-rewatch-container { display: flex; align-items: center; justify-content: center; gap: 1rem; }
    
    #updateProgressModal .modal-content { max-width: 500px; text-align: center; }
    #updateProgressBar { width: 100%; height: 20px; background-color: var(--border-color); border-radius: 10px; overflow: hidden; margin: 1rem 0; }
    #updateProgressBarFill { width: 0%; height: 100%; background-color: var(--primary); transition: width 0.2s; }
    #updateProgressText { font-size: 0.9rem; color: var(--text-secondary); }

    .number-input-wrapper { position: relative; display: flex; align-items: center; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; height: 38px; }
    .number-input-wrapper input { border: none; text-align: center; flex: 1; width: 100%; padding-right: 25px; background: var(--card-bg); -moz-appearance: textfield; }
    .number-input-wrapper input::-webkit-outer-spin-button, .number-input-wrapper input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .number-input-controls { position: absolute; right: 1px; top: 1px; bottom: 1px; display: flex; flex-direction: column; width: 24px; }
    .num-spinner-btn { flex: 1; width: 100%; border: none; background-color: var(--bg-color); color: var(--text-color); cursor: pointer; font-size: 0.8rem; line-height: 1; padding: 0; height: 50%; }
    .num-spinner-btn:hover { background-color: var(--primary); color: white; }
    .num-spinner-btn.up { border-top-right-radius: 7px; }
    .num-spinner-btn.down { border-bottom-right-radius: 7px; }

    .tmdb-result-item { display: flex; align-items: center; padding: 0.5rem; cursor: pointer; border-radius: 4px; margin-bottom: 0.25rem; }
    .tmdb-result-item:hover { background: rgba(0,0,0,0.05); }
    .tmdb-poster-small { width: 40px; height: 60px; object-fit: cover; margin-right: 0.75rem; border-radius: 4px; }

    .view-mode-banner { display: none; align-items: center; background: var(--primary); color: white; padding: 0.75rem 1.5rem; margin-bottom: 1.5rem; border-radius: 8px; }
    .view-mode-banner i { margin-right: 0.75rem; }
    .btn i.fa-plus { position: relative; top: -1px; }
    
    #detailsModal .modal-content { max-width: 900px; padding: 0; overflow-y: auto; }
    #actorModal .modal-content { max-width: 700px; max-height: 80vh; overflow-y: auto; }
    #actorModal { z-index: 1001; }
    
    .details-backdrop { width: 100%; height: 250px; background-size: cover; background-position: center 25%; position: relative; }
    .details-backdrop::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to top, var(--card-bg) 0%, rgba(0,0,0,0.5) 100%); }
    .details-header { position: relative; display: flex; padding: 1.5rem; margin-top: -100px; z-index: 2; }
    #detailsModalPoster { width: 150px; height: 225px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); flex-shrink: 0; margin-right: 1.5rem; }
    .details-title-section { padding-top: 100px; flex-grow: 1; }
    #detailsModalTitle { margin: 0; font-size: 1.75rem; }
    #detailsModalTagline { font-style: italic; color: var(--text-secondary); margin-top: 0.25rem; }
    #detailsModalMeta { margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 1rem; font-size: 0.9rem; }
    .director-link { color: var(--primary); text-decoration: none; font-weight: 500; cursor: pointer; }
    .director-link:hover { text-decoration: underline; }
    .details-body { padding: 0 1.5rem 1.5rem 1.5rem; }
    .details-section-title { font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem; margin-top: 1.5rem; }
    #detailsModalOverview { line-height: 1.6; }
    .cast-scroller { display: flex; overflow-x: auto; gap: 1rem; padding-bottom: 1rem; }
    .actor-card { text-align: center; width: 100px; flex-shrink: 0; cursor: pointer; }
    .actor-photo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 0.5rem; background-color: var(--border-color); }
    .actor-name, .actor-character { font-size: 0.8rem; user-select: text; }
    .actor-character { color: var(--text-secondary); }
    .modal-close-btn { position: absolute; top: 1rem; right: 1rem; z-index: 3; cursor: pointer; background: rgba(0,0,0,0.5); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; }

    .actor-details-header { display: flex; gap: 1.5rem; margin-bottom: 1.5rem; align-items: flex-start; }
    .actor-details-photo { width: 120px; height: 180px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
    .actor-details-info ul { list-style: none; padding: 0; margin: 0; }
    .actor-details-info li { margin-bottom: 0.5rem; }
    .btn-imdb { background: #f5c518; color: #000; margin-top: 1rem; }
    .filmography-scroller { display: flex; overflow-x: auto; gap: 1rem; padding-bottom: 1rem; }
    .film-card-small { width: 120px; flex-shrink: 0; cursor: pointer; }
    .film-card-small img { width: 100%; height: 180px; object-fit: cover; border-radius: 4px; transition: transform 0.2s, box-shadow 0.2s; }
    .film-card-small:hover img { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .film-card-small-title { font-size: 0.8rem; margin-top: 0.5rem; white-space: normal; text-align: center; }

  </style>
</head>
<body class="dark user-select-none">
  
  <div id="appLoader">
      <i class="fas fa-spinner loading-spinner"></i>
  </div>
  
  <div id="viewModeBanner" class="view-mode-banner" style="display:none">
    <i class="fas fa-eye"></i>
    <span id="viewModeUserEmail">Stai visualizzando una libreria condivisa</span>
    <button id="closeViewBtn" class="btn btn-danger" style="margin-left:auto">
      <i class="fas fa-times"></i> Esci
    </button>
  </div>

  <div class="top-bar">
    <div class="top-bar-left">
      <h1><i class="fas fa-film"></i> Film Tracker</h1>
      <div class="tracker-switch">
        <a href="index.html" class="tracker-switch-btn active" title="Vai a Film Tracker"><i class="fas fa-film"></i></a>
        <a href="serietv_tracker.html" class="tracker-switch-btn" title="Vai a Serie TV Tracker"><i class="fas fa-tv"></i></a>
      </div>
      <input type="text" id="searchInput" class="search-box" placeholder="Cerca film...">
      <select id="categoryFilter" class="filter-select">
        <option value="all">Tutte le categorie</option>
        <option value="favorites">Solo Preferiti</option>
      </select>
      <select id="sortFilter" class="filter-select">
        <option value="saga-alpha" selected>Saga / Alfabetico</option>
        <option value="alpha">Solo Alfabetico</option>
        <option value="added">Ultimi aggiunti</option>
        <option value="rating">Valutazione</option>
        <option value="year">Anno di uscita</option>
      </select>
    </div>
    <div class="top-bar-right">
        <button id="mediaManagementBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Gestione</button>
        <div class="notification-bell-container" id="notificationBellContainer" style="display: none;">
            <button id="bellIcon" class="btn btn-secondary" title="Notifiche"><i class="fas fa-bell"></i></button>
            <div id="notificationBadge" class="notification-badge">0</div>
            <div id="notificationDropdown" class="notification-dropdown"></div>
        </div>
        <button id="shareBtn" class="btn btn-secondary" title="Condividi Libreria"><i class="fas fa-share-alt"></i></button>
        <button id="exportBtn" class="btn btn-secondary" title="Esporta Dati (.json)"><i class="fas fa-download"></i></button>
        <input type="file" id="importFile" accept=".json" style="display: none;">
        <button id="importBtn" class="btn btn-secondary" title="Importa Dati (.json)"><i class="fas fa-upload"></i></button>
        <button id="updateExistingBtn" class="btn btn-secondary" title="Aggiorna Dati Film Esistenti"><i class="fas fa-sync-alt"></i></button>
        <button id="resetBtn" class="btn btn-secondary" title="Resetta Applicazione"><i class="fas fa-undo"></i></button>
        <button id="themeToggle" class="btn btn-secondary" title="Cambia Tema"><i class="fas fa-moon"></i></button>
        <div id="userInfo" style="display:none;"><button id="logoutBtn" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> Logout</button></div>
        <div class="auth-container">
            <button id="authToggle" class="btn btn-secondary"><i class="fas fa-user"></i> Login</button>
            <div id="authForms" class="auth-form">
              <div class="auth-tabs"><div class="auth-tab active" data-tab="login">Login</div><div class="auth-tab" data-tab="register">Registrati</div></div>
              <div id="loginForm" class="auth-form-container active"><input type="email" id="loginEmail" placeholder="Email"><input type="password" id="loginPassword" placeholder="Password"><div class="auth-form-buttons"><button id="loginBtn" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Login</button></div></div>
              <div id="registerForm" class="auth-form-container"><input type="email" id="registerEmail" placeholder="Email"><input type="password" id="registerPassword" placeholder="Password (min. 6 caratteri)"><input type="password" id="registerConfirmPassword" placeholder="Conferma Password"><div class="auth-form-buttons"><button id="registerBtn" class="btn btn-primary"><i class="fas fa-user-plus"></i> Registrati</button></div></div>
            </div>
        </div>
    </div>
  </div>

  <div class="stats-panel">
      <div class="stats-container">
        <div class="stat-item"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Totale</div></div>
        <div class="stat-item"><div class="stat-value" id="statWatchlist">0</div><div class="stat-label">Da Vedere</div></div>
        <div class="stat-item"><div class="stat-value" id="statWatched">0</div><div class="stat-label">Visti</div></div>
        <div class="stat-item"><div class="stat-value" id="statRewatched">0</div><div class="stat-label">Rewatch</div></div>
        <div class="stat-item"><div class="stat-value" id="statHours">0h 0m</div><div class="stat-label">Tempo Totale</div></div>
      </div>
  </div>

  <div id="mediaSectionsContainer"></div>
  
  <!-- MODALS START -->
  <div class="modal" id="mediaManagementModal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="media-management-container">
        <div class="management-tabs">
          <button class="tab-btn active" data-tab="add-media"><i class="fas fa-film"></i> Aggiungi Film</button>
          <button class="tab-btn" data-tab="manage-categories"><i class="fas fa-clapperboard"></i> Gestisci Categorie</button>
          <button class="tab-btn" data-tab="manage-friends"><i class="fas fa-user-friends"></i> Amici</button>
        </div>
        <div class="tab-content active" id="add-media-tab">
            <h2>Aggiungi un nuovo Film</h2>
            <div class="add-media-form">
                <div class="form-row">
                    <input type="text" id="mediaTitle" placeholder="Titolo film...">
                    <select id="addMediaCategorySelect"></select>
                    <button id="searchTMDbBtn" class="btn btn-secondary"><i class="fas fa-search"></i> Cerca</button>
                </div>
                <div id="tmdbResults" class="tmdb-results-container"></div>
            </div>
        </div>
        <div class="tab-content" id="manage-categories-tab">
            <h2>Gestisci Categorie</h2>
            <div class="management-form">
              <input type="text" id="newCategoryName" placeholder="Nuova categoria">
              <button id="addCategoryBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Aggiungi</button>
            </div>
            <div class="management-list" id="categoriesList"></div>
        </div>
        <div class="tab-content" id="manage-friends-tab">
            <div id="myIdContainer" class="management-section" style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; text-align: center; margin-bottom: 1.5rem;">
                <h4>Il tuo ID univoco</h4>
                <p style="font-size: 0.9rem; color: var(--text-secondary);">Condividi questo ID con i tuoi amici per permettere loro di aggiungerti.</p>
                <div style="display: flex; gap: 0.5rem; justify-content: center;">
                    <input type="text" id="myIdInput" readonly style="text-align: center; background-color: var(--bg-color);">
                    <button id="copyMyIdBtn" class="btn btn-primary"><i class="fas fa-copy"></i> Copia</button>
                </div>
            </div>
            <div class="management-section">
                <div class="management-form">
                    <input type="text" id="friendIdInput" placeholder="Incolla l'ID di un amico">
                    <button id="addFriendBtn" class="btn btn-primary"><i class="fas fa-user-plus"></i> Aggiungi</button>
                </div>
                <div class="management-list" id="friendsList"></div>
            </div>
        </div>
        <div class="modal-footer" style="border-top: none; padding-top: 0; justify-content: flex-end;">
          <button id="closeManagementModal" class="btn btn-danger">Chiudi</button>
          <button id="saveMediaBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Aggiungi Film</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="rewatchModal">
    <div class="modal-content">
        <h2 id="rewatchModalTitle">Modifica Rewatch</h2>
        <p>Specifica il numero di volte che hai rivisto il film (0 = visto una sola volta).</p>
        <div id="rewatchQuickButtons">
            <button class="btn btn-secondary quick-rewatch-btn" data-count="0">0</button>
            <button class="btn btn-secondary quick-rewatch-btn" data-count="1">1</button>
            <button class="btn btn-secondary quick-rewatch-btn" data-count="2">2</button>
            <button class="btn btn-secondary quick-rewatch-btn" data-count="3">3</button>
            <button class="btn btn-secondary quick-rewatch-btn" data-count="4">4</button>
            <button class="btn btn-secondary quick-rewatch-btn" data-count="5">5</button>
        </div>
        <div class="custom-rewatch-container">
            <label for="rewatchCountInput">Numero custom:</label>
            <div class="number-input-wrapper" style="width: 120px;">
                <input type="number" id="rewatchCountInput" min="0" value="0">
                <div class="number-input-controls">
                    <button class="num-spinner-btn up" data-target="rewatchCountInput">+</button>
                    <button class="num-spinner-btn down" data-target="rewatchCountInput">-</button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="cancelRewatchBtn" class="btn btn-danger">Annulla</button>
            <button id="confirmRewatchBtn" class="btn btn-primary">Salva</button>
        </div>
    </div>
  </div>

  <div class="modal" id="updateProgressModal">
    <div class="modal-content">
        <h2>Aggiornamento in corso...</h2>
        <div id="updateProgressBar">
            <div id="updateProgressBarFill"></div>
        </div>
        <p id="updateProgressText">Inizializzazione...</p>
    </div>
  </div>

  <div class="modal" id="shareModal"><div class="modal-content" style="max-width: 450px;"><h2>Condividi la tua libreria</h2><p>Chiunque abbia questo link potrà vedere la tua lista in tempo reale (sola lettura).</p><input type="text" id="shareLinkInput" class="share-link-input" readonly><div style="display: flex; gap: 0.5rem; margin-top: 1rem;"><button id="copyShareLinkBtn" class="btn btn-primary">Copia Link</button><button id="closeShareModalBtn" class="btn btn-danger">Chiudi</button></div></div></div>
  <div id="notification" class="notification"><span id="notificationText"></span></div>
  
  <div class="modal" id="posterModal">
      <div class="modal-content">
          <h2 id="posterModalTitle">Cambia Copertina</h2>
          <div class="poster-grid" id="posterGrid"></div>
          <div class="modal-footer">
              <button id="cancelPosterChange" class="btn btn-danger">Annulla</button>
              <button id="savePosterChange" class="btn btn-primary">Salva Selezione</button>
          </div>
      </div>
  </div>
  
  <div class="modal" id="detailsModal">
    <div class="modal-content">
        <button class="modal-close-btn" id="detailsModalClose"><i class="fas fa-times"></i></button>
        <div id="detailsModalContent"></div>
    </div>
  </div>
  
  <div class="modal" id="actorModal">
    <div class="modal-content">
        <button class="modal-close-btn" id="actorModalClose"><i class="fas fa-times"></i></button>
        <div id="actorModalContent"></div>
    </div>
  </div>
  
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <h2 id="confirmModalTitle"></h2>
      <p id="confirmModalBody"></p>
      <div id="confirmModalButtons">
        <button id="confirmModalCancel" class="btn btn-secondary">Annulla</button>
        <button id="confirmModalConfirm" class="btn btn-danger">Conferma</button>
      </div>
    </div>
  </div>
  <!-- MODALS END -->

  <script>
    const OMDb_API_KEY = "2526ef70";
    const TMDB_KEY = atob("MmNkOGJiNDgzYWIxMjE0ZDY2MDIwZTcwYjBhMzZmYTQ=");
    const MDBLIST_PROXY_URL = "https://serietvtracker.amrit-singh99mail-5e3.workers.dev"; 
    const DEFAULT_POSTER = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiB2aWV3Qm94PSIwIDAgMzAwIDQ1MCI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZ2h0PSI0NTAiIGZpbGw9IiNkZGQiLz48dGV4dCB4PSIxNTAiIHk9IjIyNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNjY2Ij5OZXNzYSBpbWFnaW5lPC90ZXh0Pjwvc3ZnPg==";
    const DEFAULT_ACTOR_PHOTO = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgdmlld0JveD0iMCAwIDgwIDgwIj48cmVjdCB3aWR0aD0iODAiIGhlaWdodD0iODAiIGZpbGw9IiNkZGQiLz48cGF0aCBkPSJtNDAgMzZhNC44IDQuOCAwIDEgMCAwLTkuNiA0LggNC44IDAgMCAwIDAgOS42em0wIDEuNmMtNC40MiAwLTgtMy41OC04LThzMy41OC04IDgtOCA4IDMuNTggOCA4LTMuNTggOC04IDh6bS0xMy4zMyAxNC44N2ExMi4wMiAxMi4wMiAwIDAgMCAyNi42NiAwYy0uNDctMi4wMi0yLjY4LTMuNTgtNS4zMy00LjA3LTEuMy0uMjUtMi42Ny0uNS00LS43My0xLjMzLS4yMy0yLjctLjMzLTQtLjMzcy0yLjY3LjEtNCwuMzNjLTEuMzMuMjItMi43LjQ4LTQgLjczLTIuNjUuNS00Ljg2IDIuMDYtNS4zMyA0LjA3eiIgZmlsbD0iIzY2NiIvPjwvc3ZnPg==";
    const DEFAULT_CATEGORIES = ["watchlist", "watched"];
    const ROTTEN_TOMATOES_ICONS = { certified: "https://upload.wikimedia.org/wikipedia/uk/b/b2/Certified_Fresh_2018.svg", fresh: "https://upload.wikimedia.org/wikipedia/commons/5/5b/Rotten_Tomatoes.svg", rotten: "https://upload.wikimedia.org/wikipedia/commons/5/52/Rotten_Tomatoes_rotten.svg" };
    const POPCORN_ICONS = { positive: "https://upload.wikimedia.org/wikipedia/commons/d/da/Rotten_Tomatoes_positive_audience.svg", negative: "https://upload.wikimedia.org/wikipedia/commons/6/63/Rotten_Tomatoes_negative_audience.svg" };
    const IMDB_STAR_ICON = "https://upload.wikimedia.org/wikipedia/commons/2/29/Gold_Star.svg";
    const LETTERBOXD_ICON = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTH45TgrphrMnMTlMx9wpG_Jj7JoBzrI9zAfg&s";
    const METACRITIC_ICON = "https://upload.wikimedia.org/wikipedia/commons/f/f2/Metacritic_M.png";
    const MAX_NOTIFICATIONS = 50;
    const MAX_LOG_SIZE = 15;

    let mediaList = [], categories = [...DEFAULT_CATEGORIES], currentTMDbSelection = null, currentUser = null, isViewMode = false, debounceTimeout, lazyLoadObserver, currentRewatchMediaId = null;
    let followedFriends = [], lastCheckedTimestamps = {}, friendListeners = {};
    let statContributorIds = new Set();
    let ignoredDuplicateIds = new Set();
    const firebaseConfig = { apiKey: "AIzaSyDm946nISfZs8ugkuYPraNTzFhvgQmnMUk", authDomain: "gametrackerdb.firebaseapp.com", databaseURL: "https://gametrackerdb-default-rtdb.europe-west1.firebasedatabase.app", projectId: "gametrackerdb" };
    
    const elements = { 
        appLoader: document.getElementById("appLoader"),
        authForms: document.getElementById("authForms"), authToggle: document.getElementById("authToggle"), 
        userInfo: document.getElementById("userInfo"), loginBtn: document.getElementById("loginBtn"), 
        loginEmail: document.getElementById("loginEmail"), loginPassword: document.getElementById("loginPassword"), 
        registerBtn: document.getElementById("registerBtn"), registerEmail: document.getElementById("registerEmail"), 
        registerPassword: document.getElementById("registerPassword"), registerConfirmPassword: document.getElementById("registerConfirmPassword"), 
        logoutBtn: document.getElementById("logoutBtn"), loginForm: document.getElementById("loginForm"), 
        registerForm: document.getElementById("registerForm"), mediaManagementBtn: document.getElementById("mediaManagementBtn"), 
        shareBtn: document.getElementById("shareBtn"), exportBtn: document.getElementById("exportBtn"), 
        importBtn: document.getElementById("importBtn"), importFile: document.getElementById("importFile"), 
        resetBtn: document.getElementById("resetBtn"), themeToggle: document.getElementById("themeToggle"), 
        updateExistingBtn: document.getElementById("updateExistingBtn"),
        searchInput: document.getElementById("searchInput"), categoryFilter: document.getElementById("categoryFilter"), 
        sortFilter: document.getElementById("sortFilter"), statTotal: document.getElementById("statTotal"), 
        statWatchlist: document.getElementById("statWatchlist"), statWatched: document.getElementById("statWatched"), 
        statRewatched: document.getElementById("statRewatched"), statHours: document.getElementById("statHours"), 
        mediaSectionsContainer: document.getElementById("mediaSectionsContainer"), mediaManagementModal: document.getElementById("mediaManagementModal"), 
        mediaTitle: document.getElementById("mediaTitle"), searchTMDbBtn: document.getElementById("searchTMDbBtn"), 
        tmdbResults: document.getElementById("tmdbResults"), saveMediaBtn: document.getElementById("saveMediaBtn"), 
        addMediaCategorySelect: document.getElementById("addMediaCategorySelect"), newCategoryName: document.getElementById("newCategoryName"), 
        addCategoryBtn: document.getElementById("addCategoryBtn"), categoriesList: document.getElementById("categoriesList"), 
        closeManagementModal: document.getElementById("closeManagementModal"),
        notification: document.getElementById("notification"), notificationText: document.getElementById("notificationText"), 
        shareModal: document.getElementById("shareModal"), shareLinkInput: document.getElementById("shareLinkInput"), 
        copyShareLinkBtn: document.getElementById("copyShareLinkBtn"), closeShareModalBtn: document.getElementById("closeShareModalBtn"), 
        viewModeBanner: document.getElementById("viewModeBanner"), viewModeUserEmail: document.getElementById("viewModeUserEmail"), 
        closeViewBtn: document.getElementById("closeViewBtn"), posterModal: document.getElementById("posterModal"), 
        posterGrid: document.getElementById("posterGrid"),
        confirmModal: document.getElementById("confirmModal"), confirmModalTitle: document.getElementById("confirmModalTitle"),
        confirmModalBody: document.getElementById("confirmModalBody"), confirmModalConfirm: document.getElementById("confirmModalConfirm"),
        confirmModalCancel: document.getElementById("confirmModalCancel"),
        rewatchModal: document.getElementById("rewatchModal"), rewatchModalTitle: document.getElementById("rewatchModalTitle"),
        rewatchCountInput: document.getElementById("rewatchCountInput"), confirmRewatchBtn: document.getElementById("confirmRewatchBtn"),
        cancelRewatchBtn: document.getElementById("cancelRewatchBtn"),
        addFriendBtn: document.getElementById('addFriendBtn'),
        friendIdInput: document.getElementById('friendIdInput'),
        friendsList: document.getElementById('friendsList'),
        notificationBellContainer: document.getElementById('notificationBellContainer'),
        bellIcon: document.getElementById('bellIcon'),
        notificationBadge: document.getElementById('notificationBadge'),
        notificationDropdown: document.getElementById('notificationDropdown'),
        savePosterChange: document.getElementById('savePosterChange'),
        cancelPosterChange: document.getElementById('cancelPosterChange'),
        detailsModal: document.getElementById('detailsModal'),
        detailsModalContent: document.getElementById('detailsModalContent'),
        detailsModalClose: document.getElementById('detailsModalClose'),
        actorModal: document.getElementById('actorModal'),
        actorModalContent: document.getElementById('actorModalContent'),
        actorModalClose: document.getElementById('actorModalClose'),
        updateProgressModal: document.getElementById('updateProgressModal'),
        updateProgressBarFill: document.getElementById('updateProgressBarFill'),
        updateProgressText: document.getElementById('updateProgressText')
    };
    
    const defaultMediaProps = { 
        isCountedAsWatched: false, 
        isCountedAsWatchlist: false, 
        rewatchCount: 0,
        lastActivityAt: null,
        isFavorite: false,
        rottenTomatoes: "N/A", 
        popcornRating: "N/A", 
        metacriticRating: "N/A", 
        letterboxdRating: "N/A",
        tmdbID: null
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    document.addEventListener("DOMContentLoaded", init);

    function init() {
      setupEventListeners();
      setupManagementModal();
      loadTheme();
      loadSortOrder();
      handleViewMode() || setupAuthListeners();
    }
    
    function hideLoader() {
        elements.appLoader.style.opacity = '0';
        setTimeout(() => elements.appLoader.style.display = 'none', 300);
    }

    function setupManagementModal() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          btn.classList.add('active');
          document.getElementById(`${btn.dataset.tab}-tab`).classList.add('active');
          
          elements.saveMediaBtn.style.display = (btn.dataset.tab === 'add-media') ? 'inline-flex' : 'none';
        });
      });
      elements.saveMediaBtn.addEventListener('click', () => {
        if (!currentTMDbSelection) return showNotification("Cerca e seleziona un film.", "warning");
        addNewMedia(currentTMDbSelection.tmdbId);
      });
      elements.closeManagementModal.addEventListener('click', () => closeModal(elements.mediaManagementModal));
    }

    function openMediaManagementModal() {
      if (isViewMode) return;
      elements.mediaTitle.value = "";
      elements.tmdbResults.innerHTML = "";
      currentTMDbSelection = null;
      
      populateAddMediaCategorySelect();
      renderCategoriesList();
      renderFriendsList();
      
      const myIdContainer = document.getElementById('myIdContainer');
      const myIdInput = document.getElementById('myIdInput');
      const copyMyIdBtn = document.getElementById('copyMyIdBtn');

      if (currentUser && myIdContainer && myIdInput && copyMyIdBtn) {
          myIdContainer.style.display = 'block';
          myIdInput.value = currentUser.uid;
          copyMyIdBtn.onclick = () => {
              navigator.clipboard.writeText(currentUser.uid);
              showNotification("Il tuo ID è stato copiato!", "success");
          };
      } else if (myIdContainer) {
          myIdContainer.style.display = 'none';
      }
      
      const addMediaTab = document.querySelector('.tab-btn[data-tab="add-media"]');
      if(addMediaTab.classList.contains('active')) {
          elements.saveMediaBtn.style.display = 'inline-flex';
      } else {
          elements.saveMediaBtn.style.display = 'none';
      }
      
      elements.mediaManagementModal.style.display = 'flex';
      document.body.classList.add('modal-open');
    }

    function getRottenTomatoesState(score) { if (!score || score === "N/A") return null; const value = parseInt(String(score).replace('%', '')); return isNaN(value) ? null : value >= 75 ? "certified" : value >= 60 ? "fresh" : "rotten"; }
    function getPopcornState(score) { if (!score || score === "N/A") return null; const value = parseInt(String(score).replace('%', '')); return isNaN(value) ? null : value >= 60 ? "positive" : "negative"; }
    function getMetacriticState(score) { if (!score || score === "N/A") return null; const value = parseInt(score); return isNaN(value) ? null : value >= 61 ? "favorable" : value >= 40 ? "mixed" : "unfavorable"; }

    function setupAuthListeners() {
      elements.authToggle.addEventListener("click", e => {
        e.stopPropagation();
        elements.authForms.classList.toggle("active");
      });
      document.addEventListener("click", e => {
        if (!elements.authForms.contains(e.target) && !e.target.closest(".auth-container")) {
          elements.authForms.classList.remove("active");
        }
      });
      document.querySelectorAll(".auth-tab").forEach(tab => {
        tab.addEventListener("click", () => {
          document.querySelectorAll(".auth-tab").forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          document.querySelectorAll(".auth-form-container").forEach(c => c.classList.remove("active"));
          document.getElementById(`${tab.dataset.tab}Form`).classList.add("active");
        });
      });
      elements.loginBtn.addEventListener("click", () => {
        const email = elements.loginEmail.value;
        const password = elements.loginPassword.value;
        if (email && password) {
          firebase.auth().signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                if (userCredential.user) {
                    const userRef = db.ref(`users/${userCredential.user.uid}/email`);
                    userRef.once('value', snapshot => {
                        if (!snapshot.exists()) {
                            userRef.set(email);
                        }
                    });
                }
                showNotification("Login effettuato", "success");
                elements.authForms.classList.remove("active");
            })
            .catch(err => showNotification(getAuthErrorMessage(err), "error"));
        } else {
          showNotification("Inserisci email e password", "warning");
        }
      });
      elements.registerBtn.addEventListener("click", () => {
        const email = elements.registerEmail.value;
        const password = elements.registerPassword.value;
        const confirmPassword = elements.registerConfirmPassword.value;
        if (email && password && confirmPassword) {
          if (password !== confirmPassword) {
            showNotification("Le password non corrispondono", "warning");
          } else if (password.length < 6) {
            showNotification("La password deve avere almeno 6 caratteri", "warning");
          } else {
            firebase.auth().createUserWithEmailAndPassword(email, password)
              .then((userCredential) => {
                db.ref(`users/${userCredential.user.uid}/email`).set(email);
                showNotification("Registrazione completata!", "success");
                elements.authForms.classList.remove("active");
              })
              .catch(err => showNotification(getAuthErrorMessage(err), "error"));
          }
        } else {
          showNotification("Compila tutti i campi", "warning");
        }
      });
      elements.logoutBtn.addEventListener("click", () => {
          detachAllFriendListeners();
          firebase.auth().signOut()
      });
      
      firebase.auth().onAuthStateChanged(user => {
        if (isViewMode) return;
        currentUser = user;
        updateAuthUI();
        if (user) {
          loadData();
        } else {
          loadLocalData();
          hideLoader();
        }
      });
    }

    function getAuthErrorMessage(err) {
      switch (err.code) {
        case "auth/email-already-in-use": return "Email già registrata";
        case "auth/invalid-email": return "Email non valida";
        case "auth/weak-password": return "Password troppo debole";
        case "auth/user-not-found": return "Utente non trovato";
        case "auth/wrong-password": return "Password errata";
        default: return "Errore: " + err.message;
      }
    }

    function updateAuthUI() {
      if (currentUser) {
        elements.userInfo.style.display = "flex";
        elements.authToggle.parentElement.style.display = "none";
        elements.notificationBellContainer.style.display = 'block';
        document.querySelectorAll(".btn").forEach(btn => btn.disabled = false);
      } else {
        elements.userInfo.style.display = "none";
        elements.authToggle.parentElement.style.display = "block";
        elements.notificationBellContainer.style.display = 'none';
        document.querySelectorAll("#mediaManagementBtn, #shareBtn").forEach(btn => btn.disabled = true);
        document.querySelectorAll("#exportBtn, #importBtn, #resetBtn, #updateExistingBtn").forEach(btn => btn.disabled = false);
      }
    }

    function loadData() {
        if (!currentUser) return;
        const path = `users/${currentUser.uid}`;
        db.ref(`${path}/mediaTracker`).on("value", snap => {
            const data = snap.val() || {};
            mediaList = (data.mediaList || []).map(item => ({ ...defaultMediaProps, ...item }));
            categories = data.categories || [...DEFAULT_CATEGORIES];
            renderFullUI();
        });

        db.ref(`${path}/social`).once("value", snapshot => {
            const data = snapshot.val() || {};
            followedFriends = data.followedFriends || [];
            lastCheckedTimestamps = data.lastCheckedTimestamps || {};
            if (!isViewMode) {
                setupFriendListeners();
                renderFriendsList();
            }
        });
        hideLoader();
    }

    function loadLocalData() {
      try {
        let storedMedia = JSON.parse(localStorage.getItem("mediaList")) || [];
        mediaList = storedMedia.map(item => ({ ...defaultMediaProps, ...item }));
        categories = JSON.parse(localStorage.getItem("categories")) || [...DEFAULT_CATEGORIES];
        renderFullUI();
      } catch (err) {
        console.error("Error loading local data:", err);
      }
    }

    function saveData() {
        if (isViewMode) return;
        if (currentUser) {
            const now = new Date().toISOString();
            db.ref(`users/${currentUser.uid}/mediaTracker`).update({
                mediaList: mediaList,
                categories: categories,
                lastModified: now
            }).catch(err => {
                console.error("Error updating media data to Firebase:", err);
            });
        } else {
            saveToLocal();
        }
    }

    function saveSocialData() {
        if (isViewMode || !currentUser) return;
        db.ref(`users/${currentUser.uid}/social`).set({ followedFriends, lastCheckedTimestamps }).catch(err => {
            console.error("Error saving social data to Firebase:", err);
        });
    }

    function saveToLocal() {
      try {
        localStorage.setItem("mediaList", JSON.stringify(mediaList));
        localStorage.setItem("categories", JSON.stringify(categories));
      } catch (err) {
        console.error("Error saving locally:", err);
      }
    }

    function handleViewMode() {
      const viewId = new URLSearchParams(window.location.search).get("view");
      if (!viewId) return false;
      isViewMode = true;
      document.querySelectorAll("#mediaManagementBtn, #shareBtn, #exportBtn, #importBtn, #resetBtn, .auth-container, #userInfo, .notification-bell-container, #updateExistingBtn").forEach(el => el.style.display = "none");
      elements.viewModeBanner.style.display = "flex";
      db.ref(`users/${viewId}/mediaTracker`).on("value", snapshot => {
        const data = snapshot.val();
        if (data) {
          let storedMedia = data.mediaList || [];
          mediaList = storedMedia.map(item => ({ ...defaultMediaProps, ...item }));
          categories = data.categories || [...DEFAULT_CATEGORIES];
          renderFullUI();
          db.ref(`users/${viewId}/email`).once("value", snapshot => {
            const email = snapshot.val();
            elements.viewModeUserEmail.textContent = `Stai visualizzando la libreria di ${email || "un utente"}`;
          });
        } else {
          showNotification("Libreria condivisa non trovata o non accessibile.", "error");
        }
        hideLoader();
      });
      return true;
    }

    function renderFullUI() {
      renderCategorySections();
      updateCategoryFilter();
      populateAddMediaCategorySelect();
      renderCategoriesList();
      updateStats(); 
      renderMedia();
    }

    function renderMedia() {
      const selectedCategory = elements.categoryFilter.value;
      const searchTerm = elements.searchInput.value.toLowerCase();
      const sortBy = elements.sortFilter.value;

      document.querySelectorAll(".media-section").forEach(section => {
        section.style.display = 'block';
        section.querySelector('.media-grid').innerHTML = '';
      });

      let filteredMedia = [...mediaList];
      if (searchTerm) {
        filteredMedia = filteredMedia.filter(m => m.title.toLowerCase().includes(searchTerm));
      }
      if (selectedCategory === "favorites") {
        filteredMedia = filteredMedia.filter(m => m.isFavorite);
      } else if (selectedCategory !== "all") {
        filteredMedia = filteredMedia.filter(m => m.category === selectedCategory);
      }

      filteredMedia.sort((a, b) => {
          switch (sortBy) {
              case "saga-alpha":
                  const aSagaCount = a.sagaName ? filteredMedia.filter(m => m.sagaName === a.sagaName).length : 0;
                  const bSagaCount = b.sagaName ? filteredMedia.filter(m => m.sagaName === b.sagaName).length : 0;
                  const isASaga = a.sagaName && aSagaCount > 1;
                  const isBSaga = b.sagaName && bSagaCount > 1;
                  
                  const sortKeyA = isASaga ? a.sagaName : a.title;
                  const sortKeyB = isBSaga ? b.sagaName : b.title;

                  if (sortKeyA !== sortKeyB) {
                      return sortKeyA.localeCompare(sortKeyB);
                  }
                  
                  const dateA = a.releaseDate || '0';
                  const dateB = b.releaseDate || '0';
                  return new Date(dateA) - new Date(dateB);
              case "alpha": 
                  return a.title.localeCompare(b.title);
              case "rating": 
                  return (parseFloat(b.imdbRating) || 0) - (parseFloat(a.imdbRating) || 0);
              case "year": 
                  return (parseInt(b.year) || 0) - (parseInt(a.year) || 0);
              case "added": 
              default: 
                  const timeA = a.lastActivityAt || a.addedAt;
                  const timeB = b.lastActivityAt || b.addedAt;
                  return new Date(timeB) - new Date(timeA);
          }
      });
      
      filteredMedia.forEach(media => {
        const grid = document.getElementById(`${media.category}Grid`);
        if (grid) grid.appendChild(createMediaCard(media));
      });
      
      let hasContent = false;
      categories.forEach(cat => {
        const section = document.getElementById(`${cat}Section`);
        const grid = document.getElementById(`${cat}Grid`);
        if (section && grid) {
          if (grid.children.length === 0) {
            if (selectedCategory === 'all' || selectedCategory === cat) {
               grid.innerHTML = `<div class="empty-state"><i class="fas fa-film"></i><p>Nessun film in questa categoria.</p></div>`;
            } else {
               section.style.display = 'none';
            }
          } else {
            hasContent = true;
          }
        }
      });
      
      if(selectedCategory === 'favorites' && !filteredMedia.length){
          renderCategorySections();
          elements.mediaSectionsContainer.innerHTML = `<div class="media-section"><div class="empty-state"><i class="fas fa-heart-crack"></i><p>Nessun preferito aggiunto.</p></div></div>`;
      } else if (selectedCategory === 'favorites' && filteredMedia.length > 0) {
          document.querySelectorAll('.media-section').forEach(s => {
              if(s.querySelector('.media-grid').children.length === 0) s.style.display = 'none';
          })
      }


      setupLazyLoading();
      updateCounts();
    }

    function updateStats() {
        statContributorIds.clear();
        ignoredDuplicateIds.clear();
        const processed = new Set();
        mediaList.forEach(media => {
            const uniqueId = media.imdbID || media.title.toLowerCase().trim();
            if (!uniqueId || processed.has(uniqueId)) return;
            processed.add(uniqueId);
            const instances = mediaList.filter(m => (m.imdbID && m.imdbID === uniqueId) || (!m.imdbID && m.title.toLowerCase() === uniqueId));
            let contributor = instances.find(m => m.category === "watched") ||
                             instances.find(m => m.isCountedAsWatched) ||
                             instances.find(m => m.category === "watchlist") ||
                             instances.find(m => m.isCountedAsWatchlist) ||
                             instances[0];
            if (contributor) {
                statContributorIds.add(contributor.id);
                instances.forEach(inst => {
                    if (inst.id !== contributor.id) ignoredDuplicateIds.add(inst.id);
                });
            }
        });
        
        const stats = { total: mediaList.length, watchlist: 0, watched: 0, rewatched: 0, minutes: 0 };
        statContributorIds.forEach(id => {
            const media = mediaList.find(m => m.id === id);
            if (!media) return;
            const isWatched = media.category === "watched" || media.isCountedAsWatched;
            if (isWatched) {
              stats.watched++;
              if (media.rewatchCount > 0) stats.rewatched += media.rewatchCount;
              const runtime = parseInt(media.runtime?.replace(/\D/g, "")) || 0;
              if (runtime > 0) stats.minutes += runtime * ((media.rewatchCount || 0) + 1);
            } else if (media.category === "watchlist" || media.isCountedAsWatchlist) {
              stats.watchlist++;
            }
        });

        const hours = Math.floor(stats.minutes / 60);
        stats.minutes %= 60;
        elements.statTotal.textContent = stats.total;
        elements.statWatchlist.textContent = stats.watchlist;
        elements.statWatched.textContent = stats.watched;
        elements.statRewatched.textContent = stats.rewatched;
        elements.statHours.textContent = `${hours}h ${stats.minutes}m`;
    }

    function updateCounts() {
      categories.forEach(cat => {
        const countEl = document.getElementById(`${cat}Count`);
        if (countEl) countEl.textContent = mediaList.filter(m => m.category === cat).length;
      });
    }

    function createMediaCard(media) {
      const card = document.createElement("div");
      card.className = "media-card";
      card.dataset.id = media.id;
      if (statContributorIds.has(media.id)) card.classList.add("is-stat-contributor");
      if (ignoredDuplicateIds.has(media.id)) card.classList.add("is-duplicate");
      
      card.addEventListener('click', (e) => {
        if (e.target.closest('.card-actions') || e.target.closest('.favorite-btn')) return;
        showDetailsModal(media.id);
      });

      let ratingsHTML = "";
      const rtState = getRottenTomatoesState(media.rottenTomatoes);
      const popcornState = getPopcornState(media.popcornRating);
      
      if (media.imdbRating && media.imdbRating !== "N/A") { ratingsHTML += `<span class="rating-badge"><img src="${IMDB_STAR_ICON}" class="rating-icon">&nbsp;${media.imdbRating}</span>`; }
      if (rtState) { ratingsHTML += `<span class="rating-badge"><img src="${ROTTEN_TOMATOES_ICONS[rtState]}" class="rating-icon">&nbsp;${media.rottenTomatoes}</span>`; }
      if (popcornState) { ratingsHTML += `<span class="rating-badge"><img src="${POPCORN_ICONS[popcornState]}" class="rating-icon">&nbsp;${media.popcornRating}</span>`; }
      
      const ratingsSection = ratingsHTML ? `<div class="media-ratings">${ratingsHTML}</div>` : "";
      
      const actionsHTML = isViewMode ? '' : `
        <div class="card-actions">
            <button class="card-btn" data-action="move" title="Sposta in..."><i class="fas fa-folder-open"></i></button>
            <button class="card-btn" data-action="delete" title="Elimina"><i class="fas fa-trash"></i></button>
        </div>`;

      card.innerHTML = `
        <div class="poster-container">
          <img data-src="${fixPosterUrl(media.poster) || DEFAULT_POSTER}" class="media-poster lazy" onerror="this.src='${DEFAULT_POSTER}'">
          <button class="favorite-btn ${media.isFavorite ? 'is-favorite' : ''}" title="Aggiungi ai preferiti"><i class="fas fa-heart"></i></button>
          ${actionsHTML}
        </div>
        <div class="media-info">
          <h3 class="media-title" title="${media.title}">${media.title}</h3>
          <div class="media-meta">
            ${media.year ? `<span>${media.year}</span>` : ""}
            ${media.runtime ? `<span><i class="fas fa-clock"></i> ${formatRuntime(media.runtime)}</span>` : ""}
          </div>
          ${ratingsSection}
        </div>
      `;
      if (!isViewMode) {
          card.querySelector('[data-action="move"]').addEventListener("click", e => {
            e.stopPropagation();
            showContextMenu(media, { x: e.clientX, y: e.clientY });
          });
          card.querySelector('[data-action="delete"]').addEventListener("click", e => {
            e.stopPropagation();
            deleteMedia(media.id);
          });
          card.querySelector('.favorite-btn').addEventListener("click", e => {
              e.stopPropagation();
              toggleFavorite(media.id);
          })
      }
      return card;
    }

    function fixPosterUrl(url) {
      if (!url || url === "N/A") return null;
      return url.startsWith("http://") || url.startsWith("https://") ? url : url.startsWith("//") ? `https:${url}` : `https://${url}`;
    }

    function renderCategorySections() {
      elements.mediaSectionsContainer.innerHTML = categories.map(cat => `
        <div class="media-section" id="${cat}Section" data-category="${cat}">
          <div class="section-header">
            <h2 class="section-title user-select-none">${getCategoryName(cat)}</h2>
            <span id="${cat}Count" class="category-count">0</span>
          </div>
          <div class="media-grid" id="${cat}Grid"></div>
        </div>
      `).join("");
    }

    function renderCategoriesList() {
      const list = elements.categoriesList;
      list.innerHTML = "";
      categories.forEach((cat, index) => {
        const count = mediaList.filter(m => m.category === cat).length;
        const dotClass = `category-dot-${index % 6}`;
        const card = document.createElement("div");
        card.className = "management-card";
        const isDefault = DEFAULT_CATEGORIES.includes(cat);
        card.innerHTML = `
          <div>
            <span class="category-dot ${dotClass}"></span>
            <div>
              <div class="category-name">${getCategoryName(cat)}</div>
            </div>
          </div>
          <div class="management-card-actions">
            <button class="btn move-up-btn" data-category="${cat}" ${index === 0 ? "disabled" : ""}><i class="fas fa-arrow-up"></i></button>
            <button class="btn move-down-btn" data-category="${cat}" ${index === categories.length - 1 ? "disabled" : ""}><i class="fas fa-arrow-down"></i></button>
            ${!isDefault ? `
              <button class="btn rename-category-btn" data-category="${cat}"><i class="fas fa-pencil-alt"></i></button>
              <button class="btn btn-danger delete-category-btn" data-category="${cat}"><i class="fas fa-trash"></i></button>
            ` : ""}
          </div>
        `;
        list.appendChild(card);
      });
      list.querySelectorAll(".rename-category-btn").forEach(btn => {
        btn.addEventListener("click", e => {
          e.stopPropagation();
          const cat = btn.dataset.category;
          const nameEl = btn.closest(".management-card").querySelector(".category-name");
          renameCategory(cat, nameEl);
        });
      });
      list.querySelectorAll(".delete-category-btn").forEach(btn => {
        btn.addEventListener("click", e => {
          e.stopPropagation();
          deleteCategory(btn.dataset.category);
        });
      });
      list.querySelectorAll(".move-up-btn").forEach(btn => btn.addEventListener("click", () => moveCategory(btn.dataset.category, -1)));
      list.querySelectorAll(".move-down-btn").forEach(btn => btn.addEventListener("click", () => moveCategory(btn.dataset.category, 1)));
    }

    function renameCategory(cat, nameEl) {
      const oldName = nameEl.textContent.trim();
      const input = document.createElement("input");
      input.type = "text";
      input.value = oldName;
      nameEl.parentElement.innerHTML = "";
      nameEl.parentElement.appendChild(input);
      input.focus();
      const save = () => {
        const newName = input.value.trim();
        if (newName && newName !== cat && !categories.includes(newName)) {
          mediaList.forEach(m => { if (m.category === cat) m.category = newName; });
          categories[categories.indexOf(cat)] = newName;
          saveData();
          renderFullUI();
          showNotification(`Categoria rinominata in "${newName}"`, "success");
        } else {
          renderCategoriesList();
        }
      };
      input.addEventListener("blur", save);
      input.addEventListener("keydown", e => {
        if (e.key === "Enter") input.blur();
        if (e.key === "Escape") renderCategoriesList();
      });
    }

    function moveCategory(cat, direction) {
      const index = categories.indexOf(cat);
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= categories.length) return;
      [categories[index], categories[newIndex]] = [categories[newIndex], categories[index]];
      saveData();
      renderFullUI();
    }

    function updateCategoryFilter() {
      const current = elements.categoryFilter.value;
      elements.categoryFilter.innerHTML = `<option value="all">Tutte le categorie</option><option value="favorites">Solo Preferiti</option>${categories.map(cat => `<option value="${cat}">${getCategoryName(cat)}</option>`).join("")}`;
      elements.categoryFilter.value = current;
    }

    function populateAddMediaCategorySelect() {
      const lastUsed = localStorage.getItem("lastUsedCategory");
      elements.addMediaCategorySelect.innerHTML = categories.map(cat => `<option value="${cat}">${getCategoryName(cat)}</option>`).join("");
      if (lastUsed && categories.includes(lastUsed)) elements.addMediaCategorySelect.value = lastUsed;
    }

    function getCategoryName(cat) {
      const names = { watchlist: "Da Vedere", watched: "Visti" };
      return names[cat] || cat;
    }

    function addCategory(name) {
      if (!name) return showNotification("Inserisci un nome per la categoria", "warning"), false;
      const trimmed = name.trim();
      if (categories.some(c => c.toLowerCase() === trimmed.toLowerCase())) {
        showNotification("Questa categoria esiste già", "warning");
        return false;
      }
      categories.push(trimmed);
      saveData();
      renderFullUI();
      showNotification(`Categoria "${trimmed}" creata`, "success");
      elements.newCategoryName.value = "";
      return true;
    }
    
    function showConfirmModal(title, body, onConfirm) {
      elements.confirmModalTitle.textContent = title;
      elements.confirmModalBody.textContent = body;
      elements.confirmModal.style.display = "flex";
      document.body.classList.add("modal-open");
      const confirmHandler = () => { onConfirm(); closeModal(elements.confirmModal); cleanup(); };
      const cancelHandler = () => { closeModal(elements.confirmModal); cleanup(); };
      const cleanup = () => {
        elements.confirmModalConfirm.removeEventListener("click", confirmHandler);
        elements.confirmModalCancel.removeEventListener("click", cancelHandler);
      };
      elements.confirmModalConfirm.addEventListener("click", confirmHandler);
      elements.confirmModalCancel.addEventListener("click", cancelHandler);
    }
    
    function deleteCategory(cat) {
      if (DEFAULT_CATEGORIES.includes(cat)) {
        showNotification("Non puoi eliminare questa categoria predefinita", "warning");
        return;
      }
      showConfirmModal("Elimina Categoria", `Sei sicuro di voler eliminare la categoria "${cat}"? Tutti i film al suo interno saranno spostati in "Da Vedere".`, () => {
        mediaList.forEach(m => { if (m.category === cat) m.category = "watchlist"; });
        categories = categories.filter(c => c !== cat);
        saveData();
        renderFullUI();
        showNotification(`Categoria "${cat}" eliminata`, "success");
      });
    }

    function closeAllMenus() {
      document.querySelectorAll(".context-menu").forEach(menu => menu.remove());
    }
    
    function showContextMenu(media, pos) {
      closeAllMenus();
      const menu = document.createElement("div");
      menu.className = "context-menu";
      const hide = () => {
        menu.classList.remove("visible");
        setTimeout(() => menu.remove(), 150);
        document.removeEventListener("click", hide, { capture: true });
        document.removeEventListener("contextmenu", hide, { capture: true });
      };
      setTimeout(() => {
        document.addEventListener("click", hide, { capture: true, once: true });
        document.addEventListener("contextmenu", hide, { capture: true, once: true });
        requestAnimationFrame(() => menu.classList.add("visible"));
      }, 0);
      menu.addEventListener("click", e => e.stopPropagation());
      
      const header = document.createElement("div");
      header.className = "context-menu-item";
      header.innerHTML = '<i class="fas fa-folder-open fa-fw"></i> <strong>Sposta in...</strong>';
      header.style.cssText = "color: var(--text-secondary); cursor: default; background: rgba(128,128,128,0.1);";
      menu.appendChild(header);
      
      categories.filter(c => c !== media.category).forEach(cat => {
        const item = document.createElement("div");
        item.className = "context-menu-item";
        const index = categories.indexOf(cat);
        const dotClass = `category-dot-${index % 6}`;
        item.innerHTML = `<span class="category-dot ${dotClass}"></span> ${getCategoryName(cat)}`;
        item.addEventListener("click", () => { moveMediaToCategory(media.id, cat); hide(); });
        menu.appendChild(item);
      });
      menu.appendChild(document.createElement("div")).className = "context-menu-divider";
      
      const isCustomCategory = !DEFAULT_CATEGORIES.includes(media.category);
      if (media.category === 'watched' || isCustomCategory) {
        const rewatchItem = document.createElement("div");
        rewatchItem.className = "context-menu-item";
        rewatchItem.innerHTML = '<i class="fas fa-sync-alt fa-fw"></i> Modifica Rewatch';
        rewatchItem.addEventListener("click", () => { openRewatchModal(media.id); hide(); });
        menu.appendChild(rewatchItem);
      }

      if (isCustomCategory) {
        const watchedItem = document.createElement("div");
        watchedItem.className = "context-menu-item";
        if (media.isCountedAsWatched) {
          watchedItem.innerHTML = '<i class="fas fa-times fa-fw"></i> Rimuovi stato "visto"';
          watchedItem.style.color = "var(--danger)";
        } else {
          watchedItem.innerHTML = '<i class="fas fa-check-double fa-fw"></i> Segna come visto qui';
        }
        watchedItem.addEventListener("click", () => { toggleCountedAsWatched(media.id); hide(); });
        menu.appendChild(watchedItem);

        const watchlistItem = document.createElement("div");
        watchlistItem.className = "context-menu-item";
        if (media.isCountedAsWatchlist) {
            watchlistItem.innerHTML = '<i class="fas fa-times fa-fw"></i> Rimuovi stato "da vedere"';
            watchlistItem.style.color = "var(--danger)";
        } else {
            watchlistItem.innerHTML = '<i class="fas fa-list-alt fa-fw"></i> Segna come da vedere qui';
        }
        watchlistItem.addEventListener("click", () => { toggleCountedAsWatchlist(media.id); hide(); });
        menu.appendChild(watchlistItem);
      }
      
      if (media.category === 'watched' || isCustomCategory) {
          menu.appendChild(document.createElement("div")).className = "context-menu-divider";
      }

      const changePosterItem = document.createElement("div");
      changePosterItem.className = "context-menu-item";
      changePosterItem.innerHTML = '<i class="fas fa-image fa-fw"></i> Cambia Copertina';
      changePosterItem.addEventListener("click", () => { showPosterModal(media.id); hide(); });
      menu.appendChild(changePosterItem);

      const deleteItem = document.createElement("div");
      deleteItem.className = "context-menu-item";
      deleteItem.innerHTML = '<i class="fas fa-trash fa-fw"></i> Elimina';
      deleteItem.style.color = "var(--danger)";
      deleteItem.addEventListener("click", () => { deleteMedia(media.id); hide(); });
      menu.appendChild(deleteItem);

      document.body.appendChild(menu);
      const rect = menu.getBoundingClientRect();
      let x = pos.x, y = pos.y;
      if (x + rect.width > window.innerWidth) x = window.innerWidth - rect.width - 5;
      if (y + rect.height > window.innerHeight) y = window.innerHeight - rect.height - 5;
      menu.style.left = `${x}px`;
      menu.style.top = `${y}px`;
    }
    
    function moveMediaToCategory(id, newCategory) {
        const media = mediaList.find(m => m.id === id);
        if (!media) return;

        const oldCategory = media.category;
        media.category = newCategory;
        media.lastActivityAt = new Date().toISOString();

        if (newCategory === 'watched') {
            media.isCountedAsWatched = true;
            media.isCountedAsWatchlist = false; 
        } else if (newCategory === 'watchlist') {
            media.isCountedAsWatchlist = true;
            media.isCountedAsWatched = false;
            media.rewatchCount = 0;
        }

        if (!DEFAULT_CATEGORIES.includes(oldCategory) && DEFAULT_CATEGORIES.includes(newCategory)) {
            if (newCategory === 'watched' && !media.isCountedAsWatched) {
                media.rewatchCount = 0;
            }
            media.isCountedAsWatched = newCategory === 'watched';
            media.isCountedAsWatchlist = newCategory === 'watchlist';
        }
        
        logActivity('move', media.title, `da '${getCategoryName(oldCategory)}' a '${getCategoryName(newCategory)}'`);
        saveData();
        renderMedia();
        updateStats();
        showNotification(`Film spostato in "${getCategoryName(newCategory)}"`, "success");
    }

    function toggleCountedAsWatched(id) {
        const media = mediaList.find(m => m.id === id);
        if (!media) return;
        media.isCountedAsWatched = !media.isCountedAsWatched;
        if (media.isCountedAsWatched) {
            media.isCountedAsWatchlist = false;
            if (media.rewatchCount < 0) media.rewatchCount = 0;
            logActivity('watched_status', media.title, `segnato come visto in '${getCategoryName(media.category)}'`);
        } else {
            logActivity('watched_status', media.title, `rimosso lo stato "visto" in '${getCategoryName(media.category)}'`);
        }
        saveData();
        refreshSingleMedia(id);
        updateStats();
        showNotification(`Stato "visto" aggiornato per ${media.title}`, "success");
    }

    function toggleCountedAsWatchlist(id) {
        const media = mediaList.find(m => m.id === id);
        if (!media) return;
        media.isCountedAsWatchlist = !media.isCountedAsWatchlist;
        if (media.isCountedAsWatchlist) {
            media.isCountedAsWatched = false;
            logActivity('watchlist_status', media.title, `segnato come da vedere in '${getCategoryName(media.category)}'`);
        } else {
             logActivity('watchlist_status', media.title, `rimosso lo stato "da vedere" in '${getCategoryName(media.category)}'`);
        }
        saveData();
        refreshSingleMedia(id);
        updateStats();
        showNotification(`Stato "da vedere" aggiornato per ${media.title}`, "success");
    }

    function openRewatchModal(id) {
        const media = mediaList.find(m => m.id === id);
        if (!media) return;

        currentRewatchMediaId = id;
        elements.rewatchModalTitle.textContent = `Modifica Rewatch: ${media.title}`;
        
        const currentCount = media.rewatchCount || 0;
        elements.rewatchCountInput.value = currentCount;
        
        updateRewatchModalButtons(currentCount);

        elements.rewatchModal.style.display = 'flex';
        document.body.classList.add('modal-open');
    }

    function updateRewatchModalButtons(count) {
        document.querySelectorAll('.quick-rewatch-btn').forEach(btn => {
            btn.classList.toggle('active', parseInt(btn.dataset.count) === count);
        });
    }

    function markRewatch(id, count) {
      const media = mediaList.find(m => m.id === id);
      if (!media) return;
      media.rewatchCount = count;
      media.lastActivityAt = new Date().toISOString();
      if (count >= 0 && !media.isCountedAsWatched) {
        media.isCountedAsWatched = true;
        media.isCountedAsWatchlist = false;
      }
      logActivity('rewatch', media.title, `impostato a ${count} rewatch`);
      saveData();
      refreshSingleMedia(id);
      updateStats();
      showNotification(`Rewatch di "${media.title}" aggiornati`, "success");
    }

    function refreshSingleMedia(id) {
      const media = mediaList.find(m => m.id === id);
      if (!media) return;
      const oldCard = document.querySelector(`.media-card[data-id="${id}"]`);
      
      const grid = oldCard ? oldCard.parentElement : null;
      if (grid && grid.id === `${media.category}Grid`) {
        const newCard = createMediaCard(media);
        grid.replaceChild(newCard, oldCard);
        if (lazyLoadObserver) lazyLoadObserver.observe(newCard.querySelector(".lazy"));
      } else {
        renderMedia();
      }
      updateCounts();
    }

    function deleteMedia(id) {
      if (isViewMode) return;
      const media = mediaList.find(m => m.id === id);
      if (!media) return;
      showConfirmModal("Elimina Film", `Sei sicuro di voler eliminare "${media.title}"?`, () => {
        logActivity('delete', media.title, `dalla categoria '${getCategoryName(media.category)}'`);
        mediaList = mediaList.filter(m => m.id !== id);
        saveData();
        renderMedia();
        showNotification("Film eliminato", "success");
      });
    }

    function closeModal(modal) {
      modal.style.display = "none";
      if (!document.querySelector('.modal[style*="display: flex"]')) {
          document.body.classList.remove("modal-open");
      }
    }

    async function searchTMDb() {
      const title = elements.mediaTitle.value.trim();
      if (!title) return showNotification("Inserisci un titolo", "warning");
      elements.tmdbResults.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-2x loading-spinner"></i></div>';
      try {
        const url = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_KEY}&query=${encodeURIComponent(title)}&language=it-IT&include_adult=false`;
        const response = await fetch(url);
        const data = await response.json();
        if (data.results && data.results.length > 0) {
          displayTMDbResults(data.results);
        } else {
          elements.tmdbResults.innerHTML = `<p>Nessun risultato trovato</p>`;
        }
      } catch (err) {
        showNotification("Errore nella ricerca", "error");
        console.error("TMDb error:", err);
        elements.tmdbResults.innerHTML = "<p>Errore durante la ricerca</p>";
      }
    }

    function displayTMDbResults(results) {
      elements.tmdbResults.innerHTML = results.map(result => `
        <div class="tmdb-result-item user-select-none" data-tmdb-id="${result.id}">
          <img src="${result.poster_path ? `https://image.tmdb.org/t/p/w200${result.poster_path}` : DEFAULT_POSTER}" class="tmdb-poster-small" onerror="this.src='${DEFAULT_POSTER}'">
          <div>
            <div><strong>${result.title}</strong></div>
            <div>${result.release_date ? result.release_date.split('-')[0] : ''}</div>
          </div>
        </div>
      `).join("");
      document.querySelectorAll(".tmdb-result-item").forEach(item => {
        item.addEventListener("click", () => {
          currentTMDbSelection = { tmdbId: item.dataset.tmdbId, title: item.querySelector("strong").textContent };
          elements.mediaTitle.value = currentTMDbSelection.title;
          showNotification(`"${currentTMDbSelection.title}" selezionato`, "success");
        });
      });
    }

    async function addNewMedia(tmdbId) {
        if (isViewMode) return;
        showNotification("Recupero dettagli del film...", "warning");
        
        try {
            const tmdbDetails = await fetchFullTMDbDetails(tmdbId);
            if (!tmdbDetails || !tmdbDetails.imdb_id) {
                return showNotification("Dettagli non trovati o IMDb ID mancante.", "error");
            }
            
            const category = elements.addMediaCategorySelect.value;
            localStorage.setItem("lastUsedCategory", category);

            if (mediaList.some(m => m.imdbID === tmdbDetails.imdb_id && m.category === category)) {
                return showNotification(`Questo film è già in "${getCategoryName(category)}"`, "warning");
            }

            let media = {
                ...defaultMediaProps,
                id: Date.now().toString(),
                title: tmdbDetails.title,
                year: tmdbDetails.release_date ? tmdbDetails.release_date.split('-')[0] : "",
                poster: tmdbDetails.poster_path ? `https://image.tmdb.org/t/p/w500${tmdbDetails.poster_path}` : DEFAULT_POSTER,
                imdbID: tmdbDetails.imdb_id,
                tmdbID: tmdbId,
                runtime: tmdbDetails.runtime ? `${tmdbDetails.runtime} min` : "",
                category,
                addedAt: new Date().toISOString(),
                lastActivityAt: new Date().toISOString(),
                sagaName: tmdbDetails.belongs_to_collection ? tmdbDetails.belongs_to_collection.name : null,
                releaseDate: tmdbDetails.release_date || null,
                isCountedAsWatched: category === 'watched',
                isCountedAsWatchlist: category === 'watchlist'
            };
            
            const ratings = await fetchMDBListRatings(media.imdbID);
            if(ratings) {
                const rtRating = ratings.find(r => r.source === 'tomatoes');
                const popcornRating = ratings.find(r => r.source === 'tomatoesaudience');
                const letterboxdRating = ratings.find(r => r.source === 'letterboxd');
                const metacriticRating = ratings.find(r => r.source === 'metacritic');
                const imdbRating = ratings.find(r => r.source === 'imdb');
                
                if (rtRating) media.rottenTomatoes = rtRating.value;
                if (popcornRating) media.popcornRating = popcornRating.value;
                if (letterboxdRating) media.letterboxdRating = letterboxdRating.value;
                if (metacriticRating) media.metacriticRating = metacriticRating.value;
                if (imdbRating) media.imdbRating = imdbRating.value;
            } else {
                media.imdbRating = tmdbDetails.vote_average ? tmdbDetails.vote_average.toFixed(1) : "N/A";
            }
            
            mediaList.push(media);
            logActivity('add', media.title, `in '${getCategoryName(media.category)}'`);
            saveData();
            closeModal(elements.mediaManagementModal);
            renderFullUI();
            showNotification(`Film "${media.title}" aggiunto!`, "success");

        } catch (error) {
            console.error("Error adding new media:", error);
            showNotification("Errore durante l'aggiunta del film.", "error");
        }
    }
    
    function exportData() {
      if (isViewMode) return;
      const data = { mediaList, categories, exportedAt: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `filmtracker_export_${new Date().toISOString().split("T")[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showNotification("Dati esportati", "success");
    }

    function importData(file) {
      if (isViewMode || !file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          if (!Array.isArray(data.mediaList)) throw new Error("Formato file non valido");
          showConfirmModal("Importa Dati", `Stai per importare ${data.mediaList.length} film. I dati attuali verranno sovrascritti. Continuare?`, () => {
            mediaList = data.mediaList;
            categories = data.categories || [...DEFAULT_CATEGORIES];
            saveData();
            renderFullUI();
            showNotification("Dati importati con successo", "success");
          });
        } catch (err) {
          showNotification("Errore nell'importazione: " + err.message, "error");
        }
      };
      reader.readAsText(file);
    }

    function resetApp() {
      if (isViewMode) return;
      showConfirmModal("Resetta Applicazione", "Sei sicuro di voler resettare l'applicazione? Tutti i dati andranno persi.", () => {
        mediaList = [];
        categories = [...DEFAULT_CATEGORIES];
        saveData();
        elements.searchInput.value = "";
        elements.categoryFilter.value = "all";
        elements.sortFilter.value = "saga-alpha";
        renderFullUI();
        showNotification("Applicazione resettata", "success");
      });
    }

    function loadTheme() {
      const theme = localStorage.getItem("theme") || "dark";
      document.body.classList.toggle("dark", theme === "dark");
      elements.themeToggle.innerHTML = `<i class="fas fa-${theme === "dark" ? "sun" : "moon"}"></i>`;
    }

    function toggleTheme() {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      elements.themeToggle.innerHTML = `<i class="fas fa-${isDark ? "sun" : "moon"}"></i>`;
    }

    function loadSortOrder() {
      const sort = localStorage.getItem("mediaTrackerSortOrder");
      if (sort) elements.sortFilter.value = sort;
    }

    function showNotification(text, type = "success") {
      elements.notificationText.textContent = text;
      elements.notification.className = `notification ${type}`;
      elements.notification.style.display = "block";
      setTimeout(() => elements.notification.style.display = "none", 3000);
    }

    function setupLazyLoading() {
      if (lazyLoadObserver) lazyLoadObserver.disconnect();
      lazyLoadObserver = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            img.src = img.dataset.src;
            img.classList.remove("lazy");
            lazyLoadObserver.unobserve(img);
          }
        });
      });
      document.querySelectorAll(".lazy").forEach(img => lazyLoadObserver.observe(img));
    }

    function formatRuntime(runtime) {
      if (!runtime) return "";
      const minutes = parseInt(runtime);
      if (isNaN(minutes) || minutes <= 0) return "";
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return hours > 0 ? `${hours}h ${mins > 0 ? `${mins}m` : ""}` : `${mins}m`;
    }

    function logActivity(type, title, details) {
        if (!currentUser) return;
        const logRef = db.ref(`users/${currentUser.uid}/activityLog`);
        const newActivity = { type, title, details, timestamp: new Date().toISOString() };
        
        return logRef.transaction(currentLog => {
            let log = Array.isArray(currentLog) ? currentLog : [];
            log.unshift(newActivity);
            return log.slice(0, MAX_LOG_SIZE);
        });
    }
    
    function detachAllFriendListeners() {
        Object.values(friendListeners).forEach(({ ref, listener }) => ref.off('value', listener));
        friendListeners = {};
    }

    function setupFriendListeners() {
        if (!currentUser) return;
        detachAllFriendListeners();

        const friendActivityMap = new Map();

        const processAndRenderNotifications = () => {
            let allNewNotifications = Array.from(friendActivityMap.values()).flat();
            allNewNotifications.sort((a, b) => new Date(b.activity.timestamp) - new Date(a.activity.timestamp));
            renderNotifications(allNewNotifications.slice(0, MAX_NOTIFICATIONS));
        };
        
        followedFriends.forEach(friend => {
            const ref = db.ref(`users/${friend.id}/activityLog`);
            const listener = snapshot => {
                const activities = snapshot.val() || [];
                const lastChecked = lastCheckedTimestamps[friend.id] || new Date(0).toISOString();
                
                const activityArray = Array.isArray(activities) ? activities : [];
                const newActivities = activityArray
                    .filter(act => act && new Date(act.timestamp) > new Date(lastChecked))
                    .map(activity => ({ friendId: friend.id, friendEmail: friend.email, activity }));

                friendActivityMap.set(friend.id, newActivities);
                processAndRenderNotifications();
            };
            ref.on('value', listener);
            friendListeners[friend.id] = { ref, listener };
        });
    }

    function renderNotifications(notifications) {
        const count = notifications.length;
        elements.notificationBadge.textContent = count;
        elements.notificationBadge.classList.toggle('visible', count > 0);
        
        elements.notificationDropdown.innerHTML = '';
        
        const header = document.createElement('div'); header.className = 'notification-header'; header.textContent = 'Notifiche Amici';
        const list = document.createElement('div'); list.className = 'notification-list';

        if (count > 0) {
            notifications.forEach(n => {
                if (!n.activity) return;
                const item = document.createElement('div');
                item.className = 'notification-item';
                item.dataset.friendId = n.friendId;
                const isTV = n.activity.type.includes('show') || n.activity.type.includes('season');
                item.innerHTML = `
                    <i class="fas ${getActivityIcon(n.activity.type)} ${isTV ? 'tv-notification' : 'film-notification'}"></i>
                    <span class="notification-item-text">${getActivityText(n.friendEmail, n.activity)}</span>`;
                
                item.addEventListener('click', () => {
                    const friendId = item.dataset.friendId;
                    if (friendId) {
                       window.open(`${window.location.origin}${window.location.pathname}?view=${friendId}`, '_blank');
                    }
                });
                list.appendChild(item);
            });
            
            const footer = document.createElement('div'); footer.className = 'notification-footer';
            const markAllBtn = document.createElement('button');
            markAllBtn.className = 'btn btn-primary btn-small';
            markAllBtn.innerHTML = '<i class="fas fa-check-double"></i> Segna tutte come lette';
            markAllBtn.addEventListener('click', markAllNotificationsAsRead);
            footer.appendChild(markAllBtn);
            
            elements.notificationDropdown.appendChild(header);
            elements.notificationDropdown.appendChild(list);
            elements.notificationDropdown.appendChild(footer);

        } else {
            const emptyState = document.createElement('div'); emptyState.className = 'no-notifications'; emptyState.textContent = 'Nessuna nuova notifica';
            list.appendChild(emptyState);
            elements.notificationDropdown.appendChild(header);
            elements.notificationDropdown.appendChild(list);
        }
    }
    
    function markAllNotificationsAsRead() {
        if (!currentUser) return;
        followedFriends.forEach(f => lastCheckedTimestamps[f.id] = new Date().toISOString());
        saveSocialData();
        renderNotifications([]);
    }

    function getActivityIcon(type) {
        if (type === 'add') return 'fa-film';
        if (type === 'move') return 'fa-folder-open';
        if (type === 'delete') return 'fa-trash-alt';
        if (type === 'rewatch') return 'fa-sync-alt';
        if (type.startsWith('add_show')) return 'fa-plus-circle';
        if (type.startsWith('complete_show')) return 'fa-tv';
        if (type.startsWith('complete_season')) return 'fa-check-circle';
        return 'fa-info-circle';
    }

    function getActivityText(friendEmail, activity) {
        const email = `<strong>${friendEmail || 'Utente'}</strong>`;
        const title = `<strong>${activity.title}</strong>`;
        switch (activity.type) {
            case 'add': return `${email} ha aggiunto il film ${title} ${activity.details}`;
            case 'move': return `${email} ha spostato il film ${title} ${activity.details}`;
            case 'delete': return `${email} ha eliminato il film ${title} ${activity.details}`;
            case 'rewatch': return `${email} ha aggiornato ${title} (${activity.details})`;
            case 'add_show': return `${email} ha aggiunto la serie ${title} ${activity.details}`;
            case 'move_show': return `${email} ha spostato la serie ${title} ${activity.details}`;
            case 'delete_show': return `${email} ha eliminato la serie ${title} ${activity.details}`;
            case 'complete_show': return `${email} ha completato la serie ${title}! 🎉`;
            case 'complete_season': return `${email} ha completato ${activity.details} di ${title}`;
            default: return `${email} ha aggiornato ${title}`;
        }
    }
    
    async function showDetailsModal(mediaId) {
        const media = mediaList.find(m => m.id === mediaId);
        if (!media || !media.imdbID) {
            showNotification("Dettagli non disponibili (manca IMDb ID)", "warning");
            return;
        }

        elements.detailsModal.style.display = 'flex';
        document.body.classList.add('modal-open');
        elements.detailsModalContent.innerHTML = '<div style="text-align: center; padding: 4rem;"><i class="fas fa-spinner fa-3x loading-spinner"></i></div>';

        const details = await fetchTMDbDetails(media.imdbID);

        if (details) {
            populateDetailsModal(details, media);
        } else {
            elements.detailsModalContent.innerHTML = '<p style="text-align: center; padding: 2rem;">Dettagli non trovati.</p>';
        }
    }

    function populateDetailsModal(details, media) {
        const backdropUrl = details.backdrop_path ? `https://image.tmdb.org/t/p/w1280${details.backdrop_path}` : '';
        const posterUrl = media.poster || (details.poster_path ? `https://image.tmdb.org/t/p/w500${details.poster_path}` : DEFAULT_POSTER);
        const genres = details.genres.map(g => g.name).join(', ');
        const directors = details.crew.filter(member => member.job === 'Director');
        const directorsHTML = directors.map(d => `<a href="#" class="director-link" data-person-id="${d.id}">${d.name}</a>`).join(', ');

        const rtState = getRottenTomatoesState(media.rottenTomatoes);
        const popcornState = getPopcornState(media.popcornRating);

        let ratingsHTML = '';
        if (media.imdbRating && media.imdbRating !== "N/A") { ratingsHTML += `<span class="rating-badge"><img src="${IMDB_STAR_ICON}" class="rating-icon">&nbsp;${media.imdbRating}</span>`; }
        if (rtState) { ratingsHTML += `<span class="rating-badge"><img src="${ROTTEN_TOMATOES_ICONS[rtState]}" class="rating-icon">&nbsp;${media.rottenTomatoes}</span>`; }
        if (popcornState) { ratingsHTML += `<span class="rating-badge"><img src="${POPCORN_ICONS[popcornState]}" class="rating-icon">&nbsp;${media.popcornRating}</span>`; }
        if (media.metacriticRating && media.metacriticRating !== "N/A") { ratingsHTML += `<span class="rating-badge"><img src="${METACRITIC_ICON}" class="rating-icon">&nbsp;${media.metacriticRating}</span>`; }
        if (media.letterboxdRating && media.letterboxdRating !== "N/A") { ratingsHTML += `<span class="rating-badge"><img src="${LETTERBOXD_ICON}" class="rating-icon">&nbsp;${media.letterboxdRating}</span>`; }

        const castHTML = details.cast.slice(0, 15).map(actor => `
            <div class="actor-card" data-person-id="${actor.id}">
                <img src="${actor.profile_path ? `https://image.tmdb.org/t/p/w200${actor.profile_path}` : DEFAULT_ACTOR_PHOTO}" class="actor-photo" onerror="this.src='${DEFAULT_ACTOR_PHOTO}'">
                <div class="actor-name">${actor.name}</div>
                <div class="actor-character">${actor.character}</div>
            </div>
        `).join('');

        elements.detailsModalContent.innerHTML = `
            <div class="details-backdrop" style="background-image: url(${backdropUrl})"></div>
            <div class="details-header">
                <img id="detailsModalPoster" src="${posterUrl}" onerror="this.src='${DEFAULT_POSTER}'">
                <div class="details-title-section">
                    <h2 id="detailsModalTitle">${details.title}</h2>
                    <div class="details-ratings-container">${ratingsHTML || '<span style="font-size: 0.9rem; color: var(--text-secondary);">Nessuna valutazione disponibile</span>'}</div>
                    <p id="detailsModalTagline">${details.tagline || ''}</p>
                    <div id="detailsModalMeta">
                        <span><i class="fas fa-calendar-alt"></i> ${details.release_date ? details.release_date.split('-')[0] : ''}</span>
                        <span><i class="fas fa-clock"></i> ${formatRuntime(details.runtime)}</span>
                        <span><i class="fas fa-film"></i> ${genres}</span>
                        ${directorsHTML ? `<span><i class="fas fa-video"></i> Regia: ${directorsHTML}</span>` : ''}
                    </div>
                </div>
            </div>
            <div class="details-body">
                <h3 class="details-section-title">Trama</h3>
                <p id="detailsModalOverview">${details.overview || 'Trama non disponibile.'}</p>
                <h3 class="details-section-title">Cast Principale</h3>
                <div class="cast-scroller" id="detailsModalCast">
                    ${castHTML}
                </div>
            </div>
        `;
        
        elements.detailsModalContent.querySelectorAll('.actor-card, .director-link').forEach(card => {
            card.addEventListener('click', (e) => {
                e.preventDefault();
                showActorModal(card.dataset.personId);
            });
        });
    }

    async function fetchTMDbDetails(imdbId) {
        try {
            const findRes = await fetch(`https://api.themoviedb.org/3/find/${imdbId}?api_key=${TMDB_KEY}&external_source=imdb_id&language=it-IT`);
            if (!findRes.ok) return null;
            const findData = await findRes.json();
            const tmdbMovie = findData.movie_results[0];
            if (!tmdbMovie) return null;

            return await fetchFullTMDbDetails(tmdbMovie.id);
        } catch (err) {
            console.error("Error finding TMDb movie by IMDb ID:", err);
            return null;
        }
    }

    async function fetchFullTMDbDetails(tmdbId) {
        try {
            const [detailsRes, creditsRes] = await Promise.all([
                fetch(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${TMDB_KEY}&language=it-IT&append_to_response=external_ids`),
                fetch(`https://api.themoviedb.org/3/movie/${tmdbId}/credits?api_key=${TMDB_KEY}&language=it-IT`)
            ]);
            
            if (!detailsRes.ok || !creditsRes.ok) return null;
            
            let details = await detailsRes.json();
            const credits = await creditsRes.json();
            
            if (!details.overview) { // Fallback for Italian overview
                 const enDetailsRes = await fetch(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${TMDB_KEY}&language=en-US`);
                 if(enDetailsRes.ok) {
                    const enDetails = await enDetailsRes.json();
                    details.overview = enDetails.overview;
                 }
            }
            
            return { ...details, cast: credits.cast, crew: credits.crew, imdb_id: details.external_ids.imdb_id };
        } catch(err) {
            console.error("Error fetching full TMDb details:", err);
            return null;
        }
    }

    async function fetchMDBListRatings(imdbId) {
        if (!imdbId || !MDBLIST_PROXY_URL || MDBLIST_PROXY_URL === "INCOLLA_L_URL_DEL_TUO_WORKER_QUI") return null;
        try {
            const res = await fetch(`${MDBLIST_PROXY_URL}?i=${imdbId}`);
            if (!res.ok) return null;
            const data = await res.json();
            return data.ratings || null;
        } catch (error) {
            console.error("Errore nel recupero dati da MDBList:", error);
            return null;
        }
    }


    async function showActorModal(personId) {
        elements.actorModal.style.display = 'flex';
        document.body.classList.add('modal-open');
        elements.actorModalContent.innerHTML = '<div style="text-align: center; padding: 4rem;"><i class="fas fa-spinner fa-3x loading-spinner"></i></div>';
        
        const actorDetails = await fetchTMDbActorDetails(personId);
        
        if(actorDetails) {
            populateActorModal(actorDetails);
        } else {
            elements.actorModalContent.innerHTML = '<p style="text-align: center; padding: 2rem;">Dettagli non trovati.</p>';
        }
    }
    
    async function fetchTMDbActorDetails(personId) {
        try {
            const [detailsRes, creditsRes] = await Promise.all([
                fetch(`https://api.themoviedb.org/3/person/${personId}?api_key=${TMDB_KEY}&language=it-IT`),
                fetch(`https://api.themoviedb.org/3/person/${personId}/movie_credits?api_key=${TMDB_KEY}&language=it-IT`)
            ]);
            if (!detailsRes.ok || !creditsRes.ok) return null;
            
            let details = await detailsRes.json();
            const credits = await creditsRes.json();

            if (!details.biography) {
                const enDetailsRes = await fetch(`https://api.themoviedb.org/3/person/${personId}?api_key=${TMDB_KEY}&language=en-US`);
                if (enDetailsRes.ok) {
                    const enDetails = await enDetailsRes.json();
                    details.biography = enDetails.biography;
                }
            }

            credits.cast.sort((a,b) => (b.vote_average || 0) - (a.vote_average || 0));

            return { ...details, movie_credits: credits };
        } catch(err) {
            console.error("Error fetching TMDb actor details:", err);
            return null;
        }
    }

    function populateActorModal(details) {
        const photoUrl = details.profile_path ? `https://image.tmdb.org/t/p/w500${details.profile_path}` : DEFAULT_ACTOR_PHOTO;
        const filmographyHTML = details.movie_credits.cast.slice(0, 15).map(film => {
            if (!film.poster_path) return '';
            return `
            <div class="film-card-small" data-tmdb-url="https://www.themoviedb.org/movie/${film.id}" title="${film.title}">
                <img src="https://image.tmdb.org/t/p/w200${film.poster_path}" onerror="this.src='${DEFAULT_POSTER}'">
                <div class="film-card-small-title">${film.title}</div>
            </div>`;
        }).join('');
        
        elements.actorModalContent.innerHTML = `
            <div class="actor-details-header">
                <img src="${photoUrl}" class="actor-details-photo" onerror="this.src='${DEFAULT_ACTOR_PHOTO}'">
                <div class="actor-details-info">
                    <h2>${details.name}</h2>
                    <ul>
                        <li><strong>Nascita:</strong> ${details.birthday ? new Date(details.birthday).toLocaleDateString('it-IT') : 'N/A'}</li>
                        <li><strong>Luogo:</strong> ${details.place_of_birth || 'N/A'}</li>
                    </ul>
                    ${details.imdb_id ? `<a href="https://www.imdb.com/name/${details.imdb_id}/" target="_blank" class="btn btn-imdb"><i class="fab fa-imdb"></i> Vedi su IMDb</a>` : ''}
                </div>
            </div>
            <div>
                <h3 class="details-section-title">Filmografia Selezionata</h3>
                <div class="filmography-scroller" id="filmographyScroller">
                    ${filmographyHTML}
                </div>
                <h3 class="details-section-title">Biografia</h3>
                <p>${details.biography || 'Biografia non disponibile.'}</p>
            </div>
        `;
        
        const filmographyScroller = document.getElementById('filmographyScroller');
        if(filmographyScroller) {
            filmographyScroller.scrollLeft = 0;
            filmographyScroller.querySelectorAll('.film-card-small').forEach(card => {
                card.addEventListener('click', () => {
                    window.open(card.dataset.tmdbUrl, '_blank');
                });
            });
        }
    }
    
    async function addFriend() {
        const friendId = friendIdInput.value.trim();
        if (!friendId || !currentUser) return;
        if (friendId === currentUser.uid) { showNotification("Non puoi aggiungere te stesso.", "warning"); return; }
        if (followedFriends.some(f => f.id === friendId)) { showNotification("Amico già presente in lista.", "warning"); return; }
        const friendEmailRef = db.ref(`users/${friendId}/email`);
        const snapshot = await friendEmailRef.once('value');
        if (snapshot.exists()) {
            followedFriends.push({ id: friendId, email: snapshot.val() });
            lastCheckedTimestamps[friendId] = new Date().toISOString();
            await saveSocialData();
            renderFriendsList();
            setupFriendListeners();
            showNotification("Amico aggiunto!", "success");
        } else {
            showNotification("ID Utente non trovato.", "error");
        }
    }
    
    async function removeFriend(friendId) {
        followedFriends = followedFriends.filter(f => f.id !== friendId);
        delete lastCheckedTimestamps[friendId];
        await saveSocialData();
        renderFriendsList();
        setupFriendListeners();
    }

    function renderFriendsList() {
        if (!currentUser) { friendsList.innerHTML = "<p>Devi essere loggato per usare questa funzione.</p>"; document.getElementById('myIdContainer').style.display = 'none'; return; }
        document.getElementById('myIdContainer').style.display = 'block';
        myIdInput.value = currentUser.uid;
        friendsList.innerHTML = "";
        if (followedFriends.length === 0) { friendsList.innerHTML = `<p style="text-align:center; color: var(--text-secondary);">Non stai seguendo nessun amico.</p>`; return; }
        followedFriends.forEach(friend => {
            const card = document.createElement("div"); card.className = "management-card";
            card.innerHTML = `
                <div>
                    <div>
                        <div class="friend-email">${friend.email}</div>
                        <div class="friend-id">${friend.id}</div>
                    </div>
                </div>
                <div class="management-card-actions">
                    <button class="btn visit-friend-films-btn" data-id="${friend.id}" title="Visita Libreria Film"><i class="fas fa-film"></i></button>
                    <button class="btn visit-friend-tv-btn" data-id="${friend.id}" title="Visita Libreria Serie TV"><i class="fas fa-tv"></i></button>
                    <button class="btn btn-danger remove-friend-btn" data-id="${friend.id}" title="Rimuovi Amico"><i class="fas fa-trash"></i></button>
                </div>`;
            card.querySelector('.remove-friend-btn').addEventListener('click', () => removeFriend(friend.id));
            card.querySelector('.visit-friend-films-btn').addEventListener('click', (e) => {
              const url = `${window.location.origin}${window.location.pathname.replace('serietv_tracker.html', 'index.html')}?view=${e.currentTarget.dataset.id}`;
              window.open(url, '_blank');
            });
            card.querySelector('.visit-friend-tv-btn').addEventListener('click', (e) => {
              const url = `${window.location.origin}${window.location.pathname.replace('index.html', 'serietv_tracker.html')}?view=${e.currentTarget.dataset.id}`;
              window.open(url, '_blank');
            });
            friendsList.appendChild(card);
        });
    }

    function setupEventListeners() {
      elements.mediaManagementBtn.addEventListener("click", openMediaManagementModal);
      elements.addCategoryBtn.addEventListener("click", () => addCategory(elements.newCategoryName.value));
      elements.searchTMDbBtn.addEventListener("click", searchTMDb);
      document.addEventListener("click", e => {
        if (e.target === elements.posterModal) closeModal(elements.posterModal);
        if (e.target === elements.detailsModal) closeModal(elements.detailsModal);
        if (e.target === elements.actorModal) closeModal(elements.actorModal);
        if (!e.target.closest('.notification-bell-container')) {
            elements.notificationDropdown.classList.remove('visible');
        }
      });
      elements.savePosterChange.addEventListener('click', () => {
          const selected = document.querySelector(".poster-option.selected");
          if (selected) {
              changePoster(elements.posterModal.dataset.mediaId, selected.dataset.url);
          }
          closeModal(elements.posterModal);
      });
      elements.cancelPosterChange.addEventListener('click', () => closeModal(elements.posterModal));
      elements.exportBtn.addEventListener("click", exportData);
      elements.importBtn.addEventListener("click", () => elements.importFile.click());
      elements.importFile.addEventListener("change", e => importData(e.target.files[0]));
      elements.updateExistingBtn.addEventListener("click", updateExistingData);
      elements.resetBtn.addEventListener("click", resetApp);
      elements.themeToggle.addEventListener("click", toggleTheme);
      elements.searchInput.addEventListener("input", () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(renderMedia, 300);
      });
      elements.categoryFilter.addEventListener("change", renderMedia);
      elements.sortFilter.addEventListener("change", () => {
        localStorage.setItem("mediaTrackerSortOrder", elements.sortFilter.value);
        renderMedia();
      });
      elements.shareBtn.addEventListener("click", () => {
        if (!currentUser) return showNotification("Devi essere loggato per condividere.", "warning");
        const link = `${window.location.origin}${window.location.pathname}?view=${currentUser.uid}`;
        elements.shareLinkInput.value = link;
        elements.shareModal.style.display = "flex";
        document.body.classList.add("modal-open");
      });
      elements.copyShareLinkBtn.addEventListener("click", () => {
        navigator.clipboard.writeText(elements.shareLinkInput.value);
        showNotification("Link copiato!", "success");
      });
      elements.closeShareModalBtn.addEventListener("click", () => closeModal(elements.shareModal));
      elements.closeViewBtn.addEventListener("click", () => { window.location.href = window.location.pathname; });
      elements.detailsModalClose.addEventListener('click', () => closeModal(elements.detailsModal));
      actorModalClose.addEventListener('click', () => closeModal(elements.actorModal));
      
      document.querySelectorAll('.quick-rewatch-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const count = parseInt(btn.dataset.count);
            elements.rewatchCountInput.value = count;
            updateRewatchModalButtons(count);
        });
      });
      elements.rewatchCountInput.addEventListener('input', () => {
          const count = parseInt(elements.rewatchCountInput.value);
          updateRewatchModalButtons(count);
      });
      document.querySelectorAll(".num-spinner-btn").forEach(btn => {
        btn.addEventListener("click", e => {
          const target = document.getElementById(e.currentTarget.dataset.target);
          if (target) {
            let value = parseInt(target.value) || 0;
            value += e.currentTarget.classList.contains("up") ? 1 : -1;
            const min = parseInt(target.min);
            if (!isNaN(min) && value < min) value = min;
            target.value = value;
            if (target.id === 'rewatchCountInput') {
                updateRewatchModalButtons(value);
            }
          }
        });
      });
      elements.confirmRewatchBtn.addEventListener('click', () => {
          const newCount = parseInt(elements.rewatchCountInput.value);
          if (!isNaN(newCount) && newCount >= 0) {
              markRewatch(currentRewatchMediaId, newCount);
              closeModal(elements.rewatchModal);
          } else {
              showNotification("Per favore, inserisci un numero valido (0 o superiore).", "warning");
          }
      });
      elements.cancelRewatchBtn.addEventListener('click', () => closeModal(elements.rewatchModal));
      
      elements.addFriendBtn.addEventListener('click', addFriend);
      elements.bellIcon.addEventListener('click', (e) => {
          e.stopPropagation();
          elements.notificationDropdown.classList.toggle('visible');
      });
    }

    async function showPosterModal(id) {
        const media = mediaList.find(m => m.id === id);
        if (!media || !media.imdbID) return showNotification("Nessun IMDb ID trovato per questo film.", "warning");
        elements.posterModal.dataset.mediaId = id;
        elements.posterGrid.innerHTML = '<div style="display:flex; justify-content:center; align-items:center; height:100%;"><i class="fas fa-spinner fa-2x loading-spinner"></i></div>';
        elements.posterModal.style.display = "flex";

        const currentPosterUrl = media.poster;

        fetchPosters(media.imdbID).then(posters => {
            if (posters.length === 0) {
                elements.posterGrid.innerHTML = "<p>Nessuna copertina alternativa trovata</p>";
                return;
            }
            elements.posterGrid.innerHTML = "";
            posters.forEach(poster => {
                const option = document.createElement("div");
                option.className = "poster-option";
                option.dataset.url = poster.url;

                if (poster.url === currentPosterUrl) {
                    option.innerHTML += `<div class="poster-current-indicator"><i class="fas fa-check"></i> Attuale</div>`;
                }

                const img = document.createElement("img");
                img.src = poster.url;
                img.onerror = () => img.src = DEFAULT_POSTER;
                option.appendChild(img);
                
                const lang = poster.iso_639_1 || 'N/A';
                option.innerHTML += `<div class="poster-language-badge">${lang}</div>`;

                option.addEventListener("click", () => {
                    document.querySelectorAll(".poster-option").forEach(o => o.classList.remove("selected"));
                    option.classList.add("selected");
                });
                elements.posterGrid.appendChild(option);
            });
        });
    }

    async function fetchPosters(imdbID) {
      try {
        const response = await fetch(`https://api.themoviedb.org/3/find/${imdbID}?api_key=${TMDB_KEY}&external_source=imdb_id`);
        const data = await response.json();
        const tmdbId = data.movie_results[0]?.id;
        if (!tmdbId) return [];
        const imagesResponse = await fetch(`https://api.themoviedb.org/3/movie/${tmdbId}/images?api_key=${TMDB_KEY}`);
        const imagesData = await imagesResponse.json();
        
        const langScore = (lang) => {
            if (lang === 'it') return 3;
            if (lang === 'en') return 2;
            if (lang === null) return 1;
            return 0;
        };

        return imagesData.posters
          .filter(p => ['it', 'en', null].includes(p.iso_639_1))
          .sort((a, b) => langScore(b.iso_639_1) - langScore(a.iso_639_1))
          .slice(0, 33)
          .map(p => ({ url: `https://image.tmdb.org/t/p/w500${p.file_path}`, iso_639_1: p.iso_639_1 }));
      } catch (err) {
        console.error("Error fetching posters:", err);
        return [];
      }
    }

    function changePoster(id, url) {
      const media = mediaList.find(m => m.id === id);
      if (media) {
        media.poster = url;
        saveData();
        refreshSingleMedia(id);
      }
    }

    async function updateExistingData() {
        if (isViewMode) return;
        const filmsToUpdate = mediaList.filter(m => m.imdbID && (!m.tmdbID || m.popcornRating === undefined || m.popcornRating === "N/A"));
        
        if (filmsToUpdate.length === 0) {
            return showNotification("Tutti i film sono già aggiornati.", "success");
        }
        
        document.body.classList.add('modal-open');
        elements.updateProgressModal.style.display = 'flex';
        let updatedCount = 0;

        for (let i = 0; i < filmsToUpdate.length; i++) {
            const media = filmsToUpdate[i];
            const progress = ((i + 1) / filmsToUpdate.length) * 100;
            elements.updateProgressBarFill.style.width = `${progress}%`;
            elements.updateProgressText.textContent = `Aggiornamento ${i + 1} di ${filmsToUpdate.length}: ${media.title}...`;

            try {
                if(!media.tmdbID) {
                    const findRes = await fetch(`https://api.themoviedb.org/3/find/${media.imdbID}?api_key=${TMDB_KEY}&external_source=imdb_id`);
                    const findData = await findRes.json();
                    const tmdbMovie = findData.movie_results[0];
                    if (tmdbMovie) media.tmdbID = tmdbMovie.id;
                }

                const ratings = await fetchMDBListRatings(media.imdbID);
                if(ratings) {
                    const rtRating = ratings.find(r => r.source === 'tomatoes');
                    const popcornRating = ratings.find(r => r.source === 'tomatoesaudience');
                    const letterboxdRating = ratings.find(r => r.source === 'letterboxd');
                    const metacriticRating = ratings.find(r => r.source === 'metacritic');
                    const imdbRating = ratings.find(r => r.source === 'imdb');
                    
                    if (rtRating) media.rottenTomatoes = rtRating.value;
                    if (popcornRating) media.popcornRating = popcornRating.value;
                    if (letterboxdRating) media.letterboxdRating = letterboxdRating.value;
                    if (metacriticRating) media.metacriticRating = metacriticRating.value;
                    if (imdbRating) media.imdbRating = imdbRating.value;

                    updatedCount++;
                }
                await new Promise(resolve => setTimeout(resolve, 300));
            } catch(err) {
                console.error(`Failed to update ${media.title}:`, err);
            }
        }
        
        closeModal(elements.updateProgressModal);

        if (updatedCount > 0) {
            saveData();
            renderFullUI();
            showNotification(`${updatedCount} film sono stati aggiornati con successo!`, "success");
        } else {
            showNotification("Nessun nuovo dato trovato per i film.", "warning");
        }
    }

    async function toggleFavorite(mediaId) {
        if (isViewMode) return;
        const media = mediaList.find(m => m.id === mediaId);
        if (media) {
            media.isFavorite = !media.isFavorite;
            await saveData();
            
            const cardBtn = document.querySelector(`.media-card[data-id="${mediaId}"] .favorite-btn`);
            if (cardBtn) cardBtn.classList.toggle('is-favorite', media.isFavorite);
            
            if (elements.categoryFilter.value === 'favorites') {
                renderMedia();
            }
        }
    }
  </script>
</body>
</html>
