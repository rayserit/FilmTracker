<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MediaTracker Pro</title>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ¬</text></svg>">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <style>
    :root {
      --primary: #3A86FF;
      --secondary: #00B4D8;
      --danger: #ff4444;
      --reset: #e74c3c;
      --success: #228b22;
      --warning: #ffcc00;
      --bg-color: #f5f5f5;
      --card-bg: white;
      --text-color: #333;
      --text-secondary: #666;
      --border-color: #e0e0e0;
    }

    body.dark {
      --bg-color: #1a1a1a;
      --card-bg: #2d2d2d;
      --text-color: #f5f5f5;
      --text-secondary: #aaa;
      --border-color: #444;
      --reset: #ff6b6b;
    }

    .user-select-none {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      padding: 1rem;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }

    .media-card {
      background: var(--card-bg);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      width: 180px;
      transition: all 0.3s ease;
      position: relative;
      border: 1px solid var(--border-color);
    }

    .media-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .media-card.moving {
      transform: scale(0.95);
      opacity: 0.5;
    }

    .media-poster {
      width: 100%;
      aspect-ratio: 2 / 3;
      object-fit: cover;
      object-position: center top;
      cursor: pointer;
      background-color: var(--border-color);
    }

    .media-info {
      padding: 0.75rem;
    }

    .media-title {
      font-size: 0.9rem;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-color);
    }

    .media-meta {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .watch-status-icon {
        font-size: 0.9rem;
        color: var(--primary);
    }
    
    .watchlist-status-icon {
        font-size: 0.9rem;
        color: var(--secondary);
    }

    .watch-status-icon sup {
        font-size: 0.7rem;
        font-weight: bold;
        margin-left: 1px;
    }

    .media-ratings {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.75rem;
    }
    
    .media-section {
      transition: all 0.3s ease;
    }

    .media-section.hidden {
      display: none !important;
    }

    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1.5rem 0 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--primary);
    }

    .section-title {
      color: var(--primary);
      margin: 0;
    }

    .category-count {
      background: var(--primary);
      color: white;
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-size: 0.8rem;
      margin-left: 0.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        opacity: 0.7;
    }

    body.dark .btn:disabled {
        background-color: #555;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-reset {
      background: var(--reset);
      color: white;
    }

    .stat-item {
      background: var(--card-bg);
      padding: 0.75rem;
      border-radius: 8px;
      text-align: center;
      min-width: 80px;
      border: 1px solid var(--border-color);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-open {
      overflow: hidden;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    input, select {
      width: 100%;
      padding: 0.5rem;
      margin: 0.5rem 0;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-color);
    }

    .card-move-dropdown {
        position: fixed;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        z-index: 1001;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        overflow: hidden;
    }
    .card-move-dropdown-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
        font-size: 0.9rem;
    }
    .card-move-dropdown-item:hover {
        background: var(--primary);
        color: white;
    }

    .card-actions {
      position: absolute;
      top: 10px;
      display: flex;
      gap: 0.5rem;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .card-actions-left {
        left: 10px;
    }
    .card-actions-right {
        right: 10px;
    }
    .media-card:hover .card-actions {
      opacity: 1;
    }

    .modal-open .card-actions {
      display: none !important;
    }

    .card-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      cursor: pointer;
    }

    .filter-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-box {
      flex: 1 1 auto;
      min-width: 150px;
      max-width: 300px; 
    }

    .filter-select {
      flex: 1 1 auto;
      min-width: 150px;
      max-width: 180px; 
    }

    .omdb-results-container {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.5rem;
    }

    .omdb-result-item {
      padding: 0.5rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .omdb-result-item:last-child {
      border-bottom: none;
    }

    .omdb-result-item:hover {
      background: rgba(0,0,0,0.05);
    }

    .omdb-poster-small {
      width: 50px;
      height: 75px;
      object-fit: cover;
      border-radius: 4px;
    }
    
    .category-management-modal {
      max-width: 400px;
    }

    .categories-list {
      max-height: 300px;
      overflow-y: auto;
      margin: 1rem 0;
    }

    .category-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .category-item:last-child {
      border-bottom: none;
    }

    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 1rem;
      border-radius: 8px;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .notification.error {
      background: var(--danger);
    }

    .notification.warning {
      background: var(--warning);
      color: #333;
    }
    
    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      background: var(--card-bg);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      position: absolute;
      right: 1rem;
      top: 5rem;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: none;
    }

    .auth-form.active {
      display: flex;
    }

    .auth-form input {
      margin: 0;
    }

    .auth-form-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .auth-form-buttons button {
      flex: 1;
    }

    .auth-tabs {
      display: flex;
      margin-bottom: 0.5rem;
    }

    .auth-tab {
      flex: 1;
      text-align: center;
      padding: 0.5rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }

    .auth-tab.active {
      border-bottom: 2px solid var(--primary);
      font-weight: bold;
    }

    .auth-form-container {
      display: none;
    }

    .auth-form-container.active {
      display: block;
    }

    .share-dropdown {
      position: relative;
      display: inline-block;
    }

    .share-dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 100;
      width: 300px;
    }

    .share-dropdown.active .share-dropdown-content {
      display: block;
    }

    .share-link {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .share-link input {
      flex: 1;
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      background: var(--bg-color);
      color: var(--text-color);
    }

    .share-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .view-mode-banner {
      background: var(--primary);
      color: white;
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .top-bar {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .main-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-grow: 1;
      flex-wrap: wrap;
    }
    
    .stats-container {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }

    .dropdown-toggle {
      cursor: pointer;
    }

    .number-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .number-input-wrapper input {
        padding-right: 25px;
    }

    .number-input-controls {
        position: absolute;
        right: 1px;
        top: 1px;
        bottom: 1px;
        display: flex;
        flex-direction: column;
    }

    .num-spinner-btn {
        flex: 1;
        width: 22px;
        border: none;
        background-color: var(--border-color);
        color: var(--text-color);
        cursor: pointer;
        font-size: 0.8rem;
        line-height: 1;
    }
    .num-spinner-btn:hover {
        background-color: var(--primary);
        color: white;
    }
    .num-spinner-btn.up {
        border-top-right-radius: 7px;
    }
    .num-spinner-btn.down {
        border-bottom-right-radius: 7px;
    }

    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[type=number] {
        -moz-appearance: textfield;
    }
  </style>
</head>
<body class="dark user-select-none">
  <!-- View Mode Banner -->
  <div id="viewModeBanner" class="view-mode-banner" style="display:none">
    <i class="fas fa-eye"></i>
    <span>Stai visualizzando una lista condivisa</span>
    <button id="closeViewBtn" class="btn btn-danger" style="margin-left:auto">
      <i class="fas fa-times"></i> Chiudi
    </button>
  </div>

  <!-- Top Bar -->
  <div class="top-bar">
    <div class="main-controls">
      <input type="text" id="searchInput" class="search-box" placeholder="Cerca film...">
      <select id="categoryFilter" class="filter-select">
        <option value="all">Tutte le categorie</option>
      </select>
      <select id="sortFilter" class="filter-select">
        <option value="alpha" selected>Alfabetico</option>
        <option value="added">Ultimi aggiunti</option>
        <option value="rating">Valutazione</option>
        <option value="year">Anno di uscita</option>
      </select>
      
      <button id="addMediaBtn" class="btn btn-primary">
        <i class="fas fa-plus"></i> Aggiungi Film
      </button>
      <button id="manageCategoriesBtn" class="btn btn-secondary">
        <i class="fas fa-folder"></i>
      </button>
      
      <div class="share-dropdown" id="shareDropdown">
        <button id="shareBtn" class="btn btn-secondary dropdown-toggle">
          <i class="fas fa-share-alt"></i> 
        </button>
        <div class="share-dropdown-content">
          <h3>Condivisione attiva</h3>
          <p>Chiunque abbia questo link puÃ² vedere la tua lista in tempo reale:</p>
          <div class="share-link">
            <input type="text" id="shareLink" readonly>
            <button id="copyLinkBtn" class="btn btn-primary">
              <i class="fas fa-copy"></i> Copia
            </button>
          </div>
          <div class="share-actions">
            <button id="disableShareBtn" class="btn btn-danger">
              <i class="fas fa-ban"></i> Disattiva
            </button>
          </div>
        </div>
      </div>
      
      <button id="exportBtn" class="btn btn-secondary">
        <i class="fas fa-download"></i> 
      </button>
      <input type="file" id="importFile" accept=".json" style="display: none;">
      <button id="importBtn" class="btn btn-secondary">
        <i class="fas fa-upload"></i> 
      </button>
      <button id="resetBtn" class="btn btn-reset">
        <i class="fas fa-undo"></i> 
      </button>
      <button id="themeToggle" class="btn">
        <i class="fas fa-moon"></i> 
      </button>

      <div id="userInfo" style="display:none; margin-left: auto;">
        <button id="logoutBtn" class="btn btn-danger">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
      <button id="authToggle" class="btn btn-secondary" style="margin-left: auto;">
        <i class="fas fa-user"></i> Login
      </button>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-container">
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
      <div class="stat-item">
        <div class="stat-value" id="statTotal">0</div>
        <div>Totale</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="statWatchlist">0</div>
        <div>Da Vedere</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="statWatched">0</div>
        <div>Visti</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="statRewatched">0</div>
        <div>Rewatch</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="statHours">0h 0m</div>
        <div>Tempo Totale</div>
      </div>
    </div>
    
    <div id="authForms" class="auth-form">
      <div class="auth-tabs">
        <div class="auth-tab active" data-tab="login">Login</div>
        <div class="auth-tab" data-tab="register">Registrati</div>
      </div>
      
      <div id="loginForm" class="auth-form-container active">
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <div class="auth-form-buttons">
          <button id="loginBtn" class="btn btn-primary">
            <i class="fas fa-sign-in-alt"></i> Login
          </button>
        </div>
      </div>
      
      <div id="registerForm" class="auth-form-container">
        <input type="email" id="registerEmail" placeholder="Email">
        <input type="password" id="registerPassword" placeholder="Password (min. 6 caratteri)">
        <input type="password" id="registerConfirmPassword" placeholder="Conferma Password">
        <div class="auth-form-buttons">
          <button id="registerBtn" class="btn btn-primary">
            <i class="fas fa-user-plus"></i> Registrati
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Media Sections -->
  <div id="mediaSectionsContainer"></div>

  <!-- Modals -->
  <div class="modal" id="addMediaModal">
    <div class="modal-content">
      <h2>Aggiungi Film</h2>
      <input type="text" id="mediaTitle" placeholder="Titolo" style="margin-bottom: 1rem;">

      <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1rem;">
        <button id="searchOMDbBtn" class="btn btn-secondary" style="flex-shrink: 0;">
            <i class="fas fa-search"></i> Cerca su OMDb
        </button>
        <select id="addMediaCategorySelect" class="filter-select" style="margin: 0;"></select>
      </div>
      <div id="omdbResults" class="omdb-results-container"></div>
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
        <button id="saveMediaBtn" class="btn btn-primary">Salva</button>
        <button id="cancelMediaBtn" class="btn btn-danger">Annulla</button>
      </div>
    </div>
  </div>

  <div class="modal" id="quickEditModal">
    <div class="modal-content" style="max-width: 400px;">
        <h2 id="quickEditTitle">Modifica Rapida</h2>
        <div id="quickEditButtonsContainer" style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
            <button class="btn" id="quickEditWatchlistBtn" style="width: 100%;"></button>
            <button class="btn" id="quickEditWatchedBtn" style="width: 100%;"></button>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <label for="quickEditRewatchCount">Rewatch:</label>
            <div class="number-input-wrapper" style="width: 100px;">
              <input type="number" id="quickEditRewatchCount" min="0" value="0" style="margin: 0; text-align: center;">
              <div class="number-input-controls">
                <button class="num-spinner-btn up" data-target="quickEditRewatchCount">+</button>
                <button class="num-spinner-btn down" data-target="quickEditRewatchCount">-</button>
              </div>
            </div>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
            <button id="confirmQuickEditBtn" class="btn btn-primary">Salva</button>
            <button id="cancelQuickEditBtn" class="btn btn-danger">Annulla</button>
        </div>
    </div>
  </div>

  <div class="modal" id="categoryManagementModal">
    <div class="modal-content category-management-modal">
      <h2>Gestione Categorie</h2>
      <div class="filter-row">
        <input type="text" id="newCategoryName" placeholder="Nome categoria">
        <button id="addCategoryBtn" class="btn btn-primary">
          <i class="fas fa-plus"></i> Aggiungi
        </button>
      </div>
      <div class="categories-list" id="categoriesList"></div>
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
        <button id="closeCategoryManagementBtn" class="btn btn-danger">Chiudi</button>
      </div>
    </div>
  </div>
  
  <!-- Notification -->
  <div id="notification" class="notification">
    <span id="notificationText"></span>
  </div>

  <script>
    const OMDb_API_KEY = "2526ef70";
    const DEFAULT_POSTER = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiB2aWV3Qm94PSIwIDAgMzAwIDQ1MCI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZ2h0PSI0NTAiIGZpbGw9IiNkZGQiLz48dGV4dCB4PSIxNTAiIHk9IjIyNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNjY2Ij5OZXNzYSBpbWFnaW5lPC90ZXh0Pjwvc3ZnPg==";
    const DEFAULT_CATEGORIES = ["watchlist", "watched"];
    let mediaList = [];
    let categories = [...DEFAULT_CATEGORIES];
    let currentQuickEditMedia = null;
    let currentOMDbSelection = null;
    let currentUser = null;
    let isViewMode = false;
    let debounceTimeout;
    let lazyLoadObserver;

    const firebaseConfig = {
      apiKey: "AIzaSyDm946nISfZs8ugkuYPraNTzFhvgQmnMUk",
      authDomain: "gametrackerdb.firebaseapp.com",
      databaseURL: "https://gametrackerdb-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gametrackerdb",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    const elements = {
      authForms: document.getElementById("authForms"), authToggle: document.getElementById("authToggle"), userInfo: document.getElementById("userInfo"), loginBtn: document.getElementById("loginBtn"), loginEmail: document.getElementById("loginEmail"), loginPassword: document.getElementById("loginPassword"), registerBtn: document.getElementById("registerBtn"), registerEmail: document.getElementById("registerEmail"), registerPassword: document.getElementById("registerPassword"), registerConfirmPassword: document.getElementById("registerConfirmPassword"), logoutBtn: document.getElementById("logoutBtn"), loginForm: document.getElementById("loginForm"), registerForm: document.getElementById("registerForm"), addMediaBtn: document.getElementById("addMediaBtn"), manageCategoriesBtn: document.getElementById("manageCategoriesBtn"), shareBtn: document.getElementById("shareBtn"), shareDropdown: document.getElementById("shareDropdown"), exportBtn: document.getElementById("exportBtn"), importBtn: document.getElementById("importBtn"), importFile: document.getElementById("importFile"), resetBtn: document.getElementById("resetBtn"), themeToggle: document.getElementById("themeToggle"), searchInput: document.getElementById("searchInput"), categoryFilter: document.getElementById("categoryFilter"), sortFilter: document.getElementById("sortFilter"), statTotal: document.getElementById("statTotal"), statWatchlist: document.getElementById("statWatchlist"), statWatched: document.getElementById("statWatched"), statRewatched: document.getElementById("statRewatched"), statHours: document.getElementById("statHours"), mediaSectionsContainer: document.getElementById("mediaSectionsContainer"), addMediaModal: document.getElementById("addMediaModal"), mediaTitle: document.getElementById("mediaTitle"), searchOMDbBtn: document.getElementById("searchOMDbBtn"), omdbResults: document.getElementById("omdbResults"), saveMediaBtn: document.getElementById("saveMediaBtn"), cancelMediaBtn: document.getElementById("cancelMediaBtn"), addMediaCategorySelect: document.getElementById("addMediaCategorySelect"), categoryManagementModal: document.getElementById("categoryManagementModal"), newCategoryName: document.getElementById("newCategoryName"), addCategoryBtn: document.getElementById("addCategoryBtn"), categoriesList: document.getElementById("categoriesList"), closeCategoryManagementBtn: document.getElementById("closeCategoryManagementBtn"), quickEditModal: document.getElementById("quickEditModal"), quickEditTitle: document.getElementById("quickEditTitle"), quickEditWatchedBtn: document.getElementById("quickEditWatchedBtn"), quickEditWatchlistBtn: document.getElementById("quickEditWatchlistBtn"), quickEditRewatchCount: document.getElementById("quickEditRewatchCount"), confirmQuickEditBtn: document.getElementById("confirmQuickEditBtn"), cancelQuickEditBtn: document.getElementById("cancelQuickEditBtn"), notification: document.getElementById("notification"), notificationText: document.getElementById("notificationText"), shareLink: document.getElementById("shareLink"), copyLinkBtn: document.getElementById("copyLinkBtn"), disableShareBtn: document.getElementById("disableShareBtn"), viewModeBanner: document.getElementById("viewModeBanner"), closeViewBtn: document.getElementById("closeViewBtn")
    };
    
    document.addEventListener("DOMContentLoaded", init);

    function init() {
      setupAuthListeners();
      setupEventListeners();
      checkSharedView();
      loadTheme();
      loadSortOrder();
    }

    function setupAuthListeners(){elements.authToggle.addEventListener("click",e=>{e.stopPropagation(),elements.authForms.classList.toggle("active")}),document.addEventListener("click",e=>{elements.authForms.contains(e.target)||e.target.closest("#authToggle")||elements.authForms.classList.remove("active")}),document.querySelectorAll(".auth-tab").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".auth-tab").forEach(e=>e.classList.remove("active")),e.classList.add("active"),document.querySelectorAll(".auth-form-container").forEach(t=>t.classList.remove("active")),document.getElementById(`${e.dataset.tab}Form`).classList.add("active")})}),elements.loginBtn.addEventListener("click",()=>{const e=elements.loginEmail.value,t=elements.loginPassword.value;e&&t?firebase.auth().signInWithEmailAndPassword(e,t).then(()=>{showNotification("Login effettuato","success"),elements.authForms.classList.remove("active")}).catch(e=>showNotification(getAuthErrorMessage(e),"error")):showNotification("Inserisci email e password","warning")}),elements.registerBtn.addEventListener("click",()=>{const e=elements.registerEmail.value,t=elements.registerPassword.value,a=elements.registerConfirmPassword.value;e&&t&&a?t!==a?showNotification("Le password non corrispondono","warning"):t.length<6?showNotification("La password deve avere almeno 6 caratteri","warning"):firebase.auth().createUserWithEmailAndPassword(e,t).then(()=>{showNotification("Registrazione completata!","success"),elements.authForms.classList.remove("active")}).catch(e=>showNotification(getAuthErrorMessage(e),"error")):showNotification("Compila tutti i campi","warning")}),elements.logoutBtn.addEventListener("click",()=>firebase.auth().signOut()),firebase.auth().onAuthStateChanged(e=>{if(checkSharedView()) return; currentUser=e,updateAuthUI(),e?(loadData(),checkActiveShare()):loadLocalData()})}
    function getAuthErrorMessage(e){switch(e.code){case"auth/email-already-in-use":return"Email giÃ  registrata";case"auth/invalid-email":return"Email non valida";case"auth/weak-password":return"Password troppo debole";case"auth/user-not-found":return"Utente non trovato";case"auth/wrong-password":return"Password errata";default:return"Errore: "+e.message}}
    function updateAuthUI() {
        if (currentUser) {
            elements.userInfo.style.display = 'flex';
            elements.authToggle.style.display = 'none';
            document.querySelectorAll('.btn').forEach(btn => btn.disabled = false);
        } else {
            elements.userInfo.style.display = 'none';
            elements.authToggle.style.display = 'block';
            document.querySelectorAll('#addMediaBtn, #manageCategoriesBtn, #shareBtn').forEach(btn => {
                btn.disabled = true;
            });
            document.querySelectorAll('#exportBtn, #importBtn, #resetBtn').forEach(btn => {
                btn.disabled = false;
            });
        }
    }
    function loadData(){if(!currentUser)return;database.ref(`users/${currentUser.uid}/mediaTracker`).on("value",e=>{let t=e.val()||{};mediaList=t.mediaList?t.mediaList.map(e=>({...{isCountedAsWatched:!1,isCountedAsWatchlist:!1,rewatchCount:0},...e})):[],categories=t.categories||[...DEFAULT_CATEGORIES],renderFullUI()})}
    function loadLocalData(){try{let e=JSON.parse(localStorage.getItem("mediaList"))||[];mediaList=e.map(e=>({...{isCountedAsWatched:!1,isCountedAsWatchlist:!1,rewatchCount:0},...e})),categories=JSON.parse(localStorage.getItem("categories"))||[...DEFAULT_CATEGORIES],renderFullUI(),updateStats()}catch(e){console.error("Error loading local data:",e)}}
    function saveData(){currentUser?database.ref(`users/${currentUser.uid}/mediaTracker`).set({mediaList,categories,activeShare:activeShareId||null}):(localStorage.setItem("mediaList",JSON.stringify(mediaList)),localStorage.setItem("categories",JSON.stringify(categories)))}
    function saveToLocal(){try{localStorage.setItem("mediaList",JSON.stringify(mediaList)),localStorage.setItem("categories",JSON.stringify(categories))}catch(e){console.error("Error saving locally:",e)}}
    function checkSharedView() {
        const urlParams = new URLSearchParams(window.location.search);
        const uid = urlParams.get('uid');
        const shareId = urlParams.get('share');
        if (uid && shareId) {
            isViewMode = true;
            database.ref(`users/${uid}/mediaTracker/activeShare`).once('value').then(snap => {
                const data = snap.val();
                if (data && data.shareId === shareId && data.expiresAt > Date.now()) {
                    Promise.all([
                        database.ref(`users/${uid}/mediaTracker/mediaList`).once('value'),
                        database.ref(`users/${uid}/mediaTracker/categories`).once('value')
                    ]).then(([mediaSnap, categoriesSnap]) => {
                        let remoteMediaList = mediaSnap.val() || [];
                        mediaList = remoteMediaList.map(media => ({...{isCountedAsWatched: false, isCountedAsWatchlist: false, rewatchCount: 0}, ...media}));
                        categories = categoriesSnap.val() || [...DEFAULT_CATEGORIES];
                        renderFullUI();
                        updateStats();
                        enableViewMode(uid);
                    });
                } else {
                    showNotification("Link non valido o scaduto", "error");
                    setTimeout(() => { window.location.href = window.location.pathname; }, 2000);
                }
            }).catch(() => showNotification("Errore nel caricamento della libreria condivisa", "error"));
            return true;
        }
        return false;
    }
    function activateSharing(){if(!currentUser)return;const e=generateId(),t=Date.now()+6048e5,a={shareId:e,expiresAt:t};database.ref(`users/${currentUser.uid}/mediaTracker/activeShare`).set(a).then(()=>{activeShareId=a,updateShareLink(e),showNotification("Condivisione attivata (valida 7 giorni)","success")}).catch(e=>showNotification("Errore nell'attivazione della condivisione","error"))}
    function enableViewMode(e){isViewMode=!0,document.querySelector(".main-controls").style.display="none",elements.viewModeBanner.style.display="flex",database.ref(`users/${e}/mediaTracker/mediaList`).on("value",e=>{mediaList=e.val()||[],renderMedia(),updateStats()})}
    function closeViewMode(){window.location.href=window.location.pathname}
    function checkActiveShare(){currentUser&&database.ref(`users/${currentUser.uid}/mediaTracker/activeShare`).once("value").then(e=>{const t=e.val();t&&t.shareId&&(activeShareId=t,updateShareLink(t.shareId))})}
    function updateShareLink(e){if(e){const t=`${window.location.origin}${window.location.pathname}?uid=${currentUser.uid}&share=${e}`;elements.shareLink.value=t,elements.shareDropdown.classList.add("active")}}
    function deactivateSharing(){currentUser&&(activeShareId=null,database.ref(`users/${currentUser.uid}/mediaTracker/activeShare`).remove().then(()=>{elements.shareDropdown.classList.remove("active"),showNotification("Condivisione disattivata","success")}).catch(e=>showNotification("Errore nella disattivazione","error")))}
    function generateId(){return Math.random().toString(36).substring(2,15)}

    // (Il resto delle funzioni JS Ã¨ qui sotto, completo)
  </script>
</body>
</html>
