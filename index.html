
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Film Tracker</title>
  
  <link rel="icon" href="https://www.svgrepo.com/show/164284/movie-clapper-open.svg" type="image/svg+xml">
  
  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <style>
    :root {
      --primary: #3A86FF;
      --secondary: #00B4D8;
      --danger: #ff4444;
      --reset: #e74c3c;
      --success: #228b22;
      --warning: #ffbe0b;
      --bg-color: #f4f7fa;
      --card-bg: white;
      --text-color: #1a1a1a;
      --text-secondary: #666;
      --border-color: #e0e0e0;
      --section-tint: rgba(58, 134, 255, 0.05);
    }

    body.dark {
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-color: #f5f5f5;
      --text-secondary: #aaa;
      --border-color: #333;
      --section-tint: rgba(58, 134, 255, 0.08);
    }

    html {
      scroll-behavior: smooth;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-spinner {
      animation: spin 1s linear infinite;
    }

    .user-select-none {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }
    
    /* App Loader */
    #appLoader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg-color);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        transition: opacity 0.3s;
    }
    #appLoader i {
        font-size: 3rem;
        color: var(--primary);
    }

    /* Header & Controls */
    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .top-bar-left {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }
    .top-bar-left h1 {
        margin: 0;
        font-size: 1.75rem;
        letter-spacing: -1px;
        color: var(--primary);
    }
    .top-bar-right {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
    }
    .search-box { max-width: 300px; }
    .filter-select { max-width: 180px; }

    /* Stats Panel */
    .stats-panel {
        background-color: var(--section-tint);
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 2rem;
    }
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 1rem;
    }
    .stat-item {
      background: var(--card-bg);
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      border: 1px solid var(--border-color);
      transition: background 0.2s;
    }
    .stat-item:hover {
        background: rgba(58, 134, 255, 0.1);
    }
    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary);
    }
    .stat-label {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }

    /* Cards */
    .media-card {
      background: var(--card-bg);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      width: 180px;
      transition: all 0.2s ease-out;
      position: relative;
      border: 1px solid var(--border-color);
      animation: fadeIn 0.5s ease-out both;
    }

    .media-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }
    body.dark .media-card:hover {
        box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }
    .media-card.is-stat-contributor {
        border-top: 2px dashed var(--primary);
    }
    .media-card.is-duplicate {
        opacity: 0.65;
    }


    .poster-container {
        position: relative;
    }
    .poster-container::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 50%;
        background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        pointer-events: none;
    }

    .media-poster {
      width: 100%;
      aspect-ratio: 2 / 3;
      object-fit: cover;
      object-position: center top;
      background-color: var(--border-color);
      display: block;
    }

    .media-info {
      padding: 0.75rem;
    }

    .media-title {
      font-size: 0.9rem;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-color);
      font-weight: 600;
      letter-spacing: -0.25px;
    }
    
    .media-meta {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .watch-status-icon sup {
        font-size: 0.7rem;
        font-weight: bold;
        margin-left: 1px;
    }

    .media-ratings {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.75rem;
    }
    .rating-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      background: rgba(0, 0, 0, 0.1);
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.8rem;
    }
    body.dark .rating-badge { background: rgba(255, 255, 255, 0.1); }
    .rating-icon { width: 16px; height: 16px; object-fit: contain; }
    
    /* Sections */
    .media-section {
      background: var(--section-tint);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: opacity 0.4s, transform 0.4s;
    }
     .media-section.hidden {
      opacity: 0;
      transform: scale(0.98);
      height: 0;
      overflow: hidden;
      margin: 0;
      padding: 0;
      pointer-events: none;
    }

    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1.5rem;
      margin-top: 1rem;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 0 0 1rem 0;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-color);
      position: relative;
    }
    .section-header::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 100px;
        height: 2px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    .section-title {
      color: var(--text-color);
      margin: 0;
      font-size: 1.25rem;
      letter-spacing: -0.5px;
      font-weight: 700;
    }
    
    .btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-sizing: border-box;
      height: 38px;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: var(--secondary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-reset { background: var(--reset); color: white; }
    .btn-warning { background: var(--warning); color: #1a1a1a; }

    /* Modals, Forms, etc. */
    .modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); display: none;
      justify-content: center; align-items: center; z-index: 1000;
    }
    .modal-open { overflow: hidden; }
    .modal-content {
      background: var(--card-bg); border-radius: 12px;
      padding: 1.5rem; width: 90%; max-width: 800px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    
    input, select {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 8px; background: var(--bg-color);
        color: var(--text-color); font-size: 1rem;
        box-sizing: border-box; margin: 0; height: 38px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(58, 134, 255, 0.2);
    }

    .omdb-results-container {
      max-height: 250px; overflow-y: auto; border: 1px solid var(--border-color);
      border-radius: 8px; padding: 0.5rem; margin-top: 1rem;
    }
    .omdb-result-item:hover { background: rgba(0,0,0,0.05); }

    /* Action Buttons on Card Hover */
    .card-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      opacity: 0;
      transform: translateX(10px);
      transition: opacity 0.2s, transform 0.2s;
    }
    .media-card:hover .card-actions {
      opacity: 1;
      transform: translateX(0);
    }
    .card-btn {
      width: 32px; height: 32px; border-radius: 50%; display: flex;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,0.7); color: white; border: none;
      cursor: pointer; font-size: 0.8rem;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
        .top-bar { flex-direction: column; align-items: stretch; }
        .top-bar-right { justify-content: flex-start; }
    }
    @media (max-width: 768px) {
        body { padding: 0.5rem; }
        .top-bar { flex-direction: column; align-items: stretch; }
        .media-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
    }
    
    /* Context Menu */
    .context-menu {
        position: fixed; background: var(--card-bg); border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1001;
        min-width: 240px; padding: 0.5rem 0; border: 1px solid var(--border-color);
        opacity: 0; transform: translateY(-10px);
        transition: opacity 0.15s, transform 0.15s;
    }
    .context-menu.visible { opacity: 1; transform: translateY(0); }
    .context-menu-item {
        padding: 0.75rem 1rem; cursor: pointer; display: flex;
        align-items: center; gap: 0.75rem; font-size: 0.9rem;
    }
    .context-menu-item i { width: 18px; text-align: center; }
    .context-menu-item:hover { background: var(--primary); color: white; }
    .context-menu-divider { height: 1px; background: var(--border-color); margin: 0.25rem 0; }
    
    .empty-state {
      text-align: center; padding: 3rem 1rem; color: var(--text-secondary);
      border: 2px dashed var(--border-color); border-radius: 8px;
      margin-top: 1rem;
    }
    .empty-state > i {
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }
    .add-film-from-empty {
        margin-top: 1rem;
        width: auto;
        white-space: nowrap;
    }
    
    #confirmModal .modal-content { max-width: 400px; }
    #confirmModalBody { margin: 1rem 0; }
    #confirmModalButtons { display: flex; justify-content: flex-end; gap: 0.5rem; }

    /* Auth Forms */
    .auth-container {
        position: relative;
    }
    .auth-form {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      width: 300px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      z-index: 1001;
      display: none;
    }
    .auth-form.active { display: block; }
    .auth-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; }
    .auth-tab {
        padding: 0.75rem 1rem; cursor: pointer; font-weight: 600;
        color: var(--text-secondary); border-bottom: 2px solid transparent;
    }
    .auth-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .auth-form-container { display: none; }
    .auth-form-container.active { display: block; }
    .auth-form-container input { width: 100%; margin-bottom: 1rem; }
    .auth-form-buttons { display: flex; justify-content: flex-end; margin-top: 1rem; }

    /* Notification */
    .notification-bell-container {
        position: relative;
    }
    .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: var(--danger);
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 0.7rem;
        font-weight: 700;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 2px solid var(--bg-color);
        transform: scale(0);
        transition: transform 0.2s ease-out;
    }
    .notification-badge.visible {
        transform: scale(1);
    }
    .notification-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: var(--card-bg);
        border-radius: 12px;
        width: 320px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        z-index: 1001;
        display: none;
        padding: 0.5rem 0;
        border: 1px solid var(--border-color);
    }
    .notification-dropdown.visible { display: block; }
    .notification-item {
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
    }
    .notification-item:hover {
        background-color: var(--section-tint);
    }
    .notification-item i {
        color: var(--primary);
    }
    .no-notifications {
        padding: 1rem;
        text-align: center;
        color: var(--text-secondary);
    }
    .notification {
      position: fixed; bottom: 20px; right: 20px;
      padding: 1rem 1.5rem; border-radius: 8px; background: var(--card-bg);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1002; display: none;
    }
    .notification.success { border-left: 4px solid var(--success); }
    .notification.error { border-left: 4px solid var(--danger); }
    .notification.warning { border-left: 4px solid var(--warning); }

    /* Modal fixes */
    .modal-footer { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }
    .management-tabs {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 1.5rem;
    }

    .tab-btn {
        padding: 0.75rem 1.5rem; background: transparent; border: none;
        cursor: pointer; font-weight: 600; color: var(--text-secondary);
        border-bottom: 2px solid transparent; transition: all 0.2s;
        display: flex; align-items: center; gap: 0.5rem;
    }

    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-btn:hover:not(.active) { color: var(--text-color); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .add-media-form { display: flex; flex-direction: column; gap: 1rem; }
    .form-row { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
    .form-row input, .form-row select { flex: 1; min-width: 200px; }
    .form-row .btn { flex-shrink: 0; }

    /* Category & Friend management */
    .management-section {
        margin-top: 1rem;
    }
    .management-form { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
    .management-form input { flex: 1; }
    .management-list { max-height: 300px; overflow-y: auto; }
    .management-card {
      display: flex; align-items: center; padding: 0.75rem;
      border-radius: 8px; background: var(--bg-color); margin-bottom: 0.5rem;
    }
    .management-card > div { flex: 1; }
    .management-card-actions { display: flex; gap: 0.25rem; }
    .management-card-actions .btn { padding: 0.5rem; height: auto; }
    .category-dot {
      width: 16px; height: 16px; border-radius: 50%;
      margin-right: 0.75rem; flex-shrink: 0;
    }
    .category-dot-watchlist { background: #00B4D8; }
    .category-dot-watched { background: #228b22; }
    .category-dot-0 { background: #3A86FF; } .category-dot-1 { background: #FF006E; }
    .category-dot-2 { background: #8338EC; } .category-dot-3 { background: #FFBE0B; }
    .category-dot-4 { background: #FB5607; } .category-dot-5 { background: #00B4D8; }
    .category-name { font-weight: 600; }
    .category-item-count { font-size: 0.8rem; color: var(--text-secondary); }
    .friend-email { font-weight: 600; }
    .friend-id { font-size: 0.8rem; color: var(--text-secondary); }


    /* Poster modal */
    .poster-modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9); display: none; justify-content: center;
      align-items: center; z-index: 1000; padding: 2rem;
    }
    .poster-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem; max-height: 80vh; overflow-y: auto; width: 100%;
    }
    .poster-option {
      cursor: pointer; transition: transform 0.2s; border: 2px solid transparent;
      border-radius: 4px;
    }
    .poster-option:hover { transform: scale(1.05); }
    .poster-option.selected { border-color: var(--primary); }
    .poster-option img { width: 100%; height: auto; border-radius: 4px; }
    
    /* Rewatch Modal */
    #rewatchModal .modal-content { max-width: 450px; text-align: center; }
    #rewatchModalTitle { margin-top: 0; }
    #rewatchQuickButtons { display: flex; gap: 0.5rem; justify-content: center; margin: 1.5rem 0; }
    .quick-rewatch-btn {
        padding: 0;
        width: 45px;
        height: 45px;
        justify-content: center;
    }
    .quick-rewatch-btn.active { background: var(--primary); color: white; }
    .custom-rewatch-container { display: flex; align-items: center; justify-content: center; gap: 1rem; }

    /* Number input controls */
    .number-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        height: 38px;
    }
    .number-input-wrapper input {
        border: none; text-align: center; flex: 1;
        width: 100%; padding-right: 25px;
        background: var(--card-bg);
        -moz-appearance: textfield;
    }
    .number-input-wrapper input::-webkit-outer-spin-button,
    .number-input-wrapper input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .number-input-controls {
        position: absolute;
        right: 1px; top: 1px; bottom: 1px;
        display: flex;
        flex-direction: column;
        width: 24px;
    }
    .num-spinner-btn {
        flex: 1; width: 100%; border: none;
        background-color: var(--bg-color);
        color: var(--text-color);
        cursor: pointer; font-size: 0.8rem; line-height: 1;
        padding: 0; height: 50%;
    }
    .num-spinner-btn:hover { background-color: var(--primary); color: white; }
    .num-spinner-btn.up { border-top-right-radius: 7px; }
    .num-spinner-btn.down { border-bottom-right-radius: 7px; }


    /* OMDb results */
    .omdb-result-item {
      display: flex; align-items: center; padding: 0.5rem;
      cursor: pointer; border-radius: 4px; margin-bottom: 0.25rem;
    }
    .omdb-result-item:hover { background: rgba(0,0,0,0.05); }
    .omdb-poster-small {
      width: 40px; height: 60px; object-fit: cover;
      margin-right: 0.75rem; border-radius: 4px;
    }

    /* View mode banner */
    .view-mode-banner {
      display: none; align-items: center; background: var(--primary); color: white;
      padding: 0.75rem 1.5rem; margin-bottom: 1.5rem; border-radius: 8px;
    }
    .view-mode-banner i { margin-right: 0.75rem; }

    .btn i.fa-plus {
        position: relative;
        top: -1px;
    }

    /* Migration Progress Bar */
    #migrationProgressContainer {
        display: none;
        padding: 1rem;
    }
    .progress-bar-container {
        width: 100%;
        height: 12px;
        background-color: var(--border-color);
        border-radius: 6px;
        overflow: hidden;
    }
    .progress-bar {
        width: 0%;
        height: 100%;
        background-color: var(--primary);
        border-radius: 6px;
        transition: width 0.3s ease-out;
    }
    #migrationStatusText {
        margin-top: 0.5rem;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
  </style>
</head>
<body class="dark user-select-none">
  
  <div id="appLoader">
      <i class="fas fa-spinner loading-spinner"></i>
  </div>
  
  <div id="viewModeBanner" class="view-mode-banner" style="display:none">
    <i class="fas fa-eye"></i>
    <span id="viewModeUserEmail">Stai visualizzando una libreria condivisa</span>
    <button id="closeViewBtn" class="btn btn-danger" style="margin-left:auto">
      <i class="fas fa-times"></i> Esci
    </button>
  </div>

  <div class="top-bar">
    <div class="top-bar-left">
      <h1><i class="fas fa-film"></i> Film Tracker</h1>
      <input type="text" id="searchInput" class="search-box" placeholder="Cerca film...">
      <select id="categoryFilter" class="filter-select">
        <option value="all">Tutte le categorie</option>
      </select>
      <select id="sortFilter" class="filter-select">
        <option value="saga-alpha" selected>Saga / Alfabetico</option>
        <option value="alpha">Solo Alfabetico</option>
        <option value="added">Ultimi aggiunti</option>
        <option value="rating">Valutazione</option>
        <option value="year">Anno di uscita</option>
      </select>
    </div>
    <div class="top-bar-right">
        <div class="notification-bell-container" id="notificationBellContainer" style="display: none;">
            <button id="bellIcon" class="btn btn-secondary" title="Notifiche"><i class="fas fa-bell"></i></button>
            <div id="notificationBadge" class="notification-badge">0</div>
            <div id="notificationDropdown" class="notification-dropdown"></div>
        </div>
        <button id="mediaManagementBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Gestione</button>
        <button id="shareBtn" class="btn btn-secondary" title="Condividi Libreria"><i class="fas fa-share-alt"></i></button>
        <button id="exportBtn" class="btn btn-secondary" title="Esporta Dati (.json)"><i class="fas fa-download"></i></button>
        <input type="file" id="importFile" accept=".json" style="display: none;">
        <button id="importBtn" class="btn btn-secondary" title="Importa Dati (.json)"><i class="fas fa-upload"></i></button>
        <button id="resetBtn" class="btn btn-secondary" title="Resetta Applicazione"><i class="fas fa-undo"></i></button>
        <button id="themeToggle" class="btn btn-secondary" title="Cambia Tema"><i class="fas fa-moon"></i></button>
        <div id="userInfo" style="display:none;"><button id="logoutBtn" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> Logout</button></div>
        <div class="auth-container">
            <button id="authToggle" class="btn btn-secondary"><i class="fas fa-user"></i> Login</button>
            <div id="authForms" class="auth-form">
              <div class="auth-tabs"><div class="auth-tab active" data-tab="login">Login</div><div class="auth-tab" data-tab="register">Registrati</div></div>
              <div id="loginForm" class="auth-form-container active"><input type="email" id="loginEmail" placeholder="Email"><input type="password" id="loginPassword" placeholder="Password"><div class="auth-form-buttons"><button id="loginBtn" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Login</button></div></div>
              <div id="registerForm" class="auth-form-container"><input type="email" id="registerEmail" placeholder="Email"><input type="password" id="registerPassword" placeholder="Password (min. 6 caratteri)"><input type="password" id="registerConfirmPassword" placeholder="Conferma Password"><div class="auth-form-buttons"><button id="registerBtn" class="btn btn-primary"><i class="fas fa-user-plus"></i> Registrati</button></div></div>
            </div>
        </div>
    </div>
  </div>

  <div class="stats-panel">
      <div class="stats-container">
        <div class="stat-item"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Totale</div></div>
        <div class="stat-item"><div class="stat-value" id="statWatchlist">0</div><div class="stat-label">Da Vedere</div></div>
        <div class="stat-item"><div class="stat-value" id="statWatched">0</div><div class="stat-label">Visti</div></div>
        <div class="stat-item"><div class="stat-value" id="statRewatched">0</div><div class="stat-label">Rewatch</div></div>
        <div class="stat-item"><div class="stat-value" id="statHours">0h 0m</div><div class="stat-label">Tempo Totale</div></div>
      </div>
  </div>

  <div id="mediaSectionsContainer"></div>
  
  <!-- MODALS START -->
  <div class="modal" id="mediaManagementModal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="media-management-container">
        <div class="management-tabs">
          <button class="tab-btn active" data-tab="add-media"><i class="fas fa-film"></i> Aggiungi Film</button>
          <button class="tab-btn" data-tab="manage-categories"><i class="fas fa-clapperboard"></i> Gestisci Categorie</button>
          <button class="tab-btn" data-tab="manage-friends"><i class="fas fa-user-friends"></i> Amici</button>
        </div>
        <div class="tab-content active" id="add-media-tab">
          <div class="add-media-form">
            <div class="form-row">
              <input type="text" id="mediaTitle" placeholder="Titolo film" class="modern-input">
              <select id="addMediaCategorySelect" class="modern-select"></select>
              <button id="searchOMDbBtn" class="btn btn-secondary"><i class="fas fa-search"></i> Cerca</button>
            </div>
            <div id="omdbResults" class="omdb-results-container"></div>
          </div>
        </div>
        <div class="tab-content" id="manage-categories-tab">
          <div style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; text-align: center; margin-bottom:1.5rem;">
            <h4>Aggiorna Dati Esistenti</h4>
            <p style="font-size: 0.9rem; color: var(--text-secondary);">
              Usa questa funzione per scaricare le informazioni su saghe e date di uscita per i film già presenti nella tua libreria.
            </p>
            <button id="migrateSagaDataBtn" class="btn btn-warning">
              <i class="fas fa-database"></i> Avvia Aggiornamento Dati
            </button>
            <div id="migrationProgressContainer">
                <div class="progress-bar-container">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
                <div id="migrationStatusText"></div>
            </div>
          </div>
          <div class="management-section">
            <div class="management-form">
              <input type="text" id="newCategoryName" placeholder="Nuova categoria">
              <button id="addCategoryBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Aggiungi</button>
            </div>
            <div class="management-list" id="categoriesList"></div>
          </div>
        </div>
        <div class="tab-content" id="manage-friends-tab">
            <div class="management-section">
                <div class="management-form">
                    <input type="text" id="friendIdInput" placeholder="Incolla l'ID di un amico">
                    <button id="addFriendBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Aggiungi</button>
                </div>
                <div class="management-list" id="friendsList"></div>
            </div>
        </div>
        <div class="modal-footer">
          <button id="saveMediaBtn" class="btn btn-primary"><i class="fas fa-save"></i> Salva Film</button>
          <button id="closeManagementModal" class="btn btn-danger"><i class="fas fa-times"></i> Chiudi</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="rewatchModal">
    <div class="modal-content">
        <h2 id="rewatchModalTitle">Modifica Rewatch</h2>
        <p>Specifica il numero di volte che hai rivisto il film (0 = visto una sola volta).</p>
        <div id="rewatchQuickButtons">
            <button class="btn btn-secondary quick-rewatch-btn" data-count="0">0</button>
            <button class="btn btn-secondary quick-rewatch-btn" data-count="1">1</button>
            <button class="btn btn-secondary quick-rewatch-btn" data-count="2">2</button>
            <button class="btn btn-secondary quick-rewatch-btn" data-count="3">3</button>
            <button class="btn btn-secondary quick-rewatch-btn" data-count="4">4</button>
            <button class="btn btn-secondary quick-rewatch-btn" data-count="5">5</button>
        </div>
        <div class="custom-rewatch-container">
            <label for="rewatchCountInput">Numero custom:</label>
            <div class="number-input-wrapper" style="width: 120px;">
                <input type="number" id="rewatchCountInput" min="0" value="0">
                <div class="number-input-controls">
                    <button class="num-spinner-btn up" data-target="rewatchCountInput">+</button>
                    <button class="num-spinner-btn down" data-target="rewatchCountInput">-</button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="cancelRewatchBtn" class="btn btn-danger">Annulla</button>
            <button id="confirmRewatchBtn" class="btn btn-primary">Salva</button>
        </div>
    </div>
  </div>

  <div class="modal" id="shareModal"><div class="modal-content" style="max-width: 450px;"><h2>Condividi la tua libreria</h2><p>Chiunque abbia questo link potrà vedere la tua lista in tempo reale (sola lettura).</p><input type="text" id="shareLinkInput" class="share-link-input" readonly><div style="display: flex; gap: 0.5rem; margin-top: 1rem;"><button id="copyShareLinkBtn" class="btn btn-primary">Copia Link</button><button id="closeShareModalBtn" class="btn btn-danger">Chiudi</button></div></div></div>
  <div id="notification" class="notification"><span id="notificationText"></span></div>
  <div id="posterModal" class="poster-modal"><div class="poster-grid" id="posterGrid"></div></div>
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <h2 id="confirmModalTitle"></h2>
      <p id="confirmModalBody"></p>
      <div id="confirmModalButtons">
        <button id="confirmModalCancel" class="btn btn-secondary">Annulla</button>
        <button id="confirmModalConfirm" class="btn btn-danger">Conferma</button>
      </div>
    </div>
  </div>
  <!-- MODALS END -->

  <script>
    const OMDb_API_KEY = "2526ef70";
    const TMDB_KEY = atob("MmNkOGJiNDgzYWIxMjE0ZDY2MDIwZTcwYjBhMzZmYTQ=");
    const DEFAULT_POSTER = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiB2aWV3Qm94PSIwIDAgMzAwIDQ1MCI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZ2h0PSI0NTAiIGZpbGw9IiNkZGQiLz48dGV4dCB4PSIxNTAiIHk9IjIyNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNjY2Ij5OZXNzYSBpbWFnaW5lPC90ZXh0Pjwvc3ZnPg==";
    const DEFAULT_CATEGORIES = ["watchlist", "watched"];
    const ROTTEN_TOMATOES_ICONS = { certified: "https://upload.wikimedia.org/wikipedia/uk/b/b2/Certified_Fresh_2018.svg", fresh: "https://upload.wikimedia.org/wikipedia/commons/5/5b/Rotten_Tomatoes.svg", rotten: "https://upload.wikimedia.org/wikipedia/commons/5/52/Rotten_Tomatoes_rotten.svg" };
    const IMDB_STAR_ICON = "https://upload.wikimedia.org/wikipedia/commons/2/29/Gold_Star.svg";
    let mediaList = [], categories = [...DEFAULT_CATEGORIES], currentOMDbSelection = null, currentUser = null, isViewMode = false, debounceTimeout, lazyLoadObserver, currentRewatchMediaId = null;
    let followedFriends = [], lastCheckedTimestamps = {};
    let statContributorIds = new Set();
    let ignoredDuplicateIds = new Set();
    const firebaseConfig = { apiKey: "AIzaSyDm946nISfZs8ugkuYPraNTzFhvgQmnMUk", authDomain: "gametrackerdb.firebaseapp.com", databaseURL: "https://gametrackerdb-default-rtdb.europe-west1.firebasedatabase.app", projectId: "gametrackerdb" };
    
    const elements = { 
        appLoader: document.getElementById("appLoader"),
        authForms: document.getElementById("authForms"), authToggle: document.getElementById("authToggle"), 
        userInfo: document.getElementById("userInfo"), loginBtn: document.getElementById("loginBtn"), 
        loginEmail: document.getElementById("loginEmail"), loginPassword: document.getElementById("loginPassword"), 
        registerBtn: document.getElementById("registerBtn"), registerEmail: document.getElementById("registerEmail"), 
        registerPassword: document.getElementById("registerPassword"), registerConfirmPassword: document.getElementById("registerConfirmPassword"), 
        logoutBtn: document.getElementById("logoutBtn"), loginForm: document.getElementById("loginForm"), 
        registerForm: document.getElementById("registerForm"), mediaManagementBtn: document.getElementById("mediaManagementBtn"), 
        shareBtn: document.getElementById("shareBtn"), exportBtn: document.getElementById("exportBtn"), 
        importBtn: document.getElementById("importBtn"), importFile: document.getElementById("importFile"), 
        resetBtn: document.getElementById("resetBtn"), themeToggle: document.getElementById("themeToggle"), 
        searchInput: document.getElementById("searchInput"), categoryFilter: document.getElementById("categoryFilter"), 
        sortFilter: document.getElementById("sortFilter"), statTotal: document.getElementById("statTotal"), 
        statWatchlist: document.getElementById("statWatchlist"), statWatched: document.getElementById("statWatched"), 
        statRewatched: document.getElementById("statRewatched"), statHours: document.getElementById("statHours"), 
        mediaSectionsContainer: document.getElementById("mediaSectionsContainer"), mediaManagementModal: document.getElementById("mediaManagementModal"), 
        mediaTitle: document.getElementById("mediaTitle"), searchOMDbBtn: document.getElementById("searchOMDbBtn"), 
        omdbResults: document.getElementById("omdbResults"), saveMediaBtn: document.getElementById("saveMediaBtn"), 
        addMediaCategorySelect: document.getElementById("addMediaCategorySelect"), newCategoryName: document.getElementById("newCategoryName"), 
        addCategoryBtn: document.getElementById("addCategoryBtn"), categoriesList: document.getElementById("categoriesList"), 
        closeManagementModal: document.getElementById("closeManagementModal"),
        notification: document.getElementById("notification"), notificationText: document.getElementById("notificationText"), 
        shareModal: document.getElementById("shareModal"), shareLinkInput: document.getElementById("shareLinkInput"), 
        copyShareLinkBtn: document.getElementById("copyShareLinkBtn"), closeShareModalBtn: document.getElementById("closeShareModalBtn"), 
        viewModeBanner: document.getElementById("viewModeBanner"), viewModeUserEmail: document.getElementById("viewModeUserEmail"), 
        closeViewBtn: document.getElementById("closeViewBtn"), posterModal: document.getElementById("posterModal"), 
        posterGrid: document.getElementById("posterGrid"),
        confirmModal: document.getElementById("confirmModal"), confirmModalTitle: document.getElementById("confirmModalTitle"),
        confirmModalBody: document.getElementById("confirmModalBody"), confirmModalConfirm: document.getElementById("confirmModalConfirm"),
        confirmModalCancel: document.getElementById("confirmModalCancel"),
        rewatchModal: document.getElementById("rewatchModal"), rewatchModalTitle: document.getElementById("rewatchModalTitle"),
        rewatchCountInput: document.getElementById("rewatchCountInput"), confirmRewatchBtn: document.getElementById("confirmRewatchBtn"),
        cancelRewatchBtn: document.getElementById("cancelRewatchBtn"),
        migrateSagaDataBtn: document.getElementById("migrateSagaDataBtn"),
        migrationProgressContainer: document.getElementById('migrationProgressContainer'),
        progressBar: document.getElementById('progressBar'),
        migrationStatusText: document.getElementById('migrationStatusText'),
        addFriendBtn: document.getElementById('addFriendBtn'),
        friendIdInput: document.getElementById('friendIdInput'),
        friendsList: document.getElementById('friendsList'),
        notificationBellContainer: document.getElementById('notificationBellContainer'),
        bellIcon: document.getElementById('bellIcon'),
        notificationBadge: document.getElementById('notificationBadge'),
        notificationDropdown: document.getElementById('notificationDropdown')
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    document.addEventListener("DOMContentLoaded", init);

    function init() {
      setupEventListeners();
      setupManagementModal();
      loadTheme();
      loadSortOrder();
      handleViewMode() || setupAuthListeners();
      setInterval(checkForFriendUpdates, 300000); // Check for updates every 5 minutes
    }
    
    function hideLoader() {
        elements.appLoader.style.opacity = '0';
        setTimeout(() => elements.appLoader.style.display = 'none', 300);
    }

    function setupManagementModal() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          btn.classList.add('active');
          document.getElementById(`${btn.dataset.tab}-tab`).classList.add('active');
          
          if (btn.dataset.tab === 'add-media') {
            elements.saveMediaBtn.style.display = 'inline-flex';
          } else {
            elements.saveMediaBtn.style.display = 'none';
          }
        });
      });
      elements.saveMediaBtn.addEventListener('click', addNewMedia);
      elements.closeManagementModal.addEventListener('click', () => {
        elements.mediaManagementModal.style.display = 'none';
        document.body.classList.remove('modal-open');
      });
    }

    function openMediaManagementModal() {
      if (isViewMode) return;
      elements.mediaTitle.value = "";
      elements.omdbResults.innerHTML = "";
      currentOMDbSelection = null;
      
      populateAddMediaCategorySelect();
      renderCategoriesList();
      renderFriendsList();
      
      const addMediaTab = document.querySelector('.tab-btn[data-tab="add-media"]');
      if(addMediaTab.classList.contains('active')) {
          elements.saveMediaBtn.style.display = 'inline-flex';
      } else {
          elements.saveMediaBtn.style.display = 'none';
      }
      
      elements.mediaManagementModal.style.display = 'flex';
      document.body.classList.add('modal-open');
    }

    function getRottenTomatoesState(score) {
      if (!score || score === "N/A") return null;
      const value = parseInt(score);
      return isNaN(value) ? null : value >= 75 ? "certified" : value >= 60 ? "fresh" : "rotten";
    }

    function setupAuthListeners() {
      elements.authToggle.addEventListener("click", e => {
        e.stopPropagation();
        elements.authForms.classList.toggle("active");
      });
      document.addEventListener("click", e => {
        if (!elements.authForms.contains(e.target) && !e.target.closest(".auth-container")) {
          elements.authForms.classList.remove("active");
        }
      });
      document.querySelectorAll(".auth-tab").forEach(tab => {
        tab.addEventListener("click", () => {
          document.querySelectorAll(".auth-tab").forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          document.querySelectorAll(".auth-form-container").forEach(c => c.classList.remove("active"));
          document.getElementById(`${tab.dataset.tab}Form`).classList.add("active");
        });
      });
      elements.loginBtn.addEventListener("click", () => {
        const email = elements.loginEmail.value;
        const password = elements.loginPassword.value;
        if (email && password) {
          firebase.auth().signInWithEmailAndPassword(email, password)
            .then(() => {
              showNotification("Login effettuato", "success");
              elements.authForms.classList.remove("active");
            })
            .catch(err => showNotification(getAuthErrorMessage(err), "error"));
        } else {
          showNotification("Inserisci email e password", "warning");
        }
      });
      elements.registerBtn.addEventListener("click", () => {
        const email = elements.registerEmail.value;
        const password = elements.registerPassword.value;
        const confirmPassword = elements.registerConfirmPassword.value;
        if (email && password && confirmPassword) {
          if (password !== confirmPassword) {
            showNotification("Le password non corrispondono", "warning");
          } else if (password.length < 6) {
            showNotification("La password deve avere almeno 6 caratteri", "warning");
          } else {
            firebase.auth().createUserWithEmailAndPassword(email, password)
              .then((userCredential) => {
                db.ref(`users/${userCredential.user.uid}/email`).set(email);
                showNotification("Registrazione completata!", "success");
                elements.authForms.classList.remove("active");
              })
              .catch(err => showNotification(getAuthErrorMessage(err), "error"));
          }
        } else {
          showNotification("Compila tutti i campi", "warning");
        }
      });
      elements.logoutBtn.addEventListener("click", () => firebase.auth().signOut());
      
      firebase.auth().onAuthStateChanged(user => {
        if (isViewMode) return;
        currentUser = user;
        updateAuthUI();
        if (user) {
          loadData();
        } else {
          loadLocalData();
          hideLoader();
        }
      });
    }

    function getAuthErrorMessage(err) {
      switch (err.code) {
        case "auth/email-already-in-use": return "Email già registrata";
        case "auth/invalid-email": return "Email non valida";
        case "auth/weak-password": return "Password troppo debole";
        case "auth/user-not-found": return "Utente non trovato";
        case "auth/wrong-password": return "Password errata";
        default: return "Errore: " + err.message;
      }
    }

    function updateAuthUI() {
      if (currentUser) {
        elements.userInfo.style.display = "flex";
        elements.authToggle.parentElement.style.display = "none";
        elements.notificationBellContainer.style.display = 'block';
        document.querySelectorAll(".btn").forEach(btn => btn.disabled = false);
      } else {
        elements.userInfo.style.display = "none";
        elements.authToggle.parentElement.style.display = "block";
        elements.notificationBellContainer.style.display = 'none';
        document.querySelectorAll("#mediaManagementBtn, #shareBtn").forEach(btn => btn.disabled = true);
        document.querySelectorAll("#exportBtn, #importBtn, #resetBtn").forEach(btn => btn.disabled = false);
      }
    }

    function loadData() {
      if (!currentUser) return;
      const path = `users/${currentUser.uid}`;
      db.ref(path).once("value").then(snapshot => {
        const data = snapshot.val() || {};
        mediaList = (data.mediaTracker?.mediaList || []).map(item => ({ ...{ isCountedAsWatched: false, isCountedAsWatchlist: false, rewatchCount: 0 }, ...item }));
        categories = data.mediaTracker?.categories || [...DEFAULT_CATEGORIES];
        followedFriends = data.social?.followedFriends || [];
        lastCheckedTimestamps = data.social?.lastCheckedTimestamps || {};
        renderFullUI();
        updateStats();
        hideLoader();
        checkForFriendUpdates();

        // Attach real-time listener for future updates
        db.ref(`${path}/mediaTracker/mediaList`).on("value", snap => {
            let updatedData = snap.val() || [];
            mediaList = updatedData.map(item => ({ ...{ isCountedAsWatched: false, isCountedAsWatchlist: false, rewatchCount: 0 }, ...item }));
            renderMedia();
            updateStats();
        });
      });
    }

    function loadLocalData() {
      try {
        let storedMedia = JSON.parse(localStorage.getItem("mediaList")) || [];
        mediaList = storedMedia.map(item => ({ ...{ isCountedAsWatched: false, isCountedAsWatchlist: false, rewatchCount: 0 }, ...item }));
        categories = JSON.parse(localStorage.getItem("categories")) || [...DEFAULT_CATEGORIES];
        renderFullUI();
        updateStats();
      } catch (err) {
        console.error("Error loading local data:", err);
      }
    }

    function saveData() {
      if (isViewMode) return;
      if (currentUser) {
        const now = new Date().toISOString();
        db.ref(`users/${currentUser.uid}/mediaTracker`).set({ mediaList, categories, lastModified: now }).catch(err => {
          console.error("Error saving media data to Firebase:", err);
        });
      } else {
        saveToLocal();
      }
    }

    function saveSocialData() {
        if (isViewMode || !currentUser) return;
        db.ref(`users/${currentUser.uid}/social`).set({ followedFriends, lastCheckedTimestamps }).catch(err => {
            console.error("Error saving social data to Firebase:", err);
        });
    }

    function saveToLocal() {
      try {
        localStorage.setItem("mediaList", JSON.stringify(mediaList));
        localStorage.setItem("categories", JSON.stringify(categories));
      } catch (err) {
        console.error("Error saving locally:", err);
      }
    }

    function handleViewMode() {
      const viewId = new URLSearchParams(window.location.search).get("view");
      if (!viewId) return false;
      isViewMode = true;
      document.querySelectorAll("#mediaManagementBtn, #shareBtn, #exportBtn, #importBtn, #resetBtn, .auth-container, #userInfo, .notification-bell-container").forEach(el => el.style.display = "none");
      elements.viewModeBanner.style.display = "flex";
      db.ref(`users/${viewId}/mediaTracker`).on("value", snapshot => {
        const data = snapshot.val();
        if (data) {
          let storedMedia = data.mediaList || [];
          mediaList = storedMedia.map(item => ({ ...{ isCountedAsWatched: false, isCountedAsWatchlist: false, rewatchCount: 0 }, ...item }));
          categories = data.categories || [...DEFAULT_CATEGORIES];
          renderFullUI();
          updateStats();
          db.ref(`users/${viewId}/email`).once("value", snapshot => {
            const email = snapshot.val();
            elements.viewModeUserEmail.textContent = `Stai visualizzando la libreria di ${email || "un utente"}`;
          });
        } else {
          showNotification("Libreria condivisa non trovata o non accessibile.", "error");
        }
        hideLoader();
      });
      return true;
    }

    function renderFullUI() {
      renderCategorySections();
      updateCategoryFilter();
      populateAddMediaCategorySelect();
      renderCategoriesList();
      renderMedia();
    }

    function renderMedia() {
      const selectedCategory = elements.categoryFilter.value;
      clearMediaGrids();
      updateStats();
      document.querySelectorAll(".media-section").forEach(section => {
        if (selectedCategory !== "all" && section.dataset.category !== selectedCategory) {
          section.classList.add("hidden");
        } else {
          section.classList.remove("hidden");
        }
      });
      const searchTerm = elements.searchInput.value.toLowerCase();
      const sortBy = elements.sortFilter.value;
      let filteredMedia = [...mediaList];
      if (searchTerm) {
        filteredMedia = filteredMedia.filter(m => m.title.toLowerCase().includes(searchTerm));
      }
      if (selectedCategory !== "all") {
        filteredMedia = filteredMedia.filter(m => m.category === selectedCategory);
      }
      filteredMedia.sort((a, b) => {
          switch (sortBy) {
              case "saga-alpha":
                  const aSagaCount = a.sagaName ? filteredMedia.filter(m => m.sagaName === a.sagaName).length : 0;
                  const bSagaCount = b.sagaName ? filteredMedia.filter(m => m.sagaName === b.sagaName).length : 0;
                  const isASaga = a.sagaName && aSagaCount > 1;
                  const isBSaga = b.sagaName && bSagaCount > 1;
                  
                  const sortKeyA = isASaga ? a.sagaName : a.title;
                  const sortKeyB = isBSaga ? b.sagaName : b.title;

                  if (sortKeyA !== sortKeyB) {
                      return sortKeyA.localeCompare(sortKeyB);
                  }
                  
                  const dateA = a.releaseDate || '0';
                  const dateB = b.releaseDate || '0';
                  return new Date(dateA) - new Date(dateB);
              case "alpha": 
                  return a.title.localeCompare(b.title);
              case "rating": 
                  return (parseFloat(b.imdbRating) || 0) - (parseFloat(a.imdbRating) || 0);
              case "year": 
                  return (parseInt(b.year) || 0) - (parseInt(a.year) || 0);
              case "added": 
              default: 
                  return new Date(b.addedAt) - new Date(a.addedAt);
          }
      });
      const fragments = {};
      categories.forEach(cat => fragments[cat] = document.createDocumentFragment());
      filteredMedia.forEach(media => {
        const grid = fragments[media.category];
        if (grid) grid.appendChild(createMediaCard(media));
      });
      categories.forEach(cat => {
        const grid = document.getElementById(`${cat}Grid`);
        if (grid) {
          grid.appendChild(fragments[cat]);
          if (grid.children.length === 0) {
            const emptyStateBtn = isViewMode ? '' : `<button class="btn btn-primary add-film-from-empty"><i class="fas fa-plus"></i> Aggiungi un film</button>`;
            grid.innerHTML = `<div class="empty-state"><i class="fas fa-film"></i><p>Nessun film in questa categoria.</p>${emptyStateBtn}</div>`;
          }
        }
      });
      setupLazyLoading();
      updateCounts();
    }

    function clearMediaGrids() {
      categories.forEach(cat => {
        const grid = document.getElementById(`${cat}Grid`);
        if (grid) grid.innerHTML = "";
      });
    }

    function updateStats() {
      const stats = { total: mediaList.length, watchlist: 0, watched: 0, rewatched: 0, minutes: 0 };
      statContributorIds.clear();
      ignoredDuplicateIds.clear();
      const processed = new Set();
      mediaList.forEach(media => {
        const uniqueId = media.imdbID || media.title.toLowerCase().trim();
        if (processed.has(uniqueId)) return;
        processed.add(uniqueId);
        const instances = mediaList.filter(m => (m.imdbID || m.title.toLowerCase()) === uniqueId);
        let contributor = instances.find(m => m.category === "watched") ||
                         instances.find(m => m.isCountedAsWatched) ||
                         instances.find(m => m.category === "watchlist") ||
                         instances.find(m => m.isCountedAsWatchlist);
        if (contributor) {
          statContributorIds.add(contributor.id);
          instances.forEach(inst => {
            if (inst.id !== contributor.id) ignoredDuplicateIds.add(inst.id);
          });
        }
      });
      statContributorIds.forEach(id => {
        const media = mediaList.find(m => m.id === id);
        if (!media) return;
        const isWatched = media.category === "watched" || media.isCountedAsWatched;
        if (media.category === "watched") stats.watched++;
        else if ((media.category === "watchlist" || media.isCountedAsWatchlist) && !isWatched) stats.watchlist++;
        if (isWatched) {
          if (media.rewatchCount > 0) stats.rewatched += media.rewatchCount;
          const runtime = parseInt(media.runtime?.replace(/\D/g, "")) || 0;
          if (runtime > 0) stats.minutes += runtime * ((media.rewatchCount || 0) + 1);
        }
      });
      const hours = Math.floor(stats.minutes / 60);
      stats.minutes %= 60;
      elements.statTotal.textContent = stats.total;
      elements.statWatchlist.textContent = stats.watchlist;
      elements.statWatched.textContent = stats.watched;
      elements.statRewatched.textContent = stats.rewatched;
      elements.statHours.textContent = `${hours}h ${stats.minutes}m`;
    }

    function updateCounts() {
      document.querySelectorAll(".category-count").forEach(el => el.textContent = "");
      categories.forEach(cat => {
        const countEl = document.getElementById(`${cat}Count`);
        if (countEl) countEl.textContent = mediaList.filter(m => m.category === cat).length;
      });
    }

    function createMediaCard(media) {
      const card = document.createElement("div");
      card.className = "media-card";
      card.dataset.id = media.id;
      if (statContributorIds.has(media.id)) card.classList.add("is-stat-contributor");
      if (ignoredDuplicateIds.has(media.id)) card.classList.add("is-duplicate");
      
      let ratingsHTML = "";
      if (media.imdbRating && media.imdbRating !== "N/A") {
        ratingsHTML += `<span class="rating-badge" title="IMDb Rating: ${media.imdbRating}"><img src="${IMDB_STAR_ICON}" class="rating-icon" alt="IMDb"> ${media.imdbRating}</span>`;
      }
      if (media.rottenTomatoes && media.rottenTomatoes !== "N/A") {
        const state = getRottenTomatoesState(media.rottenTomatoes);
        if (state) {
          ratingsHTML += `<span class="rating-badge" title="Rotten Tomatoes: ${media.rottenTomatoes}"><img src="${ROTTEN_TOMATOES_ICONS[state]}" class="rating-icon" alt="Rotten Tomatoes"> ${media.rottenTomatoes}</span>`;
        }
      }
      const ratingsSection = ratingsHTML ? `<div class="media-ratings">${ratingsHTML}</div>` : "";
      
      let statusHTML = "";
      const isEffectivelyWatched = media.isCountedAsWatched || media.category === "watched";
      
      if (isEffectivelyWatched) {
          const totalViews = (media.rewatchCount || 0) + 1;
          const sup = totalViews > 1 ? `<sup>${totalViews}</sup>` : "";
          statusHTML = `<span class="watch-status-icon" title="Visto ${totalViews} volte"><i class="fas fa-eye"></i>${sup}</span>`;
      } else if (media.isCountedAsWatchlist && media.category !== "watchlist") {
          statusHTML = `<span class="watchlist-status-icon" title="In lista Da Vedere"><i class="fas fa-list-alt"></i></span>`;
      }
      
      const actionsHTML = isViewMode ? '' : `
        <div class="card-actions">
            <button class="card-btn" data-action="move" title="Sposta in..."><i class="fas fa-folder-open"></i></button>
            <button class="card-btn" data-action="delete" title="Elimina"><i class="fas fa-trash"></i></button>
        </div>`;

      card.innerHTML = `
        <div class="poster-container">
          <img data-src="${fixPosterUrl(media.poster) || DEFAULT_POSTER}" class="media-poster lazy" onerror="this.src='${DEFAULT_POSTER}'">
          ${actionsHTML}
        </div>
        <div class="media-info">
          <h3 class="media-title" title="${media.title}">${media.title}</h3>
          <div class="media-meta">
            ${media.year ? `<span>${media.year}</span>` : ""}
            ${media.runtime ? `<span>⏱️ ${formatRuntime(media.runtime)}</span>` : ""}
            ${statusHTML}
          </div>
          ${ratingsSection}
        </div>
      `;
      if (!isViewMode) {
          card.querySelector('[data-action="move"]').addEventListener("click", e => {
            e.stopPropagation();
            showContextMenu(media, { x: e.clientX, y: e.clientY });
          });
          card.querySelector('[data-action="delete"]').addEventListener("click", e => {
            e.stopPropagation();
            deleteMedia(media.id);
          });
      }
      return card;
    }

    function fixPosterUrl(url) {
      if (!url || url === "N/A") return null;
      return url.startsWith("http://") || url.startsWith("https://") ? url : url.startsWith("//") ? `https:${url}` : `https://${url}`;
    }

    function renderCategorySections() {
      elements.mediaSectionsContainer.innerHTML = categories.map(cat => `
        <div class="media-section" id="${cat}Section" data-category="${cat}">
          <div class="section-header">
            <h2 class="section-title user-select-none">${getCategoryName(cat)}</h2>
            <span id="${cat}Count" class="category-count">0</span>
          </div>
          <div class="media-grid" id="${cat}Grid"></div>
        </div>
      `).join("");
    }

    function renderCategoriesList() {
      const list = elements.categoriesList;
      list.innerHTML = "";
      categories.forEach((cat, index) => {
        const count = mediaList.filter(m => m.category === cat).length;
        const dotClass = `category-dot-${index % 6}`;
        const specialDot = cat === "watchlist" ? "category-dot-watchlist" : cat === "watched" ? "category-dot-watched" : "";
        const card = document.createElement("div");
        card.className = "management-card";
        card.innerHTML = `
          <span class="category-dot ${dotClass} ${specialDot}"></span>
          <div>
            <div class="category-name">${getCategoryName(cat)}</div>
            <div class="category-item-count">${count} film</div>
          </div>
          <div class="management-card-actions">
            <button class="btn btn-secondary move-up-btn" data-category="${cat}" ${index === 0 ? "disabled" : ""}><i class="fas fa-arrow-up"></i></button>
            <button class="btn btn-secondary move-down-btn" data-category="${cat}" ${index === categories.length - 1 ? "disabled" : ""}><i class="fas fa-arrow-down"></i></button>
            ${DEFAULT_CATEGORIES.includes(cat) ? "" : `
              <button class="btn btn-secondary rename-category-btn" data-category="${cat}"><i class="fas fa-pencil-alt"></i></button>
              <button class="btn btn-danger delete-category-btn" data-category="${cat}"><i class="fas fa-trash"></i></button>
            `}
          </div>
        `;
        list.appendChild(card);
      });
      list.querySelectorAll(".rename-category-btn").forEach(btn => {
        btn.addEventListener("click", e => {
          e.stopPropagation();
          const cat = btn.dataset.category;
          const nameEl = btn.closest(".management-card").querySelector(".category-name");
          renameCategory(cat, nameEl);
        });
      });
      list.querySelectorAll(".delete-category-btn").forEach(btn => {
        btn.addEventListener("click", e => {
          e.stopPropagation();
          deleteCategory(btn.dataset.category);
        });
      });
      list.querySelectorAll(".move-up-btn").forEach(btn => btn.addEventListener("click", () => moveCategory(btn.dataset.category, -1)));
      list.querySelectorAll(".move-down-btn").forEach(btn => btn.addEventListener("click", () => moveCategory(btn.dataset.category, 1)));
    }

    function renameCategory(cat, nameEl) {
      const oldName = nameEl.textContent.trim();
      const input = document.createElement("input");
      input.type = "text";
      input.value = oldName;
      input.className = "modern-input";
      input.style.marginBottom = "0";
      nameEl.parentElement.innerHTML = "";
      nameEl.parentElement.appendChild(input);
      input.focus();
      const save = () => {
        const newName = input.value.trim();
        if (newName && newName !== cat && !categories.includes(newName)) {
          mediaList.forEach(m => { if (m.category === cat) m.category = newName; });
          categories[categories.indexOf(cat)] = newName;
          saveData();
          renderFullUI();
          showNotification(`Categoria rinominata in "${newName}"`, "success");
        } else {
          renderCategoriesList();
        }
      };
      input.addEventListener("blur", save);
      input.addEventListener("keydown", e => {
        if (e.key === "Enter") input.blur();
        if (e.key === "Escape") renderCategoriesList();
      });
    }

    function moveCategory(cat, direction) {
      const index = categories.indexOf(cat);
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= categories.length) return;
      [categories[index], categories[newIndex]] = [categories[newIndex], categories[index]];
      saveData();
      renderFullUI();
    }

    function updateCategoryFilter() {
      const current = elements.categoryFilter.value;
      elements.categoryFilter.innerHTML = `<option value="all">Tutte le categorie</option>${categories.map(cat => `<option value="${cat}">${getCategoryName(cat)}</option>`).join("")}`;
      elements.categoryFilter.value = current;
    }

    function populateAddMediaCategorySelect() {
      const lastUsed = localStorage.getItem("lastUsedCategory");
      elements.addMediaCategorySelect.innerHTML = categories.map(cat => `<option value="${cat}">${getCategoryName(cat)}</option>`).join("");
      if (lastUsed && categories.includes(lastUsed)) elements.addMediaCategorySelect.value = lastUsed;
    }

    function getCategoryName(cat, withDot = false) {
      const names = { watchlist: "Da Vedere", watched: "Visti" };
      const index = categories.indexOf(cat);
      const dotClass = `category-dot-${index % 6}`;
      const specialDot = cat === "watchlist" ? "category-dot-watchlist" : cat === "watched" ? "category-dot-watched" : "";
      return withDot ? `<span class="category-dot ${dotClass} ${specialDot}"></span>${names[cat] || cat}` : names[cat] || cat;
    }

    function addCategory(name) {
      if (!name) return showNotification("Inserisci un nome per la categoria", "warning"), false;
      const trimmed = name.trim();
      if (categories.some(c => c.toLowerCase() === trimmed.toLowerCase())) {
        showNotification("Questa categoria esiste già", "warning");
        return false;
      }
      categories.push(trimmed);
      saveData();
      renderFullUI();
      showNotification(`Categoria "${trimmed}" creata`, "success");
      elements.newCategoryName.value = "";
      return true;
    }
    
    function showConfirmModal(title, body, onConfirm) {
      elements.confirmModalTitle.textContent = title;
      elements.confirmModalBody.textContent = body;
      elements.confirmModal.style.display = "flex";
      document.body.classList.add("modal-open");
      const cancel = () => {
        closeModal(elements.confirmModal);
        cleanup();
      };
      const confirm = () => {
        onConfirm();
        closeModal(elements.confirmModal);
        cleanup();
      };
      const cleanup = () => {
        elements.confirmModalConfirm.removeEventListener("click", confirm);
        elements.confirmModalCancel.removeEventListener("click", cancel);
      };
      elements.confirmModalConfirm.addEventListener("click", confirm);
      elements.confirmModalCancel.addEventListener("click", cancel);
    }
    
    function deleteCategory(cat) {
      if (DEFAULT_CATEGORIES.includes(cat)) {
        showNotification("Non puoi eliminare questa categoria predefinita", "warning");
        return;
      }
      showConfirmModal("Elimina Categoria", `Sei sicuro di voler eliminare la categoria "${cat}"? Tutti i film al suo interno saranno spostati in "Da Vedere".`, () => {
        mediaList.forEach(m => { if (m.category === cat) m.category = "watchlist"; });
        categories = categories.filter(c => c !== cat);
        saveData();
        renderFullUI();
        showNotification(`Categoria "${cat}" eliminata`, "success");
      });
    }

    function closeAllMenus() {
      document.querySelectorAll(".context-menu").forEach(menu => menu.remove());
    }
    
    function showContextMenu(media, pos) {
      closeAllMenus();
      const menu = document.createElement("div");
      menu.className = "context-menu";
      const hide = () => {
        menu.classList.remove("visible");
        setTimeout(() => menu.remove(), 150);
        document.removeEventListener("click", hide, { capture: true });
        document.removeEventListener("contextmenu", hide, { capture: true });
      };
      setTimeout(() => {
        document.addEventListener("click", hide, { capture: true, once: true });
        document.addEventListener("contextmenu", hide, { capture: true, once: true });
        requestAnimationFrame(() => menu.classList.add("visible"));
      }, 0);
      menu.addEventListener("click", e => e.stopPropagation());
      
      const header = document.createElement("div");
      header.className = "context-menu-item";
      header.innerHTML = '<i class="fas fa-folder-open fa-fw"></i> <strong>Sposta in...</strong>';
      header.style.cssText = "color: var(--text-secondary); cursor: default; background: rgba(128,128,128,0.1);";
      menu.appendChild(header);
      
      categories.filter(c => c !== media.category).forEach(cat => {
        const item = document.createElement("div");
        item.className = "context-menu-item";
        item.innerHTML = getCategoryName(cat, true);
        item.addEventListener("click", () => { moveMediaToCategory(media.id, cat); hide(); });
        menu.appendChild(item);
      });
      menu.appendChild(document.createElement("div")).className = "context-menu-divider";
      
      const isCustomCategory = !DEFAULT_CATEGORIES.includes(media.category);
      if (media.category === 'watched' || isCustomCategory) {
        const rewatchItem = document.createElement("div");
        rewatchItem.className = "context-menu-item";
        rewatchItem.innerHTML = '<i class="fas fa-sync-alt fa-fw"></i> Modifica Rewatch';
        rewatchItem.addEventListener("click", () => { openRewatchModal(media.id); hide(); });
        menu.appendChild(rewatchItem);
      }

      if (isCustomCategory) {
        const watchedItem = document.createElement("div");
        watchedItem.className = "context-menu-item";
        if (media.isCountedAsWatched) {
          watchedItem.innerHTML = '<i class="fas fa-times fa-fw"></i> Rimuovi stato "visto"';
          watchedItem.style.color = "var(--danger)";
        } else {
          watchedItem.innerHTML = '<i class="fas fa-check-double fa-fw"></i> Segna come visto qui';
        }
        watchedItem.addEventListener("click", () => { toggleCountedAsWatched(media.id); hide(); });
        menu.appendChild(watchedItem);

        const watchlistItem = document.createElement("div");
        watchlistItem.className = "context-menu-item";
        if (media.isCountedAsWatchlist) {
            watchlistItem.innerHTML = '<i class="fas fa-times fa-fw"></i> Rimuovi stato "da vedere"';
            watchlistItem.style.color = "var(--danger)";
        } else {
            watchlistItem.innerHTML = '<i class="fas fa-list-alt fa-fw"></i> Segna come da vedere qui';
        }
        watchlistItem.addEventListener("click", () => { toggleCountedAsWatchlist(media.id); hide(); });
        menu.appendChild(watchlistItem);
      }
      
      if (media.category === 'watched' || isCustomCategory) {
          menu.appendChild(document.createElement("div")).className = "context-menu-divider";
      }

      const changePosterItem = document.createElement("div");
      changePosterItem.className = "context-menu-item";
      changePosterItem.innerHTML = '<i class="fas fa-image fa-fw"></i> Cambia Copertina';
      changePosterItem.addEventListener("click", () => { showPosterModal(media.id); hide(); });
      menu.appendChild(changePosterItem);

      const deleteItem = document.createElement("div");
      deleteItem.className = "context-menu-item";
      deleteItem.innerHTML = '<i class="fas fa-trash fa-fw"></i> Elimina';
      deleteItem.style.color = "var(--danger)";
      deleteItem.addEventListener("click", () => { deleteMedia(media.id); hide(); });
      menu.appendChild(deleteItem);

      document.body.appendChild(menu);
      const rect = menu.getBoundingClientRect();
      let x = pos.x, y = pos.y;
      if (x + rect.width > window.innerWidth) x = window.innerWidth - rect.width - 5;
      if (y + rect.height > window.innerHeight) y = window.innerHeight - rect.height - 5;
      menu.style.left = `${x}px`;
      menu.style.top = `${y}px`;
    }
    
    function moveMediaToCategory(id, newCategory) {
        const media = mediaList.find(m => m.id === id);
        if (!media) return;

        const oldCategory = media.category;
        media.category = newCategory;

        if (newCategory === 'watched') {
            media.isCountedAsWatched = true;
            media.isCountedAsWatchlist = false; 
        } else if (newCategory === 'watchlist') {
            media.isCountedAsWatchlist = true;
        }

        if (!DEFAULT_CATEGORIES.includes(oldCategory) && DEFAULT_CATEGORIES.includes(newCategory)) {
            if (newCategory === 'watched' && !media.isCountedAsWatched) {
                media.rewatchCount = 0;
            }
            media.isCountedAsWatched = newCategory === 'watched';
            media.isCountedAsWatchlist = newCategory === 'watchlist';
        }

        saveData();
        renderMedia();
        showNotification(`Film spostato in "${getCategoryName(newCategory)}"`, "success");
    }

    function toggleCountedAsWatched(id) {
        const media = mediaList.find(m => m.id === id);
        if (!media) return;
        media.isCountedAsWatched = !media.isCountedAsWatched;
        if (media.isCountedAsWatched) {
            media.isCountedAsWatchlist = false;
            if (media.rewatchCount < 0) media.rewatchCount = 0;
        }
        saveData();
        refreshSingleMedia(id);
        updateStats();
        showNotification(`Stato "visto" aggiornato per ${media.title}`, "success");
    }

    function toggleCountedAsWatchlist(id) {
        const media = mediaList.find(m => m.id === id);
        if (!media) return;
        media.isCountedAsWatchlist = !media.isCountedAsWatchlist;
        if (media.isCountedAsWatchlist) media.isCountedAsWatched = false;
        saveData();
        refreshSingleMedia(id);
        updateStats();
        showNotification(`Stato "da vedere" aggiornato per ${media.title}`, "success");
    }

    function openRewatchModal(id) {
        const media = mediaList.find(m => m.id === id);
        if (!media) return;

        currentRewatchMediaId = id;
        elements.rewatchModalTitle.textContent = `Modifica Rewatch: ${media.title}`;
        
        const currentCount = media.rewatchCount || 0;
        elements.rewatchCountInput.value = currentCount;
        
        updateRewatchModalButtons(currentCount);

        elements.rewatchModal.style.display = 'flex';
        document.body.classList.add('modal-open');
    }

    function updateRewatchModalButtons(count) {
        document.querySelectorAll('.quick-rewatch-btn').forEach(btn => {
            btn.classList.toggle('active', parseInt(btn.dataset.count) === count);
        });
    }

    function markRewatch(id, count) {
      const media = mediaList.find(m => m.id === id);
      if (!media) return;
      media.rewatchCount = count;
      if (count >= 0 && !media.isCountedAsWatched) {
        media.isCountedAsWatched = true;
        media.isCountedAsWatchlist = false;
      }
      saveData();
      refreshSingleMedia(id);
      updateStats();
      showNotification(`Rewatch di "${media.title}" aggiornati`, "success");
    }

    function refreshSingleMedia(id) {
      const media = mediaList.find(m => m.id === id);
      if (!media) return;
      const oldCard = document.querySelector(`.media-card[data-id="${id}"]`);
      const grid = oldCard ? oldCard.parentElement : document.getElementById(`${media.category}Grid`);
      if (!grid) return;
      const newCard = createMediaCard(media);
      if (oldCard) {
        grid.replaceChild(newCard, oldCard);
      } else {
        grid.appendChild(newCard);
      }
      if (lazyLoadObserver) lazyLoadObserver.observe(newCard.querySelector(".lazy"));
      updateCounts();
    }

    function deleteMedia(id) {
      if (isViewMode) return;
      const media = mediaList.find(m => m.id === id);
      if (!media) return;
      showConfirmModal("Elimina Film", `Sei sicuro di voler eliminare "${media.title}"?`, () => {
        mediaList = mediaList.filter(m => m.id !== id);
        saveData();
        renderMedia();
        showNotification("Film eliminato", "success");
      });
    }

    function closeModal(modal) {
      modal.style.display = "none";
      document.body.classList.remove("modal-open");
    }

    async function searchOMDb() {
      const title = elements.mediaTitle.value.trim();
      if (!title) return showNotification("Inserisci un titolo", "warning");
      elements.omdbResults.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-2x loading-spinner"></i></div>';
      try {
        let url = `https://www.omdbapi.com/?apikey=${OMDb_API_KEY}&s=${encodeURIComponent(title)}&type=movie`;
        let response = await fetch(url);
        let data = await response.json();
        if (data.Response === "True") {
          displayOMDbResults(data.Search);
        } else if (data.Error === "Too many results.") {
          showNotification("Troppi risultati. Tento una ricerca esatta...", "warning");
          url = `https://www.omdbapi.com/?apikey=${OMDb_API_KEY}&t=${encodeURIComponent(title)}&type=movie`;
          response = await fetch(url);
          data = await response.json();
          if (data.Response === "True") {
            displayOMDbResults([data]);
          } else {
            elements.omdbResults.innerHTML = `<p>${data.Error || "Nessun risultato trovato"}</p>`;
          }
        } else {
          elements.omdbResults.innerHTML = `<p>${data.Error || "Nessun risultato trovato"}</p>`;
        }
      } catch (err) {
        showNotification("Errore nella ricerca", "error");
        console.error("OMDb error:", err);
        elements.omdbResults.innerHTML = "<p>Errore durante la ricerca</p>";
      }
    }

    function displayOMDbResults(results) {
      elements.omdbResults.innerHTML = results.map(result => `
        <div class="omdb-result-item user-select-none" data-id="${result.imdbID}">
          <img src="${fixPosterUrl(result.Poster)}" class="omdb-poster-small" onerror="this.src='${DEFAULT_POSTER}'">
          <div><div><strong>${result.Title}</strong></div><div>${result.Year}</div></div>
        </div>
      `).join("");
      document.querySelectorAll(".omdb-result-item").forEach(item => {
        item.addEventListener("click", async () => {
          const details = await getOMDbMovieDetails(item.dataset.id);
          if (details) {
            currentOMDbSelection = details;
            elements.mediaTitle.value = details.Title;
            showNotification(`Dettagli di "${details.Title}" pronti per il salvataggio`, "success");
          }
        });
      });
    }

    async function getOMDbMovieDetails(imdbID) {
      try {
        const response = await fetch(`https://www.omdbapi.com/?apikey=${OMDb_API_KEY}&i=${imdbID}`);
        const data = await response.json();
        if (data.Response === "False") throw new Error(data.Error || "Dettagli non disponibili");
        return data;
      } catch (err) {
        console.error("Error fetching movie details:", err);
        showNotification("Errore nel caricamento dei dettagli", "error");
        return null;
      }
    }

    async function addNewMedia() {
        if (isViewMode) return;
        const title = elements.mediaTitle.value.trim();
        if (!title) return showNotification("Inserisci un titolo", "warning");

        const category = elements.addMediaCategorySelect.value;
        localStorage.setItem("lastUsedCategory", category);
        
        let media = {
            id: Date.now().toString(),
            title,
            category,
            addedAt: new Date().toISOString(),
            poster: "",
            rewatchCount: 0,
            isCountedAsWatched: category === "watched",
            isCountedAsWatchlist: category === "watchlist",
            year: "",
            imdbID: null,
            imdbRating: "",
            rottenTomatoes: "",
            runtime: "",
            sagaName: null,
            releaseDate: null
        };

        if (currentOMDbSelection) {
            media = {
                ...media,
                title: currentOMDbSelection.Title,
                year: currentOMDbSelection.Year,
                poster: fixPosterUrl(currentOMDbSelection.Poster),
                imdbID: currentOMDbSelection.imdbID,
                imdbRating: currentOMDbSelection.imdbRating || "N/A",
                runtime: currentOMDbSelection.Runtime || ""
            };
            if (currentOMDbSelection.Ratings && Array.isArray(currentOMDbSelection.Ratings)) {
                for (const rating of currentOMDbSelection.Ratings) {
                    if (rating.Source === "Rotten Tomatoes") media.rottenTomatoes = rating.Value || "N/A";
                }
            }

            if (media.imdbID) {
                try {
                    const findRes = await fetch(`https://api.themoviedb.org/3/find/${media.imdbID}?api_key=${TMDB_KEY}&external_source=imdb_id`);
                    const findData = await findRes.json();
                    const tmdbMovie = findData.movie_results[0];

                    if (tmdbMovie) {
                        const detailsRes = await fetch(`https://api.themoviedb.org/3/movie/${tmdbMovie.id}?api_key=${TMDB_KEY}`);
                        const tmdbDetails = await detailsRes.json();
                        
                        if (tmdbDetails.belongs_to_collection) media.sagaName = tmdbDetails.belongs_to_collection.name;
                        if (tmdbDetails.release_date) media.releaseDate = tmdbDetails.release_date;
                    }
                } catch (err) {
                    console.error("Error fetching saga details from TMDb:", err);
                }
            }
        }

        const duplicate = mediaList.some(m => (m.imdbID && m.imdbID === media.imdbID || !m.imdbID && m.title.toLowerCase() === media.title.toLowerCase()) && m.category === media.category);
        if (duplicate) showNotification(`Attenzione: Questo film è già in "${getCategoryName(media.category)}"`, "warning");
        
        mediaList.push(media);
        saveData();
        closeModal(elements.mediaManagementModal);
        renderMedia();
        showNotification(`Film "${media.title}" aggiunto!`, "success");
    }
    
    async function migrateExistingData() {
        if (isViewMode) return;

        const btn = elements.migrateSagaDataBtn;
        btn.style.display = 'none';
        elements.migrationProgressContainer.style.display = 'block';
        elements.progressBar.style.width = '0%';

        const moviesToUpdate = mediaList.filter(m => m.imdbID && typeof m.sagaName === 'undefined');

        if (moviesToUpdate.length === 0) {
            showNotification("Tutti i film sono già aggiornati!", "success");
            btn.style.display = 'inline-flex';
            elements.migrationProgressContainer.style.display = 'none';
            return;
        }

        showNotification(`Aggiornamento di ${moviesToUpdate.length} film iniziato...`, "warning");

        let updatedCount = 0;
        let processedCount = 0;
        
        for (const movie of moviesToUpdate) {
            try {
                const findRes = await fetch(`https://api.themoviedb.org/3/find/${movie.imdbID}?api_key=${TMDB_KEY}&external_source=imdb_id`);
                const findData = await findRes.json();
                const tmdbMovie = findData.movie_results[0];

                if (tmdbMovie) {
                    const detailsRes = await fetch(`https://api.themoviedb.org/3/movie/${tmdbMovie.id}?api_key=${TMDB_KEY}`);
                    const tmdbDetails = await detailsRes.json();
                    
                    if (tmdbDetails.belongs_to_collection) {
                        movie.sagaName = tmdbDetails.belongs_to_collection.name;
                        updatedCount++;
                    } else {
                        movie.sagaName = null;
                    }

                    if (tmdbDetails.release_date) {
                        movie.releaseDate = tmdbDetails.release_date;
                    } else {
                        movie.releaseDate = null;
                    }
                }
            } catch (err) {
                console.error(`Errore durante l'aggiornamento di ${movie.title}:`, err);
                movie.sagaName = null;
                movie.releaseDate = null;
            } finally {
                processedCount++;
                const percentage = Math.round((processedCount / moviesToUpdate.length) * 100);
                elements.progressBar.style.width = `${percentage}%`;
                elements.migrationStatusText.textContent = `Aggiornamento ${processedCount} di ${moviesToUpdate.length}...`;
                await new Promise(res => setTimeout(res, 250)); 
            }
        }
        
        saveData();
        renderMedia();
        showNotification(`Aggiornamento completato! ${updatedCount} film appartengono a una saga.`, "success");
        elements.migrationStatusText.textContent = 'Completato!';
        
        setTimeout(() => {
            btn.style.display = 'inline-flex';
            elements.migrationProgressContainer.style.display = 'none';
        }, 2000);
    }

    function exportData() {
      if (isViewMode) return;
      const data = { mediaList, categories, exportedAt: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `filmtracker_export_${new Date().toISOString().split("T")[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showNotification("Dati esportati", "success");
    }

    function importData(file) {
      if (isViewMode || !file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          if (!Array.isArray(data.mediaList)) throw new Error("Formato file non valido");
          showConfirmModal("Importa Dati", `Stai per importare ${data.mediaList.length} film. I dati attuali verranno sovrascritti. Continuare?`, () => {
            mediaList = data.mediaList;
            categories = data.categories || [...DEFAULT_CATEGORIES];
            saveData();
            renderFullUI();
            showNotification("Dati importati con successo", "success");
          });
        } catch (err) {
          showNotification("Errore nell'importazione: " + err.message, "error");
        }
      };
      reader.readAsText(file);
    }

    function resetApp() {
      if (isViewMode) return;
      showConfirmModal("Resetta Applicazione", "Sei sicuro di voler resettare l'applicazione? Tutti i dati andranno persi.", () => {
        mediaList = [];
        categories = [...DEFAULT_CATEGORIES];
        saveData();
        elements.searchInput.value = "";
        elements.categoryFilter.value = "all";
        elements.sortFilter.value = "saga-alpha";
        renderFullUI();
        showNotification("Applicazione resettata", "success");
      });
    }

    function loadTheme() {
      const theme = localStorage.getItem("theme") || "dark";
      document.body.classList.toggle("dark", theme === "dark");
      elements.themeToggle.innerHTML = `<i class="fas fa-${theme === "dark" ? "sun" : "moon"}"></i>`;
    }

    function toggleTheme() {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      elements.themeToggle.innerHTML = `<i class="fas fa-${isDark ? "sun" : "moon"}"></i>`;
    }

    function loadSortOrder() {
      const sort = localStorage.getItem("mediaTrackerSortOrder");
      if (sort) elements.sortFilter.value = sort;
    }

    function showNotification(text, type = "success") {
      elements.notificationText.textContent = text;
      elements.notification.className = `notification ${type}`;
      elements.notification.style.display = "block";
      setTimeout(() => elements.notification.style.display = "none", 3000);
    }

    function setupLazyLoading() {
      if (lazyLoadObserver) lazyLoadObserver.disconnect();
      lazyLoadObserver = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            img.src = img.dataset.src;
            img.classList.remove("lazy");
            lazyLoadObserver.unobserve(img);
          }
        });
      });
      document.querySelectorAll(".lazy").forEach(img => lazyLoadObserver.observe(img));
    }

    function formatRuntime(runtime) {
      if (!runtime) return "";
      const minutes = parseInt(runtime);
      if (isNaN(minutes) || minutes <= 0) return "";
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return hours > 0 ? `${hours}h ${mins > 0 ? `${mins}m` : ""}` : `${mins}m`;
    }

    async function checkForRatingUpdates() {
      const toUpdate = mediaList.filter(m => m.imdbID && (!m.imdbRating || m.imdbRating === "N/A"))
        .sort((a, b) => (a.lastChecked || 0) - (b.lastChecked || 0))
        .slice(0, 5);
      for (const media of toUpdate) {
        const details = await getOMDbMovieDetails(media.imdbID);
        if (details && details.imdbRating && details.imdbRating !== "N/A") {
          media.imdbRating = details.imdbRating;
          media.rottenTomatoes = "";
          for (const rating of details.Ratings || []) {
            if (rating.Source === "Rotten Tomatoes") media.rottenTomatoes = rating.Value;
          }
          media.lastChecked = Date.now();
          refreshSingleMedia(media.id);
          showNotification(`Rating aggiornati per: ${media.title}`, "success");
        }
      }
      saveData();
    }
    
    async function checkForFriendUpdates() {
        if (!currentUser || followedFriends.length === 0) return;

        let newUpdates = [];
        for (const friend of followedFriends) {
            const friendPath = `users/${friend.id}/mediaTracker/lastModified`;
            const lastChecked = lastCheckedTimestamps[friend.id] || 0;
            
            try {
                const snapshot = await db.ref(friendPath).once('value');
                const lastModified = snapshot.val();
                if (lastModified && new Date(lastModified) > new Date(lastChecked)) {
                    newUpdates.push(friend);
                }
            } catch (error) {
                console.error(`Could not check for updates for friend ${friend.id}:`, error);
            }
        }
        renderNotifications(newUpdates);
    }

    function renderNotifications(updates) {
        const count = updates.length;
        elements.notificationBadge.textContent = count;
        elements.notificationBadge.classList.toggle('visible', count > 0);

        if (count > 0) {
            elements.notificationDropdown.innerHTML = updates.map(friend => `
                <div class="notification-item" data-id="${friend.id}">
                    <i class="fas fa-user-edit"></i>
                    <span><strong>${friend.email}</strong> ha aggiornato la sua libreria.</span>
                </div>
            `).join('');
            document.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', () => {
                    const friendId = item.dataset.id;
                    const url = `${window.location.origin}${window.location.pathname}?view=${friendId}`;
                    window.open(url, '_blank');
                    
                    lastCheckedTimestamps[friendId] = new Date().toISOString();
                    saveSocialData();
                    
                    item.remove();
                    const newCount = elements.notificationDropdown.children.length;
                    elements.notificationBadge.textContent = newCount;
                    elements.notificationBadge.classList.toggle('visible', newCount > 0);
                    if (newCount === 0) {
                        elements.notificationDropdown.innerHTML = '<div class="no-notifications">Nessuna nuova notifica</div>';
                    }
                });
            });
        } else {
            elements.notificationDropdown.innerHTML = '<div class="no-notifications">Nessuna nuova notifica</div>';
        }
    }

    function setupEventListeners() {
      elements.mediaSectionsContainer.addEventListener("click", e => {
        if (isViewMode) return;
        if (e.target.closest(".add-film-from-empty")) openMediaManagementModal();
      });
      document.addEventListener("contextmenu", e => {
        if (isViewMode) return;
        closeAllMenus();
        const card = e.target.closest(".media-card");
        if (card) {
          e.preventDefault();
          const id = card.dataset.id;
          const media = mediaList.find(m => m.id === id);
          if (media) showContextMenu(media, { x: e.clientX, y: e.clientY });
        }
      });
      elements.mediaManagementBtn.addEventListener("click", openMediaManagementModal);
      elements.addCategoryBtn.addEventListener("click", () => addCategory(elements.newCategoryName.value));
      elements.searchOMDbBtn.addEventListener("click", searchOMDb);
      document.addEventListener("click", e => {
        if (e.target === elements.posterModal) {
          const selected = document.querySelector(".poster-option.selected");
          if (selected) {
            changePoster(elements.posterModal.dataset.mediaId, selected.dataset.url);
          } else {
            showNotification("Nessuna nuova copertina selezionata.", "warning");
          }
          elements.posterModal.style.display = "none";
        }
         if (!elements.notificationBellContainer.contains(e.target)) {
            elements.notificationDropdown.classList.remove('visible');
        }
      });
      elements.exportBtn.addEventListener("click", exportData);
      elements.importBtn.addEventListener("click", () => elements.importFile.click());
      elements.importFile.addEventListener("change", e => importData(e.target.files[0]));
      elements.resetBtn.addEventListener("click", resetApp);
      elements.themeToggle.addEventListener("click", toggleTheme);
      elements.searchInput.addEventListener("input", () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(renderMedia, 300);
      });
      elements.categoryFilter.addEventListener("change", renderMedia);
      elements.sortFilter.addEventListener("change", () => {
        localStorage.setItem("mediaTrackerSortOrder", elements.sortFilter.value);
        renderMedia();
      });
      elements.shareBtn.addEventListener("click", () => {
        if (!currentUser) return showNotification("Devi essere loggato per condividere.", "warning");
        const link = `${window.location.origin}${window.location.pathname}?view=${currentUser.uid}`;
        elements.shareLinkInput.value = link;
        elements.shareModal.style.display = "flex";
        document.body.classList.add("modal-open");
      });
      elements.copyShareLinkBtn.addEventListener("click", () => {
        navigator.clipboard.writeText(elements.shareLinkInput.value);
        showNotification("Link copiato!", "success");
      });
      elements.closeShareModalBtn.addEventListener("click", () => closeModal(elements.shareModal));
      elements.closeViewBtn.addEventListener("click", () => { window.location.href = window.location.pathname; });
      elements.migrateSagaDataBtn.addEventListener('click', migrateExistingData);
      
      // Event Listeners for Rewatch Modal
      document.querySelectorAll('.quick-rewatch-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const count = parseInt(btn.dataset.count);
            elements.rewatchCountInput.value = count;
            updateRewatchModalButtons(count);
        });
      });
      elements.rewatchCountInput.addEventListener('input', () => {
          const count = parseInt(elements.rewatchCountInput.value);
          updateRewatchModalButtons(count);
      });
      document.querySelectorAll(".num-spinner-btn").forEach(btn => {
        btn.addEventListener("click", e => {
          const target = document.getElementById(e.currentTarget.dataset.target);
          if (target) {
            let value = parseInt(target.value) || 0;
            value += e.currentTarget.classList.contains("up") ? 1 : -1;
            const min = parseInt(target.min);
            if (!isNaN(min) && value < min) value = min;
            target.value = value;
            if (target.id === 'rewatchCountInput') {
                updateRewatchModalButtons(value);
            }
          }
        });
      });
      elements.confirmRewatchBtn.addEventListener('click', () => {
          const newCount = parseInt(elements.rewatchCountInput.value);
          if (!isNaN(newCount) && newCount >= 0) {
              markRewatch(currentRewatchMediaId, newCount);
              closeModal(elements.rewatchModal);
          } else {
              showNotification("Per favore, inserisci un numero valido (0 o superiore).", "warning");
          }
      });
      elements.cancelRewatchBtn.addEventListener('click', () => closeModal(elements.rewatchModal));
      
      // Friends & Notifications
      elements.addFriendBtn.addEventListener('click', addFriend);
      elements.bellIcon.addEventListener('click', (e) => {
          e.stopPropagation();
          elements.notificationDropdown.classList.toggle('visible');
      });
    }

    async function addFriend() {
        const friendId = elements.friendIdInput.value.trim();
        if (!friendId) return showNotification("Inserisci l'ID di un amico.", "warning");
        if (friendId === currentUser.uid) return showNotification("Non puoi aggiungere te stesso.", "warning");
        if (followedFriends.some(f => f.id === friendId)) return showNotification("Questo utente è già nella tua lista amici.", "warning");

        const friendRef = db.ref(`users/${friendId}/email`);
        try {
            const snapshot = await friendRef.once('value');
            if (snapshot.exists()) {
                const friendEmail = snapshot.val();
                followedFriends.push({ id: friendId, email: friendEmail });
                lastCheckedTimestamps[friendId] = new Date().toISOString();
                saveSocialData();
                renderFriendsList();
                showNotification(`Amico ${friendEmail} aggiunto!`, "success");
                elements.friendIdInput.value = "";
            } else {
                showNotification("ID utente non trovato.", "error");
            }
        } catch (error) {
            console.error("Error adding friend:", error);
            showNotification("Impossibile aggiungere l'amico. Controlla l'ID e riprova.", "error");
        }
    }

    function removeFriend(friendId) {
        followedFriends = followedFriends.filter(f => f.id !== friendId);
        delete lastCheckedTimestamps[friendId];
        saveSocialData();
        renderFriendsList();
        showNotification("Amico rimosso.", "success");
    }

    function renderFriendsList() {
        elements.friendsList.innerHTML = "";
        if (followedFriends.length === 0) {
            elements.friendsList.innerHTML = `<p style="text-align:center; color: var(--text-secondary);">Non stai seguendo nessun amico.</p>`;
            return;
        }
        followedFriends.forEach(friend => {
            const card = document.createElement("div");
            card.className = "management-card";
            card.innerHTML = `
                <div>
                    <div class="friend-email">${friend.email}</div>
                    <div class="friend-id">${friend.id}</div>
                </div>
                <div class="management-card-actions">
                    <button class="btn btn-danger remove-friend-btn" data-id="${friend.id}"><i class="fas fa-trash"></i></button>
                </div>`;
            card.querySelector('.remove-friend-btn').addEventListener('click', () => removeFriend(friend.id));
            elements.friendsList.appendChild(card);
        });
    }

    function showPosterModal(id) {
      const media = mediaList.find(m => m.id === id);
      if (!media || !media.imdbID) return showNotification("Nessun IMDb ID trovato per questo film.", "warning");
      elements.posterModal.dataset.mediaId = id;
      elements.posterGrid.innerHTML = "<p>Caricamento copertine...</p>";
      elements.posterModal.style.display = "flex";
      fetchPosters(media.imdbID).then(posters => {
        if (posters.length === 0) {
          elements.posterGrid.innerHTML = "<p>Nessuna copertina alternativa trovata</p>";
          return;
        }
        elements.posterGrid.innerHTML = "";
        posters.forEach(poster => {
          const option = document.createElement("div");
          option.className = "poster-option";
          option.dataset.url = poster.url;
          const img = document.createElement("img");
          img.src = poster.url;
          img.onerror = () => img.src = DEFAULT_POSTER;
          option.appendChild(img);
          option.addEventListener("click", () => {
            document.querySelectorAll(".poster-option").forEach(o => o.classList.remove("selected"));
            option.classList.add("selected");
          });
          elements.posterGrid.appendChild(option);
        });
      });
    }

    async function fetchPosters(imdbID) {
      try {
        const response = await fetch(`https://api.themoviedb.org/3/find/${imdbID}?api_key=${TMDB_KEY}&external_source=imdb_id`);
        const data = await response.json();
        const tmdbId = data.movie_results[0]?.id;
        if (!tmdbId) return [];
        const imagesResponse = await fetch(`https://api.themoviedb.org/3/movie/${tmdbId}/images?api_key=${TMDB_KEY}`);
        const imagesData = await imagesResponse.json();
        return imagesData.posters
          .slice(0, 20)
          .map(p => ({ url: `https://image.tmdb.org/t/p/w500${p.file_path}` }));
      } catch (err) {
        console.error("Error fetching posters:", err);
        return [];
      }
    }

    function changePoster(id, url) {
      const media = mediaList.find(m => m.id === id);
      if (media) {
        media.poster = url;
        saveData();
        refreshSingleMedia(id);
      }
    }
  </script>
</body>
</html>
