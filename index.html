<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MediaTracker Pro</title>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <style>
    :root {
      --primary: #3A86FF;
      --secondary: #00B4D8;
      --danger: #ff4444;
      --reset: #e74c3c;
      --success: #228b22;
      --warning: #ffcc00;
      --bg-color: #f5f5f5;
      --card-bg: white;
      --text-color: #333;
      --text-secondary: #666;
      --border-color: #e0e0e0;
    }

    body.dark {
      --bg-color: #1a1a1a;
      --card-bg: #2d2d2d;
      --text-color: #f5f5f5;
      --text-secondary: #aaa;
      --border-color: #444;
      --reset: #ff6b6b;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      padding: 1rem;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }

    .media-card {
      background: var(--card-bg);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      width: 180px;
      transition: all 0.3s ease;
      position: relative;
      border: 1px solid var(--border-color);
    }

    .media-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .media-card.moving {
      transform: scale(0.95);
      opacity: 0.5;
    }

    .media-poster {
      width: 100%;
      height: 240px;
      object-fit: cover;
      object-position: center top;
    }

    .media-info {
      padding: 0.75rem;
    }

    .media-title {
      font-size: 0.9rem;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-color);
    }

    .media-meta {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }

    .media-ratings {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.75rem;
    }

    .rewatch-badge {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: bold;
    }

    .category-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: bold;
    }

    .media-section {
      transition: all 0.3s ease;
    }

    .media-section.hidden {
      display: none !important;
    }

    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1.5rem 0 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--primary);
    }

    .section-title {
      color: var(--primary);
      margin: 0;
    }

    .category-count {
      background: var(--primary);
      color: white;
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-size: 0.8rem;
      margin-left: 0.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-reset {
      background: var(--reset);
      color: white;
    }

    .stat-item {
      background: var(--card-bg);
      padding: 0.75rem;
      border-radius: 8px;
      text-align: center;
      min-width: 80px;
      border: 1px solid var(--border-color);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-open {
      overflow: hidden;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .context-menu {
      position: fixed;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1100;
      width: 200px;
      display: none;
      border: 1px solid var(--border-color);
    }

    .context-menu-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .context-menu-item:hover {
      background: rgba(0,0,0,0.1);
    }

    .context-submenu {
      position: relative;
    }

    .context-submenu-items {
      display: none;
      position: absolute;
      left: 100%;
      top: 0;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      width: 200px;
      border: 1px solid var(--border-color);
    }

    .context-submenu:hover .context-submenu-items {
      display: block;
    }

    input, select {
      width: 100%;
      padding: 0.5rem;
      margin: 0.5rem 0;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-color);
    }

    .toolbar {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .card-actions {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      gap: 0.5rem;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .media-card:hover .card-actions {
      opacity: 1;
    }

    .modal-open .card-actions {
      display: none !important;
    }

    .card-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      cursor: pointer;
    }

    .filter-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-box {
      flex: 2;
      min-width: 200px;
    }

    .filter-select {
      flex: 1;
      min-width: 150px;
    }

    .omdb-results-container {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.5rem;
    }

    .omdb-result-item {
      padding: 0.5rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .omdb-result-item:last-child {
      border-bottom: none;
    }

    .omdb-result-item:hover {
      background: rgba(0,0,0,0.05);
    }

    .omdb-poster-small {
      width: 50px;
      height: 75px;
      object-fit: cover;
      border-radius: 4px;
    }

    .add-category-modal {
      max-width: 300px;
    }

    .category-management-modal {
      max-width: 400px;
    }

    .categories-list {
      max-height: 300px;
      overflow-y: auto;
      margin: 1rem 0;
    }

    .category-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .category-item:last-child {
      border-bottom: none;
    }

    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 1rem;
      border-radius: 8px;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .notification.error {
      background: var(--danger);
    }

    .notification.warning {
      background: var(--warning);
      color: #333;
    }

    #authContainer {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
      margin-left: auto;
    }

    #userInfo {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.5rem;
    }

    #userEmail {
      color: var(--primary);
      font-weight: bold;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      background: var(--card-bg);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      position: absolute;
      right: 1rem;
      top: 4rem;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: none;
    }

    .auth-form.active {
      display: flex;
    }

    .auth-form input {
      margin: 0;
    }

    .auth-form-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .auth-form-buttons button {
      flex: 1;
    }

    .auth-tabs {
      display: flex;
      margin-bottom: 0.5rem;
    }

    .auth-tab {
      flex: 1;
      text-align: center;
      padding: 0.5rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }

    .auth-tab.active {
      border-bottom: 2px solid var(--primary);
      font-weight: bold;
    }

    .auth-form-container {
      display: none;
    }

    .auth-form-container.active {
      display: block;
    }

    .share-dropdown {
      position: relative;
      display: inline-block;
    }

    .share-dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 100;
      width: 300px;
    }

    .share-dropdown.active .share-dropdown-content {
      display: block;
    }

    .share-link {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .share-link input {
      flex: 1;
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      background: var(--bg-color);
      color: var(--text-color);
    }

    .share-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .view-mode-banner {
      background: var(--primary);
      color: white;
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .top-bar {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .main-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-grow: 1;
      flex-wrap: wrap;
    }
    
    .user-section {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-left: auto;
    }
    
    .stats-container {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }

    .search-filters {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      flex-grow: 1;
    }

    .actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .dropdown-toggle {
      cursor: pointer;
    }
  </style>
</head>
<body class="light">
  <!-- View Mode Banner -->
  <div id="viewModeBanner" class="view-mode-banner" style="display:none">
    <i class="fas fa-eye"></i>
    <span>Stai visualizzando una lista condivisa</span>
    <button id="closeViewBtn" class="btn btn-danger" style="margin-left:auto">
      <i class="fas fa-times"></i> Chiudi
    </button>
  </div>

  <!-- Top Bar -->
  <div class="top-bar">
    <div class="main-controls">
      <input type="text" id="searchInput" class="search-box" placeholder="Cerca film...">
      <select id="categoryFilter" class="filter-select">
        <option value="all">Tutte le categorie</option>
      </select>
      <select id="sortFilter" class="filter-select">
        <option value="alpha" selected>Alfabetico</option>
        <option value="added">Ultimi aggiunti</option>
        <option value="rating">Valutazione</option>
        <option value="year">Anno di uscita</option>
      </select>
      
      <button id="addMediaBtn" class="btn btn-primary">
        <i class="fas fa-plus"></i> Aggiungi Film
      </button>
      <button id="manageCategoriesBtn" class="btn btn-secondary">
        <i class="fas fa-folder"></i>
      </button>
      
      <div class="share-dropdown" id="shareDropdown">
        <button id="shareBtn" class="btn btn-secondary dropdown-toggle">
          <i class="fas fa-share-alt"></i> 
        </button>
        <div class="share-dropdown-content">
          <h3>Condivisione attiva</h3>
          <p>Chiunque abbia questo link pu√≤ vedere la tua lista in tempo reale:</p>
          <div class="share-link">
            <input type="text" id="shareLink" readonly>
            <button id="copyLinkBtn" class="btn btn-primary">
              <i class="fas fa-copy"></i> Copia
            </button>
          </div>
          <div class="share-actions">
            <button id="disableShareBtn" class="btn btn-danger">
              <i class="fas fa-ban"></i> Disattiva
            </button>
          </div>
        </div>
      </div>
      
      <button id="exportBtn" class="btn btn-secondary">
        <i class="fas fa-download"></i> 
      </button>
      <input type="file" id="importFile" accept=".json" style="display: none;">
      <button id="importBtn" class="btn btn-secondary">
        <i class="fas fa-upload"></i> 
      </button>
      <button id="resetBtn" class="btn btn-reset">
        <i class="fas fa-undo"></i> 
      </button>
      <button id="themeToggle" class="btn">
        <i class="fas fa-moon"></i> 
      </button>
    </div>
    
    <!-- Auth Container -->
    <div id="authContainer" class="user-section">
      <div id="userInfo" style="display:none">
        <span id="userEmail"></span>
        <button id="logoutBtn" class="btn btn-danger">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
      <button id="authToggle" class="btn btn-secondary">
        <i class="fas fa-user"></i> Login
      </button>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-container">
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
      <div class="stat-item">
        <div class="stat-value" id="statTotal">0</div>
        <div>Totale</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="statWatchlist">0</div>
        <div>Da Vedere</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="statWatched">0</div>
        <div>Visti</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="statRewatched">0</div>
        <div>Rewatch</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="statHours">0h 0m</div>
        <div>Tempo Totale</div>
      </div>
    </div>
    
    <div id="authForms" class="auth-form">
      <div class="auth-tabs">
        <div class="auth-tab active" data-tab="login">Login</div>
        <div class="auth-tab" data-tab="register">Registrati</div>
      </div>
      
      <div id="loginForm" class="auth-form-container active">
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <div class="auth-form-buttons">
          <button id="loginBtn" class="btn btn-primary">
            <i class="fas fa-sign-in-alt"></i> Login
          </button>
        </div>
      </div>
      
      <div id="registerForm" class="auth-form-container">
        <input type="email" id="registerEmail" placeholder="Email">
        <input type="password" id="registerPassword" placeholder="Password (min. 6 caratteri)">
        <input type="password" id="registerConfirmPassword" placeholder="Conferma Password">
        <div class="auth-form-buttons">
          <button id="registerBtn" class="btn btn-primary">
            <i class="fas fa-user-plus"></i> Registrati
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Media Sections -->
  <div id="mediaSectionsContainer"></div>

  <!-- Modals -->
  <div class="modal" id="addMediaModal">
    <div class="modal-content">
      <h2>Aggiungi Film</h2>
      <input type="text" id="mediaTitle" placeholder="Titolo">
      <button id="searchOMDbBtn" class="btn btn-secondary">
        <i class="fas fa-search"></i> Cerca su OMDb
      </button>
      <div id="omdbResults" class="omdb-results-container"></div>
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
        <button id="saveMediaBtn" class="btn btn-primary">Salva</button>
        <button id="cancelMediaBtn" class="btn btn-danger">Annulla</button>
      </div>
    </div>
  </div>

  <div class="modal" id="categoryManagementModal">
    <div class="modal-content category-management-modal">
      <h2>Gestione Categorie</h2>
      <div class="filter-row">
        <input type="text" id="newCategoryName" placeholder="Nome categoria">
        <button id="addCategoryBtn" class="btn btn-primary">
          <i class="fas fa-plus"></i> Aggiungi
        </button>
      </div>
      <div class="categories-list" id="categoriesList"></div>
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
        <button id="closeCategoryManagementBtn" class="btn btn-danger">Chiudi</button>
      </div>
    </div>
  </div>

  <div class="modal" id="rewatchModal">
    <div class="modal-content">
      <h2>Segna Rewatch</h2>
      <p>Quante volte hai visto questo film in totale?</p>
      <input type="number" id="rewatchCount" min="1" value="1" style="width: 60px; text-align: center;">
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
        <button id="confirmRewatchBtn" class="btn btn-primary">Conferma</button>
        <button id="cancelRewatchBtn" class="btn btn-danger">Annulla</button>
      </div>
    </div>
  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="contextMenu">
    <div class="context-menu-item context-submenu">
      <i class="fas fa-folder"></i> Sposta in
      <div class="context-submenu-items" id="categorySubmenu"></div>
    </div>
    <div class="context-menu-item" id="cmRewatch">
      <i class="fas fa-redo"></i> Segna Rewatch
    </div>
    <div class="context-menu-item" id="cmDelete">
      <i class="fas fa-trash"></i> Elimina Film
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification">
    <span id="notificationText"></span>
  </div>

  <script>
    // Configurazione
    const OMDb_API_KEY = "2526ef70";
    const DEFAULT_POSTER = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiB2aWV3Qm94PSIwIDAgMzAwIDQ1MCI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZ2h0PSI0NTAiIGZpbGw9IiNkZGQiLz48dGV4dCB4PSIxNTAiIHk9IjIyNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNjY2Ij5OZXNzYSBpbWFnaW5lPC90ZXh0Pjwvc3ZnPg==";
    const DEFAULT_CATEGORIES = ["watchlist", "watched"];

    // Stato
    let mediaList = [];
    let categories = [...DEFAULT_CATEGORIES];
    let currentContextMedia = null;
    let currentRewatchMedia = null;
    let currentOMDbSelection = null;
    let currentUser = null;
    let isViewMode = false;
    let activeShareId = null;

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDm946nISfZs8ugkuYPraNTzFhvgQmnMUk",
      authDomain: "gametrackerdb.firebaseapp.com",
      databaseURL: "https://gametrackerdb-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gametrackerdb",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Elementi DOM
    const elements = {
      authContainer: document.getElementById("authContainer"),
      authForms: document.getElementById("authForms"),
      authToggle: document.getElementById("authToggle"),
      userInfo: document.getElementById("userInfo"),
      loginBtn: document.getElementById("loginBtn"),
      loginEmail: document.getElementById("loginEmail"),
      loginPassword: document.getElementById("loginPassword"),
      registerBtn: document.getElementById("registerBtn"),
      registerEmail: document.getElementById("registerEmail"),
      registerPassword: document.getElementById("registerPassword"),
      registerConfirmPassword: document.getElementById("registerConfirmPassword"),
      logoutBtn: document.getElementById("logoutBtn"),
      userEmail: document.getElementById("userEmail"),
      loginForm: document.getElementById("loginForm"),
      registerForm: document.getElementById("registerForm"),
      appContent: document.getElementById("appContent"),
      addMediaBtn: document.getElementById("addMediaBtn"),
      manageCategoriesBtn: document.getElementById("manageCategoriesBtn"),
      shareBtn: document.getElementById("shareBtn"),
      shareDropdown: document.getElementById("shareDropdown"),
      exportBtn: document.getElementById("exportBtn"),
      importBtn: document.getElementById("importBtn"),
      importFile: document.getElementById("importFile"),
      resetBtn: document.getElementById("resetBtn"),
      themeToggle: document.getElementById("themeToggle"),
      searchInput: document.getElementById("searchInput"),
      categoryFilter: document.getElementById("categoryFilter"),
      sortFilter: document.getElementById("sortFilter"),
      statTotal: document.getElementById("statTotal"),
      statWatchlist: document.getElementById("statWatchlist"),
      statWatched: document.getElementById("statWatched"),
      statRewatched: document.getElementById("statRewatched"),
      statHours: document.getElementById("statHours"),
      mediaSectionsContainer: document.getElementById("mediaSectionsContainer"),
      addMediaModal: document.getElementById("addMediaModal"),
      mediaTitle: document.getElementById("mediaTitle"),
      searchOMDbBtn: document.getElementById("searchOMDbBtn"),
      omdbResults: document.getElementById("omdbResults"),
      saveMediaBtn: document.getElementById("saveMediaBtn"),
      cancelMediaBtn: document.getElementById("cancelMediaBtn"),
      categoryManagementModal: document.getElementById("categoryManagementModal"),
      newCategoryName: document.getElementById("newCategoryName"),
      addCategoryBtn: document.getElementById("addCategoryBtn"),
      categoriesList: document.getElementById("categoriesList"),
      closeCategoryManagementBtn: document.getElementById("closeCategoryManagementBtn"),
      rewatchModal: document.getElementById("rewatchModal"),
      rewatchCount: document.getElementById("rewatchCount"),
      confirmRewatchBtn: document.getElementById("confirmRewatchBtn"),
      cancelRewatchBtn: document.getElementById("cancelRewatchBtn"),
      contextMenu: document.getElementById("contextMenu"),
      cmRewatch: document.getElementById("cmRewatch"),
      cmDelete: document.getElementById("cmDelete"),
      categorySubmenu: document.getElementById("categorySubmenu"),
      notification: document.getElementById("notification"),
      notificationText: document.getElementById("notificationText"),
      shareLink: document.getElementById("shareLink"),
      copyLinkBtn: document.getElementById("copyLinkBtn"),
      disableShareBtn: document.getElementById("disableShareBtn"),
      viewModeBanner: document.getElementById("viewModeBanner"),
      closeViewBtn: document.getElementById("closeViewBtn")
    };

    // Inizializzazione
    function init() {
      setupAuthListeners();
      setupEventListeners();
      checkSharedView();
      loadTheme();
    }

    // Autenticazione
    function setupAuthListeners() {
      elements.authToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        elements.authForms.classList.toggle('active');
      });
      
      document.addEventListener('click', (e) => {
        if (!elements.authForms.contains(e.target) && e.target !== elements.authToggle) {
          elements.authForms.classList.remove('active');
        }
      });
      
      document.querySelectorAll('.auth-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          document.querySelectorAll('.auth-form-container').forEach(form => {
            form.classList.remove('active');
          });
          document.getElementById(`${tab.dataset.tab}Form`).classList.add('active');
        });
      });
      
      elements.loginBtn.addEventListener('click', () => {
        const email = elements.loginEmail.value;
        const password = elements.loginPassword.value;
        
        if (!email || !password) {
          showNotification("Inserisci email e password", "warning");
          return;
        }
        
        firebase.auth().signInWithEmailAndPassword(email, password)
          .then(() => {
            showNotification("Login effettuato", "success");
            elements.authForms.classList.remove('active');
          })
          .catch(error => showNotification(getAuthErrorMessage(error), "error"));
      });
      
      elements.registerBtn.addEventListener('click', () => {
        const email = elements.registerEmail.value;
        const password = elements.registerPassword.value;
        const confirmPassword = elements.registerConfirmPassword.value;
        
        if (!email || !password || !confirmPassword) {
          showNotification("Compila tutti i campi", "warning");
          return;
        }
        
        if (password !== confirmPassword) {
          showNotification("Le password non corrispondono", "warning");
          return;
        }
        
        if (password.length < 6) {
          showNotification("La password deve avere almeno 6 caratteri", "warning");
          return;
        }
        
        firebase.auth().createUserWithEmailAndPassword(email, password)
          .then(() => {
            showNotification("Registrazione completata!", "success");
            elements.authForms.classList.remove('active');
          })
          .catch(error => showNotification(getAuthErrorMessage(error), "error"));
      });
      
      elements.logoutBtn.addEventListener('click', () => firebase.auth().signOut());
      
      firebase.auth().onAuthStateChanged((user) => {
        currentUser = user;
        updateAuthUI();
        
        if (user) {
          loadData();
          checkActiveShare();
        } else {
          loadLocalData();
        }
      });
    }

    function getAuthErrorMessage(error) {
      switch(error.code) {
        case 'auth/email-already-in-use': return "Email gi√† registrata";
        case 'auth/invalid-email': return "Email non valida";
        case 'auth/weak-password': return "Password troppo debole";
        case 'auth/user-not-found': return "Utente non trovato";
        case 'auth/wrong-password': return "Password errata";
        default: return "Errore: " + error.message;
      }
    }

    function updateAuthUI() {
      if (currentUser) {
        elements.userInfo.style.display = 'flex';
        elements.authToggle.style.display = 'none';
        elements.userEmail.textContent = currentUser.email;
        document.querySelectorAll('.btn').forEach(btn => btn.disabled = false);
      } else {
        elements.userInfo.style.display = 'none';
        elements.authToggle.style.display = 'block';
        elements.userEmail.textContent = '';
        document.querySelectorAll('#addMediaBtn, #manageCategoriesBtn, #exportBtn, #importBtn, #resetBtn, #shareBtn').forEach(btn => {
          btn.disabled = true;
        });
      }
    }

    // Caricamento dati
function loadData() {
  if (!currentUser) return;
  
  db.ref(`users/${currentUser.uid}/mediaList`).on('value', snapshot => {
    mediaList = snapshot.val() || [];
    renderMedia(); // Chiamata aggiuntiva per forzare il rendering
    updateStats();
  });
  
  db.ref(`users/${currentUser.uid}/categories`).once('value').then(snapshot => {
    categories = snapshot.val() || [...DEFAULT_CATEGORIES];
    updateCategoryFilter();
    updateCategorySubmenu();
    renderCategorySections();
    renderMedia(); // Aggiungi questa linea
  });
}

    function loadLocalData() {
      try {
        mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
        categories = JSON.parse(localStorage.getItem("categories")) || [...DEFAULT_CATEGORIES];
        renderMedia();
        updateStats();
        updateCategoryFilter();
        updateCategorySubmenu();
        renderCategorySections();
      } catch (e) {
        console.error("Error loading local data:", e);
      }
    }

    function saveData() {
      if (!currentUser) {
        saveToLocal();
        return;
      }
      
      db.ref(`users/${currentUser.uid}/mediaList`).set(mediaList)
        .then(() => db.ref(`users/${currentUser.uid}/categories`).set(categories))
        .then(() => saveToLocal())
        .catch(error => {
          console.error("Error saving to Firebase:", error);
          saveToLocal();
        });
    }

    function saveToLocal() {
      try {
        localStorage.setItem("mediaList", JSON.stringify(mediaList));
        localStorage.setItem("categories", JSON.stringify(categories));
      } catch (e) {
        console.error("Error saving locally:", e);
      }
    }

    // Condivisione
    function checkSharedView() {
      const urlParams = new URLSearchParams(window.location.search);
      const uid = urlParams.get('uid');
      const share = urlParams.get('share');

      if (uid && share) {
        enableViewMode(uid, share);
      }
    }

    function enableViewMode(uid, shareKey) {
      isViewMode = true;
      
      // Nascondi elementi di modifica
      document.querySelectorAll('.btn').forEach(btn => btn.style.display = 'none');
      elements.authContainer.style.display = 'none';
      elements.viewModeBanner.style.display = 'flex';
      
      // Carica i media condivisi
      db.ref(`users/${uid}/mediaList`).on('value', snapshot => {
        mediaList = snapshot.val() || [];
        renderMedia();
        updateStats();
      });
    }

    function closeViewMode() {
      window.location.href = window.location.pathname;
    }

    function checkActiveShare() {
      if (!currentUser) return;
      
      db.ref(`users/${currentUser.uid}/activeShare`).once('value').then(snapshot => {
        const shareId = snapshot.val();
        if (shareId) {
          activeShareId = shareId;
          updateShareLink(shareId);
        }
      });
    }
    
function updateShareLink(shareId) {
  if (!shareId) return;
  const shareLink = `${window.location.origin}${window.location.pathname}?uid=${currentUser.uid}&share=${shareId}`;
  elements.shareLink.value = shareLink;
  elements.shareDropdown.classList.add('active'); // Apri il dropdown automaticamente
}

function activateSharing() {
  if (!currentUser) return;

  // Se esiste gi√† un activeShareId, riutilizzalo invece di crearne uno nuovo
  const shareId = activeShareId || generateId();
  
  db.ref(`users/${currentUser.uid}/activeShare`).set(shareId)
    .then(() => {
      activeShareId = shareId;
      updateShareLink(shareId);
      showNotification("Condivisione attivata", "success");
    });
}

function deactivateSharing() {
  if (!currentUser || !activeShareId) return;
  
  db.ref(`users/${currentUser.uid}/activeShare`).remove()
    .then(() => {
      activeShareId = null;
      // Non svuotare pi√π il campo, ma mantieni l'ultimo link (solo visualizzazione)
      showNotification("Condivisione disattivata", "success");
    })
    .catch(error => {
      showNotification("Errore nella disattivazione", "error");
    });
}

    function updateShareLink(shareId) {
      const shareLink = `${window.location.origin}${window.location.pathname}?uid=${currentUser.uid}&share=${shareId}`;
      elements.shareLink.value = shareLink;
    }

    function generateId() {
      return Math.random().toString(36).substring(2, 15);
    }

    // Media functions
function renderMedia() {
  clearMediaGrids();
  updateStats();

  const searchTerm = elements.searchInput.value.toLowerCase();
  const filterCategory = elements.categoryFilter.value;
  const sortBy = elements.sortFilter.value;

  // Mostra TUTTE le sezioni inizialmente (rimosso il nascondi iniziale)
  document.querySelectorAll('.media-section').forEach(section => {
    section.style.display = 'block'; // Mostra sempre le sezioni
  });

  let filteredMedia = [...mediaList];
  
  if (searchTerm) {
    filteredMedia = filteredMedia.filter(media => 
      media.title.toLowerCase().includes(searchTerm)
    );
  }
  
  if (filterCategory !== "all") {
    filteredMedia = filteredMedia.filter(media => 
      media.category === filterCategory
    );
    
    // Nascondi solo le sezioni non filtrate
    document.querySelectorAll('.media-section').forEach(section => {
      if (section.dataset.category !== filterCategory) {
        section.style.display = 'none';
      }
    });
  }
  
  filteredMedia.sort((a, b) => {
    switch(sortBy) {
      case "alpha": return a.title.localeCompare(b.title);
      case "rating": return (parseFloat(b.imdbRating) || 0) - (parseFloat(a.imdbRating) || 0);
      case "year": return (parseInt(b.year) || 0) - (parseInt(a.year) || 0);
      case "added":
      default: return new Date(b.addedAt) - new Date(a.addedAt);
    }
  });

  filteredMedia.forEach(media => {
    const grid = document.getElementById(`${media.category}Grid`);
    if (grid) {
      const existingCard = grid.querySelector(`.media-card[data-id="${media.id}"]`);
      if (!existingCard) {
        grid.appendChild(createMediaCard(media));
      }
    }
  });

  updateCounts();
}

    function clearMediaGrids() {
      categories.forEach(category => {
        const grid = document.getElementById(`${category}Grid`);
        if (grid) grid.innerHTML = "";
      });
    }

    function updateStats() {
      let stats = {
        total: mediaList.length,
        watchlist: 0,
        watched: 0,
        rewatched: 0,
        hours: 0,
        minutes: 0
      };

      mediaList.forEach(media => {
        if (media.category === "watchlist") stats.watchlist++;
        if (media.category === "watched") stats.watched++;
        if (media.rewatchCount > 1) stats.rewatched++;

        if (media.category === "watched") {
          const runtime = media.runtime ? parseInt(media.runtime.toString().replace(/\D/g, '')) : 0;
          if (runtime > 0) {
            const totalMinutes = runtime * (media.rewatchCount || 1);
            stats.minutes += totalMinutes;
          }
        }
      });

      stats.hours = Math.floor(stats.minutes / 60);
      stats.minutes = stats.minutes % 60;

      elements.statTotal.textContent = stats.total;
      elements.statWatchlist.textContent = stats.watchlist;
      elements.statWatched.textContent = stats.watched;
      elements.statRewatched.textContent = stats.rewatched;
      elements.statHours.textContent = `${stats.hours}h ${stats.minutes}m`;
    }

    function updateCounts() {
      categories.forEach(category => {
        const countElement = document.getElementById(`${category}Count`);
        if (countElement) {
          const count = mediaList.filter(m => m.category === category).length;
          countElement.textContent = count;
          
          const section = document.getElementById(`${category}Section`);
          if (section && elements.categoryFilter.value !== 'all' && count === 0) {
            section.style.display = 'none';
          }
        }
      });
    }

    function createMediaCard(media) {
      const card = document.createElement("div");
      card.className = "media-card";
      card.dataset.id = media.id;
      
      const ratingsHTML = media.imdbRating || media.rottenTomatoes ? `
        <div class="media-ratings">
          ${media.imdbRating ? `<span>‚≠ê ${media.imdbRating}</span>` : ''}
          ${media.rottenTomatoes ? `<span>üçÖ ${media.rottenTomatoes}</span>` : ''}
        </div>
      ` : '';

      const rewatchHTML = media.rewatchCount > 1 ? `
        <span class="rewatch-badge">
          üîÑ√ó${media.rewatchCount}
        </span>
      ` : '';

      const categoryHTML = !DEFAULT_CATEGORIES.includes(media.category) ? `
        <span class="category-badge">
          ${media.category}
        </span>
      ` : '';

      card.innerHTML = `
        <div style="position:relative;">
          <img src="${fixPosterUrl(media.poster) || DEFAULT_POSTER}" class="media-poster" 
               onerror="this.src='${DEFAULT_POSTER}'">
          ${rewatchHTML}
          ${categoryHTML}
          <div class="card-actions">
            <button class="card-btn" data-action="edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="card-btn" data-action="delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="media-info">
          <h3 class="media-title" title="${media.title}">${media.title}</h3>
          <div class="media-meta">
            ${media.year ? `<span>${media.year}</span>` : ''}
            ${media.runtime ? `<span>‚è±Ô∏è ${media.runtime}</span>` : ''}
          </div>
          ${ratingsHTML}
        </div>
      `;

      card.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        showContextMenu(media, e.clientX, e.clientY);
      });

      card.querySelector("[data-action='edit']").addEventListener("click", (e) => {
        e.stopPropagation();
        editMedia(media.id);
      });

      card.querySelector("[data-action='delete']").addEventListener("click", (e) => {
        e.stopPropagation();
        deleteMedia(media.id);
      });

      return card;
    }

    function fixPosterUrl(url) {
      if (!url || url === "N/A") return null;
      if (url.startsWith("http://") || url.startsWith("https://")) {
        return url;
      }
      if (url.startsWith("//")) {
        return `https:${url}`;
      }
      return `https://${url}`;
    }

    // Categories
function renderCategorySections() {
  elements.mediaSectionsContainer.innerHTML = categories.map(category => `
    <div class="media-section" id="${category}Section" data-category="${category}" style="display:block">
      <div class="section-header">
        <h2 class="section-title">${getCategoryName(category)}</h2>
        <span id="${category}Count" class="category-count">0</span>
      </div>
      <div class="media-grid" id="${category}Grid"></div>
    </div>
  `).join("");
}
    function renderCategoriesList() {
      elements.categoriesList.innerHTML = categories
        .map((category, idx) => `
          <div class="category-item">
            <span>${getCategoryName(category)}</span>
            <div style="display: flex; gap: 0.2rem;">
              ${!DEFAULT_CATEGORIES.includes(category) ?
                `<button class="btn btn-danger delete-category-btn" data-category="${category}">
                  <i class="fas fa-trash"></i>
                </button>` : ''}
              <button class="btn btn-secondary move-up-btn" data-category="${category}" ${idx === 0 ? 'disabled' : ''}>
                <i class="fas fa-arrow-up"></i>
              </button>
              <button class="btn btn-secondary move-down-btn" data-category="${category}" ${idx === categories.length - 1 ? 'disabled' : ''}>
                <i class="fas fa-arrow-down"></i>
              </button>
            </div>
          </div>
        `).join("");
      
      document.querySelectorAll(".delete-category-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const category = btn.dataset.category;
          deleteCategory(category);
        });
      });
      
      document.querySelectorAll(".move-up-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          moveCategory(btn.dataset.category, -1);
        });
      });
      
      document.querySelectorAll(".move-down-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          moveCategory(btn.dataset.category, 1);
        });
      });
    }

    function moveCategory(category, direction) {
      const idx = categories.indexOf(category);
      const newIndex = idx + direction;
      if (newIndex < 0 || newIndex >= categories.length) return;

      [categories[idx], categories[newIndex]] = [categories[newIndex], categories[idx]];
      saveData();
      renderCategoriesList();
      renderCategorySections();
      renderMedia();
    }

    function updateCategoryFilter() {
      elements.categoryFilter.innerHTML = `
        <option value="all">Tutte le categorie</option>
        ${categories.map(cat => `
          <option value="${cat}">${getCategoryName(cat)}</option>
        `).join("")}
      `;
    }

    function updateCategorySubmenu() {
      elements.categorySubmenu.innerHTML = categories.map(cat => `
        <div class="context-menu-item" data-category="${cat}">${getCategoryName(cat)}</div>
      `).join("");
    }

    function getCategoryName(category) {
      const names = {
        watchlist: "Da Vedere",
        watched: "Visti"
      };
      return names[category] || category;
    }

    function addCategory(name) {
      if (!name) {
        showNotification("Inserisci un nome per la categoria", "warning");
        return false;
      }

      const normalizedName = name.trim();
      
      if (categories.some(cat => cat.toLowerCase() === normalizedName.toLowerCase())) {
        showNotification("Questa categoria esiste gi√†", "warning");
        return false;
      }

      categories.push(normalizedName);
      saveData();
      renderMedia();
      renderCategoriesList();
      showNotification(`Categoria "${normalizedName}" creata`, "success");
      return true;
    }

    function deleteCategory(category) {
      if (DEFAULT_CATEGORIES.includes(category)) {
        showNotification("Non puoi eliminare questa categoria predefinita", "warning");
        return;
      }

      if (!confirm(`Eliminare la categoria "${category}"? Tutti i film verranno spostati in "Da Vedere".`)) return;
      
      mediaList.forEach(media => {
        if (media.category === category) {
          media.category = "watchlist";
        }
      });
      
      categories = categories.filter(c => c !== category);
      saveData();
      renderCategoriesList();
      renderMedia();
      showNotification(`Categoria "${category}" eliminata`, "success");
    }

    // Media actions
    function showContextMenu(media, x, y) {
      if (isViewMode) return;
      
      currentContextMedia = media;
      
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      const menuWidth = 200;
      const menuHeight = 120;
      
      const adjustedX = x + menuWidth > viewportWidth ? viewportWidth - menuWidth : x;
      const adjustedY = y + menuHeight > viewportHeight ? viewportHeight - menuHeight : y;
      
      elements.contextMenu.style.left = `${adjustedX}px`;
      elements.contextMenu.style.top = `${adjustedY}px`;
      elements.contextMenu.style.display = "block";
    }

    function closeContextMenu() {
      elements.contextMenu.style.display = "none";
      currentContextMedia = null;
    }

    function moveMediaToCategory(mediaId, category) {
      const media = mediaList.find(m => m.id === mediaId);
      if (!media) return;

      const card = document.querySelector(`.media-card[data-id="${mediaId}"]`);
      if (card) {
        card.classList.add('moving');
      }

      setTimeout(() => {
        media.category = category;
        saveData();
        renderMedia();
        showNotification(`Film spostato in "${category}"`, "success");
      }, 300);
    }

    function markRewatch(mediaId, count) {
      const media = mediaList.find(m => m.id === mediaId);
      if (!media) return;

      if (media.category !== "watched") {
        media.category = "watched";
      }

      media.rewatchCount = count;
      saveData();
      
      refreshSingleMedia(mediaId);
      updateStats();
      showNotification(`Film visto ${count} ${count === 1 ? 'volta' : 'volte'}`, "success");
    }

    function refreshSingleMedia(mediaId) {
      const media = mediaList.find(m => m.id === mediaId);
      if (!media) return;

      // Remove from all grids
      document.querySelectorAll('.media-grid').forEach(grid => {
        const card = grid.querySelector(`.media-card[data-id="${mediaId}"]`);
        if (card) card.remove();
      });

      // Add to correct grid
      const grid = document.getElementById(`${media.category}Grid`);
      if (grid) {
        grid.appendChild(createMediaCard(media));
      }
      
      updateCounts();
    }

    function editMedia(mediaId) {
      if (isViewMode) return;
      
      const media = mediaList.find(m => m.id === mediaId);
      if (!media) return;

      elements.mediaTitle.value = media.title;
      elements.addMediaModal.style.display = "flex";
      document.body.classList.add("modal-open");

      elements.saveMediaBtn.textContent = "Aggiorna";
      elements.saveMediaBtn.onclick = () => {
        media.title = elements.mediaTitle.value.trim();
        saveData();
        closeModal(elements.addMediaModal);
        refreshSingleMedia(mediaId);
        showNotification("Film aggiornato", "success");
      };
    }

    function deleteMedia(id) {
      if (isViewMode) return;
      
      if (!confirm("Eliminare questo film dalla lista?")) return;
      
      mediaList = mediaList.filter(m => m.id !== id);
      saveData();
      renderMedia();
      showNotification("Film eliminato", "success");
    }

    // Modals
    function closeModal(modal) {
      modal.style.display = "none";
      document.body.classList.remove("modal-open");
      elements.mediaTitle.value = "";
      elements.omdbResults.innerHTML = "";
      currentOMDbSelection = null;
    }

    // OMDb
    async function searchOMDb() {
      const title = elements.mediaTitle.value.trim();

      if (!title) {
        showNotification("Inserisci un titolo", "warning");
        return;
      }

      try {
        elements.omdbResults.innerHTML = "<p>Ricerca in corso...</p>";
        const response = await fetch(
          `https://www.omdbapi.com/?apikey=${OMDb_API_KEY}&s=${encodeURIComponent(title)}&type=movie`
        );
        const data = await response.json();

        if (data.Response === "False") {
          elements.omdbResults.innerHTML = `<p>${data.Error || "Nessun risultato trovato"}</p>`;
          return;
        }

        displayOMDbResults(data.Search);
      } catch (error) {
        showNotification("Errore nella ricerca", "error");
        console.error("OMDb error:", error);
        elements.omdbResults.innerHTML = "<p>Errore durante la ricerca</p>";
      }
    }

    function displayOMDbResults(results) {
      elements.omdbResults.innerHTML = results.map(movie => `
        <div class="omdb-result-item" data-id="${movie.imdbID}">
          <img src="${fixPosterUrl(movie.Poster)}" 
               class="omdb-poster-small"
               onerror="this.src='${DEFAULT_POSTER}'">
          <div>
            <div><strong>${movie.Title}</strong></div>
            <div>${movie.Year}</div>
          </div>
        </div>
      `).join("");

      document.querySelectorAll(".omdb-result-item").forEach(item => {
        item.addEventListener("click", async () => {
          const imdbID = item.dataset.id;
          const movie = await getOMDbMovieDetails(imdbID);
          if (movie) {
            currentOMDbSelection = movie;
            elements.mediaTitle.value = movie.Title;
            showNotification(`Dettagli di "${movie.Title}" pronti per il salvataggio`, "success");
          }
        });
      });
    }

    async function getOMDbMovieDetails(imdbID) {
      try {
        const response = await fetch(
          `https://www.omdbapi.com/?apikey=${OMDb_API_KEY}&i=${imdbID}`
        );
        const data = await response.json();
        
        if (data.Response === "False") {
          throw new Error(data.Error || "Dettagli non disponibili");
        }
        
        return data;
      } catch (error) {
        console.error("Error fetching movie details:", error);
        showNotification("Errore nel caricamento dei dettagli", "error");
        return null;
      }
    }

    function addNewMedia() {
      if (isViewMode) return;
      
      const title = elements.mediaTitle.value.trim();

      if (!title) {
        showNotification("Inserisci un titolo", "warning");
        return;
      }

      let mediaData = {
        id: Date.now().toString(),
        title,
        category: "watchlist",
        addedAt: new Date().toISOString(),
        poster: "",
        rewatchCount: 0,
        year: "",
        imdbRating: "",
        rottenTomatoes: "",
        runtime: ""
      };

      if (currentOMDbSelection) {
        mediaData = {
          ...mediaData,
          title: currentOMDbSelection.Title,
          year: currentOMDbSelection.Year,
          poster: fixPosterUrl(currentOMDbSelection.Poster),
          imdbRating: currentOMDbSelection.imdbRating,
          runtime: currentOMDbSelection.Runtime || "",
        };

        if (currentOMDbSelection.Ratings) {
          const rtRating = currentOMDbSelection.Ratings.find(r => r.Source === "Rotten Tomatoes");
          if (rtRating) {
            mediaData.rottenTomatoes = rtRating.Value;
          }
        }
      }

      mediaList.push(mediaData);
      saveData();
      closeModal(elements.addMediaModal);
      renderMedia();
      showNotification(`Film "${mediaData.title}" aggiunto!`, "success");
    }

    // Import/Export
    function exportData() {
      if (isViewMode) return;
      
      const data = {
        mediaList,
        categories,
        exportedAt: new Date().toISOString()
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `mediatracker_export_${new Date().toISOString().split("T")[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      showNotification("Dati esportati", "success");
    }

    function importData(file) {
      if (isViewMode || !file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (!Array.isArray(data.mediaList)) throw new Error("Formato file non valido");

          if (confirm(`Importare ${data.mediaList.length} media? I dati attuali verranno sovrascritti.`)) {
            mediaList = data.mediaList;
            categories = data.categories || [...DEFAULT_CATEGORIES];
            saveData();
            renderMedia();
            showNotification("Dati importati con successo", "success");
          }
        } catch (error) {
          showNotification("Errore nell'importazione: " + error.message, "error");
        }
      };
      reader.readAsText(file);
    }

    // Reset
    function resetApp() {
      if (isViewMode) return;
      
      if (confirm("Resettare completamente l'applicazione? Tutti i dati verranno persi.")) {
        mediaList = [];
        categories = [...DEFAULT_CATEGORIES];
        saveData();
        elements.searchInput.value = "";
        elements.categoryFilter.value = "all";
        elements.sortFilter.value = "alpha";
        renderMedia();
        showNotification("Applicazione resettata", "success");
      }
    }

    // Theme
    function loadTheme() {
      const savedTheme = localStorage.getItem("theme") || "light";
      document.body.classList.toggle("dark", savedTheme === "dark");
      elements.themeToggle.innerHTML = `
        <i class="fas fa-${savedTheme === "dark" ? "sun" : "moon"}"></i> Tema
      `;
    }

    function toggleTheme() {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      
      elements.themeToggle.innerHTML = `
        <i class="fas fa-${isDark ? "sun" : "moon"}"></i> Tema
      `;
    }

    // Category management
    function openCategoryManagement() {
      if (isViewMode) return;
      
      renderCategoriesList();
      elements.categoryManagementModal.style.display = "flex";
      document.body.classList.add("modal-open");
    }

    // Notification
    function showNotification(message, type = "success") {
      elements.notificationText.textContent = message;
      elements.notification.className = `notification ${type}`;
      elements.notification.style.display = "block";

      setTimeout(() => {
        elements.notification.style.display = "none";
      }, 3000);
    }

    // Setup event listeners
    function setupEventListeners() {
      // Media actions
      elements.addMediaBtn.addEventListener("click", () => {
        elements.mediaTitle.value = "";
        elements.omdbResults.innerHTML = "";
        elements.saveMediaBtn.textContent = "Salva";
        elements.saveMediaBtn.onclick = addNewMedia;
        elements.addMediaModal.style.display = "flex";
        document.body.classList.add("modal-open");
      });

      elements.manageCategoriesBtn.addEventListener("click", openCategoryManagement);

      elements.addCategoryBtn.addEventListener("click", () => {
        if (addCategory(elements.newCategoryName.value)) {
          elements.newCategoryName.value = "";
        }
      });

      elements.closeCategoryManagementBtn.addEventListener("click", () => {
        closeModal(elements.categoryManagementModal);
      });

      elements.cancelMediaBtn.addEventListener("click", () => {
        closeModal(elements.addMediaModal);
      });

      elements.searchOMDbBtn.addEventListener("click", searchOMDb);

      // Context menu
      document.addEventListener("click", (e) => {
        if (
          elements.contextMenu.style.display === "block" &&
          e.target.closest("#categorySubmenu") &&
          e.target.closest("[data-category]")
        ) {
          const category = e.target.closest("[data-category]").dataset.category;
          if (currentContextMedia) {
            moveMediaToCategory(currentContextMedia.id, category);
          }
          closeContextMenu();
        } else {
          closeContextMenu();
        }
      });

      elements.cmRewatch.addEventListener("click", () => {
        if (!currentContextMedia || isViewMode) return;
        currentRewatchMedia = currentContextMedia;
        elements.rewatchCount.value = currentRewatchMedia.rewatchCount || 1;
        elements.rewatchModal.style.display = "flex";
        document.body.classList.add("modal-open");
        closeContextMenu();
      });

      elements.cmDelete.addEventListener("click", () => {
        if (!currentContextMedia || isViewMode) return;
        deleteMedia(currentContextMedia.id);
        closeContextMenu();
      });

      // Rewatch modal
      elements.confirmRewatchBtn.addEventListener("click", () => {
        const count = parseInt(elements.rewatchCount.value) || 1;
        if (count <= 0) {
          showNotification("Inserisci un numero valido (almeno 1)", "warning");
          return;
        }
        markRewatch(currentRewatchMedia.id, count);
        closeModal(elements.rewatchModal);
      });

      elements.cancelRewatchBtn.addEventListener("click", () => {
        closeModal(elements.rewatchModal);
      });

      // Close modals when clicking outside
      elements.addMediaModal.addEventListener("click", (e) => {
        if (e.target === elements.addMediaModal) {
          closeModal(elements.addMediaModal);
        }
      });

      elements.categoryManagementModal.addEventListener("click", (e) => {
        if (e.target === elements.categoryManagementModal) {
          closeModal(elements.categoryManagementModal);
        }
      });

      elements.rewatchModal.addEventListener("click", (e) => {
        if (e.target === elements.rewatchModal) {
          closeModal(elements.rewatchModal);
        }
      });

      // Import/Export
      elements.exportBtn.addEventListener("click", exportData);
      elements.importBtn.addEventListener("click", () => elements.importFile.click());
      elements.importFile.addEventListener("change", (e) => importData(e.target.files[0]));

      // Reset
      elements.resetBtn.addEventListener("click", resetApp);

      // Theme
      elements.themeToggle.addEventListener("click", toggleTheme);

      // Filters and search
      elements.searchInput.addEventListener("input", renderMedia);
      elements.categoryFilter.addEventListener("change", renderMedia);
      elements.sortFilter.addEventListener("change", renderMedia);

      // Sharing
elements.shareBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  
  if (activeShareId) {
    // Se la condivisione √® gi√† attiva, mostra semplicemente il dropdown
    elements.shareDropdown.classList.toggle('active');
  } else {
    // Se non attiva, riattivala
    activateSharing();
    showNotification(activeShareId ? "Condivisione riattivata" : "Condivisione attivata", "success");
  }
});

      document.addEventListener('click', (e) => {
        if (!elements.shareDropdown.contains(e.target)) {
          elements.shareDropdown.classList.remove('active');
        }
      });

      elements.copyLinkBtn.addEventListener("click", () => {
        navigator.clipboard.writeText(elements.shareLink.value);
        showNotification("Link copiato!", "success");
      });
      
      elements.disableShareBtn.addEventListener("click", () => {
        deactivateSharing();
        elements.shareDropdown.classList.remove('active');
      });
      
      elements.closeViewBtn.addEventListener("click", closeViewMode);
    }

    // Start the app
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
