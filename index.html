<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Film Tracker</title>

  <!-- Icona per segnalibri (Favicon) -->
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path fill='%233A86FF' d='M0 96C0 60.7 28.7 32 64 32H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zM48 368v32c0 8.8 7.2 16 16 16H96c8.8 0 16-7.2 16-16V368c0-8.8-7.2-16-16-16H64c-8.8 0-16 7.2-16 16zm368-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V368c0-8.8-7.2-16-16-16H416zM48 240v32c0 8.8 7.2 16 16 16H96c8.8 0 16-7.2 16-16V240c0-8.8-7.2-16-16-16H64c-8.8 0-16 7.2-16 16zm368-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V240c0-8.8-7.2-16-16-16H416zM48 112v32c0 8.8 7.2 16 16 16H96c8.8 0 16-7.2 16-16V112c0-8.8-7.2-16-16-16H64c-8.8 0-16 7.2-16 16zm368-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V112c0-8.8-7.2-16-16-16H416zM128 128v64c0 17.7 14.3 32 32 32H352c17.7 0 32-14.3 32-32V128c0-17.7-14.3-32-32-32H160c-17.7 0-32 14.3-32 32zm32 128c-17.7 0-32 14.3-32 32v64c0 17.7 14.3 32 32 32H352c17.7 0 32-14.3 32-32V288c0-17.7-14.3-32-32-32H160z'/></svg>">

  <!-- Icona per Apple devices -->
  <link rel="apple-touch-icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path fill='%233A86FF' d='M0 96C0 60.7 28.7 32 64 32H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zM48 368v32c0 8.8 7.2 16 16 16H96c8.8 0 16-7.2 16-16V368c0-8.8-7.2-16-16-16H64c-8.8 0-16 7.2-16 16zm368-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V368c0-8.8-7.2-16-16-16H416zM48 240v32c0 8.8 7.2 16 16 16H96c8.8 0 16-7.2 16-16V240c0-8.8-7.2-16-16-16H64c-8.8 0-16 7.2-16 16zm368-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V240c0-8.8-7.2-16-16-16H416zM48 112v32c0 8.8 7.2 16 16 16H96c8.8 0 16-7.2 16-16V112c0-8.8-7.2-16-16-16H64c-8.8 0-16 7.2-16 16zm368-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V112c0-8.8-7.2-16-16-16H416zM128 128v64c0 17.7 14.3 32 32 32H352c17.7 0 32-14.3 32-32V128c0-17.7-14.3-32-32-32H160c-17.7 0-32 14.3-32 32zm32 128c-17.7 0-32 14.3-32 32v64c0 17.7 14.3 32 32 32H352c17.7 0 32-14.3 32-32V288c0-17.7-14.3-32-32-32H160z'/></svg>">

  <!-- Icona per Windows -->
  <meta name="msapplication-TileImage"
    content="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path fill='%233A86FF' d='M0 96C0 60.7 28.7 32 64 32H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zM48 368v32c0 8.8 7.2 16 16 16H96c8.8 0 16-7.2 16-16V368c0-8.8-7.2-16-16-16H64c-8.8 0-16 7.2-16 16zm368-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V368c0-8.8-7.2-16-16-16H416zM48 240v32c0 8.8 7.2 16 16 16H96c8.8 0 16-7.2 16-16V240c0-8.8-7.2-16-16-16H64c-8.8 0-16 7.2-16 16zm368-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V240c0-8.8-7.2-16-16-16H416zM48 112v32c0 8.8 7.2 16 16 16H96c8.8 0 16-7.2 16-16V112c0-8.8-7.2-16-16-16H64c-8.8 0-16 7.2-16 16zm368-16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h32c8.8 0 16-7.2 16-16V112c0-8.8-7.2-16-16-16H416zM128 128v64c0 17.7 14.3 32 32 32H352c17.7 0 32-14.3 32-32V128c0-17.7-14.3-32-32-32H160c-17.7 0-32 14.3-32 32zm32 128c-17.7 0-32 14.3-32 32v64c0 17.7 14.3 32 32 32H352c17.7 0 32-14.3 32-32V288c0-17.7-14.3-32-32-32H160z'/></svg>">

  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <!-- Chart.js per Statistiche Avanzate -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #3A86FF;
      --secondary: #00B4D8;
      --danger: #ff4444;
      --reset: #e74c3c;
      --success: #228b22;
      --warning: #ffbe0b;
      --bg-color: #f4f7fa;
      --card-bg: white;
      --text-color: #1a1a1a;
      --text-secondary: #666;
      --border-color: #e0e0e0;
      --section-tint: rgba(58, 134, 255, 0.05);
      --tv-accent: #2a9d8f;
      /* Colore per notifiche TV Show */
    }

    body.dark {
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-color: #f5f5f5;
      --text-secondary: #aaa;
      --border-color: #333;
      --section-tint: rgba(58, 134, 255, 0.08);
    }

    html {
      scroll-behavior: smooth;
    }

    /* Rendi la barra di scorrimento più sottile e moderna (stile app) */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-color);
    }

    ::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }

    .tracker-switch {
      display: flex;
      background-color: rgba(128, 128, 128, 0.1);
      border-radius: 8px;
      padding: 4px;
      border: 1px solid var(--border-color);
    }

    .tracker-switch-btn {
      padding: 0.25rem 0.75rem;
      text-decoration: none;
      color: var(--text-secondary);
      border-radius: 6px;
      transition: all 0.2s ease;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .tracker-switch-btn.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .tracker-switch-btn:not(.active):hover {
      background-color: var(--section-tint);
      color: var(--text-color);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-spinner {
      animation: spin 1s linear infinite;
    }

    .user-select-none {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }

    #appLoader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-color);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      transition: opacity 0.3s;
    }

    #appLoader i {
      font-size: 3rem;
      color: var(--primary);
    }

    .top-bar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(30, 30, 30, 0.8);
      /* Colore scuro semi-trasparente */
      backdrop-filter: blur(15px);
      /* Sfocatura dello sfondo */
      -webkit-backdrop-filter: blur(15px);
      border-bottom: 1px solid var(--border-color);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .top-bar-left {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .top-bar-left h1 {
      margin: 0;
      font-size: 1.75rem;
      letter-spacing: -1px;
      color: var(--primary);
    }

    .top-bar-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .search-box {
      max-width: 300px;
    }

    .filter-select {
      max-width: 180px;
    }

    .stats-panel {
      background-color: var(--section-tint);
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 2rem;
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 1rem;
    }

    .stat-item {
      background: var(--card-bg);
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      border: 1px solid var(--border-color);
      transition: background 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      position: relative;
    }

    .stat-item:hover {
      background: rgba(58, 134, 255, 0.1);
    }

    .stat-icon {
      font-size: 1.8rem;
      color: var(--primary);
      margin-bottom: 0.25rem;
    }

    .stat-name {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-color);
      line-height: 1;
    }

    /* Mobile: Hide text labels, keep icons */
    @media (max-width: 768px) {
      .stat-name {
        display: none;
      }

      .stat-icon {
        font-size: 1.5rem;
        margin-bottom: 0;
      }

      .stat-value {
        font-size: 1.2rem;
      }

      .stat-item {
        padding: 0.75rem;
        gap: 0.25rem;
      }
    }

    .media-card {
      background: var(--card-bg);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      width: 180px;
      transition: transform 0.2s cubic-bezier(0.2, 0, 0, 1), box-shadow 0.2s;
      position: relative;
      border: 1px solid var(--border-color);
      animation: fadeIn 0.5s ease-out both;
      cursor: pointer;
      display: flex;
      flex-direction: column;
    }

    .media-card:hover {
      transform: translateY(-5px) scale(1.02);
      /* Sale e si ingrandisce leggermente */
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .media-card.is-stat-contributor {
      border-top: 2px dashed var(--primary);
    }

    .media-card.is-duplicate {
      opacity: 0.65;
    }

    .media-poster {
      width: 100%;
      aspect-ratio: 2 / 3;
      object-fit: cover;
      object-position: center top;
      background-color: var(--border-color);
      display: block;
    }

    .media-info {
      padding: 0.75rem;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .media-title {
      font-size: 0.9rem;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-color);
      font-weight: 600;
    }

    .media-meta {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .media-ratings {
      display: flex;
      gap: 0.25rem;
      margin-top: 0.5rem;
      flex-wrap: nowrap;
    }

    .rating-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      background: rgba(0, 0, 0, 0.05);
      padding: 0.2rem 0.4rem;
      border-radius: 12px;
      font-size: 0.75rem;
    }

    body.dark .rating-badge {
      background: rgba(255, 255, 255, 0.08);
    }

    .rating-icon {
      width: 14px;
      height: 14px;
      object-fit: contain;
    }

    .card-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      opacity: 0;
      transform: translateX(10px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
    }

    .media-card:hover .card-actions {
      opacity: 1;
      transform: translateX(0);
      pointer-events: all;
    }

    .card-btn {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
      transition: background 0.2s;
    }

    .card-btn:hover {
      background: rgba(0, 0, 0, 0.8);
    }

    .favorite-btn {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 30px;
      height: 30px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      opacity: 0;
    }

    .media-card:hover .favorite-btn {
      opacity: 1;
    }

    .favorite-btn.is-favorite {
      background: rgba(255, 255, 255, 0.8);
      opacity: 1;
    }

    .favorite-btn i {
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .favorite-btn.is-favorite i {
      transform: scale(1.3);
      color: #e74c3c;
    }

    .media-section {
      background: var(--section-tint);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: opacity 0.4s, transform 0.4s;
    }

    .media-section.hidden {
      opacity: 0;
      transform: scale(0.98);
      height: 0;
      overflow: hidden;
      margin: 0;
      padding: 0;
      pointer-events: none;
    }

    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 0 0 1rem 0;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-color);
      position: relative;
    }

    .section-header::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100px;
      height: 2px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    .section-title {
      color: var(--text-color);
      margin: 0;
      font-size: 1.25rem;
      letter-spacing: -0.5px;
      font-weight: 700;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      box-sizing: border-box;
      height: 38px;
    }

    .btn-small {
      padding: 0.25rem 0.75rem;
      height: auto;
      font-size: 0.8rem;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-reset {
      background: var(--reset);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: #1a1a1a;
    }

    /* Stato base del modale (Invisibile) */
    .modal {
      display: none;
      /* Gestito dal JS */
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      z-index: 1000;
      justify-content: center;
      align-items: flex-end;
      /* Mobile: attacca al fondo */
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    /* Quando il modale è attivo */
    .modal.visible {
      opacity: 1;
    }

    .modal-open {
      overflow: hidden;
    }

    /* Il contenuto del modale */
    .modal-content {
      background: var(--card-bg);
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;

      /* Animazione Mobile: sale dal basso */
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
      border-radius: 20px 20px 0 0;
      padding: 1.5rem;
      box-sizing: border-box;
    }

    .modal.visible .modal-content {
      transform: translateY(0);
    }

    /* --- REGOLE DESKTOP --- */
    @media (min-width: 769px) {
      .modal {
        align-items: center;
        /* Centra nel desktop */
      }

      .modal-content {
        width: 90%;
        max-width: 800px;
        border-radius: 12px;
        /* Animazione Desktop: leggera comparsa con scala */
        transform: scale(0.9) translateY(20px);
        opacity: 0;
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.2s;
      }

      .modal.visible .modal-content {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    input,
    select {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-color);
      color: var(--text-color);
      font-size: 1rem;
      box-sizing: border-box;
      margin: 0;
      height: 38px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(58, 134, 255, 0.2);
    }

    .tmdb-results-container {
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.5rem;
      margin-top: 1rem;
    }

    .tmdb-result-item:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    @media (max-width: 1200px) {
      .top-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .top-bar-right {
        justify-content: flex-start;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
      }

      .top-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .media-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }
    }

    /* Livello 3: Centro Manutenzione, Storico, Calendario */
    #settingsModal,
    #historyModal,
    #calendarModal,
    #updateSummaryModal {
      z-index: 1200 !important;
    }

    /* Livello 4: Conferme (Import, Reset, Elimina) - DEVE ESSERE IL PIÙ ALTO */
    #confirmModal {
      z-index: 1500 !important;
    }

    .settings-grid {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .settings-card {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--border-color);
    }

    .settings-card:active {
      transform: scale(0.97);
    }

    .settings-icon {
      width: 45px;
      height: 45px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      margin-right: 1rem;
    }

    .settings-info {
      display: flex;
      flex-direction: column;
    }

    .settings-title {
      font-weight: 700;
      font-size: 1rem;
    }

    .settings-desc {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    /* Colori chiari e distinti */
    .export-card {
      background: rgba(34, 139, 34, 0.1);
      color: #228b22;
      border-color: rgba(34, 139, 34, 0.2);
    }

    .export-card .settings-icon {
      background: #228b22;
      color: white;
    }

    .import-card {
      background: rgba(58, 134, 255, 0.1);
      color: var(--primary);
      border-color: rgba(58, 134, 255, 0.2);
    }

    .import-card .settings-icon {
      background: var(--primary);
      color: white;
    }

    .reset-card {
      background: rgba(231, 76, 60, 0.1);
      color: #e74c3c;
      border-color: rgba(231, 76, 60, 0.2);
    }

    .reset-card .settings-icon {
      background: #e74c3c;
      color: white;
    }

    .last-backup-info {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-secondary);
      padding: 0.5rem;
      background: var(--section-tint);
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }

    .context-menu {
      position: fixed;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1001;
      min-width: 240px;
      padding: 0.5rem 0;
      border: 1px solid var(--border-color);
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.15s, transform 0.15s;
    }

    .context-menu.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .context-menu-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9rem;
    }

    .context-menu-item i {
      width: 18px;
      text-align: center;
    }

    .context-menu-item:hover {
      background: var(--primary);
      color: white;
    }

    .context-menu-divider {
      height: 1px;
      background: var(--border-color);
      margin: 0.25rem 0;
    }

    #digitalModal {
      z-index: 1200 !important;
    }

    #digitalList {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .digital-item {
      display: flex;
      gap: 1rem;
      background: var(--section-tint);
      border-radius: 12px;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      align-items: center;
      transition: transform 0.2s;
    }

    .digital-item:active {
      transform: scale(0.98);
    }

    .digital-still-wrapper {
      width: 120px;
      min-width: 120px;
      aspect-ratio: 16/9;
      border-radius: 8px;
      overflow: hidden;
      background: #2b2b2b;
    }

    .digital-still {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .digital-info {
      flex: 1;
      min-width: 0;
    }

    .digital-title {
      font-weight: 700;
      font-size: 1rem;
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .digital-release-date {
      font-size: 0.85rem;
      color: var(--primary);
      font-weight: 600;
      margin-top: 4px;
      display: block;
    }

    .digital-status {
      font-size: 0.7rem;
      text-transform: uppercase;
      background: rgba(0, 0, 0, 0.2);
      padding: 2px 6px;
      border-radius: 4px;
      margin-top: 6px;
      display: inline-block;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-secondary);
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      margin-top: 1rem;
    }

    .empty-state>i {
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }

    .add-film-from-empty {
      margin-top: 1rem;
      width: auto;
      white-space: nowrap;
    }

    #confirmModal .modal-content {
      max-width: 400px;
    }

    #confirmModalBody {
      margin: 1rem 0;
    }

    #confirmModalButtons {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    .auth-container {
      position: relative;
    }

    .auth-form {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      width: 300px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      display: none;
    }

    .auth-form.active {
      display: block;
    }

    .auth-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1rem;
    }

    .auth-tab {
      padding: 0.75rem 1rem;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 2px solid transparent;
    }

    .auth-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .auth-form-container {
      display: none;
    }

    .auth-form-container.active {
      display: block;
    }

    .auth-form-container input {
      width: 100%;
      margin-bottom: 1rem;
    }

    .auth-form-buttons {
      display: flex;
      justify-content: flex-end;
      margin-top: 1rem;
    }

    .notification-bell-container {
      position: relative;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: var(--danger);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 0.7rem;
      font-weight: 700;
      display: flex;
      justify-content: center;
      align-items: center;
      border: 2px solid var(--bg-color);
      transform: scale(0);
      transition: transform 0.2s ease-out;
    }

    .notification-badge.visible {
      transform: scale(1);
    }

    .notification-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--card-bg);
      border-radius: 12px;
      width: 350px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      display: none;
      border: 1px solid var(--border-color);
      overflow: hidden;
      max-height: 400px;
      flex-direction: column;
    }

    .notification-dropdown.visible {
      display: flex;
    }

    .notification-header {
      padding: 0.75rem 1rem;
      font-weight: 600;
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .notification-list {
      flex: 1;
      max-height: 300px;
      overflow-y: auto;
    }

    .notification-footer {
      padding: 0.5rem;
      text-align: center;
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .notification-item {
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .notification-item:hover {
      background-color: var(--section-tint);
    }

    .notification-item i {
      width: 16px;
      text-align: center;
    }

    .notification-item i.film-notification {
      color: var(--primary);
    }

    .notification-item i.tv-notification {
      color: var(--tv-accent);
    }

    .notification-item-text {
      flex: 1;
    }

    .no-notifications {
      padding: 1.5rem;
      text-align: center;
      color: var(--text-secondary);
    }

    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      background: var(--card-bg);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1002;
      display: none;
    }

    .notification.success {
      border-left: 4px solid var(--success);
    }

    .notification.error {
      border-left: 4px solid var(--danger);
    }

    .notification.warning {
      border-left: 4px solid var(--warning);
    }

    .modal-footer {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1.5rem;
      padding: 1.5rem 1.5rem 0 1.5rem;
      border-top: 1px solid var(--border-color);
    }

    .management-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1.5rem;
    }

    .tab-btn {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .tab-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .tab-btn:hover:not(.active) {
      color: var(--text-color);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .add-media-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .form-row {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .form-row input,
    .form-row select {
      flex: 1;
      min-width: 200px;
    }

    .form-row .btn {
      flex-shrink: 0;
    }

    .management-section {
      margin-top: 1rem;
    }

    .management-form {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .management-form input {
      flex: 1;
    }

    .management-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .management-card {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-radius: 8px;
      background: var(--bg-color);
      margin-bottom: 0.5rem;
    }

    .management-card>div:first-child {
      flex: 1;
      display: flex;
      align-items: center;
    }

    .management-card-actions {
      display: flex;
      gap: 0.5rem;
    }

    .management-card-actions .btn {
      padding: 0;
      justify-content: center;
      height: 32px;
      width: 32px;
    }

    #categoriesList .management-card-actions .btn {
      background: var(--secondary);
      color: white;
      border: none;
    }

    #categoriesList .management-card-actions .btn.btn-danger {
      background: var(--danger);
    }

    #categoriesList .management-card-actions .btn:hover {
      opacity: 0.85;
    }

    .category-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 0.75rem;
      flex-shrink: 0;
    }

    .category-dot-watchlist {
      background: #00B4D8;
    }

    .category-dot-watched {
      background: #228b22;
    }

    .category-dot-0 {
      background: #3A86FF;
    }

    .category-dot-1 {
      background: #FF006E;
    }

    .category-dot-2 {
      background: #8338EC;
    }

    .category-dot-3 {
      background: #FFBE0B;
    }

    .category-dot-4 {
      background: #FB5607;
    }

    .category-dot-5 {
      background: #00B4D8;
    }

    .category-name {
      font-weight: 600;
    }

    .category-name-input {
      background: var(--bg-color);
      color: var(--text-color);
      border: 1px solid var(--primary);
      border-radius: 4px;
      padding: 2px 8px;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      outline: none;
    }

    .friend-email {
      font-weight: 600;
    }

    .friend-id {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    #friendsList .management-card-actions .btn {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
    }

    #friendsList .management-card-actions .btn.visit-friend-films-btn:hover {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    #friendsList .management-card-actions .btn.visit-friend-tv-btn:hover {
      background-color: #2a9d8f;
      color: white;
      border-color: #2a9d8f;
    }

    #friendsList .management-card-actions .btn.remove-friend-btn:hover {
      background-color: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    #posterModal .modal-content {
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .poster-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      padding: 0.5rem;
    }

    .poster-option {
      position: relative;
      cursor: pointer;
      transition: transform 0.2s;
      border: 3px solid transparent;
      border-radius: 8px;
      overflow: hidden;
    }

    .poster-option:hover {
      transform: scale(1.05);
    }

    .poster-option.selected {
      border-color: var(--primary);
    }

    .poster-option img {
      width: 100%;
      height: auto;
      display: block;
    }

    .poster-current-indicator {
      position: absolute;
      top: 5px;
      left: 5px;
      background: var(--success);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .poster-language-badge {
      position: absolute;
      bottom: 5px;
      right: 5px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    #rewatchModal .modal-content {
      max-width: 450px;
      text-align: center;
    }

    #rewatchModalTitle {
      margin-top: 0;
    }

    #rewatchQuickButtons {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin: 1.5rem 0;
    }

    .quick-rewatch-btn {
      padding: 0;
      width: 45px;
      height: 45px;
      justify-content: center;
    }

    .quick-rewatch-btn.active {
      background: var(--primary);
      color: white;
    }

    .custom-rewatch-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }

    #updateProgressModal .modal-content {
      max-width: 500px;
      text-align: center;
    }

    #updateProgressBar {
      width: 100%;
      height: 20px;
      background-color: var(--border-color);
      border-radius: 10px;
      overflow: hidden;
      margin: 1rem 0;
    }

    #updateProgressBarFill {
      width: 0%;
      height: 100%;
      background-color: var(--primary);
      transition: width 0.2s;
    }

    #updateProgressText {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .number-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      height: 38px;
    }

    .number-input-wrapper input {
      border: none;
      text-align: center;
      flex: 1;
      width: 100%;
      padding-right: 25px;
      background: var(--card-bg);
      -moz-appearance: textfield;
      appearance: textfield;
    }

    .number-input-wrapper input::-webkit-outer-spin-button,
    .number-input-wrapper input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .number-input-controls {
      position: absolute;
      right: 1px;
      top: 1px;
      bottom: 1px;
      display: flex;
      flex-direction: column;
      width: 24px;
    }

    .num-spinner-btn {
      flex: 1;
      width: 100%;
      border: none;
      background-color: var(--bg-color);
      color: var(--text-color);
      cursor: pointer;
      font-size: 0.8rem;
      line-height: 1;
      padding: 0;
      height: 50%;
    }

    .num-spinner-btn:hover {
      background-color: var(--primary);
      color: white;
    }

    .num-spinner-btn.up {
      border-top-right-radius: 7px;
    }

    .num-spinner-btn.down {
      border-bottom-right-radius: 7px;
    }

    .tmdb-result-item {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      cursor: pointer;
      border-radius: 4px;
      margin-bottom: 0.25rem;
    }

    .tmdb-result-item:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    .tmdb-poster-small {
      width: 40px;
      height: 60px;
      object-fit: cover;
      margin-right: 0.75rem;
      border-radius: 4px;
    }

    .view-mode-banner {
      display: none;
      align-items: center;
      background: var(--primary);
      color: white;
      padding: 0.75rem 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 8px;
    }

    .view-mode-banner i {
      margin-right: 0.75rem;
    }

    .btn i.fa-plus {
      position: relative;
      top: -1px;
    }

    #detailsModal .modal-content {
      max-width: 900px;
      padding: 0;
      overflow-y: auto;
    }

    #actorModal .modal-content {
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
    }

    #actorModal {
      z-index: 1001;
    }

    .details-backdrop {
      width: 100%;
      height: 250px;
      background-size: cover;
      background-position: center 25%;
      position: relative;
    }

    .details-backdrop::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to top, var(--card-bg) 0%, rgba(0, 0, 0, 0.5) 100%);
    }

    .details-header {
      position: relative;
      display: flex;
      padding: 1.5rem;
      margin-top: -100px;
      z-index: 2;
    }

    #detailsModalPoster {
      width: 150px;
      height: 225px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      flex-shrink: 0;
      margin-right: 1.5rem;
    }

    .details-title-section {
      padding-top: 100px;
      flex-grow: 1;
    }

    #detailsModalTitle {
      margin: 0;
      font-size: 1.75rem;
    }

    .details-ratings-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 0.75rem;
    }

    #detailsModalTagline {
      font-style: italic;
      color: var(--text-secondary);
      margin-top: 0.5rem;
    }

    #detailsModalMeta {
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      font-size: 0.9rem;
    }

    .director-link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
    }

    .director-link:hover {
      text-decoration: underline;
    }

    .details-body {
      padding: 0 1.5rem 1.5rem 1.5rem;
    }

    .details-section-title {
      font-weight: 600;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
      margin-top: 1.5rem;
    }

    #detailsModalOverview {
      line-height: 1.6;
    }

    .cast-scroller {
      display: flex;
      overflow-x: auto;
      gap: 1rem;
      padding-bottom: 1rem;
    }

    .actor-card {
      text-align: center;
      width: 100px;
      flex-shrink: 0;
      cursor: pointer;
    }

    .actor-photo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 0.5rem;
      background-color: #2b2b2b;
      border: 2px solid var(--border-color);
      display: block;
    }

    .actor-details-photo {
      width: 120px;
      height: 180px;
      object-fit: cover;
      border-radius: 12px;
      background-color: #2b2b2b;
      border: 1px solid var(--border-color);
    }

    .actor-name,
    .actor-character {
      font-size: 0.8rem;
      user-select: text;
    }

    .actor-character {
      color: var(--text-secondary);
    }

    .modal-close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      z-index: 3;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
    }

    /* Rende cliccabili le statistiche in alto */
    .stats-panel .stat-item {
      cursor: pointer;
      transition: transform 0.2s, background 0.2s;
    }

    .stats-panel .stat-item:active {
      transform: scale(0.95);
    }

    #advancedStatsModal {
      z-index: 1200;
    }

    .charts-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
      margin-top: 1rem;
    }

    @media (min-width: 768px) {
      .charts-container {
        grid-template-columns: 1fr 1fr;
      }
    }

    .chart-detail-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      background: var(--section-tint);
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .chart-detail-poster {
      width: 45px;
      height: 65px;
      object-fit: cover;
      border-radius: 4px;
      background-color: var(--border-color);
    }

    .chart-detail-info {
      display: flex;
      flex-direction: column;
    }

    .actor-details-header {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
      align-items: flex-start;
    }

    .actor-details-photo {
      width: 120px;
      height: 180px;
      object-fit: cover;
      border-radius: 8px;
      flex-shrink: 0;
    }

    .actor-details-info ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .actor-details-info li {
      margin-bottom: 0.5rem;
    }

    .btn-imdb {
      background: #f5c518;
      color: #000;
      margin-top: 1rem;
    }

    .filmography-scroller {
      display: flex;
      overflow-x: auto;
      gap: 1rem;
      padding-bottom: 1rem;
    }

    .film-card-small {
      width: 120px;
      flex-shrink: 0;
      cursor: pointer;
    }

    .film-card-small img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 4px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .film-card-small:hover img {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .film-card-small-title {
      font-size: 0.8rem;
      margin-top: 0.5rem;
      white-space: normal;
      text-align: center;
    }

    /* START: Mobile Menu and Notifications Modals Styles */
    #mobileMenuModal,
    #filterSortModal,
    #categoryNavModal {
      align-items: flex-end;
      background: rgba(0, 0, 0, 0.4);
    }

    #mobileMenuModal.visible .modal-content,
    #filterSortModal.visible .modal-content,
    #categoryNavModal.visible .modal-content {
      transform: translateY(0);
    }

    .mobile-menu-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .mobile-menu-list .btn {
      width: 100%;
      justify-content: flex-start;
      background-color: var(--section-tint);
      color: var(--text-color);
    }

    .mobile-menu-list .btn i {
      width: 24px;
      text-align: center;
      color: var(--primary);
    }

    #mobileNotificationsModal {
      align-items: flex-end;
      /* Position modal at bottom */
      background: rgba(0, 0, 0, 0.4);
    }

    #mobileNotificationsModal .modal-content {
      width: 100%;
      max-width: none;
      height: 75vh;
      border-radius: 16px 16px 0 0;
      margin: 0;
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.15);
      transform: translateY(100%);
      transition: transform 0.3s ease-out;
      position: absolute;
      bottom: 0;
    }

    #mobileNotificationsModal.visible .modal-content {
      transform: translateY(0);
    }

    .filter-modal-section {
      margin-bottom: 1rem;
    }

    .filter-modal-section label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .filter-modal-section select {
      width: 100%;
    }

    /* END: Mobile Menu and Notifications Modals Styles */

    /* START: Bottom Navigation Bar Styles */
    .bottom-nav {
      display: none;
      /* Hidden by default, shown in media query */
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background-color: var(--card-bg);
      border-top: 1px solid var(--border-color);
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 999;
      justify-content: space-around;
      align-items: center;
    }

    .bottom-nav-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex-grow: 1;
      height: 100%;
      font-size: 0.7rem;
      cursor: pointer;
      transition: color 0.2s;
      position: relative;
    }

    .bottom-nav-btn i {
      font-size: 1.2rem;
      margin-bottom: 0.2rem;
    }

    .bottom-nav-btn.active {
      color: var(--primary);
    }

    .bottom-nav-btn:active {
      transform: scale(0.95);
    }

    .bottom-nav-btn.add-btn {
      background: var(--primary);
      color: white;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(42, 157, 143, 0.4);
      flex-grow: 0;
    }

    .bottom-nav-btn.add-btn i {
      font-size: 1.4rem;
      margin: 0;
    }

    .notification-badge-mobile {
      position: absolute;
      top: -2px;
      right: -2px;
      background-color: var(--danger);
      color: white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      font-size: 0.6rem;
      font-weight: 700;
      display: flex;
      justify-content: center;
      align-items: center;
      border: 2px solid var(--card-bg);
      transform: scale(0);
      transition: transform 0.2s ease-out;
    }

    .notification-badge-mobile.visible {
      transform: scale(1);
    }

    #mobileFilterBtn {
      display: none;
    }

    /* Hide mobile filter button on desktop */

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
        padding-bottom: 80px;
        /* Spazio per la bottom nav */
        -webkit-text-size-adjust: 100%;
      }

      /* 1. NASCONDI TUTTA LA PARTE DESTRA (Pulsanti Desktop) */
      .top-bar-right {
        display: none !important;
      }

      /* 2. SISTEMA LA BARRA SUPERIORE */
      .top-bar {
        padding: 0.5rem 0.75rem;
        margin-bottom: 0.5rem;
        height: auto;
        min-height: 60px;
        display: flex;
        align-items: center;
      }

      /* 3. RIGA UNICA: Switch - Search - Filter */
      .top-bar-left {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        width: 100% !important;
        gap: 10px !important;
        align-items: center !important;
        justify-content: space-between !important;
      }

      /* Lo Switch a sinistra */
      .tracker-switch {
        flex-shrink: 0 !important;
        order: 1;
      }

      /* La barra di ricerca al centro che si espande */
      .search-box {
        flex-grow: 1 !important;
        min-width: 0 !important;
        /* Permette il restringimento */
        width: 100% !important;
        max-width: none !important;
        margin: 0 !important;
        order: 2;
        height: 40px;
      }

      /* Il tasto filtro a destra */
      #mobileFilterBtn {
        display: flex !important;
        flex-shrink: 0 !important;
        order: 3;
        width: 40px;
        height: 40px;
        padding: 0;
        justify-content: center;
        align-items: center;
      }

      /* Nascondi titoli e select nativi */
      #topBarTitle,
      .top-bar-left h1,
      .top-bar-left .filter-select {
        display: none !important;
      }

      /* --- STATISTICHE: GRIGLIA 4 COLONNE PER LE PRIME 4 STATISTICHE --- */
      .stats-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        /* 4 colonne per le prime 4 statistiche */
        gap: 0.4rem;
        padding-bottom: 0;
        overflow: visible;
      }

      .stat-item {
        width: auto;
        min-width: 0;
        padding: 0.4rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        border-radius: 12px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      /* Le prime 4 statistiche sulla stessa riga */
      .stat-item:nth-child(1),
      .stat-item:nth-child(2),
      .stat-item:nth-child(3),
      .stat-item:nth-child(4) {
        grid-row: 1;
      }

      /* L'ultima stat (Ore) su una riga intera sotto */
      .stat-item:nth-child(5) {
        grid-column: 1 / -1;
        grid-row: 2;
        flex-direction: row;
        gap: 1rem;
        padding: 0.75rem;
      }

      .stat-value {
        font-size: 1.3rem;
        /* Numeri leggermente più piccoli per stare in 4 colonne */
        margin-bottom: 0.3rem;
        line-height: 1;
        font-weight: 700;
        color: var(--text-color);
      }

      .stat-item:nth-child(5) .stat-value {
        margin-bottom: 0;
        font-size: 1.2rem;
      }

      /* Nasconde il testo ma prepara il contenitore per l'icona */
      .stat-label {
        font-size: 0;
        /* NASCONDE IL TESTO */
        display: flex;
        justify-content: center;
      }

      /* Definizioni Icone (Visibili e più grandi) */
      .stat-item:nth-child(1) .stat-label::after {
        content: "\f00a";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        font-size: 1.1rem;
        color: var(--text-secondary);
        opacity: 0.6;
      }

      /* Totale */
      .stat-item:nth-child(2) .stat-label::after {
        content: "\f00b";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        font-size: 1.1rem;
        color: var(--secondary);
      }

      /* Da Vedere */
      .stat-item:nth-child(3) .stat-label::after {
        content: "\f00c";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        font-size: 1.1rem;
        color: var(--success);
      }

      /* Visti */
      .stat-item:nth-child(4) .stat-label::after {
        content: "\f2f9";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        font-size: 1.1rem;
        color: var(--warning);
      }

      /* Rewatch */
      .stat-item:nth-child(5) .stat-label::after {
        content: "\f017";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        font-size: 1.2rem;
        color: var(--text-secondary);
        opacity: 0.6;
      }

      /* Ore */

      /* --- GRIGLIA FILM --- */
      .media-section {
        padding: 0;
        background: transparent;
        margin-bottom: 1rem;
      }

      .section-header {
        padding: 0 0.5rem 0.5rem 0.5rem;
        margin-bottom: 0.5rem;
      }

      .media-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.75rem;
        padding: 0 0.25rem;
      }

      .media-card {
        width: auto;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      .media-title {
        font-size: 0.8rem;
      }

      .media-ratings {
        display: none;
      }

      .media-meta {
        display: flex;
        font-size: 0.65rem;
        justify-content: center;
        gap: 0.3rem;
        flex-wrap: wrap;
        margin-top: 0.2rem;
        color: var(--text-secondary);
      }

      /* --- MODALE DETTAGLI FILM (CENTRATO) --- */
      #detailsModal .modal-content {
        padding: 0;
        width: 100%;
        height: 100vh;
        border-radius: 0;
      }

      .details-header {
        flex-direction: column;
        align-items: center;
        margin-top: -90px;
        padding: 1rem;
        text-align: center;
      }

      #detailsModalPoster {
        width: 130px;
        height: 195px;
        margin: 0 0 1rem 0;
        border: 2px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      }

      .details-title-section {
        padding: 0;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      #detailsModalHeader-main {
        flex-direction: column;
        width: 100%;
        gap: 0.5rem;
        align-items: center;
      }

      #detailsModalTitle {
        font-size: 1.75rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        text-align: center;
        width: 100%;
        line-height: 1.2;
      }

      .details-ratings-container {
        justify-content: center;
        margin-bottom: 1rem;
        width: 100%;
      }

      #detailsModalHeader-main>div:last-child {
        display: flex;
        justify-content: center;
        gap: 1rem;
        width: 100%;
        margin-top: 0.5rem;
      }

      #detailsModalHeader-main>div:last-child .btn {
        flex: 0 1 auto;
        padding: 0.6rem 1.2rem;
      }

      #detailsModalMeta {
        justify-content: center;
        font-size: 0.8rem;
        opacity: 0.8;
      }

      .details-body {
        padding: 0 1rem 2rem 1rem;
      }

      /* --- NOTIFICHE --- */
      #mobileNotificationsModal {
        justify-content: flex-end;
        background: rgba(0, 0, 0, 0.6);
      }

      #mobileNotificationsModal .modal-content {
        width: 95%;
        margin: 0 auto 85px auto;
        border-radius: 16px;
        height: auto;
        max-height: 60vh;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .notification-list {
        max-height: 40vh;
      }

      .notification-item {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
      }

      /* --- BOTTOM NAV --- */
      .bottom-nav {
        display: grid !important;
        /* Creiamo 5 colonne di larghezza identica */
        grid-template-columns: repeat(5, 1fr);
        justify-items: center;
        align-items: center;
        height: 65px;
        padding-bottom: env(safe-area-inset-bottom);
        background: var(--card-bg);
        border-top: 1px solid var(--border-color);
      }

      .nav-spacer {
        /* Questo elemento occupa spazio ma non reagisce ai tocchi */
        pointer-events: none;
        visibility: hidden;
      }

      .bottom-nav-btn {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      /* Forza il tasto + ad occupare la colonna centrale (la 3) */
      .bottom-nav-btn.add-btn {
        grid-column: 3;
        transform: translateY(-15px);
        width: 56px;
        height: 56px;
        border: 4px solid var(--bg-color);
        box-shadow: 0 4px 12px rgba(58, 134, 255, 0.3);
      }
    }

    #detailsModalOverview,
    .cast-scroller {
      transition: opacity 0.3s ease-in-out;
    }

    /* Animazione pulsante per gli scheletri */
    .skeleton {
      background: #2a2a2a;
      background: linear-gradient(90deg, #2a2a2a 25%, #333 50%, #2a2a2a 75%);
      background-size: 200% 100%;
      animation: skeleton-pulse 1.5s infinite ease-in-out;
    }

    @keyframes skeleton-pulse {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    .skeleton-text {
      color: transparent !important;
      background: #2a2a2a;
      border-radius: 4px;
      animation: skeleton-pulse 1.5s infinite ease-in-out;
    }
  </style>
</head>

<body class="dark user-select-none">

  <div id="appLoader">
    <i class="fas fa-spinner loading-spinner"></i>
  </div>

  <div id="viewModeBanner" class="view-mode-banner" style="display:none">
    <i class="fas fa-eye"></i>
    <span id="viewModeUserEmail">Stai visualizzando una libreria condivisa</span>
    <button id="closeViewBtn" class="btn btn-danger" style="margin-left:auto">
      <i class="fas fa-times"></i> Esci
    </button>
  </div>

  <div class="top-bar">
    <div class="top-bar-left">
      <h1><i class="fas fa-film"></i> Film</h1>
      <div class="tracker-switch">
        <a href="index.html" class="tracker-switch-btn active" title="Vai a Film Tracker"><i
            class="fas fa-film"></i></a>
        <a href="serietv_tracker.html" class="tracker-switch-btn" title="Vai a Serie TV Tracker"><i
            class="fas fa-tv"></i></a>
      </div>
      <input type="text" id="searchInput" class="search-box" placeholder="Cerca film...">
      <button id="mobileFilterBtn" class="btn btn-secondary"><i class="fas fa-filter"></i></button>
      <select id="categoryFilter" class="filter-select">
        <option value="all">Tutte le categorie</option>
        <option value="favorites">Solo Preferiti</option>
      </select>
      <select id="sortFilter" class="filter-select">
        <option value="saga-alpha" selected>Saga / Alfabetico</option>
        <option value="alpha">Solo Alfabetico</option>
        <option value="added">Ultimi aggiunti</option>
        <option value="rating">Valutazione</option>
        <option value="year">Anno di uscita</option>
      </select>
    </div>
    <div class="top-bar-right">
      <button id="mediaManagementBtn" class="btn btn-primary" title="Gestione"><i class="fas fa-plus"></i></button>
      <button id="digitalBtn" class="btn btn-secondary" title="Uscite Digitali">
        <i class="fas fa-cloud"></i>
      </button>
      <button id="settingsBtn" class="btn btn-secondary" title="Impostazioni Dati">
        <i class="fas fa-cog"></i>
      </button>
      <div class="notification-bell-container" id="notificationBellContainer" style="display: none;">
        <button id="bellIcon" class="btn btn-secondary" title="Notifiche"><i class="fas fa-bell"></i></button>
        <div id="notificationBadge" class="notification-badge">0</div>
        <div id="notificationDropdown" class="notification-dropdown"></div>
      </div>
      <button id="shareBtn" class="btn btn-secondary" title="Condividi Libreria"><i
          class="fas fa-share-alt"></i></button>
      <button id="themeToggle" class="btn btn-secondary" title="Cambia Tema"><i class="fas fa-moon"></i></button>
      <div id="userInfo" style="display:none;"><button id="logoutBtn" class="btn btn-danger" title="Logout"><i
            class="fas fa-sign-out-alt"></i></button></div>
      <button id="authToggle" class="btn btn-secondary" title="Login / Registrati"><i class="fas fa-user"></i></button>
    </div>
  </div>

  <div class="stats-panel">
    <div class="stats-container">
      <div class="stat-item" title="Totale">
        <i class="fas fa-film stat-icon"></i>
        <span class="stat-name">Totale</span>
        <div class="stat-value" id="statTotal">0</div>
      </div>
      <div class="stat-item" title="Da Vedere">
        <i class="fas fa-bookmark stat-icon"></i>
        <span class="stat-name">Da Vedere</span>
        <div class="stat-value" id="statWatchlist">0</div>
      </div>
      <div class="stat-item" title="Visti">
        <i class="fas fa-check-circle stat-icon"></i>
        <span class="stat-name">Visti</span>
        <div class="stat-value" id="statWatched">0</div>
      </div>
      <div class="stat-item" title="Rivisti">
        <i class="fas fa-redo stat-icon"></i>
        <span class="stat-name">Rivisti</span>
        <div class="stat-value" id="statRewatched">0</div>
      </div>
      <div class="stat-item" title="Tempo Totale">
        <i class="fas fa-clock stat-icon"></i>
        <span class="stat-name">Tempo Totale</span>
        <div class="stat-value" id="statHours">0h 0m</div>
      </div>
    </div>
  </div>

  <div id="mediaSectionsContainer"></div>

  <!-- MODALS START -->
  <div class="modal" id="mediaManagementModal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="media-management-container">
        <div class="management-tabs">
          <button class="tab-btn active" data-tab="add-media"><i class="fas fa-film"></i> Aggiungi Film</button>
          <button class="tab-btn" data-tab="manage-categories"><i class="fas fa-clapperboard"></i> Gestisci
            Categorie</button>
          <button class="tab-btn" data-tab="manage-friends"><i class="fas fa-user-friends"></i> Amici</button>
        </div>
        <div class="tab-content active" id="add-media-tab">
          <h2>Aggiungi un nuovo Film</h2>
          <div class="add-media-form">
            <div class="form-row">
              <input type="text" id="mediaTitle" placeholder="Titolo film...">
              <select id="addMediaCategorySelect"></select>
              <button id="searchTMDbBtn" class="btn btn-secondary"><i class="fas fa-search"></i> Cerca</button>
            </div>
            <div id="tmdbResults" class="tmdb-results-container"></div>
          </div>
        </div>
        <div class="tab-content" id="manage-categories-tab">
          <h2>Gestisci Categorie</h2>
          <div class="management-form">
            <input type="text" id="newCategoryName" placeholder="Nuova categoria">
            <button id="addCategoryBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Aggiungi</button>
          </div>
          <div class="management-list" id="categoriesList"></div>
        </div>
        <div class="tab-content" id="manage-friends-tab">
          <div id="myIdContainer" class="management-section"
            style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; text-align: center; margin-bottom: 1.5rem;">
            <h4>Il tuo ID univoco</h4>
            <p style="font-size: 0.9rem; color: var(--text-secondary);">Condividi questo ID con i tuoi amici per
              permettere loro di aggiungerti.</p>
            <div style="display: flex; gap: 0.5rem; justify-content: center;">
              <input type="text" id="myIdInput" readonly style="text-align: center; background-color: var(--bg-color);">
              <button id="copyMyIdBtn" class="btn btn-primary"><i class="fas fa-copy"></i> Copia</button>
            </div>
          </div>
          <div class="management-section">
            <div class="management-form">
              <input type="text" id="friendIdInput" placeholder="Incolla l'ID di un amico">
              <button id="addFriendBtn" class="btn btn-primary"><i class="fas fa-user-plus"></i> Aggiungi</button>
            </div>
            <div class="management-list" id="friendsList"></div>
          </div>
        </div>
        <div class="modal-footer" style="border-top: none; padding-top: 0; justify-content: flex-end;">
          <button id="closeManagementModal" class="btn btn-danger">Chiudi</button>
          <button id="saveMediaBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Aggiungi Film</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="rewatchModal">
    <div class="modal-content">
      <h2 id="rewatchModalTitle">Modifica Rewatch</h2>
      <p>Specifica il numero di volte che hai rivisto il film (0 = visto una sola volta).</p>
      <div id="rewatchQuickButtons">
        <button class="btn btn-secondary quick-rewatch-btn" data-count="0">0</button>
        <button class="btn btn-secondary quick-rewatch-btn" data-count="1">1</button>
        <button class="btn btn-secondary quick-rewatch-btn" data-count="2">2</button>
        <button class="btn btn-secondary quick-rewatch-btn" data-count="3">3</button>
        <button class="btn btn-secondary quick-rewatch-btn" data-count="4">4</button>
        <button class="btn btn-secondary quick-rewatch-btn" data-count="5">5</button>
      </div>
      <div class="custom-rewatch-container">
        <label for="rewatchCountInput">Numero custom:</label>
        <div class="number-input-wrapper" style="width: 120px;">
          <input type="number" id="rewatchCountInput" min="0" value="0">
          <div class="number-input-controls">
            <button class="num-spinner-btn up" data-target="rewatchCountInput">+</button>
            <button class="num-spinner-btn down" data-target="rewatchCountInput">-</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelRewatchBtn" class="btn btn-danger">Annulla</button>
        <button id="confirmRewatchBtn" class="btn btn-primary">Salva</button>
      </div>
    </div>
  </div>

  <div class="modal" id="updateProgressModal">
    <div class="modal-content">
      <h2 id="updateProgressTitle">Aggiornamento in corso...</h2>
      <div id="updateProgressBar">
        <div id="updateProgressBarFill"></div>
      </div>
      <p id="updateProgressText">Inizializzazione...</p>
    </div>
  </div>

  <div class="modal" id="shareModal">
    <div class="modal-content" style="max-width: 450px;">
      <h2>Condividi la tua libreria</h2>
      <p>Chiunque abbia questo link potrà vedere la tua lista in tempo reale (sola lettura).</p><input type="text"
        id="shareLinkInput" class="share-link-input" readonly>
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem;"><button id="copyShareLinkBtn"
          class="btn btn-primary">Copia Link</button><button id="closeShareModalBtn"
          class="btn btn-danger">Chiudi</button></div>
    </div>
  </div>
  <div id="notification" class="notification"><span id="notificationText"></span></div>

  <div class="modal" id="posterModal">
    <div class="modal-content">
      <h2 id="posterModalTitle">Cambia Copertina</h2>
      <div class="poster-grid" id="posterGrid"></div>
      <div class="modal-footer">
        <button id="cancelPosterChange" class="btn btn-danger">Annulla</button>
        <button id="savePosterChange" class="btn btn-primary">Salva Selezione</button>
      </div>
    </div>
  </div>

  <div class="modal" id="detailsModal">
    <div class="modal-content">
      <button class="modal-close-btn" id="detailsModalClose"><i class="fas fa-times"></i></button>
      <div id="detailsModalContent"></div>
    </div>
  </div>

  <div class="modal" id="actorModal">
    <div class="modal-content">
      <button class="modal-close-btn" id="actorModalClose"><i class="fas fa-times"></i></button>
      <div id="actorModalContent"></div>
    </div>
  </div>

  <!-- MODALE STATISTICHE AVANZATE -->
  <div class="modal" id="advancedStatsModal">
    <div class="modal-content" style="max-width: 800px; padding: 1.5rem;">
      <h2 style="text-align: center; margin-top: 0; color: var(--primary);">Statistiche Avanzate</h2>

      <div class="charts-container">
        <!-- Grafico a Torta: Generi -->
        <div class="chart-box">
          <h3 style="text-align: center; font-size: 1rem; color: var(--text-secondary);">I tuoi Generi Preferiti</h3>
          <div style="position: relative; height: 250px; width: 100%;">
            <canvas id="genresChart"></canvas>
          </div>
        </div>

        <!-- Grafico a Barre: Attività Mensile -->
        <div class="chart-box">
          <h3 style="text-align: center; font-size: 1rem; color: var(--text-secondary);">Film Attivi negli ultimi 6 mesi
          </h3>
          <div style="position: relative; height: 250px; width: 100%;">
            <canvas id="activityChart"></canvas>
          </div>
        </div>
      </div>

      <div class="modal-footer" style="border-top: none;">
        <button onclick="closeModal(document.getElementById('advancedStatsModal'))" class="btn btn-secondary"
          style="width: 100%;">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- MODALE DETTAGLI GRAFICO (Drill-down) -->
  <div class="modal" id="chartDetailsModal" style="z-index: 1250;">
    <div class="modal-content" style="max-width: 500px;">
      <h2 id="chartDetailsTitle" style="text-align: center; margin-top: 0; color: var(--primary);">Dettagli</h2>
      <div id="chartDetailsList"
        style="max-height: 55vh; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; padding: 0.5rem;">
        <!-- La lista dei film apparirà qui -->
      </div>
      <div class="modal-footer" style="border-top: none; padding-top: 1rem;">
        <button onclick="closeModal(document.getElementById('chartDetailsModal'))" class="btn btn-secondary"
          style="width: 100%;">Chiudi</button>
      </div>
    </div>
  </div>
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <h2 id="confirmModalTitle"></h2>
      <p id="confirmModalBody"></p>
      <div id="confirmModalButtons">
        <button id="confirmModalCancel" class="btn btn-secondary">Annulla</button>
        <button id="confirmModalConfirm" class="btn btn-danger">Conferma</button>
      </div>
    </div>
  </div>

  <!-- Mobile "More Options" Modal -->
  <div class="modal" id="mobileMenuModal">
    <div class="modal-content">
      <h2 style="text-align: center; margin-top: 0;">Altre Opzioni</h2>
      <div class="mobile-menu-list">
        <button class="btn" id="mobileMenuUserActionBtn"><i class="fas fa-user"></i><span>Login /
            Registrati</span></button>
        <button class="btn" id="mobileMenuShareBtn"><i class="fas fa-share-alt"></i>Condividi Libreria</button>
        <button class="btn" id="mobileSettingsBtn">
          <i class="fas fa-cog"></i>Gestione Dati & Backup
        </button>
        <button class="btn" id="mobileMenuThemeBtn"><i class="fas fa-moon"></i>Cambia Tema</button>
      </div>
      <div class="modal-footer" style="border: none; padding-bottom: 0;">
        <button id="mobileMenuCloseBtn" class="btn btn-danger">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- Mobile Notifications Modal -->
  <div class="modal" id="mobileNotificationsModal">
    <div class="modal-content">
      <div class="notification-header" style="text-align:center; position:relative;">
        Notifiche Amici
        <button class="modal-close-btn" id="mobileNotificationsCloseBtn"
          style="background:none; color:var(--text-color); top:0.5rem; right:0.5rem;"><i
            class="fas fa-times"></i></button>
      </div>
      <div class="notification-list" id="notificationListMobile"></div>
      <div class="notification-footer">
        <button id="markAllReadMobileBtn" class="btn btn-primary btn-small"><i class="fas fa-check-double"></i> Segna
          tutte come lette</button>
      </div>
    </div>
  </div>

  <!-- Mobile Filter & Sort Modal -->
  <div class="modal" id="filterSortModal">
    <div class="modal-content">
      <h2 style="text-align: center; margin-top: 0;">Filtra e Ordina</h2>
      <div class="filter-modal-section">
        <label for="mobileCategoryFilter">Categoria</label>
        <select id="mobileCategoryFilter"></select>
      </div>
      <div class="filter-modal-section">
        <label for="mobileSortFilter">Ordina per</label>
        <select id="mobileSortFilter">
          <option value="saga-alpha" selected>Saga / Alfabetico</option>
          <option value="alpha">Solo Alfabetico</option>
          <option value="added">Ultimi aggiunti</option>
          <option value="rating">Valutazione</option>
          <option value="year">Anno di uscita</option>
        </select>
      </div>
      <div class="modal-footer" style="border: none; padding-bottom: 0;">
        <button id="applyFiltersBtn" class="btn btn-primary">Applica</button>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div class="modal" id="authModal">
    <div class="modal-content" style="max-width: 350px;">
      <h2 style="text-align: center; margin-top: 0;">Accedi</h2>

      <div class="auth-tabs">
        <div class="auth-tab active" data-tab="login">Login</div>
        <div class="auth-tab" data-tab="register">Registrati</div>
      </div>

      <div id="loginForm" class="auth-form-container active">
        <input type="email" id="loginEmail" placeholder="Email" style="width: 100%; margin-bottom: 1rem;">
        <input type="password" id="loginPassword" placeholder="Password" style="width: 100%; margin-bottom: 1rem;">
        <button id="loginBtn" class="btn btn-primary" style="width: 100%;"><i class="fas fa-sign-in-alt"></i>
          Login</button>
      </div>

      <div id="registerForm" class="auth-form-container">
        <input type="email" id="registerEmail" placeholder="Email" style="width: 100%; margin-bottom: 1rem;">
        <input type="password" id="registerPassword" placeholder="Password (min. 6 car.)"
          style="width: 100%; margin-bottom: 1rem;">
        <input type="password" id="registerConfirmPassword" placeholder="Conferma Password"
          style="width: 100%; margin-bottom: 1rem;">
        <button id="registerBtn" class="btn btn-primary" style="width: 100%;"><i class="fas fa-user-plus"></i>
          Registrati</button>
      </div>

      <div class="modal-footer">
        <button class="btn btn-danger" onclick="closeModal(document.getElementById('authModal'))">Chiudi</button>
      </div>
    </div>
  </div>
  <!-- MODALS END -->

  <div id="notification" class="notification"><span id="notificationText"></span></div>

  <!-- Category Navigation Modal (Mobile) -->
  <div class="modal" id="categoryNavModal">
    <div class="modal-content">
      <h2 style="text-align: center; margin-top: 0;">Vai a Categoria</h2>
      <div id="categoryNavList" class="mobile-menu-list">
        <!-- Categories will be dynamically populated here -->
      </div>
      <div class="modal-footer" style="border: none; padding-bottom: 0;">
        <button id="closeCategoryNavBtn" class="btn btn-danger">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation Bar for Mobile -->
  <div class="bottom-nav" id="bottomNav">
    <button class="bottom-nav-btn active" id="bottomNavHome" title="Liste">
      <i class="fas fa-list-ul"></i>
      <span>Liste</span>
    </button>

    <!-- Tasto Digital al posto dello spacer -->
    <button class="bottom-nav-btn" id="mobileDigitalBtn" title="Digital">
      <i class="fas fa-cloud"></i>
      <span>Digital</span>
    </button>

    <button class="bottom-nav-btn add-btn" id="bottomNavAdd" title="Aggiungi Film">
      <i class="fas fa-plus"></i>
    </button>
    <button class="bottom-nav-btn" id="bottomNavNotifications" title="Notifiche">
      <i class="fas fa-bell"></i>
      <span class="notification-badge-mobile" id="notificationBadgeMobile">0</span>
      <span>Notifiche</span>
    </button>
    <button class="bottom-nav-btn" id="bottomNavManage" title="Altro">
      <i class="fas fa-ellipsis-h"></i>
      <span>Altro</span>
    </button>
  </div>

  <div class="modal" id="settingsModal">
    <div class="modal-content" style="max-width: 500px;">
      <h2 style="text-align: center; margin-top: 0;">Centro Manutenzione</h2>

      <div class="settings-grid">
        <!-- EXPORT -->
        <div class="settings-card export-card" id="exportAction">
          <div class="settings-icon"><i class="fas fa-download"></i></div>
          <div class="settings-info">
            <span class="settings-title">Esporta Dati</span>
            <span class="settings-desc">Scarica un backup locale (JSON)</span>
          </div>
        </div>

        <!-- IMPORT -->
        <div class="settings-card import-card" id="importAction">
          <div class="settings-icon"><i class="fas fa-upload"></i></div>
          <div class="settings-info">
            <span class="settings-title">Importa Dati</span>
            <span class="settings-desc">Ripristina da un file salvato</span>
          </div>
        </div>

        <!-- RESET -->
        <div class="settings-card reset-card" id="resetAction">
          <div class="settings-icon"><i class="fas fa-trash-alt"></i></div>
          <div class="settings-info">
            <span class="settings-title">Resetta Tracker</span>
            <span class="settings-desc">Cancella tutto (Azione irreversibile)</span>
          </div>
        </div>
        <input type="file" id="importFile" accept=".json" style="display: none;">
      </div>

      <div id="lastBackupBadge" class="last-backup-info">
        <i class="fas fa-history"></i> Ultimo backup: <span>Mai eseguito</span>
      </div>

      <div class="modal-footer" style="border-top: none;">
        <button onclick="closeModal(document.getElementById('settingsModal'))" class="btn btn-secondary"
          style="width: 100%;">Chiudi</button>
      </div>
    </div>
  </div>

  <script>
    const OMDb_API_KEY = "2526ef70";
    const TMDB_KEY = atob("MmNkOGJiNDgzYWIxMjE0ZDY2MDIwZTcwYjBhMzZmYTQ=");
    const MDBLIST_PROXY_URL = "https://serietvtracker.amrit-singh99mail-5e3.workers.dev";
    const DEFAULT_POSTER = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiB2aWV3Qm94PSIwIDAgMzAwIDQ1MCI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZ2h0PSI0NTAiIGZpbGw9IiNkZGQiLz48dGV4dCB4PSIxNTAiIHk9IjIyNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNjY2Ij5OZXNzYSBpbWFnaW5lPC90ZXh0Pjwvc3ZnPg==";
    const DEFAULT_ACTOR_PHOTO = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj4KICA8cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzJiMmIyYiIvPgogIDxnIGZpbGw9IiM0NDQiPgogICAgPGNpcmNsZSBjeD0iNTAiIGN5PSIzOCIgcj0iMTgiLz4KICAgIDxwYXRoIGQ9Ik0yMCw5NSBDMjAsNjUgMzAsNTggNTAsNTggQzcwLDU4IDgwLDY1IDgwLDk1IEw4MCwxMDAgTDIwLDEwMCBaIi8+CiAgPC9nPgo8L3N2Zz4=";
    const DEFAULT_CATEGORIES = ["watchlist", "watched"];
    const ROTTEN_TOMATOES_ICONS = { certified: "https://upload.wikimedia.org/wikipedia/uk/b/b2/Certified_Fresh_2018.svg", fresh: "https://upload.wikimedia.org/wikipedia/commons/5/5b/Rotten_Tomatoes.svg", rotten: "https://upload.wikimedia.org/wikipedia/commons/5/52/Rotten_Tomatoes_rotten.svg" };
    const POPCORN_ICONS = { positive: "https://upload.wikimedia.org/wikipedia/commons/d/da/Rotten_Tomatoes_positive_audience.svg", negative: "https://upload.wikimedia.org/wikipedia/commons/6/63/Rotten_Tomatoes_negative_audience.svg" };
    const IMDB_STAR_ICON = "https://upload.wikimedia.org/wikipedia/commons/2/29/Gold_Star.svg";
    const LETTERBOXD_ICON = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTH45TgrphrMnMTlMx9wpG_Jj7JoBzrI9zAfg&s";
    const METACRITIC_ICON = "https://upload.wikimedia.org/wikipedia/commons/f/f2/Metacritic_M.png";
    const MAX_NOTIFICATIONS = 50;
    const MAX_LOG_SIZE = 15;

    let mediaList = [], categories = [...DEFAULT_CATEGORIES], currentTMDbSelection = null, currentUser = null, isViewMode = false, debounceTimeout, lazyLoadObserver, currentRewatchMediaId = null;
    let followedFriends = [], lastCheckedTimestamps = {}, friendListeners = {};
    let statContributorIds = new Set();
    let ignoredDuplicateIds = new Set();
    const firebaseConfig = { apiKey: "AIzaSyDm946nISfZs8ugkuYPraNTzFhvgQmnMUk", authDomain: "gametrackerdb.firebaseapp.com", databaseURL: "https://gametrackerdb-default-rtdb.europe-west1.firebasedatabase.app", projectId: "gametrackerdb" };

    const elements = {
      appLoader: document.getElementById("appLoader"),
      authModal: document.getElementById("authModal"), authToggle: document.getElementById("authToggle"),
      userInfo: document.getElementById("userInfo"), loginBtn: document.getElementById("loginBtn"),
      loginEmail: document.getElementById("loginEmail"), loginPassword: document.getElementById("loginPassword"),
      registerBtn: document.getElementById("registerBtn"), registerEmail: document.getElementById("registerEmail"),
      registerPassword: document.getElementById("registerPassword"), registerConfirmPassword: document.getElementById("registerConfirmPassword"),
      logoutBtn: document.getElementById("logoutBtn"), loginForm: document.getElementById("loginForm"),
      registerForm: document.getElementById("registerForm"), mediaManagementBtn: document.getElementById("mediaManagementBtn"),
      shareBtn: document.getElementById("shareBtn"),
      settingsBtn: document.getElementById("settingsBtn"),
      importFile: document.getElementById("importFile"),
      themeToggle: document.getElementById("themeToggle"),
      searchInput: document.getElementById("searchInput"), categoryFilter: document.getElementById("categoryFilter"),
      sortFilter: document.getElementById("sortFilter"), statTotal: document.getElementById("statTotal"),
      statWatchlist: document.getElementById("statWatchlist"), statWatched: document.getElementById("statWatched"),
      statRewatched: document.getElementById("statRewatched"), statHours: document.getElementById("statHours"),
      mediaSectionsContainer: document.getElementById("mediaSectionsContainer"), mediaManagementModal: document.getElementById("mediaManagementModal"),
      mediaTitle: document.getElementById("mediaTitle"), searchTMDbBtn: document.getElementById("searchTMDbBtn"),
      tmdbResults: document.getElementById("tmdbResults"), saveMediaBtn: document.getElementById("saveMediaBtn"),
      addMediaCategorySelect: document.getElementById("addMediaCategorySelect"), newCategoryName: document.getElementById("newCategoryName"),
      addCategoryBtn: document.getElementById("addCategoryBtn"), categoriesList: document.getElementById("categoriesList"),
      closeManagementModal: document.getElementById("closeManagementModal"),
      notification: document.getElementById("notification"), notificationText: document.getElementById("notificationText"),
      shareModal: document.getElementById("shareModal"), shareLinkInput: document.getElementById("shareLinkInput"),
      copyShareLinkBtn: document.getElementById("copyShareLinkBtn"), closeShareModalBtn: document.getElementById("closeShareModalBtn"),
      viewModeBanner: document.getElementById("viewModeBanner"), viewModeUserEmail: document.getElementById("viewModeUserEmail"),
      closeViewBtn: document.getElementById("closeViewBtn"), posterModal: document.getElementById("posterModal"),
      posterGrid: document.getElementById("posterGrid"),
      confirmModal: document.getElementById("confirmModal"), confirmModalTitle: document.getElementById("confirmModalTitle"),
      confirmModalBody: document.getElementById("confirmModalBody"), confirmModalConfirm: document.getElementById("confirmModalConfirm"),
      confirmModalCancel: document.getElementById("confirmModalCancel"),
      rewatchModal: document.getElementById("rewatchModal"), rewatchModalTitle: document.getElementById("rewatchModalTitle"),
      rewatchCountInput: document.getElementById("rewatchCountInput"), confirmRewatchBtn: document.getElementById("confirmRewatchBtn"),
      cancelRewatchBtn: document.getElementById("cancelRewatchBtn"),
      addFriendBtn: document.getElementById('addFriendBtn'),
      friendIdInput: document.getElementById('friendIdInput'),
      friendsList: document.getElementById('friendsList'),
      notificationBellContainer: document.getElementById('notificationBellContainer'),
      bellIcon: document.getElementById('bellIcon'),
      notificationBadge: document.getElementById('notificationBadge'),
      notificationDropdown: document.getElementById('notificationDropdown'),
      savePosterChange: document.getElementById('savePosterChange'),
      cancelPosterChange: document.getElementById('cancelPosterChange'),
      detailsModal: document.getElementById('detailsModal'),
      detailsModalContent: document.getElementById('detailsModalContent'),
      detailsModalClose: document.getElementById('detailsModalClose'),
      actorModal: document.getElementById('actorModal'),
      actorModalContent: document.getElementById('actorModalContent'),
      actorModalClose: document.getElementById('actorModalClose'),
      updateProgressModal: document.getElementById('updateProgressModal'),
      updateProgressBarFill: document.getElementById('updateProgressBarFill'),
      updateProgressText: document.getElementById('updateProgressText'),
      updateProgressTitle: document.getElementById('updateProgressTitle'),
      // Bottom Nav Bar Elements
      bottomNavAdd: document.getElementById('bottomNavAdd'),
      bottomNavManage: document.getElementById('bottomNavManage'),

      bottomNavNotifications: document.getElementById('bottomNavNotifications'),
      bottomNavHome: document.getElementById('bottomNavHome'),
      notificationBadgeMobile: document.getElementById('notificationBadgeMobile'),
      // Mobile Modals and Buttons
      mobileMenuModal: document.getElementById('mobileMenuModal'),
      mobileMenuCloseBtn: document.getElementById('mobileMenuCloseBtn'),
      mobileMenuUserActionBtn: document.getElementById('mobileMenuUserActionBtn'),
      mobileMenuShareBtn: document.getElementById('mobileMenuShareBtn'),
      mobileMenuExportBtn: document.getElementById('mobileMenuExportBtn'),
      mobileMenuImportBtn: document.getElementById('mobileMenuImportBtn'),
      mobileMenuThemeBtn: document.getElementById('mobileMenuThemeBtn'),
      mobileMenuResetBtn: document.getElementById('mobileMenuResetBtn'),
      mobileNotificationsModal: document.getElementById('mobileNotificationsModal'),
      mobileNotificationsCloseBtn: document.getElementById('mobileNotificationsCloseBtn'),
      notificationListMobile: document.getElementById('notificationListMobile'),
      markAllReadMobileBtn: document.getElementById('markAllReadMobileBtn'),
      // Filter Modal
      filterSortModal: document.getElementById('filterSortModal'),
      mobileFilterBtn: document.getElementById('mobileFilterBtn'),
      mobileCategoryFilter: document.getElementById('mobileCategoryFilter'),
      mobileSortFilter: document.getElementById('mobileSortFilter'),
      applyFiltersBtn: document.getElementById('applyFiltersBtn'),
      // Category Navigation Modal
      categoryNavModal: document.getElementById('categoryNavModal'),
      categoryNavList: document.getElementById('categoryNavList'),
      closeCategoryNavBtn: document.getElementById('closeCategoryNavBtn'),
      // Advanced Stats Modals
      advancedStatsModal: document.getElementById('advancedStatsModal'),
      genresChart: document.getElementById('genresChart'),
      activityChart: document.getElementById('activityChart'),
      chartDetailsModal: document.getElementById('chartDetailsModal'),
      chartDetailsTitle: document.getElementById('chartDetailsTitle'),
      chartDetailsList: document.getElementById('chartDetailsList'),
    };

    const defaultMediaProps = {
      isCountedAsWatched: false,
      isCountedAsWatchlist: false,
      rewatchCount: 0,
      lastActivityAt: null,
      isFavorite: false,
      rottenTomatoes: "N/A",
      popcornRating: "N/A",
      metacriticRating: "N/A",
      letterboxdRating: "N/A",
      tmdbID: null,
      italianTitle: null,
      genres: []
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    window.addEventListener("load", init);

    function init() {
      setupEventListeners();
      setupManagementModal();
      loadTheme();
      loadSortOrder();
      updateSwitcherLinksInViewMode();
      handleViewMode() || setupAuthListeners();
    }

    function updateSwitcherLinksInViewMode() {
      const params = new URLSearchParams(window.location.search);
      const viewId = params.get('view');
      if (viewId) {
        const filmTrackerLink = document.querySelector('.tracker-switch-btn[href="index.html"]');
        const tvTrackerLink = document.querySelector('.tracker-switch-btn[href="serietv_tracker.html"]');
        if (filmTrackerLink) filmTrackerLink.href = `index.html?view=${viewId}`;
        if (tvTrackerLink) tvTrackerLink.href = `serietv_tracker.html?view=${viewId}`;
      }
    }

    function hideLoader() {
      elements.appLoader.style.opacity = '0';
      setTimeout(() => elements.appLoader.style.display = 'none', 300);
    }

    function setupManagementModal() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

          btn.classList.add('active');
          document.getElementById(`${btn.dataset.tab}-tab`).classList.add('active');

          elements.saveMediaBtn.style.display = (btn.dataset.tab === 'add-media') ? 'inline-flex' : 'none';
        });
      });
      elements.saveMediaBtn.addEventListener('click', () => {
        if (!currentTMDbSelection) return showNotification("Cerca e seleziona un film.", "warning");
        addNewMedia(currentTMDbSelection.tmdbId);
      });
      elements.closeManagementModal.addEventListener('click', () => closeModal(elements.mediaManagementModal));
    }

    function openMediaManagementModal() {
      if (isViewMode) return;
      elements.mediaTitle.value = "";
      elements.tmdbResults.innerHTML = "";
      currentTMDbSelection = null;

      populateAddMediaCategorySelect();
      renderCategoriesList();
      renderFriendsList();

      const myIdContainer = document.getElementById('myIdContainer');
      const myIdInput = document.getElementById('myIdInput');
      const copyMyIdBtn = document.getElementById('copyMyIdBtn');

      if (currentUser && myIdContainer && myIdInput && copyMyIdBtn) {
        myIdContainer.style.display = 'block';
        myIdInput.value = currentUser.uid;
        copyMyIdBtn.onclick = () => {
          navigator.clipboard.writeText(currentUser.uid);
          showNotification("Il tuo ID è stato copiato!", "success");
        };
      } else if (myIdContainer) {
        myIdContainer.style.display = 'none';
      }

      const addMediaTab = document.querySelector('.tab-btn[data-tab="add-media"]');
      if (addMediaTab.classList.contains('active')) {
        elements.saveMediaBtn.style.display = 'inline-flex';
      } else {
        elements.saveMediaBtn.style.display = 'none';
      }

      openModal(elements.mediaManagementModal);
    }

    function getRottenTomatoesState(score) { if (!score || score === "N/A") return null; const value = parseInt(String(score).replace('%', '')); return isNaN(value) ? null : value >= 75 ? "certified" : value >= 60 ? "fresh" : "rotten"; }
    function getPopcornState(score) { if (!score || score === "N/A") return null; const value = parseInt(String(score).replace('%', '')); return isNaN(value) ? null : value >= 60 ? "positive" : "negative"; }
    function getMetacriticState(score) { if (!score || score === "N/A") return null; const value = parseInt(score); return isNaN(value) ? null : value >= 61 ? "favorable" : value >= 40 ? "mixed" : "unfavorable"; }

    function setupAuthListeners() {
      elements.authToggle.addEventListener("click", () => openModal(elements.authModal));

      document.querySelectorAll(".auth-tab").forEach(tab => {
        tab.addEventListener("click", () => {
          document.querySelectorAll(".auth-tab").forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          document.querySelectorAll(".auth-form-container").forEach(c => c.classList.remove("active"));
          document.getElementById(`${tab.dataset.tab}Form`).classList.add("active");
        });
      });
      elements.loginBtn.addEventListener("click", () => {
        const email = elements.loginEmail.value;
        const password = elements.loginPassword.value;
        if (email && password) {
          firebase.auth().signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
              if (userCredential.user) {
                const userRef = db.ref(`users/${userCredential.user.uid}/email`);
                userRef.once('value', snapshot => {
                  if (!snapshot.exists()) {
                    userRef.set(email);
                  }
                });
              }
              showNotification("Login effettuato", "success");
              elements.authForms.classList.remove("active");
            })
            .catch(err => showNotification(getAuthErrorMessage(err), "error"));
        } else {
          showNotification("Inserisci email e password", "warning");
        }
      });
      elements.registerBtn.addEventListener("click", () => {
        const email = elements.registerEmail.value;
        const password = elements.registerPassword.value;
        const confirmPassword = elements.registerConfirmPassword.value;
        if (email && password && confirmPassword) {
          if (password !== confirmPassword) {
            showNotification("Le password non corrispondono", "warning");
          } else if (password.length < 6) {
            showNotification("La password deve avere almeno 6 caratteri", "warning");
          } else {
            firebase.auth().createUserWithEmailAndPassword(email, password)
              .then((userCredential) => {
                db.ref(`users/${userCredential.user.uid}/email`).set(email);
                showNotification("Registrazione completata!", "success");
                elements.authForms.classList.remove("active");
              })
              .catch(err => showNotification(getAuthErrorMessage(err), "error"));
          }
        } else {
          showNotification("Compila tutti i campi", "warning");
        }
      });
      elements.logoutBtn.addEventListener("click", () => {
        detachAllFriendListeners();
        firebase.auth().signOut();
      });

      firebase.auth().onAuthStateChanged(user => {
        if (isViewMode) return;
        currentUser = user;
        updateAuthUI();
        if (user) {
          loadData();
        } else {
          loadLocalData();
          hideLoader();
        }
      });
    }

    function getAuthErrorMessage(err) {
      switch (err.code) {
        case "auth/email-already-in-use": return "Email già registrata";
        case "auth/invalid-email": return "Email non valida";
        case "auth/weak-password": return "Password troppo debole";
        case "auth/user-not-found": return "Utente non trovato";
        case "auth/wrong-password": return "Password errata";
        default: return "Errore: " + err.message;
      }
    }

    function updateAuthUI() {
      const userActionBtn = document.getElementById('mobileMenuUserActionBtn');
      const userActionBtnIcon = userActionBtn ? userActionBtn.querySelector('i') : null;
      const userActionBtnLabel = userActionBtn ? userActionBtn.querySelector('span') : null;
      if (currentUser) {
        elements.userInfo.style.display = "flex";
        elements.authToggle.style.display = "none";
        elements.notificationBellContainer.style.display = 'block';
        document.querySelectorAll(".btn").forEach(btn => btn.disabled = false);
        if (userActionBtn) {
          if (userActionBtnLabel) {
            userActionBtnLabel.textContent = 'Logout';
          } else {
            userActionBtn.textContent = 'Logout';
          }
          userActionBtn.style.color = 'var(--danger)';
          if (userActionBtnIcon) {
            userActionBtnIcon.style.color = 'var(--danger)';
          }
        }
      } else {
        elements.userInfo.style.display = "none";
        elements.authToggle.style.display = "inline-flex";
        elements.notificationBellContainer.style.display = 'none';
        document.querySelectorAll("#mediaManagementBtn, #shareBtn").forEach(btn => btn.disabled = true);
        document.querySelectorAll("#exportBtn, #importBtn, #resetBtn").forEach(btn => btn.disabled = false);
        if (userActionBtn) {
          if (userActionBtnLabel) {
            userActionBtnLabel.textContent = 'Login / Registrati';
          } else {
            userActionBtn.textContent = 'Login / Registrati';
          }
          userActionBtn.style.color = '';
          if (userActionBtnIcon) {
            userActionBtnIcon.style.color = '';
          }
        }
      }
    }

    function loadData() {
      if (!currentUser) return;
      const path = `users/${currentUser.uid}`;
      db.ref(`${path}/mediaTracker`).on("value", snap => {
        const data = snap.val() || {};
        mediaList = (data.mediaList || []).map(item => ({ ...defaultMediaProps, ...item }));
        categories = data.categories || [...DEFAULT_CATEGORIES];
        renderFullUI();
      });

      db.ref(`${path}/social`).once("value", snapshot => {
        const data = snapshot.val() || {};
        followedFriends = data.followedFriends || [];
        lastCheckedTimestamps = data.lastCheckedTimestamps || {};
        if (!isViewMode) {
          setupFriendListeners();
          renderFriendsList();
        }
      });
      hideLoader();
    }

    function loadLocalData() {
      try {
        let storedMedia = JSON.parse(localStorage.getItem("mediaList")) || [];
        mediaList = storedMedia.map(item => ({ ...defaultMediaProps, ...item }));
        categories = JSON.parse(localStorage.getItem("categories")) || [...DEFAULT_CATEGORIES];
        renderFullUI();
      } catch (err) {
        console.error("Error loading local data:", err);
      }
    }

    function saveData() {
      if (isViewMode) return;
      if (currentUser) {
        const now = new Date().toISOString();
        db.ref(`users/${currentUser.uid}/mediaTracker`).update({
          mediaList: mediaList,
          categories: categories,
          lastModified: now
        }).catch(err => {
          console.error("Error updating media data to Firebase:", err);
        });
      } else {
        saveToLocal();
      }
    }

    function saveSocialData() {
      if (isViewMode || !currentUser) return;
      db.ref(`users/${currentUser.uid}/social`).set({ followedFriends, lastCheckedTimestamps }).catch(err => {
        console.error("Error saving social data to Firebase:", err);
      });
    }

    function saveToLocal() {
      try {
        localStorage.setItem("mediaList", JSON.stringify(mediaList));
        localStorage.setItem("categories", JSON.stringify(categories));
      } catch (err) {
        console.error("Error saving locally:", err);
      }
    }

    function handleViewMode() {
      const viewId = new URLSearchParams(window.location.search).get("view");
      if (!viewId) return false;
      isViewMode = true;
      document.body.style.paddingBottom = '0';
      document.getElementById('bottomNav').style.display = 'none';
      document.querySelectorAll("#mediaManagementBtn, #shareBtn, #exportBtn, #importBtn, #resetBtn, #authToggle, #userInfo, .notification-bell-container").forEach(el => el.style.display = "none");
      elements.viewModeBanner.style.display = "flex";
      db.ref(`users/${viewId}/mediaTracker`).on("value", snapshot => {
        const data = snapshot.val();
        if (data) {
          let storedMedia = data.mediaList || [];
          mediaList = storedMedia.map(item => ({ ...defaultMediaProps, ...item }));
          categories = data.categories || [...DEFAULT_CATEGORIES];
          renderFullUI();
          db.ref(`users/${viewId}/email`).once("value", snapshot => {
            const email = snapshot.val();
            elements.viewModeUserEmail.textContent = `Stai visualizzando la libreria di ${email || "un utente"}`;
          });
        } else {
          showNotification("Libreria condivisa non trovata o non accessibile.", "error");
        }
        hideLoader();
      });
      return true;
    }

    function renderFullUI() {
      renderCategorySections();
      updateCategoryFilter();
      populateAddMediaCategorySelect();
      renderCategoriesList();
      updateStats();
      renderMedia();
    }

    function populateCategoryNavModal() {
      const container = elements.categoryNavList;
      container.innerHTML = '';

      // Add all categories (including default ones like watchlist and watched)
      categories.forEach((cat) => {
        const btn = document.createElement('button');
        btn.className = 'btn';

        // Determine icon and display name based on category
        let icon = 'fa-folder';
        let displayName = cat;

        if (cat === 'watchlist') {
          icon = 'fa-bookmark';
          displayName = 'Da Vedere';
        } else if (cat === 'watched') {
          icon = 'fa-check-circle';
          displayName = 'Visti';
        }

        btn.innerHTML = `<i class="fas ${icon}"></i> ${displayName}`;
        btn.addEventListener('click', () => {
          closeModal(elements.categoryNavModal);
          setTimeout(() => {
            const section = document.getElementById(`${cat}Section`);
            if (section) {
              const headerOffset = 80; // Adjust for sticky header or top bar if needed
              const elementPosition = section.getBoundingClientRect().top;
              const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

              window.scrollTo({
                top: offsetPosition,
                behavior: "smooth"
              });
            }
          }, 300);
        });
        container.appendChild(btn);
      });
    }

    function renderMedia() {
      const selectedCategory = elements.categoryFilter.value;
      const searchTerm = elements.searchInput.value.toLowerCase();
      const sortBy = elements.sortFilter.value;

      document.querySelectorAll(".media-section").forEach(section => {
        section.style.display = 'block';
        section.querySelector('.media-grid').innerHTML = '';
      });

      let filteredMedia = [...mediaList];
      if (searchTerm) {
        filteredMedia = filteredMedia.filter(m =>
          m.title.toLowerCase().includes(searchTerm) ||
          (m.italianTitle && m.italianTitle.toLowerCase().includes(searchTerm))
        );
      }
      if (selectedCategory === "favorites") {
        filteredMedia = filteredMedia.filter(m => m.isFavorite);
      } else if (selectedCategory !== "all") {
        filteredMedia = filteredMedia.filter(m => m.category === selectedCategory);
      }

      filteredMedia.sort((a, b) => {
        switch (sortBy) {
          case "saga-alpha":
            const aSagaCount = a.sagaName ? filteredMedia.filter(m => m.sagaName === a.sagaName).length : 0;
            const bSagaCount = b.sagaName ? filteredMedia.filter(m => m.sagaName === b.sagaName).length : 0;
            const isASaga = a.sagaName && aSagaCount > 1;
            const isBSaga = b.sagaName && bSagaCount > 1;

            const sortKeyA = isASaga ? a.sagaName : a.title;
            const sortKeyB = isBSaga ? b.sagaName : b.title;

            if (sortKeyA !== sortKeyB) {
              return sortKeyA.localeCompare(sortKeyB);
            }

            const dateA = a.releaseDate || '0';
            const dateB = b.releaseDate || '0';
            return new Date(dateA) - new Date(dateB);
          case "alpha":
            return a.title.localeCompare(b.title);
          case "rating":
            return (parseFloat(b.imdbRating) || 0) - (parseFloat(a.imdbRating) || 0);
          case "year":
            return (parseInt(b.year) || 0) - (parseInt(a.year) || 0);
          case "added":
          default:
            const timeA = a.lastActivityAt || a.addedAt;
            const timeB = b.lastActivityAt || b.addedAt;
            return new Date(timeB) - new Date(timeA);
        }
      });

      filteredMedia.forEach(media => {
        const grid = document.getElementById(`${media.category}Grid`);
        if (grid) grid.appendChild(createMediaCard(media));
      });

      let hasContent = false;
      categories.forEach(cat => {
        const section = document.getElementById(`${cat}Section`);
        const grid = document.getElementById(`${cat}Grid`);
        if (section && grid) {
          if (grid.children.length === 0) {
            if (selectedCategory === 'all' || selectedCategory === cat) {
              grid.innerHTML = `<div class="empty-state"><i class="fas fa-film"></i><p>Nessun film in questa categoria.</p></div>`;
            } else {
              section.style.display = 'none';
            }
          } else {
            hasContent = true;
          }
        }
      });

      if (selectedCategory === 'favorites' && !filteredMedia.length) {
        renderCategorySections();
        elements.mediaSectionsContainer.innerHTML = `<div class="media-section"><div class="empty-state"><i class="fas fa-heart-crack"></i><p>Nessun preferito aggiunto.</p></div></div>`;
      } else if (selectedCategory === 'favorites' && filteredMedia.length > 0) {
        document.querySelectorAll('.media-section').forEach(s => {
          if (s.querySelector('.media-grid').children.length === 0) s.style.display = 'none';
        })
      }


      setupLazyLoading();
      updateCounts();
    }

    function updateStats() {
      statContributorIds.clear();
      ignoredDuplicateIds.clear();
      const processed = new Set();
      mediaList.forEach(media => {
        const uniqueId = media.imdbID || media.title.toLowerCase().trim();
        if (!uniqueId || processed.has(uniqueId)) return;
        processed.add(uniqueId);
        const instances = mediaList.filter(m => (m.imdbID && m.imdbID === uniqueId) || (!m.imdbID && m.title.toLowerCase() === uniqueId));
        let contributor = instances.find(m => m.category === "watched") ||
          instances.find(m => m.isCountedAsWatched) ||
          instances.find(m => m.category === "watchlist") ||
          instances.find(m => m.isCountedAsWatchlist) ||
          instances[0];
        if (contributor) {
          statContributorIds.add(contributor.id);
          instances.forEach(inst => {
            if (inst.id !== contributor.id) ignoredDuplicateIds.add(inst.id);
          });
        }
      });

      const stats = { watchlist: 0, watched: 0, rewatched: 0, minutes: 0 };
      statContributorIds.forEach(id => {
        const media = mediaList.find(m => m.id === id);
        if (!media) return;
        const isWatched = media.category === "watched" || media.isCountedAsWatched;
        if (isWatched) {
          stats.watched++;
          if (media.rewatchCount > 0) stats.rewatched += media.rewatchCount;
          const runtime = parseInt(media.runtime?.replace(/\D/g, "")) || 0;
          if (runtime > 0) stats.minutes += runtime * ((media.rewatchCount || 0) + 1);
        } else if (media.category === "watchlist" || media.isCountedAsWatchlist) {
          stats.watchlist++;
        }
      });

      const hours = Math.floor(stats.minutes / 60);
      stats.minutes %= 60;

      elements.statTotal.textContent = statContributorIds.size;

      elements.statWatchlist.textContent = stats.watchlist;
      elements.statWatched.textContent = stats.watched;
      elements.statRewatched.textContent = stats.rewatched;
      elements.statHours.textContent = `${hours}h ${stats.minutes}m`;
    }

    function updateCounts() {
      categories.forEach(cat => {
        const countEl = document.getElementById(`${cat}Count`);
        if (countEl) countEl.textContent = mediaList.filter(m => m.category === cat).length;
      });
    }

    function createMediaCard(media) {
      const card = document.createElement("div");
      card.className = "media-card";
      card.dataset.id = media.id;
      if (statContributorIds.has(media.id)) card.classList.add("is-stat-contributor");
      if (ignoredDuplicateIds.has(media.id)) card.classList.add("is-duplicate");

      card.addEventListener('click', (e) => {
        if (e.target.closest('.card-actions') || e.target.closest('.favorite-btn')) return;
        showDetailsModal(media.id);
      });

      let ratingsHTML = "";
      const rtState = getRottenTomatoesState(media.rottenTomatoes);
      const popcornState = getPopcornState(media.popcornRating);

      if (media.imdbRating && media.imdbRating !== "N/A") { ratingsHTML += `<span class="rating-badge"><img src="${IMDB_STAR_ICON}" class="rating-icon">&nbsp;${media.imdbRating}</span>`; }
      if (rtState) { ratingsHTML += `<span class="rating-badge"><img src="${ROTTEN_TOMATOES_ICONS[rtState]}" class="rating-icon">&nbsp;${media.rottenTomatoes}</span>`; }
      if (popcornState) { ratingsHTML += `<span class="rating-badge"><img src="${POPCORN_ICONS[popcornState]}" class="rating-icon">&nbsp;${media.popcornRating}</span>`; }

      const ratingsSection = ratingsHTML ? `<div class="media-ratings">${ratingsHTML}</div>` : "";

      const actionsHTML = isViewMode ? '' : `
        <div class="card-actions">
            <button class="card-btn" data-action="move" title="Sposta in..."><i class="fas fa-folder-open"></i></button>
            <button class="card-btn" data-action="delete" title="Elimina"><i class="fas fa-trash"></i></button>
        </div>`;

      card.innerHTML = `
        <div class="poster-container">
          <img data-src="${fixPosterUrl(media.poster) || DEFAULT_POSTER}" class="media-poster lazy" onerror="this.src='${DEFAULT_POSTER}'">
          <button class="favorite-btn ${media.isFavorite ? 'is-favorite' : ''}" title="Aggiungi ai preferiti"><i class="fas fa-heart"></i></button>
          ${actionsHTML}
        </div>
        <div class="media-info">
          <h3 class="media-title" title="${media.title}">${media.title}</h3>
          <div class="media-meta">
            ${media.year ? `<span>${media.year}</span>` : ""}
            ${media.runtime ? `<span><i class="fas fa-clock"></i> ${formatRuntime(media.runtime)}</span>` : ""}
            ${(media.rewatchCount && media.rewatchCount > 0) ? `<span title="${media.rewatchCount} Rewatch"><i class="fas fa-redo" style="font-size: 0.8em;"></i> ${media.rewatchCount}</span>` : ""}
          </div>
          ${ratingsSection}
        </div>
      `;
      if (!isViewMode) {
        card.addEventListener('contextmenu', e => {
          e.preventDefault();
          showContextMenu(media, { x: e.clientX, y: e.clientY });
        });
        card.querySelector('[data-action="move"]').addEventListener("click", e => {
          e.stopPropagation();
          showContextMenu(media, { x: e.clientX, y: e.clientY });
        });
        card.querySelector('[data-action="delete"]').addEventListener("click", e => {
          e.stopPropagation();
          deleteMedia(media.id);
        });
        card.querySelector('.favorite-btn').addEventListener("click", e => {
          e.stopPropagation();
          toggleFavorite(media.id);
        })
      }
      return card;
    }

    function fixPosterUrl(url) {
      if (!url || url === "N/A") return null;
      return url.startsWith("http://") || url.startsWith("https://") ? url : url.startsWith("//") ? `https:${url}` : `https://${url}`;
    }

    function renderCategorySections() {
      elements.mediaSectionsContainer.innerHTML = categories.map(cat => `
        <div class="media-section" id="${cat}Section" data-category="${cat}">
          <div class="section-header">
            <h2 class="section-title user-select-none">${getCategoryName(cat)}</h2>
            <span id="${cat}Count" class="category-count">0</span>
          </div>
          <div class="media-grid" id="${cat}Grid"></div>
        </div>
      `).join("");
    }

    function renderCategoriesList() {
      const list = elements.categoriesList;
      list.innerHTML = "";
      categories.forEach((cat, index) => {
        const count = mediaList.filter(m => m.category === cat).length;
        const dotClass = `category-dot-${index % 6}`;
        const card = document.createElement("div");
        card.className = "management-card";
        const isDefault = DEFAULT_CATEGORIES.includes(cat);
        card.innerHTML = `
          <div>
            <span class="category-dot ${dotClass}"></span>
            <div>
              <div class="category-name">${getCategoryName(cat)}</div>
            </div>
          </div>
          <div class="management-card-actions">
            <button class="btn move-up-btn" data-category="${cat}" ${index === 0 ? "disabled" : ""}><i class="fas fa-arrow-up"></i></button>
            <button class="btn move-down-btn" data-category="${cat}" ${index === categories.length - 1 ? "disabled" : ""}><i class="fas fa-arrow-down"></i></button>
            ${!isDefault ? `
              <button class="btn rename-category-btn" data-category="${cat}"><i class="fas fa-pencil-alt"></i></button>
              <button class="btn btn-danger delete-category-btn" data-category="${cat}"><i class="fas fa-trash"></i></button>
            ` : ""}
          </div>
        `;
        list.appendChild(card);
      });
      list.querySelectorAll(".rename-category-btn").forEach(btn => {
        btn.addEventListener("click", e => {
          e.stopPropagation();
          const cat = btn.dataset.category;
          const nameEl = btn.closest(".management-card").querySelector(".category-name");
          renameCategory(cat, nameEl);
        });
      });
      list.querySelectorAll(".delete-category-btn").forEach(btn => {
        btn.addEventListener("click", e => {
          e.stopPropagation();
          deleteCategory(btn.dataset.category);
        });
      });
      list.querySelectorAll(".move-up-btn").forEach(btn => btn.addEventListener("click", () => moveCategory(btn.dataset.category, -1)));
      list.querySelectorAll(".move-down-btn").forEach(btn => btn.addEventListener("click", () => moveCategory(btn.dataset.category, 1)));
    }

    function renameCategory(cat, nameEl) {
      if (DEFAULT_CATEGORIES.includes(cat)) return;

      const oldName = cat;
      const input = document.createElement("input");
      input.type = "text";
      input.value = oldName;
      input.className = "category-name-input";
      input.style.width = "100%";

      nameEl.innerHTML = "";
      nameEl.appendChild(input);
      input.focus();

      const save = () => {
        const newName = input.value.trim();
        if (newName && newName !== oldName) {
          if (categories.includes(newName)) {
            showNotification("Questa categoria esiste già", "warning");
            renderCategoriesList();
            return;
          }
          const catIndex = categories.indexOf(oldName);
          if (catIndex !== -1) {
            categories[catIndex] = newName;
          }
          mediaList.forEach(m => {
            if (m.category === oldName) {
              m.category = newName;
            }
          });
          saveData();
          renderFullUI();
          showNotification(`Categoria rinominata in "${newName}"`, "success");
        } else {
          renderCategoriesList();
        }
      };

      input.addEventListener("blur", save);
      input.addEventListener("keydown", e => {
        if (e.key === "Enter") {
          e.preventDefault();
          input.blur();
        }
        if (e.key === "Escape") {
          e.preventDefault();
          renderCategoriesList();
        }
      });
    }

    function moveCategory(cat, direction) {
      const index = categories.indexOf(cat);
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= categories.length) return;
      [categories[index], categories[newIndex]] = [categories[newIndex], categories[index]];
      saveData();
      renderFullUI();
    }

    function updateCategoryFilter() {
      const current = elements.categoryFilter.value;
      elements.categoryFilter.innerHTML = `<option value="all">Tutte le categorie</option><option value="favorites">Solo Preferiti</option>${categories.map(cat => `<option value="${cat}">${getCategoryName(cat)}</option>`).join("")}`;
      elements.categoryFilter.value = current;
      elements.mobileCategoryFilter.innerHTML = elements.categoryFilter.innerHTML;
      elements.mobileCategoryFilter.value = current;
    }

    function populateAddMediaCategorySelect() {
      const lastUsed = localStorage.getItem("lastUsedCategory");
      elements.addMediaCategorySelect.innerHTML = categories.map(cat => `<option value="${cat}">${getCategoryName(cat)}</option>`).join("");
      if (lastUsed && categories.includes(lastUsed)) elements.addMediaCategorySelect.value = lastUsed;
    }

    function getCategoryName(cat) {
      const names = { watchlist: "Da Vedere", watched: "Visti" };
      return names[cat] || cat;
    }

    function addCategory(name) {
      if (!name) return showNotification("Inserisci un nome per la categoria", "warning"), false;
      const trimmed = name.trim();
      if (categories.some(c => c.toLowerCase() === trimmed.toLowerCase())) {
        showNotification("Questa categoria esiste già", "warning");
        return false;
      }
      categories.push(trimmed);
      saveData();
      renderFullUI();
      showNotification(`Categoria "${trimmed}" creata`, "success");
      elements.newCategoryName.value = "";
      return true;
    }

    function showConfirmModal(title, body, onConfirm) {
      elements.confirmModalTitle.textContent = title;
      elements.confirmModalBody.textContent = body;
      openModal(elements.confirmModal);
      const confirmHandler = () => { onConfirm(); closeModal(elements.confirmModal); cleanup(); };
      const cancelHandler = () => { closeModal(elements.confirmModal); cleanup(); };
      const cleanup = () => {
        elements.confirmModalConfirm.removeEventListener("click", confirmHandler);
        elements.confirmModalCancel.removeEventListener("click", cancelHandler);
      };
      elements.confirmModalConfirm.addEventListener("click", confirmHandler);
      elements.confirmModalCancel.addEventListener("click", cancelHandler);
    }

    function deleteCategory(cat) {
      if (DEFAULT_CATEGORIES.includes(cat)) {
        showNotification("Non puoi eliminare questa categoria predefinita", "warning");
        return;
      }
      showConfirmModal("Elimina Categoria", `Sei sicuro di voler eliminare la categoria "${cat}"? Tutti i film al suo interno saranno spostati in "Da Vedere".`, () => {
        mediaList.forEach(m => { if (m.category === cat) m.category = "watchlist"; });
        categories = categories.filter(c => c !== cat);
        saveData();
        renderFullUI();
        showNotification(`Categoria "${cat}" eliminata`, "success");
      });
    }

    function closeAllMenus() {
      document.querySelectorAll(".context-menu").forEach(menu => menu.remove());
    }

    function showContextMenu(media, pos) {
      closeAllMenus();
      const menu = document.createElement("div");
      menu.className = "context-menu";
      const hide = () => {
        menu.classList.remove("visible");
        setTimeout(() => menu.remove(), 150);
        document.removeEventListener("click", hide, { capture: true });
        document.removeEventListener("contextmenu", hide, { capture: true });
      };
      setTimeout(() => {
        document.addEventListener("click", hide, { capture: true, once: true });
        document.addEventListener("contextmenu", hide, { capture: true, once: true });
        requestAnimationFrame(() => menu.classList.add("visible"));
      }, 0);
      menu.addEventListener("click", e => e.stopPropagation());

      const header = document.createElement("div");
      header.className = "context-menu-item";
      header.innerHTML = '<i class="fas fa-folder-open fa-fw"></i> <strong>Sposta in...</strong>';
      header.style.cssText = "color: var(--text-secondary); cursor: default; background: rgba(128,128,128,0.1);";
      menu.appendChild(header);

      categories.filter(c => c !== media.category).forEach(cat => {
        const item = document.createElement("div");
        item.className = "context-menu-item";
        const index = categories.indexOf(cat);
        const dotClass = `category-dot-${index % 6}`;
        item.innerHTML = `<span class="category-dot ${dotClass}"></span> ${getCategoryName(cat)}`;
        item.addEventListener("click", () => { moveMediaToCategory(media.id, cat); hide(); });
        menu.appendChild(item);
      });
      menu.appendChild(document.createElement("div")).className = "context-menu-divider";

      const isCustomCategory = !DEFAULT_CATEGORIES.includes(media.category);
      if (media.category === 'watched' || isCustomCategory) {
        const rewatchItem = document.createElement("div");
        rewatchItem.className = "context-menu-item";
        rewatchItem.innerHTML = '<i class="fas fa-sync-alt fa-fw"></i> Modifica Rewatch';
        rewatchItem.addEventListener("click", () => { openRewatchModal(media.id); hide(); });
        menu.appendChild(rewatchItem);
      }

      if (isCustomCategory) {
        const watchedItem = document.createElement("div");
        watchedItem.className = "context-menu-item";
        if (media.isCountedAsWatched) {
          watchedItem.innerHTML = '<i class="fas fa-times fa-fw"></i> Rimuovi stato "visto"';
          watchedItem.style.color = "var(--danger)";
        } else {
          watchedItem.innerHTML = '<i class="fas fa-check-double fa-fw"></i> Segna come visto qui';
        }
        watchedItem.addEventListener("click", () => { toggleCountedAsWatched(media.id); hide(); });
        menu.appendChild(watchedItem);

        const watchlistItem = document.createElement("div");
        watchlistItem.className = "context-menu-item";
        if (media.isCountedAsWatchlist) {
          watchlistItem.innerHTML = '<i class="fas fa-times fa-fw"></i> Rimuovi stato "da vedere"';
          watchlistItem.style.color = "var(--danger)";
        } else {
          watchlistItem.innerHTML = '<i class="fas fa-list-alt fa-fw"></i> Segna come da vedere qui';
        }
        watchlistItem.addEventListener("click", () => { toggleCountedAsWatchlist(media.id); hide(); });
        menu.appendChild(watchlistItem);
      }

      if (media.category === 'watched' || isCustomCategory) {
        menu.appendChild(document.createElement("div")).className = "context-menu-divider";
      }

      const changePosterItem = document.createElement("div");
      changePosterItem.className = "context-menu-item";
      changePosterItem.innerHTML = '<i class="fas fa-image fa-fw"></i> Cambia Copertina';
      changePosterItem.addEventListener("click", () => { showPosterModal(media.id); hide(); });
      menu.appendChild(changePosterItem);

      const deleteItem = document.createElement("div");
      deleteItem.className = "context-menu-item";
      deleteItem.innerHTML = '<i class="fas fa-trash fa-fw"></i> Elimina';
      deleteItem.style.color = "var(--danger)";
      deleteItem.addEventListener("click", () => { deleteMedia(media.id); hide(); });
      menu.appendChild(deleteItem);

      document.body.appendChild(menu);
      const rect = menu.getBoundingClientRect();
      let x = pos.x, y = pos.y;
      if (x + rect.width > window.innerWidth) x = window.innerWidth - rect.width - 5;
      if (y + rect.height > window.innerHeight) y = window.innerHeight - rect.height - 5;
      menu.style.left = `${x}px`;
      menu.style.top = `${y}px`;
    }

    function moveMediaToCategory(id, newCategory) {
      const media = mediaList.find(m => m.id === id);
      if (!media) return;

      const oldCategory = media.category;
      media.category = newCategory;
      media.lastActivityAt = new Date().toISOString();

      if (newCategory === 'watched') {
        media.isCountedAsWatched = true;
        media.isCountedAsWatchlist = false;
      } else if (newCategory === 'watchlist') {
        media.isCountedAsWatchlist = true;
        media.isCountedAsWatched = false;
        media.rewatchCount = 0;
      }

      if (!DEFAULT_CATEGORIES.includes(oldCategory) && DEFAULT_CATEGORIES.includes(newCategory)) {
        if (newCategory === 'watched' && !media.isCountedAsWatched) {
          media.rewatchCount = 0;
        }
        media.isCountedAsWatched = newCategory === 'watched';
        media.isCountedAsWatchlist = newCategory === 'watchlist';
      }

      logActivity('move', media.title, `da '${getCategoryName(oldCategory)}' a '${getCategoryName(newCategory)}'`);
      saveData();
      renderMedia();
      updateStats();
      showNotification(`Film spostato in "${getCategoryName(newCategory)}"`, "success");
    }

    function toggleCountedAsWatched(id) {
      const media = mediaList.find(m => m.id === id);
      if (!media) return;
      media.isCountedAsWatched = !media.isCountedAsWatched;
      if (media.isCountedAsWatched) {
        media.isCountedAsWatchlist = false;
        if (media.rewatchCount < 0) media.rewatchCount = 0;
        logActivity('watched_status', media.title, `segnato come visto in '${getCategoryName(media.category)}'`);
      } else {
        logActivity('watched_status', media.title, `rimosso lo stato "visto" in '${getCategoryName(media.category)}'`);
      }
      saveData();
      refreshSingleMedia(id);
      updateStats();
      showNotification(`Stato "visto" aggiornato per ${media.title}`, "success");
    }

    function toggleCountedAsWatchlist(id) {
      const media = mediaList.find(m => m.id === id);
      if (!media) return;
      media.isCountedAsWatchlist = !media.isCountedAsWatchlist;
      if (media.isCountedAsWatchlist) {
        media.isCountedAsWatched = false;
        logActivity('watchlist_status', media.title, `segnato come da vedere in '${getCategoryName(media.category)}'`);
      } else {
        logActivity('watchlist_status', media.title, `rimosso lo stato "da vedere" in '${getCategoryName(media.category)}'`);
      }
      saveData();
      refreshSingleMedia(id);
      updateStats();
      showNotification(`Stato "da vedere" aggiornato per ${media.title}`, "success");
    }

    function openRewatchModal(id) {
      const media = mediaList.find(m => m.id === id);
      if (!media) return;

      currentRewatchMediaId = id;
      elements.rewatchModalTitle.textContent = `Modifica Rewatch: ${media.title}`;

      const currentCount = media.rewatchCount || 0;
      elements.rewatchCountInput.value = currentCount;

      updateRewatchModalButtons(currentCount);

      openModal(elements.rewatchModal);
    }

    function updateRewatchModalButtons(count) {
      document.querySelectorAll('.quick-rewatch-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.count) === count);
      });
    }

    function markRewatch(id, count) {
      const media = mediaList.find(m => m.id === id);
      if (!media) return;
      media.rewatchCount = count;
      media.lastActivityAt = new Date().toISOString();
      if (count >= 0 && !media.isCountedAsWatched) {
        media.isCountedAsWatched = true;
        media.isCountedAsWatchlist = false;
      }
      logActivity('rewatch', media.title, `impostato a ${count} rewatch`);
      saveData();
      refreshSingleMedia(id);
      updateStats();
      showNotification(`Rewatch di "${media.title}" aggiornati`, "success");
    }

    function refreshSingleMedia(id) {
      const media = mediaList.find(m => m.id === id);
      if (!media) return;
      const oldCard = document.querySelector(`.media-card[data-id="${id}"]`);

      const grid = oldCard ? oldCard.parentElement : null;
      if (grid && grid.id === `${media.category}Grid`) {
        const newCard = createMediaCard(media);
        grid.replaceChild(newCard, oldCard);
        if (lazyLoadObserver) lazyLoadObserver.observe(newCard.querySelector(".lazy"));
      } else {
        renderMedia();
      }
      updateCounts();
    }

    function deleteMedia(id) {
      if (isViewMode) return;
      const media = mediaList.find(m => m.id === id);
      if (!media) return;
      showConfirmModal("Elimina Film", `Sei sicuro di voler eliminare "${media.title}"?`, () => {
        logActivity('delete', media.title, `dalla categoria '${getCategoryName(media.category)}'`);
        mediaList = mediaList.filter(m => m.id !== id);
        saveData();
        renderMedia();
        showNotification("Film eliminato", "success");
      });
    }

    function closeModal(modal) {
      if (modal && modal.classList.contains('visible')) {
        history.back();
      } else if (modal) {
        // Fallback for modals opened without history (e.g. startup)
        modal.classList.remove('visible');
        setTimeout(() => {
          modal.style.display = 'none';
          if (!document.querySelector('.modal.visible')) {
            document.body.classList.remove('modal-open');
          }
        }, 300);
      }
    }

    async function searchTMDb() {
      const title = elements.mediaTitle.value.trim();
      if (!title) return showNotification("Inserisci un titolo", "warning");
      elements.tmdbResults.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-2x loading-spinner"></i></div>';
      try {
        const url = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_KEY}&query=${encodeURIComponent(title)}&language=it-IT&include_adult=false`;
        const response = await fetch(url);
        const data = await response.json();
        if (data.results && data.results.length > 0) {
          displayTMDbResults(data.results);
        } else {
          elements.tmdbResults.innerHTML = `<p>Nessun risultato trovato</p>`;
        }
      } catch (err) {
        showNotification("Errore nella ricerca", "error");
        console.error("TMDb error:", err);
        elements.tmdbResults.innerHTML = "<p>Errore durante la ricerca</p>";
      }
    }

    function displayTMDbResults(results) {
      elements.tmdbResults.innerHTML = results.map(result => `
        <div class="tmdb-result-item user-select-none" data-tmdb-id="${result.id}">
          <img src="${result.poster_path ? `https://image.tmdb.org/t/p/w200${result.poster_path}` : DEFAULT_POSTER}" class="tmdb-poster-small" onerror="this.src='${DEFAULT_POSTER}'">
          <div>
            <div><strong>${result.title}</strong> (${result.release_date ? result.release_date.split('-')[0] : 'N/D'})</div>
            <div style="font-size:0.8rem; color: var(--text-secondary)">${result.original_title}</div>
          </div>
        </div>
      `).join("");
      document.querySelectorAll(".tmdb-result-item").forEach(item => {
        item.addEventListener("click", () => {
          currentTMDbSelection = { tmdbId: item.dataset.tmdbId, title: item.querySelector("strong").textContent };
          elements.mediaTitle.value = currentTMDbSelection.title;
          showNotification(`"${currentTMDbSelection.title}" selezionato`, "success");
        });
      });
    }

    async function addNewMedia(tmdbId) {
      if (isViewMode) return;
      showNotification("Recupero dettagli del film...", "warning");

      try {
        const [enDetails, itDetails] = await Promise.all([
          fetchFullTMDbDetails(tmdbId, 'en-US'),
          fetchFullTMDbDetails(tmdbId, 'it-IT')
        ]);

        if (!enDetails || !enDetails.imdb_id) {
          return showNotification("Dettagli non trovati o IMDb ID mancante.", "error");
        }

        const category = elements.addMediaCategorySelect.value;
        localStorage.setItem("lastUsedCategory", category);

        if (mediaList.some(m => m.imdbID === enDetails.imdb_id && m.category === category)) {
          return showNotification(`Questo film è già in "${getCategoryName(category)}"`, "warning");
        }

        let media = {
          ...defaultMediaProps,
          id: Date.now().toString(),
          title: enDetails.title,
          italianTitle: itDetails ? itDetails.title : enDetails.title,
          genres: enDetails.genres ? enDetails.genres.map(g => g.name) : [],
          year: enDetails.release_date ? enDetails.release_date.split('-')[0] : "",
          poster: enDetails.poster_path ? `https://image.tmdb.org/t/p/w500${enDetails.poster_path}` : DEFAULT_POSTER,
          imdbID: enDetails.imdb_id,
          tmdbID: tmdbId,
          runtime: enDetails.runtime ? `${enDetails.runtime} min` : "",
          category,
          addedAt: new Date().toISOString(),
          lastActivityAt: new Date().toISOString(),
          sagaName: enDetails.belongs_to_collection ? enDetails.belongs_to_collection.name : null,
          releaseDate: enDetails.release_date || null,
          isCountedAsWatched: category === 'watched',
          isCountedAsWatchlist: category === 'watchlist'
        };

        const ratings = await fetchMDBListRatings(media.imdbID);
        if (ratings) {
          const rtRating = ratings.find(r => r.source === 'tomatoes');
          const popcornRating = ratings.find(r => r.source === 'tomatoesaudience');
          const letterboxdRating = ratings.find(r => r.source === 'letterboxd');
          const metacriticRating = ratings.find(r => r.source === 'metacritic');
          const imdbRating = ratings.find(r => r.source === 'imdb');

          if (rtRating) media.rottenTomatoes = rtRating.value;
          if (popcornRating) media.popcornRating = popcornRating.value;
          if (letterboxdRating) media.letterboxdRating = letterboxdRating.value;
          if (metacriticRating) media.metacriticRating = metacriticRating.value;
          if (imdbRating) media.imdbRating = imdbRating.value;
        } else {
          media.imdbRating = enDetails.vote_average ? enDetails.vote_average.toFixed(1) : "N/A";
        }

        mediaList.push(media);
        logActivity('add', media.title, `in '${getCategoryName(media.category)}'`);
        saveData();
        closeModal(elements.mediaManagementModal);
        renderFullUI();
        showNotification(`Film "${media.title}" aggiunto!`, "success");

      } catch (error) {
        console.error("Error adding new media:", error);
        showNotification("Errore durante l'aggiunta del film.", "error");
      }
    }

    function exportData() {
      if (isViewMode) return;
      const data = { mediaList, categories, exportedAt: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `filmtracker_export_${new Date().toISOString().split("T")[0]}.json`;
      a.click();

      // SALVA IL TIMESTAMP
      const now = new Date().toISOString();
      localStorage.setItem('lastFilmExport', now);
      if (currentUser) db.ref(`users/${currentUser.uid}/lastExport`).set(now);

      updateBackupBadge(now);
      showNotification("Backup scaricato con successo!", "success");
    }

    function updateBackupBadge(timestamp) {
      const badge = document.querySelector('#lastBackupBadge span');
      const stored = timestamp || localStorage.getItem('lastFilmExport');
      if (stored) {
        badge.textContent = new Date(stored).toLocaleString('it-IT', {
          day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
        });
      }
    }

    function importData(file) {
      if (isViewMode || !file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          if (!Array.isArray(data.mediaList)) throw new Error("Formato file non valido");

          // Chiudiamo il modale impostazioni così la conferma è pulita sullo sfondo
          if (document.getElementById('settingsModal')) {
            closeModal(document.getElementById('settingsModal'));
          }

          // Aspettiamo che il modale inizi a chiudersi prima di chiedere conferma
          setTimeout(() => {
            showConfirmModal("Importa Dati", `Stai per importare ${data.mediaList.length} film. I dati attuali verranno sovrascritti. Continuare?`, () => {
              mediaList = data.mediaList;
              categories = data.categories || [...DEFAULT_CATEGORIES];
              saveData();
              renderFullUI();
              showNotification("Dati importati con successo", "success");
            });
          }, 350);
        } catch (err) {
          showNotification("Errore nell'importazione: " + err.message, "error");
        }
      };
      reader.readAsText(file);
    }

    function resetApp() {
      if (isViewMode) return;
      showConfirmModal("Resetta Applicazione", "Sei sicuro di voler resettare l'applicazione? Tutti i dati andranno persi.", () => {
        mediaList = [];
        categories = [...DEFAULT_CATEGORIES];
        saveData();
        elements.searchInput.value = "";
        elements.categoryFilter.value = "all";
        elements.sortFilter.value = "saga-alpha";
        renderFullUI();
        showNotification("Applicazione resettata", "success");
      });
    }

    function loadTheme() {
      const theme = localStorage.getItem("theme") || "dark";
      document.body.classList.toggle("dark", theme === "dark");
      elements.themeToggle.innerHTML = `<i class="fas fa-${theme === "dark" ? "sun" : "moon"}"></i>`;
    }

    function toggleTheme() {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      elements.themeToggle.innerHTML = `<i class="fas fa-${isDark ? "sun" : "moon"}"></i>`;
    }

    function loadSortOrder() {
      const sort = localStorage.getItem("mediaTrackerSortOrder");
      if (sort) elements.sortFilter.value = sort;
    }

    function showNotification(text, type = "success") {
      elements.notificationText.textContent = text;
      elements.notification.className = `notification ${type}`;
      elements.notification.style.display = "block";
      setTimeout(() => elements.notification.style.display = "none", 3000);
    }

    function setupLazyLoading() {
      if (lazyLoadObserver) lazyLoadObserver.disconnect();
      lazyLoadObserver = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            img.src = img.dataset.src;
            img.classList.remove("lazy");
            lazyLoadObserver.unobserve(img);
          }
        });
      });
      document.querySelectorAll(".lazy").forEach(img => lazyLoadObserver.observe(img));
    }

    function formatRuntime(runtime) {
      if (!runtime) return "";
      const minutes = parseInt(runtime);
      if (isNaN(minutes) || minutes <= 0) return "";
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return hours > 0 ? `${hours}h ${mins > 0 ? `${mins}m` : ""}` : `${mins}m`;
    }

    function logActivity(type, title, details) {
      if (!currentUser) return;
      const logRef = db.ref(`users/${currentUser.uid}/activityLog`);
      const newActivity = { type, title, details, timestamp: new Date().toISOString() };

      return logRef.transaction(currentLog => {
        let log = Array.isArray(currentLog) ? currentLog : [];
        log.unshift(newActivity);
        return log.slice(0, MAX_LOG_SIZE);
      });
    }

    function detachAllFriendListeners() {
      Object.values(friendListeners).forEach(({ ref, listener }) => ref.off('value', listener));
      friendListeners = {};
    }

    function setupFriendListeners() {
      if (!currentUser) return;
      detachAllFriendListeners();

      const friendActivityMap = new Map();

      const processAndRenderNotifications = () => {
        let allNewNotifications = Array.from(friendActivityMap.values()).flat();
        allNewNotifications.sort((a, b) => new Date(b.activity.timestamp) - new Date(a.activity.timestamp));
        renderNotifications(allNewNotifications.slice(0, MAX_NOTIFICATIONS));
      };

      followedFriends.forEach(friend => {
        const ref = db.ref(`users/${friend.id}/activityLog`);
        const listener = snapshot => {
          const activities = snapshot.val() || [];
          const lastChecked = lastCheckedTimestamps[friend.id] || new Date(0).toISOString();

          const activityArray = Array.isArray(activities) ? activities : [];
          const newActivities = activityArray
            .filter(act => act && new Date(act.timestamp) > new Date(lastChecked))
            .map(activity => ({ friendId: friend.id, friendEmail: friend.email, activity }));

          friendActivityMap.set(friend.id, newActivities);
          processAndRenderNotifications();
        };
        ref.on('value', listener);
        friendListeners[friend.id] = { ref, listener };
      });
    }

    function renderNotifications(notifications) {
      const count = notifications.length;
      elements.notificationBadge.textContent = count;
      elements.notificationBadge.classList.toggle('visible', count > 0);
      elements.notificationBadgeMobile.textContent = count;
      elements.notificationBadgeMobile.classList.toggle('visible', count > 0);

      elements.notificationDropdown.innerHTML = '';

      const header = document.createElement('div'); header.className = 'notification-header'; header.textContent = 'Notifiche Amici';
      const list = document.createElement('div'); list.className = 'notification-list';

      if (count > 0) {
        notifications.forEach(n => {
          if (!n.activity) return;
          const item = document.createElement('div');
          item.className = 'notification-item';
          item.dataset.friendId = n.friendId;
          const isTV = n.activity.type.includes('show') || n.activity.type.includes('season');
          item.innerHTML = `
                    <i class="fas ${getActivityIcon(n.activity.type)} ${isTV ? 'tv-notification' : 'film-notification'}"></i>
                    <span class="notification-item-text">${getActivityText(n.friendEmail, n.activity)}</span>`;

          item.addEventListener('click', () => {
            const friendId = item.dataset.friendId;
            if (friendId) {
              const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
              const url = isTV
                ? `${baseUrl}/serietv_tracker.html?view=${friendId}`
                : `${baseUrl}/index.html?view=${friendId}`;
              window.open(url, '_blank');
            }
          });
          list.appendChild(item);
        });

        const footer = document.createElement('div'); footer.className = 'notification-footer';
        const markAllBtn = document.createElement('button');
        markAllBtn.className = 'btn btn-primary btn-small';
        markAllBtn.innerHTML = '<i class="fas fa-check-double"></i> Segna tutte come lette';
        markAllBtn.addEventListener('click', markAllNotificationsAsRead);
        footer.appendChild(markAllBtn);

        elements.notificationDropdown.appendChild(header);
        elements.notificationDropdown.appendChild(list);
        elements.notificationDropdown.appendChild(footer);

      } else {
        const emptyState = document.createElement('div'); emptyState.className = 'no-notifications'; emptyState.textContent = 'Nessuna nuova notifica';
        list.appendChild(emptyState);
        elements.notificationDropdown.appendChild(header);
        elements.notificationDropdown.appendChild(list);
      }

      // Update mobile notification list as well
      elements.notificationListMobile.innerHTML = '';
      if (count > 0) {
        notifications.forEach(n => {
          if (!n.activity) return;
          const item = document.createElement('div');
          item.className = 'notification-item';
          item.dataset.friendId = n.friendId;
          const isTV = n.activity.type.includes('show') || n.activity.type.includes('season');
          item.innerHTML = `
                    <i class="fas ${getActivityIcon(n.activity.type)} ${isTV ? 'tv-notification' : 'film-notification'}"></i>
                    <span class="notification-item-text">${getActivityText(n.friendEmail, n.activity)}</span>`;

          item.addEventListener('click', () => {
            const friendId = item.dataset.friendId;
            if (friendId) {
              const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
              const url = isTV
                ? `${baseUrl}/serietv_tracker.html?view=${friendId}`
                : `${baseUrl}/index.html?view=${friendId}`;
              window.open(url, '_blank');
            }
          });
          elements.notificationListMobile.appendChild(item);
        });
      } else {
        const emptyState = document.createElement('div'); emptyState.className = 'no-notifications'; emptyState.textContent = 'Nessuna nuova notifica';
        elements.notificationListMobile.appendChild(emptyState);
      }
    }

    function markAllNotificationsAsRead() {
      if (!currentUser) return;
      followedFriends.forEach(f => lastCheckedTimestamps[f.id] = new Date().toISOString());
      saveSocialData();
      renderNotifications([]);
    }

    function getActivityIcon(type) {
      if (type === 'add') return 'fa-film';
      if (type === 'move') return 'fa-folder-open';
      if (type === 'delete') return 'fa-trash-alt';
      if (type === 'rewatch') return 'fa-sync-alt';
      if (type.startsWith('add_show')) return 'fa-plus-circle';
      if (type.startsWith('complete_show')) return 'fa-tv';
      if (type.startsWith('complete_season')) return 'fa-check-circle';
      return 'fa-info-circle';
    }

    function getActivityText(friendEmail, activity) {
      const email = `<strong>${friendEmail || 'Utente'}</strong>`;
      const title = `<strong>${activity.title}</strong>`;
      switch (activity.type) {
        case 'add': return `${email} ha aggiunto il film ${title} ${activity.details}`;
        case 'move': return `${email} ha spostato il film ${title} ${activity.details}`;
        case 'delete': return `${email} ha eliminato il film ${title} ${activity.details}`;
        case 'rewatch': return `${email} ha aggiornato ${title} (${activity.details})`;
        case 'add_show': return `${email} ha aggiunto la serie ${title} ${activity.details}`;
        case 'move_show': return `${email} ha spostato la serie ${title} ${activity.details}`;
        case 'delete_show': return `${email} ha eliminato la serie ${title} ${activity.details}`;
        case 'complete_show': return `${email} ha completato la serie ${title}! 🎉`;
        case 'complete_season': return `${email} ha completato ${activity.details} di ${title}`;
        default: return `${email} ha aggiornato ${title}`;
      }
    }

    async function showDetailsModal(mediaId) {
      const media = mediaList.find(m => m.id === mediaId);
      if (!media || !media.imdbID) {
        showNotification("Dettagli non disponibili (manca IMDb ID)", "warning");
        return;
      }

      openModal(elements.detailsModal);
      renderDetailsShell(media);

      try {
        const details = await fetchTMDbDetails(media.imdbID, 'it-IT');
        if (details) {
          if (details.genres) {
            const newGenres = details.genres.map(g => g.name);
            if (JSON.stringify(media.genres) !== JSON.stringify(newGenres)) {
              media.genres = newGenres;
              saveData();
            }
          }
          populateDetailsModal(details, media);
        } else {
          elements.detailsModalContent.innerHTML = '<p style="text-align: center; padding: 2rem;">Dettagli non trovati.</p>';
        }
      } catch (err) {
        console.error("Errore caricamento dettagli:", err);
      }
    }

    function renderDetailsShell(media) {
      const posterUrl = media.poster || DEFAULT_POSTER;

      elements.detailsModalContent.innerHTML = `
        <div class="details-backdrop" style="background-color: #1a1a1a;"></div>
        <div class="details-header">
            <img id="detailsModalPoster" src="${posterUrl}" onerror="this.src='${DEFAULT_POSTER}'">
            <div class="details-title-section">
                <h2 id="detailsModalTitle">${media.title}</h2>
                <div class="details-ratings-container" id="shell-ratings">
                    <div class="skeleton" style="width:100px; height:20px; border-radius:10px;"></div>
                </div>
                <div id="detailsModalMeta">
                    <span><i class="fas fa-calendar-alt"></i> ${media.year || ''}</span>
                    <span><i class="fas fa-clock"></i> ${formatRuntime(media.runtime || 0)}</span>
                    <span id="shell-genres" class="skeleton" style="width:80px; height:15px; display:inline-block;"></span>
                </div>
            </div>
        </div>
        <div class="details-body">
            <h3 class="details-section-title">Trama</h3>
            <p id="detailsModalOverview" class="skeleton-text">Caricamento descrizione...</p>
            
            <h3 class="details-section-title">Cast Principale</h3>
            <div class="cast-scroller" id="detailsModalCast">
                ${Array(5).fill('<div class="actor-card"><div class="actor-photo skeleton"></div></div>').join('')}
            </div>
        </div>
      `;
    }

    function populateDetailsModal(details, media) {
      // 1. Update backdrop
      if (details.backdrop_path) {
        const backdrop = elements.detailsModalContent.querySelector('.details-backdrop');
        if (backdrop) {
          backdrop.style.backgroundImage = `url(https://image.tmdb.org/t/p/w1280${details.backdrop_path})`;
          backdrop.style.backgroundColor = 'transparent';
        }
      }

      // 2. Update Poster (in case API has a better one)
      const posterUrl = media.poster || (details.poster_path ? `https://image.tmdb.org/t/p/w500${details.poster_path}` : DEFAULT_POSTER);
      const posterImg = document.getElementById('detailsModalPoster');
      if (posterImg) posterImg.src = posterUrl;

      // 3. Update Meta & Ratings
      const genres = details.genres.map(g => g.name).join(', ');
      const directors = details.crew.filter(member => member.job === 'Director');
      const directorsHTML = directors.map(d => `<a href="#" class="director-link" data-person-id="${d.id}">${d.name}</a>`).join(', ');

      const rtState = getRottenTomatoesState(media.rottenTomatoes);
      const popcornState = getPopcornState(media.popcornRating);

      let ratingsHTML = '';
      if (media.imdbRating && media.imdbRating !== "N/A") { ratingsHTML += `<span class="rating-badge"><img src="${IMDB_STAR_ICON}" class="rating-icon">&nbsp;${media.imdbRating}</span>`; }
      if (rtState) { ratingsHTML += `<span class="rating-badge"><img src="${ROTTEN_TOMATOES_ICONS[rtState]}" class="rating-icon">&nbsp;${media.rottenTomatoes}</span>`; }
      if (popcornState) { ratingsHTML += `<span class="rating-badge"><img src="${POPCORN_ICONS[popcornState]}" class="rating-icon">&nbsp;${media.popcornRating}</span>`; }
      if (media.metacriticRating && media.metacriticRating !== "N/A") { ratingsHTML += `<span class="rating-badge"><img src="${METACRITIC_ICON}" class="rating-icon">&nbsp;${media.metacriticRating}</span>`; }
      if (media.letterboxdRating && media.letterboxdRating !== "N/A") { ratingsHTML += `<span class="rating-badge"><img src="${LETTERBOXD_ICON}" class="rating-icon">&nbsp;${media.letterboxdRating}</span>`; }

      const ratingsContainer = document.getElementById('shell-ratings');
      if (ratingsContainer) {
        ratingsContainer.innerHTML = ratingsHTML || '<span style="font-size: 0.9rem; color: var(--text-secondary);">Nessuna valutazione disponibile</span>';
      }

      const genresSpan = document.getElementById('shell-genres');
      if (genresSpan) {
        genresSpan.outerHTML = `<span><i class="fas fa-film"></i> ${genres}</span>`;
      }

      const metaContainer = document.getElementById('detailsModalMeta');
      if (metaContainer && directorsHTML) {
        const directorSpan = document.createElement('span');
        directorSpan.innerHTML = `<i class="fas fa-video"></i> Regia: ${directorsHTML}`;
        metaContainer.appendChild(directorSpan);
      }

      // Update Tagline
      if (details.tagline) {
        const tagline = document.createElement('p');
        tagline.id = 'detailsModalTagline';
        tagline.textContent = details.tagline;
        const titleSection = document.querySelector('.details-title-section');
        if (titleSection) titleSection.insertBefore(tagline, metaContainer);
      }

      // 4. Update Overview
      const overview = document.getElementById('detailsModalOverview');
      if (overview) {
        overview.classList.remove('skeleton-text');
        overview.textContent = details.overview || 'Trama non disponibile.';
      }

      // 5. Update Cast
      const castHTML = details.cast.slice(0, 15).map(actor => `
            <div class="actor-card" data-person-id="${actor.id}">
                <img src="${actor.profile_path ? `https://image.tmdb.org/t/p/w200${actor.profile_path}` : DEFAULT_ACTOR_PHOTO}" class="actor-photo" onerror="this.src='${DEFAULT_ACTOR_PHOTO}'">
                <div class="actor-name">${actor.name}</div>
                <div class="actor-character">${actor.character}</div>
            </div>
        `).join('');

      const castContainer = document.getElementById('detailsModalCast');
      if (castContainer) {
        castContainer.innerHTML = castHTML;
      }

      // Re-attach listeners
      elements.detailsModalContent.querySelectorAll('.actor-card, .director-link').forEach(card => {
        card.addEventListener('click', (e) => {
          e.preventDefault();
          showActorModal(card.dataset.personId);
        });
      });
    }

    async function fetchTMDbDetails(imdbId, lang = 'it-IT') {
      try {
        const findRes = await fetch(`https://api.themoviedb.org/3/find/${imdbId}?api_key=${TMDB_KEY}&external_source=imdb_id`);
        if (!findRes.ok) return null;
        const findData = await findRes.json();
        const tmdbMovie = findData.movie_results[0];
        if (!tmdbMovie) return null;

        return await fetchFullTMDbDetails(tmdbMovie.id, lang);
      } catch (err) {
        console.error("Error finding TMDb movie by IMDb ID:", err);
        return null;
      }
    }

    async function fetchFullTMDbDetails(tmdbId, lang = 'en-US') {
      try {
        const [detailsRes, creditsRes] = await Promise.all([
          fetch(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${TMDB_KEY}&language=${lang}&append_to_response=external_ids`),
          fetch(`https://api.themoviedb.org/3/movie/${tmdbId}/credits?api_key=${TMDB_KEY}&language=${lang}`)
        ]);

        if (!detailsRes.ok || !creditsRes.ok) return null;

        let details = await detailsRes.json();
        const credits = await creditsRes.json();

        if (!details.overview && lang === 'it-IT') {
          const enDetailsRes = await fetch(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${TMDB_KEY}&language=en-US`);
          if (enDetailsRes.ok) {
            const enDetails = await enDetailsRes.json();
            details.overview = enDetails.overview;
          }
        }

        return { ...details, cast: credits.cast, crew: credits.crew, imdb_id: details.external_ids.imdb_id };
      } catch (err) {
        console.error("Error fetching full TMDb details:", err);
        return null;
      }
    }

    async function fetchMDBListRatings(imdbId) {
      if (!imdbId || !MDBLIST_PROXY_URL || MDBLIST_PROXY_URL === "INCOLLA_L_URL_DEL_TUO_WORKER_QUI") return null;
      try {
        const res = await fetch(`${MDBLIST_PROXY_URL}?i=${imdbId}`);
        if (!res.ok) return null;
        const data = await res.json();
        return data.ratings || null;
      } catch (error) {
        console.error("Errore nel recupero dati da MDBList:", error);
        return null;
      }
    }


    async function showActorModal(personId) {
      openModal(elements.actorModal);
      elements.actorModalContent.innerHTML = '<div style="text-align: center; padding: 4rem;"><i class="fas fa-spinner fa-3x loading-spinner"></i></div>';

      const actorDetails = await fetchTMDbActorDetails(personId);

      if (actorDetails) {
        populateActorModal(actorDetails);
      } else {
        elements.actorModalContent.innerHTML = '<p style="text-align: center; padding: 2rem;">Dettagli non trovati.</p>';
      }
    }

    async function fetchTMDbActorDetails(personId) {
      try {
        const [detailsRes, creditsRes] = await Promise.all([
          fetch(`https://api.themoviedb.org/3/person/${personId}?api_key=${TMDB_KEY}&language=it-IT`),
          fetch(`https://api.themoviedb.org/3/person/${personId}/movie_credits?api_key=${TMDB_KEY}&language=it-IT`)
        ]);
        if (!detailsRes.ok || !creditsRes.ok) return null;

        let details = await detailsRes.json();
        const credits = await creditsRes.json();

        if (!details.biography) {
          const enDetailsRes = await fetch(`https://api.themoviedb.org/3/person/${personId}?api_key=${TMDB_KEY}&language=en-US`);
          if (enDetailsRes.ok) {
            const enDetails = await enDetailsRes.json();
            details.biography = enDetails.biography;
          }
        }

        return { ...details, movie_credits: credits };
      } catch (err) {
        console.error("Error fetching TMDb actor details:", err);
        return null;
      }
    }

    function populateActorModal(details) {
      const photoUrl = details.profile_path ? `https://image.tmdb.org/t/p/w500${details.profile_path}` : DEFAULT_ACTOR_PHOTO;

      let filmographyHTML = '';
      let filmographyTitle = 'Filmografia Selezionata';

      if (details.known_for_department === 'Directing') {
        filmographyTitle = 'Filmografia Selezionata (Regista)';
        const directedFilms = [];
        const processedIds = new Set();
        details.movie_credits.crew.forEach(film => {
          if (film.job === 'Director' && !processedIds.has(film.id)) {
            directedFilms.push(film);
            processedIds.add(film.id);
          }
        });
        directedFilms.sort((a, b) => (b.vote_average || 0) - (a.vote_average || 0));
        filmographyHTML = directedFilms.slice(0, 15).map(film => {
          if (!film.poster_path) return '';
          return `
                <div class="film-card-small" data-tmdb-url="https://www.themoviedb.org/movie/${film.id}" title="${film.title}">
                    <img src="https://image.tmdb.org/t/p/w200${film.poster_path}" onerror="this.src='${DEFAULT_POSTER}'">
                    <div class="film-card-small-title">${film.title}</div>
                </div>`;
        }).join('');
      } else {
        filmographyTitle = 'Filmografia Selezionata (Attore)';
        details.movie_credits.cast.sort((a, b) => (b.vote_average || 0) - (a.vote_average || 0));
        filmographyHTML = details.movie_credits.cast.slice(0, 15).map(film => {
          if (!film.poster_path) return '';
          return `
                <div class="film-card-small" data-tmdb-url="https://www.themoviedb.org/movie/${film.id}" title="${film.title}">
                    <img src="https://image.tmdb.org/t/p/w200${film.poster_path}" onerror="this.src='${DEFAULT_POSTER}'">
                    <div class="film-card-small-title">${film.title}</div>
                </div>`;
        }).join('');
      }

      elements.actorModalContent.innerHTML = `
            <div class="actor-details-header">
                <img src="${photoUrl}" class="actor-details-photo" onerror="this.src='${DEFAULT_ACTOR_PHOTO}'">
                <div class="actor-details-info">
                    <h2>${details.name}</h2>
                    <ul>
                        <li><strong>Nascita:</strong> ${details.birthday ? new Date(details.birthday).toLocaleDateString('it-IT') : 'N/A'}</li>
                        <li><strong>Luogo:</strong> ${details.place_of_birth || 'N/A'}</li>
                    </ul>
                    ${details.imdb_id ? `<a href="https://www.imdb.com/name/${details.imdb_id}/" target="_blank" class="btn btn-imdb"><i class="fab fa-imdb"></i> Vedi su IMDb</a>` : ''}
                </div>
            </div>
            <div>
                <h3 class="details-section-title">${filmographyTitle}</h3>
                <div class="filmography-scroller" id="filmographyScroller">
                    ${filmographyHTML}
                </div>
                <h3 class="details-section-title">Biografia</h3>
                <p>${details.biography || 'Biografia non disponibile.'}</p>
            </div>
        `;

      const filmographyScroller = document.getElementById('filmographyScroller');
      if (filmographyScroller) {
        filmographyScroller.scrollLeft = 0;
        filmographyScroller.querySelectorAll('.film-card-small').forEach(card => {
          card.addEventListener('click', () => {
            window.open(card.dataset.tmdbUrl, '_blank');
          });
        });
      }
    }

    async function addFriend() {
      const friendId = friendIdInput.value.trim();
      if (!friendId || !currentUser) return;
      if (friendId === currentUser.uid) { showNotification("Non puoi aggiungere te stesso.", "warning"); return; }
      if (followedFriends.some(f => f.id === friendId)) { showNotification("Amico già presente in lista.", "warning"); return; }
      const friendEmailRef = db.ref(`users/${friendId}/email`);
      const snapshot = await friendEmailRef.once('value');
      if (snapshot.exists()) {
        followedFriends.push({ id: friendId, email: snapshot.val() });
        lastCheckedTimestamps[friendId] = new Date().toISOString();
        await saveSocialData();
        renderFriendsList();
        setupFriendListeners();
        showNotification("Amico aggiunto!", "success");
      } else {
        showNotification("ID Utente non trovato.", "error");
      }
    }

    async function removeFriend(friendId) {
      followedFriends = followedFriends.filter(f => f.id !== friendId);
      delete lastCheckedTimestamps[friendId];
      await saveSocialData();
      renderFriendsList();
      setupFriendListeners();
    }

    function renderFriendsList() {
      if (!currentUser) { friendsList.innerHTML = "<p>Devi essere loggato per usare questa funzione.</p>"; document.getElementById('myIdContainer').style.display = 'none'; return; }
      document.getElementById('myIdContainer').style.display = 'block';
      myIdInput.value = currentUser.uid;
      friendsList.innerHTML = "";
      if (followedFriends.length === 0) { friendsList.innerHTML = `<p style="text-align:center; color: var(--text-secondary);">Non stai seguendo nessun amico.</p>`; return; }
      followedFriends.forEach(friend => {
        const card = document.createElement("div"); card.className = "management-card";
        card.innerHTML = `
                <div>
                    <div>
                        <div class="friend-email">${friend.email}</div>
                        <div class="friend-id">${friend.id}</div>
                    </div>
                </div>
                <div class="management-card-actions">
                    <button class="btn visit-friend-films-btn" data-id="${friend.id}" title="Visita Libreria Film"><i class="fas fa-film"></i></button>
                    <button class="btn visit-friend-tv-btn" data-id="${friend.id}" title="Visita Libreria Serie TV"><i class="fas fa-tv"></i></button>
                    <button class="btn btn-danger remove-friend-btn" data-id="${friend.id}" title="Rimuovi Amico"><i class="fas fa-trash"></i></button>
                </div>`;
        card.querySelector('.remove-friend-btn').addEventListener('click', () => removeFriend(friend.id));
        card.querySelector('.visit-friend-films-btn').addEventListener('click', (e) => {
          const url = `${window.location.origin}${window.location.pathname.replace('serietv_tracker.html', 'index.html')}?view=${e.currentTarget.dataset.id}`;
          window.open(url, '_blank');
        });
        card.querySelector('.visit-friend-tv-btn').addEventListener('click', (e) => {
          const url = `${window.location.origin}${window.location.pathname.replace('index.html', 'serietv_tracker.html')}?view=${e.currentTarget.dataset.id}`;
          window.open(url, '_blank');
        });
        friendsList.appendChild(card);
      });
    }

    function setupEventListeners() {
      elements.mediaManagementBtn.addEventListener("click", openMediaManagementModal);
      elements.addCategoryBtn.addEventListener("click", () => addCategory(elements.newCategoryName.value));
      elements.searchTMDbBtn.addEventListener("click", searchTMDb);
      document.addEventListener("click", e => {
        if (e.target === elements.posterModal) closeModal(elements.posterModal);
        if (e.target === elements.detailsModal) closeModal(elements.detailsModal);
        if (e.target === elements.actorModal) closeModal(elements.actorModal);
        if (e.target === elements.categoryNavModal) closeModal(elements.categoryNavModal);
        if (e.target === elements.filterSortModal) closeModal(elements.filterSortModal);
        if (e.target === elements.mobileMenuModal) closeModal(elements.mobileMenuModal);
        if (e.target === elements.mobileNotificationsModal) closeModal(elements.mobileNotificationsModal);
        if (!e.target.closest('.notification-bell-container')) {
          elements.notificationDropdown.classList.remove('visible');
        }
      });
      elements.savePosterChange.addEventListener('click', () => {
        const selected = document.querySelector(".poster-option.selected");
        if (selected) {
          changePoster(elements.posterModal.dataset.mediaId, selected.dataset.url);
        }
        closeModal(elements.posterModal);
      });
      elements.cancelPosterChange.addEventListener('click', () => closeModal(elements.posterModal));
      // Apri modale Impostazioni (Desktop)
      if (elements.settingsBtn) {
        elements.settingsBtn.addEventListener('click', () => {
          updateBackupBadge();
          openModal(document.getElementById('settingsModal'));
        });
      }

      // Apri modale Impostazioni (Mobile)
      const mobileSettingsBtn = document.getElementById('mobileSettingsBtn');
      if (mobileSettingsBtn) {
        mobileSettingsBtn.addEventListener('click', () => {
          closeModal(elements.mobileMenuModal);
          setTimeout(() => {
            updateBackupBadge();
            openModal(document.getElementById('settingsModal'));
          }, 300);
        });
      }

      // Azioni dentro il modale (Export, Import, Reset)
      const exportAction = document.getElementById('exportAction');
      if (exportAction) exportAction.addEventListener('click', exportData);

      const importAction = document.getElementById('importAction');
      if (importAction) {
        importAction.addEventListener('click', () => {
          if (elements.importFile) elements.importFile.click();
        });
      }

      const resetAction = document.getElementById('resetAction');
      if (resetAction) {
        resetAction.addEventListener('click', () => {
          // Chiudiamo il modale impostazioni PRIMA
          closeModal(document.getElementById('settingsModal'));

          // Aspettiamo che finisca l'animazione e poi chiediamo conferma
          setTimeout(() => {
            resetApp();
          }, 350);
        });
      }

      if (elements.importFile) {
        elements.importFile.addEventListener("change", e => importData(e.target.files[0]));
      }
      elements.themeToggle.addEventListener("click", toggleTheme);
      elements.searchInput.addEventListener("input", () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(renderMedia, 300);
      });
      elements.categoryFilter.addEventListener("change", renderMedia);
      elements.sortFilter.addEventListener("change", () => {
        localStorage.setItem("mediaTrackerSortOrder", elements.sortFilter.value);
        renderMedia();
      });
      elements.shareBtn.addEventListener("click", () => {
        if (!currentUser) return showNotification("Devi essere loggato per condividere.", "warning");
        const link = `${window.location.origin}${window.location.pathname}?view=${currentUser.uid}`;
        elements.shareLinkInput.value = link;
        elements.shareModal.style.display = "flex";
        document.body.classList.add("modal-open");
      });
      elements.copyShareLinkBtn.addEventListener("click", () => {
        navigator.clipboard.writeText(elements.shareLinkInput.value);
        showNotification("Link copiato!", "success");
      });
      elements.closeShareModalBtn.addEventListener("click", () => closeModal(elements.shareModal));
      elements.closeViewBtn.addEventListener("click", () => { window.location.href = window.location.pathname; });
      elements.detailsModalClose.addEventListener('click', () => closeModal(elements.detailsModal));
      actorModalClose.addEventListener('click', () => closeModal(elements.actorModal));

      document.querySelectorAll('.quick-rewatch-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const count = parseInt(btn.dataset.count);
          elements.rewatchCountInput.value = count;
          updateRewatchModalButtons(count);
        });
      });
      elements.rewatchCountInput.addEventListener('input', () => {
        const count = parseInt(elements.rewatchCountInput.value);
        updateRewatchModalButtons(count);
      });

      // --- Bottom Nav Bar Listeners ---
      elements.bottomNavHome.addEventListener('click', () => {
        populateCategoryNavModal();
        openModal(elements.categoryNavModal);
        requestAnimationFrame(() => elements.categoryNavModal.classList.add('visible'));
      });

      elements.bottomNavAdd.addEventListener('click', () => { elements.mediaManagementBtn.click(); document.querySelector('.tab-btn[data-tab="add-media"]').click(); });
      elements.bottomNavManage.addEventListener('click', () => { openModal(elements.mobileMenuModal); requestAnimationFrame(() => elements.mobileMenuModal.classList.add('visible')); });
      elements.bottomNavNotifications.addEventListener('click', () => { openModal(elements.mobileNotificationsModal); requestAnimationFrame(() => elements.mobileNotificationsModal.classList.add('visible')); });

      // --- Mobile Modals Listeners ---
      elements.mobileMenuCloseBtn.addEventListener('click', () => closeModal(elements.mobileMenuModal));
      elements.mobileNotificationsCloseBtn.addEventListener('click', () => closeModal(elements.mobileNotificationsModal));
      elements.markAllReadMobileBtn.addEventListener('click', markAllNotificationsAsRead);
      elements.mobileMenuUserActionBtn.addEventListener('click', () => { (currentUser) ? elements.logoutBtn.click() : elements.authToggle.click(); closeModal(elements.mobileMenuModal); });
      elements.mobileMenuThemeBtn.addEventListener('click', () => { elements.themeToggle.click(); });

      // --- Filter Modal Listeners ---
      elements.mobileFilterBtn.addEventListener('click', () => {
        elements.mobileCategoryFilter.value = elements.categoryFilter.value;
        elements.mobileSortFilter.value = elements.sortFilter.value;
        openModal(elements.filterSortModal);
        requestAnimationFrame(() => elements.filterSortModal.classList.add('visible'));
      });
      elements.applyFiltersBtn.addEventListener('click', () => {
        elements.categoryFilter.value = elements.mobileCategoryFilter.value;
        elements.sortFilter.value = elements.mobileSortFilter.value;
        localStorage.setItem("mediaTrackerSortOrder", elements.sortFilter.value);
        renderMedia();
        closeModal(elements.filterSortModal);
      });

      // --- Category Navigation Modal Listeners ---
      elements.closeCategoryNavBtn.addEventListener('click', () => closeModal(elements.categoryNavModal));

      document.querySelectorAll(".num-spinner-btn").forEach(btn => {
        btn.addEventListener("click", e => {
          const target = document.getElementById(e.currentTarget.dataset.target);
          if (target) {
            let value = parseInt(target.value) || 0;
            value += e.currentTarget.classList.contains("up") ? 1 : -1;
            const min = parseInt(target.min);
            if (!isNaN(min) && value < min) value = min;
            target.value = value;
            if (target.id === 'rewatchCountInput') {
              updateRewatchModalButtons(value);
            }
          }
        });
      });
      elements.confirmRewatchBtn.addEventListener('click', () => {
        const newCount = parseInt(elements.rewatchCountInput.value);
        if (!isNaN(newCount) && newCount >= 0) {
          markRewatch(currentRewatchMediaId, newCount);
          closeModal(elements.rewatchModal);
        } else {
          showNotification("Per favore, inserisci un numero valido (0 o superiore).", "warning");
        }
      });
      elements.cancelRewatchBtn.addEventListener('click', () => closeModal(elements.rewatchModal));

      elements.addFriendBtn.addEventListener('click', addFriend);
      elements.bellIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        elements.notificationDropdown.classList.toggle('visible');
      });
    }

    async function showPosterModal(id) {
      const media = mediaList.find(m => m.id === id);
      if (!media || !media.imdbID) return showNotification("Nessun IMDb ID trovato per questo film.", "warning");
      elements.posterModal.dataset.mediaId = id;
      elements.posterGrid.innerHTML = '<div style="display:flex; justify-content:center; align-items:center; height:100%;"><i class="fas fa-spinner fa-2x loading-spinner"></i></div>';
      openModal(elements.posterModal);

      const currentPosterUrl = media.poster;

      fetchPosters(media.imdbID).then(posters => {
        if (posters.length === 0) {
          elements.posterGrid.innerHTML = "<p>Nessuna copertina alternativa trovata</p>";
          return;
        }
        elements.posterGrid.innerHTML = "";
        posters.forEach(poster => {
          const option = document.createElement("div");
          option.className = "poster-option";
          option.dataset.url = poster.url;

          if (poster.url === currentPosterUrl) {
            option.innerHTML += `<div class="poster-current-indicator"><i class="fas fa-check"></i> Attuale</div>`;
          }

          const img = document.createElement("img");
          img.src = poster.url;
          img.onerror = () => img.src = DEFAULT_POSTER;
          option.appendChild(img);

          const lang = poster.iso_639_1 || 'N/A';
          option.innerHTML += `<div class="poster-language-badge">${lang}</div>`;

          option.addEventListener("click", () => {
            document.querySelectorAll(".poster-option").forEach(o => o.classList.remove("selected"));
            option.classList.add("selected");
          });
          elements.posterGrid.appendChild(option);
        });
      });
    }

    async function fetchPosters(imdbID) {
      try {
        const response = await fetch(`https://api.themoviedb.org/3/find/${imdbID}?api_key=${TMDB_KEY}&external_source=imdb_id`);
        const data = await response.json();
        const tmdbId = data.movie_results[0]?.id;
        if (!tmdbId) return [];
        const imagesResponse = await fetch(`https://api.themoviedb.org/3/movie/${tmdbId}/images?api_key=${TMDB_KEY}`);
        const imagesData = await imagesResponse.json();

        const langScore = (lang) => {
          if (lang === 'it') return 3;
          if (lang === 'en') return 2;
          if (lang === null) return 1;
          return 0;
        };

        return imagesData.posters
          .filter(p => ['it', 'en', null].includes(p.iso_639_1))
          .sort((a, b) => langScore(b.iso_639_1) - langScore(a.iso_639_1))
          .slice(0, 33)
          .map(p => ({ url: `https://image.tmdb.org/t/p/w500${p.file_path}`, iso_639_1: p.iso_639_1 }));
      } catch (err) {
        console.error("Error fetching posters:", err);
        return [];
      }
    }

    function changePoster(id, url) {
      const media = mediaList.find(m => m.id === id);
      if (media) {
        media.poster = url;
        saveData();
        refreshSingleMedia(id);
      }
    }

    async function toggleFavorite(mediaId) {
      if (isViewMode) return;
      const media = mediaList.find(m => m.id === mediaId);
      if (media) {
        media.isFavorite = !media.isFavorite;
        await saveData();

        const cardBtn = document.querySelector(`.media-card[data-id="${mediaId}"] .favorite-btn`);
        if (cardBtn) cardBtn.classList.toggle('is-favorite', media.isFavorite);

        if (elements.categoryFilter.value === 'favorites') {
          renderMedia();
        }
      }
    }

    /* --- GESTIONE MODALI E BACK GESTURE (HISTORY API) --- */

    // 1. Nuova funzione unificata per aprire i modali
    function openModal(modal) {
      if (!modal) return;

      // Se il modale è già aperto, non fare nulla per evitare doppi stati
      if (modal.classList.contains('visible')) return;

      modal.style.display = 'flex';
      document.body.classList.add('modal-open');

      // Aspetta un micro-secondo e aggiungi la classe per l'animazione
      setTimeout(() => {
        modal.classList.add('visible');
      }, 10);

      // Aggiungiamo uno stato alla cronologia del browser.
      if (!history.state || history.state.modalId !== modal.id) {
        history.pushState({ modalId: modal.id }, '', window.location.href);
      }
    }

    // 2. Nuova funzione unificata per chiudere i modali
    function closeModal(modal) {
      if (modal && modal.classList.contains('visible')) {
        // Invece di nasconderlo direttamente, diciamo al browser di "tornare indietro".
        // Questo attiverà l'evento 'popstate' (vedi punto 3), che chiuderà visivamente il modale con animazione.
        history.back();
      }
    }

    // 3. Gestore dell'evento "Torna Indietro" (Swipe o Tasto fisico)
    window.addEventListener('popstate', (event) => {
      // Troviamo tutti i modali attualmente visibili (quelli con la classe .visible)
      const visibleModals = Array.from(document.querySelectorAll('.modal'))
        .filter(m => m.classList.contains('visible'));

      if (visibleModals.length > 0) {
        // Ordiniamo per z-index decrescente per chiudere prima quello più in alto
        visibleModals.sort((a, b) => {
          const zA = parseInt(window.getComputedStyle(a).zIndex) || 0;
          const zB = parseInt(window.getComputedStyle(b).zIndex) || 0;
          return zB - zA;
        });

        // Chiudiamo visivamente il modale più in alto con animazione
        const topModal = visibleModals[0];
        topModal.classList.remove('visible');

        // Aspetta che l'animazione finisca (300ms) prima di fare display: none
        setTimeout(() => {
          topModal.style.display = 'none';

          // Se non ci sono altri modali visibili, riattiviamo lo scroll del body
          if (!document.querySelector('.modal.visible')) {
            document.body.classList.remove('modal-open');
          }
        }, 300);
      }
    });

    // --- BACK GESTURE IMPLEMENTATION FOR MOBILE MODALS ---
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    let isSwipingBack = false;

    function handleTouchStart(e) {
      touchStartX = e.changedTouches[0].screenX;
      touchStartY = e.changedTouches[0].screenY;
      isSwipingBack = false;
    }

    function handleTouchMove(e) {
      if (!touchStartX || !touchStartY) return;

      touchEndX = e.changedTouches[0].screenX;
      touchEndY = e.changedTouches[0].screenY;

      const deltaX = touchEndX - touchStartX;
      const deltaY = touchEndY - touchStartY;

      // Check if this is a horizontal swipe to the right
      if (Math.abs(deltaX) > Math.abs(deltaY) && deltaX > 50) {
        isSwipingBack = true;
        e.preventDefault();
      }
    }

    function handleTouchEnd(e) {
      if (!touchStartX || !touchStartY) return;

      const deltaX = touchEndX - touchStartX;
      const deltaY = touchEndY - touchStartY;

      // Check if it's a valid back gesture (swipe right with minimal vertical movement)
      if (isSwipingBack && Math.abs(deltaX) > 100 && Math.abs(deltaY) < 100) {
        const modal = e.currentTarget;
        if (modal && modal.classList.contains('modal') && modal.style.display === 'flex') {
          closeModal(modal);
        }
      }

      // Reset values
      touchStartX = 0;
      touchStartY = 0;
      touchEndX = 0;
      touchEndY = 0;
      isSwipingBack = false;
    }

    // Add back gesture support to all modals
    function setupBackGestureSupport() {
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        // Skip modals that shouldn't be closed with back gesture
        if (modal.id === 'confirmModal') return;

        modal.addEventListener('touchstart', handleTouchStart, { passive: false });
        modal.addEventListener('touchmove', handleTouchMove, { passive: false });
        modal.addEventListener('touchend', handleTouchEnd, { passive: false });
      });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Chiudi modale con ESC
      if (e.key === "Escape") {
        const visibleModal = document.querySelector('.modal[style*="flex"]');
        if (visibleModal) closeModal(visibleModal);
      }

      // Focus sulla ricerca con il tasto "/"
      if (e.key === "/" && !["INPUT", "TEXTAREA"].includes(document.activeElement.tagName)) {
        e.preventDefault();
        elements.searchInput.focus();
      }

      // ALT+N per aggiungere nuovo film
      if (e.altKey && e.key === 'n') {
        elements.mediaManagementBtn.click();
        document.querySelector('.tab-btn[data-tab="add-media"]').click();
      }
    });

    async function loadDigitalCalendar() {
      const listContainer = document.getElementById('digitalList');
      if (!listContainer) return;

      listContainer.innerHTML = `<div style="text-align:center; padding: 3rem;"><i class="fas fa-spinner fa-spin fa-2x" style="color: var(--primary);"></i></div>`;

      try {
        const response = await fetch(`${MDBLIST_PROXY_URL}?mode=digital`);
        const movies = await response.json();

        if (!movies || movies.length === 0) {
          listContainer.innerHTML = "<p style='text-align:center;'>Nessun dato trovato.</p>";
          return;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // Filtro: film usciti da non più di 5 giorni o futuri
        const filtered = movies.filter(m => m.timestamp > (today.getTime() - (5 * 24 * 60 * 60 * 1000)));
        filtered.sort((a, b) => a.timestamp - b.timestamp);

        listContainer.innerHTML = filtered.map(movie => {
          const relDate = new Date(movie.date);

          // Badge per data incerta
          const tbcBadge = movie.rdWarning ? `<span style="color: var(--danger); font-size: 0.7rem; font-weight: 800; margin-left: 5px;">(TBC)</span>` : '';

          // Stringa Regista • Genere • Durata
          const metaString = `${movie.director || 'N/D'} • ${movie.genre || 'N/D'} • ${movie.duration || 'N/D'}`;

          return `
            <div class="digital-item">
                <div class="digital-still-wrapper">
                    <img src="${movie.still}" class="digital-still" onerror="this.src='${DEFAULT_POSTER}'">
                </div>
                <div class="digital-info">
                    <span class="digital-title">${movie.title}</span>
                    <span class="digital-release-date" style="color: var(--primary); font-weight: 600; font-size: 0.85rem;">
                        <i class="fas fa-calendar-day"></i> ${relDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'long' })} ${tbcBadge}
                    </span>
                    <span class="digital-meta" style="font-size: 0.75rem; color: var(--text-secondary); display: block; margin-top: 2px;">
                        ${metaString}
                    </span>
                </div>
                <!-- TASTO AGGIUNGI RAPIDO -->
                <button onclick="closeModal(document.getElementById('digitalModal')); addNewMedia('${movie.tmdbId}')" 
                        class="btn btn-primary" 
                        style="width: 38px; height: 38px; padding: 0; flex-shrink: 0; border-radius: 50%;" 
                        title="Aggiungi alla Watchlist">
                    <i class="fas fa-plus"></i>
                </button>
            </div>`;
        }).join('');

      } catch (error) {
        listContainer.innerHTML = "<p style='text-align:center; color: var(--danger);'>Errore di caricamento.</p>";
      }
    }

    const digitalBtn = document.getElementById('digitalBtn');
    if (digitalBtn) {
      digitalBtn.addEventListener('click', () => {
        openModal(document.getElementById('digitalModal'));
        loadDigitalCalendar();
      });
    }

    const mobileDigitalBtn = document.getElementById('mobileDigitalBtn');
    if (mobileDigitalBtn) {
      mobileDigitalBtn.addEventListener('click', () => {
        openModal(document.getElementById('digitalModal'));
        loadDigitalCalendar();
      });
    }

    if (document.readyState === 'complete') {
      setupBackGestureSupport();
    } else {
      window.addEventListener('load', setupBackGestureSupport);
    }

    let genresChartInstance = null;
    let activityChartInstance = null;

    function renderAdvancedStats() {
      const genreCounts = {};
      mediaList.forEach(media => {
        if (media.category === 'watched' || media.isCountedAsWatched) {
          if (media.genres && Array.isArray(media.genres)) {
            media.genres.forEach(g => {
              genreCounts[g] = (genreCounts[g] || 0) + 1;
            });
          }
        }
      });

      const sortedGenres = Object.entries(genreCounts).sort((a, b) => b[1] - a[1]).slice(0, 6);
      const genreLabels = sortedGenres.map(g => g[0]);
      const genreData = sortedGenres.map(g => g[1]);

      const monthCounts = {};
      const last6Months = [];

      for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        monthCounts[key] = 0;
        last6Months.push(key);
      }

      mediaList.forEach(media => {
        if (media.lastActivityAt) {
          const d = new Date(media.lastActivityAt);
          const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
          if (monthCounts[key] !== undefined) {
            monthCounts[key]++;
          }
        }
      });

      const activityData = last6Months.map(m => monthCounts[m]);
      const activityLabels = last6Months.map(m => {
        const [y, mo] = m.split('-');
        const date = new Date(y, mo - 1);
        return date.toLocaleDateString('it-IT', { month: 'short' }).toUpperCase();
      });

      const isDark = document.body.classList.contains('dark');
      const textColor = isDark ? '#aaaaaa' : '#666666';
      const gridColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';
      const bgColor = isDark ? '#1e1e1e' : '#ffffff';
      const modernColors = ['#FF3366', '#20A4F3', '#FFD166', '#06D6A0', '#118AB2', '#073B4C'];

      const ctxGenres = document.getElementById('genresChart').getContext('2d');
      if (genresChartInstance) genresChartInstance.destroy();

      genresChartInstance = new Chart(ctxGenres, {
        type: 'doughnut',
        data: {
          labels: genreLabels.length ? genreLabels : ['Dati in elaborazione...'],
          datasets: [{
            data: genreData.length ? genreData : [1],
            backgroundColor: genreData.length ? modernColors : ['#444'],
            borderWidth: 3,
            borderColor: bgColor,
            hoverOffset: 15,
            borderRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: 15 },
          onHover: (event, chartElement) => {
            event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
          },
          onClick: (event, elements) => {
            if (elements.length > 0) {
              showChartDetails('genre', genreLabels[elements[0].index]);
            }
          },
          plugins: {
            legend: { position: 'right', labels: { color: textColor, font: { family: 'Inter', size: 12 }, usePointStyle: true, boxWidth: 8 } },
            tooltip: { backgroundColor: isDark ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.8)', titleColor: isDark ? '#000' : '#fff', bodyColor: isDark ? '#000' : '#fff', padding: 12, cornerRadius: 8, displayColors: false }
          }
        }
      });

      const ctxActivity = document.getElementById('activityChart').getContext('2d');
      if (activityChartInstance) activityChartInstance.destroy();

      let gradient = ctxActivity.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, 'rgba(58, 134, 255, 0.6)');
      gradient.addColorStop(1, 'rgba(58, 134, 255, 0.0)');

      activityChartInstance = new Chart(ctxActivity, {
        type: 'line',
        data: {
          labels: activityLabels,
          datasets: [{
            label: 'Film Attivi',
            data: activityData,
            backgroundColor: gradient,
            borderColor: '#3A86FF',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#fff',
            pointBorderColor: '#3A86FF',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          onHover: (event, chartElement) => {
            event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
          },
          onClick: (event, elements) => {
            if (elements.length > 0) {
              showChartDetails('activity', last6Months[elements[0].index], activityLabels[elements[0].index]);
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: { backgroundColor: '#3A86FF', titleFont: { size: 13 }, bodyFont: { size: 14, weight: 'bold' }, padding: 12, cornerRadius: 8, displayColors: false, callbacks: { label: function (c) { return c.raw + ' Film modificati'; } } }
          },
          scales: {
            y: { beginAtZero: true, ticks: { color: textColor, precision: 0, stepSize: 1 }, grid: { color: gridColor, drawBorder: false } },
            x: { ticks: { color: textColor, font: { family: 'Inter', weight: '600' } }, grid: { display: false, drawBorder: false } }
          }
        }
      });
    }

    function showChartDetails(type, key, displayLabel = '') {
      let filteredShows = [];
      let title = '';

      if (type === 'genre') {
        title = `Genere: ${key}`;
        filteredShows = mediaList.filter(m =>
          (m.category === 'watched' || m.isCountedAsWatched) &&
          m.genres && m.genres.includes(key)
        );
      } else if (type === 'activity') {
        title = `Attività di ${displayLabel}`;
        filteredShows = mediaList.filter(m => {
          if (!m.lastActivityAt) return false;
          const d = new Date(m.lastActivityAt);
          return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}` === key;
        });
      }

      filteredShows.sort((a, b) => a.title.localeCompare(b.title));

      elements.chartDetailsTitle.textContent = title;
      const listContainer = elements.chartDetailsList;

      if (filteredShows.length === 0) {
        listContainer.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">Nessun dato corrispondente.</p>';
      } else {
        listContainer.innerHTML = filteredShows.map(show => `
            <div class="chart-detail-item">
                <img src="${show.poster || DEFAULT_POSTER}" class="chart-detail-poster" onerror="this.src='${DEFAULT_POSTER}'">
                <div class="chart-detail-info">
                    <span style="font-weight: 700; font-size: 0.95rem;">${show.title}</span>
                    <span style="font-size: 0.8rem; color: var(--primary);"><i class="fas fa-folder"></i> ${getCategoryName(show.category)}</span>
                </div>
            </div>
        `).join('');
      }

      openModal(elements.chartDetailsModal);
    }

    // Add event listeners for the stats panel items
    document.querySelectorAll('.stat-item').forEach(item => {
      item.addEventListener('click', () => {
        openModal(elements.advancedStatsModal);
        renderAdvancedStats();
      });
    });
  </script>


  <!-- MODALE DIGITAL CALENDAR -->
  <div class="modal" id="digitalModal">
    <div class="modal-content">
      <h2 style="text-align: center; margin: 1rem 0;">Prossime Uscite Digitali</h2>
      <div id="digitalList" style="flex: 1; overflow-y: auto; padding: 0 1rem 1rem 1rem;">
        <!-- I film appariranno qui -->
      </div>
      <div class="modal-footer" style="padding: 1rem; border-top: 1px solid var(--border-color);">
        <button onclick="closeModal(document.getElementById('digitalModal'))" class="btn btn-secondary"
          style="width: 100%;">Chiudi</button>
      </div>
    </div>
  </div>

</body>

</html>
