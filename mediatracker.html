
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MediaTracker Pro</title>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    /* Tema chiaro (default) */
    :root {
      --primary: #3A86FF;
      --secondary: #00B4D8;
      --danger: #ff4444;
      --reset: #ff6b6b;
      --success: #228b22;
      --warning: #ffcc00;
      --bg-color: #f5f5f5;
      --card-bg: white;
      --text-color: #333;
      --text-secondary: #666;
      --border-color: #e0e0e0;
    }

    /* Tema scuro */
    body.dark {
      --bg-color: #1a1a1a;
      --card-bg: #2d2d2d;
      --text-color: #f5f5f5;
      --text-secondary: #aaa;
      --border-color: #444;
      --reset: #ff8e8e;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      padding: 1rem;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }

    /* Card Media */
    .media-card {
      background: var(--card-bg);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      width: 180px;
      transition: all 0.3s ease;
      position: relative;
      border: 1px solid var(--border-color);
    }

    .media-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .media-card.moving {
      transform: scale(0.95);
      opacity: 0.5;
    }

    .media-poster {
      width: 100%;
      height: 240px;
      object-fit: cover;
      object-position: center top;
    }

    .media-info {
      padding: 0.75rem;
    }

    .media-title {
      font-size: 0.9rem;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-color);
    }

    .media-meta {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }

    .media-ratings {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.75rem;
    }

    .rewatch-badge {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: bold;
    }

    .category-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: bold;
    }

    /* Sezioni */
    .media-section {
      transition: all 0.3s ease;
    }

    .media-section.hidden {
      display: none !important;
    }

    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1.5rem 0 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--primary);
    }

    .section-title {
      color: var(--primary);
      margin: 0;
    }

    .category-count {
      background: var(--primary);
      color: white;
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-size: 0.8rem;
      margin-left: 0.5rem;
    }

    /* Pulsanti */
    .btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-reset {
      background: var(--reset);
      color: white;
    }

    /* Stats */
    .stats-container {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
      flex-wrap: wrap;
    }

    .stat-item {
      background: var(--card-bg);
      padding: 0.75rem;
      border-radius: 8px;
      text-align: center;
      min-width: 80px;
      border: 1px solid var(--border-color);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-open {
      overflow: hidden;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1100;
      width: 200px;
      display: none;
      border: 1px solid var(--border-color);
    }

    .context-menu-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .context-menu-item:hover {
      background: rgba(0,0,0,0.1);
    }

    .context-submenu {
      position: relative;
    }

    .context-submenu-items {
      display: none;
      position: absolute;
      left: 100%;
      top: 0;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      width: 200px;
      border: 1px solid var(--border-color);
    }

    .context-submenu:hover .context-submenu-items {
      display: block;
    }

    /* Form elementi */
    input, select {
      width: 100%;
      padding: 0.5rem;
      margin: 0.5rem 0;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-color);
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-filter-container {
      display: flex;
      gap: 0.75rem;
      flex-grow: 1;
      min-width: 300px;
      flex-wrap: wrap;
    }

    .search-box {
      flex: 2;
      min-width: 200px;
    }

    .filter-select {
      flex: 1;
      min-width: 150px;
    }

    /* Action buttons on cards */
    .card-actions {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      gap: 0.5rem;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .media-card:hover .card-actions {
      opacity: 1;
    }

    .modal-open .card-actions {
      display: none !important;
    }

    .card-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      cursor: pointer;
    }

    /* OMDb results */
    .omdb-results-container {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.5rem;
    }

    .omdb-result-item {
      padding: 0.5rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .omdb-result-item:last-child {
      border-bottom: none;
    }

    .omdb-result-item:hover {
      background: rgba(0,0,0,0.05);
    }

    .omdb-poster-small {
      width: 50px;
      height: 75px;
      object-fit: cover;
      border-radius: 4px;
    }

    /* Category management modal */
    .category-management-modal {
      max-width: 400px;
    }

    .categories-list {
      max-height: 300px;
      overflow-y: auto;
      margin: 1rem 0;
    }

    .category-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      border-bottom: 1px solid var(--border-color);
      cursor: move;
      background: var(--card-bg);
      margin-bottom: 0.5rem;
      border-radius: 8px;
    }

    .category-item:last-child {
      border-bottom: none;
    }

    .category-item.dragging {
      opacity: 0.5;
      border: 1px dashed var(--primary);
    }

    .drag-handle {
      cursor: move;
      padding: 0.5rem;
      color: var(--text-secondary);
    }

    /* Bulk actions */
    .bulk-actions {
      display: none;
      gap: 0.5rem;
      margin: 1rem 0;
    }

    .bulk-actions.active {
      display: flex;
    }

    /* Notification */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 1rem;
      border-radius: 8px;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .notification.error {
      background: var(--danger);
    }

    .notification.warning {
      background: var(--warning);
      color: #333;
    }

    /* Checkbox for bulk selection */
    .bulk-checkbox {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 2;
      display: none;
    }

    .bulk-mode .bulk-checkbox {
      display: block;
    }

    .bulk-mode .card-actions {
      display: none !important;
    }
  </style>
</head>
<body class="light">
  <!-- Main App -->
  <div id="appContent">
    <div class="header">
      <div class="toolbar">
        <button id="addMediaBtn" class="btn btn-primary">
          <i class="fas fa-plus"></i> Aggiungi Film
        </button>
        <button id="manageCategoriesBtn" class="btn btn-secondary">
          <i class="fas fa-folder"></i> Gestione Categorie
        </button>
        <button id="exportBtn" class="btn btn-secondary">
          <i class="fas fa-download"></i> Esporta
        </button>
        <input type="file" id="importFile" accept=".json" style="display: none;">
        <button id="importBtn" class="btn btn-secondary">
          <i class="fas fa-upload"></i> Importa
        </button>
        <button id="resetBtn" class="btn btn-reset">
          <i class="fas fa-undo"></i> Reset
        </button>
        <button id="themeToggle" class="btn">
          <i class="fas fa-moon"></i> Tema
        </button>
        <button id="bulkActionBtn" class="btn btn-secondary" style="display: none;">
          <i class="fas fa-tasks"></i> Azioni Multiple
        </button>

        <div class="search-filter-container">
          <input type="text" id="searchInput" class="search-box" placeholder="Cerca film...">
          <select id="categoryFilter" class="filter-select">
            <option value="all">Tutte le categorie</option>
          </select>
          <select id="sortFilter" class="filter-select">
            <option value="added">Ultimi aggiunti</option>
            <option value="alpha">Alfabetico</option>
            <option value="rating">Valutazione</option>
            <option value="year">Anno di uscita</option>
          </select>
        </div>
      </div>

      <div class="bulk-actions" id="bulkActions">
        <select id="bulkCategorySelect" class="filter-select">
          <option value="">Sposta in...</option>
        </select>
        <button id="bulkMoveBtn" class="btn btn-secondary">
          <i class="fas fa-folder"></i> Applica
        </button>
        <button id="bulkDeleteBtn" class="btn btn-danger">
          <i class="fas fa-trash"></i> Elimina
        </button>
        <button id="cancelBulkBtn" class="btn btn-reset">
          <i class="fas fa-times"></i> Annulla
        </button>
      </div>
      
      <div class="stats-container">
        <div class="stat-item">
          <div class="stat-value" id="statTotal">0</div>
          <div>Totale</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statWatchlist">0</div>
          <div>Da Vedere</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statWatched">0</div>
          <div>Visti</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statRewatched">0</div>
          <div>Rewatch</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statHours">0h 0m</div>
          <div>Tempo Totale</div>
        </div>
      </div>
    </div>

    <!-- Sezioni Media verranno generate dinamicamente -->
    <div id="mediaSectionsContainer"></div>
  </div>

  <!-- Add Media Modal -->
  <div class="modal" id="addMediaModal">
    <div class="modal-content">
      <h2>Aggiungi Film</h2>
      <input type="text" id="mediaTitle" placeholder="Titolo">
      <button id="searchOMDbBtn" class="btn btn-secondary">
        <i class="fas fa-search"></i> Cerca su OMDb
      </button>
      <div id="omdbResults" class="omdb-results-container"></div>
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
        <button id="saveMediaBtn" class="btn btn-primary">Salva</button>
        <button id="cancelMediaBtn" class="btn btn-danger">Annulla</button>
      </div>
    </div>
  </div>

  <!-- Category Management Modal -->
  <div class="modal" id="categoryManagementModal">
    <div class="modal-content category-management-modal">
      <h2>Gestione Categorie</h2>
      <div class="filter-row">
        <input type="text" id="newCategoryName" placeholder="Nome categoria">
        <button id="addCategoryBtn" class="btn btn-primary">
          <i class="fas fa-plus"></i> Aggiungi
        </button>
      </div>
      <div class="categories-list" id="categoriesList">
        <!-- Categorie verranno aggiunte dinamicamente -->
      </div>
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
        <button id="saveCategoriesOrderBtn" class="btn btn-primary">
          <i class="fas fa-save"></i> Salva Ordine
        </button>
        <button id="closeCategoryManagementBtn" class="btn btn-danger">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- Rewatch Modal -->
  <div class="modal" id="rewatchModal">
    <div class="modal-content">
      <h2>Segna Rewatch</h2>
      <p>Quante volte hai visto questo film in totale?</p>
      <input type="number" id="rewatchCount" min="1" value="1" style="width: 60px; text-align: center;">
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
        <button id="confirmRewatchBtn" class="btn btn-primary">Conferma</button>
        <button id="cancelRewatchBtn" class="btn btn-danger">Annulla</button>
      </div>
    </div>
  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="contextMenu">
    <div class="context-menu-item context-submenu">
      <i class="fas fa-folder"></i> Sposta in
      <div class="context-submenu-items" id="categorySubmenu">
        <!-- Categorie verranno aggiunte dinamicamente -->
      </div>
    </div>
    <div class="context-menu-item" id="cmRewatch">
      <i class="fas fa-redo"></i> Segna Rewatch
    </div>
    <div class="context-menu-item" id="cmDelete">
      <i class="fas fa-trash"></i> Elimina Film
    </div>
    <div class="context-menu-item" id="cmBulkSelect">
      <i class="fas fa-tasks"></i> Seleziona Multipli
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification">
    <span id="notificationText"></span>
  </div>

  <script>
    // Configurazione
    const OMDb_API_KEY = "2526ef70";
    const DEFAULT_POSTER = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iNDUwIiB2aWV3Qm94PSIwIDAgMzAwIDQ1MCI+PHJlY3Qgd2lkdGg9IjMwMCIgaGVpZ2h0PSI0NTAiIGZpbGw9IiNkZGQiLz48dGV4dCB4PSIxNTAiIHk9IjIyNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNjY2Ij5OZXNzYSBpbWFnaW5lPC90ZXh0Pjwvc3ZnPg==";
    const DEFAULT_CATEGORIES = ["watchlist", "watched"];

    // Stato
    let mediaList = JSON.parse(localStorage.getItem("mediaList")) || [];
    let categories = JSON.parse(localStorage.getItem("categories")) || DEFAULT_CATEGORIES;
    let currentContextMedia = null;
    let currentRewatchMedia = null;
    let currentOMDbSelection = null;
    let selectedMediaIds = [];
    let isBulkMode = false;
    let draggedCategory = null;

    // Elementi DOM
    const elements = {
      appContent: document.getElementById("appContent"),
      addMediaBtn: document.getElementById("addMediaBtn"),
      manageCategoriesBtn: document.getElementById("manageCategoriesBtn"),
      addMediaModal: document.getElementById("addMediaModal"),
      categoryManagementModal: document.getElementById("categoryManagementModal"),
      mediaTitle: document.getElementById("mediaTitle"),
      newCategoryName: document.getElementById("newCategoryName"),
      searchOMDbBtn: document.getElementById("searchOMDbBtn"),
      omdbResults: document.getElementById("omdbResults"),
      saveMediaBtn: document.getElementById("saveMediaBtn"),
      cancelMediaBtn: document.getElementById("cancelMediaBtn"),
      addCategoryBtn: document.getElementById("addCategoryBtn"),
      closeCategoryManagementBtn: document.getElementById("closeCategoryManagementBtn"),
      saveCategoriesOrderBtn: document.getElementById("saveCategoriesOrderBtn"),
      categoriesList: document.getElementById("categoriesList"),
      mediaSectionsContainer: document.getElementById("mediaSectionsContainer"),
      statTotal: document.getElementById("statTotal"),
      statWatchlist: document.getElementById("statWatchlist"),
      statWatched: document.getElementById("statWatched"),
      statRewatched: document.getElementById("statRewatched"),
      statHours: document.getElementById("statHours"),
      contextMenu: document.getElementById("contextMenu"),
      cmRewatch: document.getElementById("cmRewatch"),
      cmDelete: document.getElementById("cmDelete"),
      cmBulkSelect: document.getElementById("cmBulkSelect"),
      categorySubmenu: document.getElementById("categorySubmenu"),
      exportBtn: document.getElementById("exportBtn"),
      importBtn: document.getElementById("importBtn"),
      importFile: document.getElementById("importFile"),
      resetBtn: document.getElementById("resetBtn"),
      themeToggle: document.getElementById("themeToggle"),
      notification: document.getElementById("notification"),
      notificationText: document.getElementById("notificationText"),
      rewatchModal: document.getElementById("rewatchModal"),
      rewatchCount: document.getElementById("rewatchCount"),
      confirmRewatchBtn: document.getElementById("confirmRewatchBtn"),
      cancelRewatchBtn: document.getElementById("cancelRewatchBtn"),
      searchInput: document.getElementById("searchInput"),
      categoryFilter: document.getElementById("categoryFilter"),
      sortFilter: document.getElementById("sortFilter"),
      bulkActionBtn: document.getElementById("bulkActionBtn"),
      bulkActions: document.getElementById("bulkActions"),
      bulkCategorySelect: document.getElementById("bulkCategorySelect"),
      bulkMoveBtn: document.getElementById("bulkMoveBtn"),
      bulkDeleteBtn: document.getElementById("bulkDeleteBtn"),
      cancelBulkBtn: document.getElementById("cancelBulkBtn")
    };

    // Inizializzazione
    function init() {
      loadTheme();
      loadMedia();
      loadCategories();
      setupEventListeners();
      renderCategorySections();
      renderMedia();
      updateCategoryFilter();
      updateCategorySubmenu();
      setupDragAndDrop();
    }

    // Carica tema
    function loadTheme() {
      const savedTheme = localStorage.getItem("theme") || "light";
      document.body.classList.toggle("dark", savedTheme === "dark");
      elements.themeToggle.innerHTML = `
        <i class="fas fa-${savedTheme === "dark" ? "sun" : "moon"}"></i> Tema
      `;
    }

    // Carica i media
    function loadMedia() {
      try {
        const saved = localStorage.getItem("mediaList");
        mediaList = saved ? JSON.parse(saved) : [];
        if (!Array.isArray(mediaList)) {
          console.error("Dati mediaList corrotti, reinizializzo");
          mediaList = [];
        }
      } catch (e) {
        console.error("Error loading media:", e);
        mediaList = [];
      }
    }

    // Carica le categorie
    function loadCategories() {
      try {
        const saved = localStorage.getItem("categories");
        if (saved) {
          categories = JSON.parse(saved);
          if (!categories.includes("watchlist")) categories.unshift("watchlist");
          if (!categories.includes("watched")) categories.push("watched");
        } else {
          categories = [...DEFAULT_CATEGORIES];
        }
      } catch (e) {
        console.error("Error loading categories:", e);
        categories = [...DEFAULT_CATEGORIES];
      }
    }

    // Salva i media
    function saveMedia() {
      try {
        localStorage.setItem("mediaList", JSON.stringify(mediaList));
        console.log("Dati salvati:", mediaList.length, "film");
      } catch (e) {
        console.error("Error saving media:", e);
        showNotification("Errore nel salvataggio dei dati", "error");
      }
    }

    // Salva le categorie
    function saveCategories() {
      try {
        localStorage.setItem("categories", JSON.stringify(categories));
        renderCategorySections();
        updateCategoryFilter();
        updateCategorySubmenu();
        renderCategoriesList();
        updateBulkCategorySelect();
      } catch (e) {
        console.error("Error saving categories:", e);
        showNotification("Errore nel salvataggio delle categorie", "error");
      }
    }

    // Renderizza le sezioni delle categorie
    function renderCategorySections() {
      elements.mediaSectionsContainer.innerHTML = categories.map(category => `
        <div class="media-section" id="${category}Section" data-category="${category}">
          <div class="section-header">
            <h2 class="section-title">${getCategoryName(category)}</h2>
            <span id="${category}Count" class="category-count">0</span>
          </div>
          <div class="media-grid" id="${category}Grid"></div>
        </div>
      `).join("");
    }

    // Renderizza la lista delle categorie nella modal
    function renderCategoriesList() {
      elements.categoriesList.innerHTML = categories.map(category => `
        <div class="category-item" data-category="${category}" draggable="true">
          <span>${getCategoryName(category)}</span>
          ${!DEFAULT_CATEGORIES.includes(category) ? `
            <button class="btn btn-danger delete-category-btn" data-category="${category}">
              <i class="fas fa-trash"></i>
            </button>
          ` : '<i class="fas fa-grip-lines drag-handle"></i>'}
        </div>
      `).join("");

      // Aggiungi event listener per i pulsanti di eliminazione
      document.querySelectorAll(".delete-category-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const category = btn.dataset.category;
          deleteCategory(category);
        });
      });
    }

    // Setup drag and drop per categorie
    function setupDragAndDrop() {
      const container = elements.categoriesList;

      container.querySelectorAll('.category-item').forEach(item => {
        item.addEventListener('dragstart', (e) => {
          draggedCategory = item;
          item.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', item.innerHTML);
        });

        item.addEventListener('dragend', () => {
          item.classList.remove('dragging');
          draggedCategory = null;
        });
      });

      container.addEventListener('dragover', (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(container, e.clientY);
        const draggable = draggedCategory;
        
        if (afterElement == null) {
          container.appendChild(draggable);
        } else {
          container.insertBefore(draggable, afterElement);
        }
      });
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.category-item:not(.dragging)')];

      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Salva l'ordine delle categorie
    function saveCategoriesOrder() {
      const newOrder = [...elements.categoriesList.querySelectorAll('.category-item')]
        .map(item => item.dataset.category)
        .filter(cat => cat); // Rimuovi eventuali valori null

      categories = newOrder;
      saveCategories();
      showNotification("Ordine categorie salvato", "success");
    }

    // Aggiorna il filtro categorie
    function updateCategoryFilter() {
      elements.categoryFilter.innerHTML = `
        <option value="all">Tutte le categorie</option>
        ${categories.map(cat => `
          <option value="${cat}">${getCategoryName(cat)}</option>
        `).join("")}
      `;

      // Aggiorna anche il select per le azioni multiple
      updateBulkCategorySelect();
    }

    function updateBulkCategorySelect() {
      elements.bulkCategorySelect.innerHTML = `
        <option value="">Sposta in...</option>
        ${categories.map(cat => `
          <option value="${cat}">${getCategoryName(cat)}</option>
        `).join("")}
      `;
    }

    // Aggiorna il submenu categorie
    function updateCategorySubmenu() {
      elements.categorySubmenu.innerHTML = categories.map(cat => `
        <div class="context-menu-item" data-category="${cat}">${getCategoryName(cat)}</div>
      `).join("");
    }

    // Ottieni nome categoria
    function getCategoryName(category) {
      const names = {
        watchlist: "Da Vedere",
        watched: "Visti"
      };
      return names[category] || category;
    }

    // Renderizza i media
    function renderMedia() {
      clearMediaGrids();
      updateStats();

      const searchTerm = elements.searchInput.value.toLowerCase();
      const filterCategory = elements.categoryFilter.value;
      const sortBy = elements.sortFilter.value;

      // Nascondi tutte le sezioni prima di filtrare
      document.querySelectorAll('.media-section').forEach(section => {
        section.style.display = 'none';
      });

      let filteredMedia = [...mediaList];
      
      if (searchTerm) {
        filteredMedia = filteredMedia.filter(media => 
          media.title.toLowerCase().includes(searchTerm)
        );
      }
      
      if (filterCategory !== "all") {
        filteredMedia = filteredMedia.filter(media => 
          media.category === filterCategory
        );
        
        // Mostra solo la sezione filtrata
        const section = document.getElementById(`${filterCategory}Section`);
        if (section) section.style.display = 'block';
      } else {
        // Mostra tutte le sezioni
        document.querySelectorAll('.media-section').forEach(section => {
          section.style.display = 'block';
        });
      }
      
      filteredMedia.sort((a, b) => {
        switch(sortBy) {
          case "alpha": return a.title.localeCompare(b.title);
          case "rating": return (parseFloat(b.imdbRating) || 0) - (parseFloat(a.imdbRating) || 0);
          case "year": return (parseInt(b.year) || 0) - (parseInt(a.year) || 0);
          case "added":
          default: return new Date(b.addedAt) - new Date(a.addedAt);
        }
      });

      filteredMedia.forEach(media => {
        const grid = document.getElementById(`${media.category}Grid`);
        if (grid) grid.appendChild(createMediaCard(media));
      });

      updateCounts();
      updateBulkModeUI();
    }

    // Svuota le griglie
    function clearMediaGrids() {
      categories.forEach(category => {
        const grid = document.getElementById(`${category}Grid`);
        if (grid) grid.innerHTML = "";
      });
    }

    // Aggiorna statistiche
    function updateStats() {
      let stats = {
        total: mediaList.length,
        watchlist: 0,
        watched: 0,
        rewatched: 0,
        hours: 0,
        minutes: 0
      };

      mediaList.forEach(media => {
        if (media.category === "watchlist") stats.watchlist++;
        if (media.category === "watched") stats.watched++;
        if (media.rewatchCount > 1) stats.rewatched++;

        // Calcola solo per i film visti
        if (media.category === "watched") {
          const runtime = media.runtime ? parseInt(media.runtime.toString().replace(/\D/g, '')) : 0;
          if (runtime > 0) {
            // Tempo totale = runtime * rewatchCount
            const totalMinutes = runtime * (media.rewatchCount || 1);
            stats.minutes += totalMinutes;
          }
        }
      });

      // Converti minuti in ore e minuti
      stats.hours = Math.floor(stats.minutes / 60);
      stats.minutes = stats.minutes % 60;

      elements.statTotal.textContent = stats.total;
      elements.statWatchlist.textContent = stats.watchlist;
      elements.statWatched.textContent = stats.watched;
      elements.statRewatched.textContent = stats.rewatched;
      elements.statHours.textContent = `${stats.hours}h ${stats.minutes}m`;
    }

    // Aggiorna contatori
    function updateCounts() {
      categories.forEach(category => {
        const countElement = document.getElementById(`${category}Count`);
        if (countElement) {
          const count = mediaList.filter(m => m.category === category).length;
          countElement.textContent = count;
          
          const section = document.getElementById(`${category}Section`);
          if (section && elements.categoryFilter.value !== 'all' && count === 0) {
            section.style.display = 'none';
          }
        }
      });
    }

    // Crea una card media
    function createMediaCard(media) {
      const card = document.createElement("div");
      card.className = `media-card ${isBulkMode ? 'bulk-selectable' : ''}`;
      card.dataset.id = media.id;
      
      const ratingsHTML = media.imdbRating || media.rottenTomatoes ? `
        <div class="media-ratings">
          ${media.imdbRating ? `<span>⭐ ${media.imdbRating}</span>` : ''}
          ${media.rottenTomatoes ? `<span>🍅 ${media.rottenTomatoes}</span>` : ''}
        </div>
      ` : '';

      const rewatchHTML = media.rewatchCount > 1 ? `
        <span class="rewatch-badge">
          🔄×${media.rewatchCount}
        </span>
      ` : '';

      const categoryHTML = !DEFAULT_CATEGORIES.includes(media.category) ? `
        <span class="category-badge">
          ${media.category}
        </span>
      ` : '';

      const isSelected = selectedMediaIds.includes(media.id);

      card.innerHTML = `
        <div style="position:relative;">
          <input type="checkbox" class="bulk-checkbox" ${isSelected ? 'checked' : ''} 
                 data-id="${media.id}" style="display: ${isBulkMode ? 'block' : 'none'};">
          <img src="${fixPosterUrl(media.poster) || DEFAULT_POSTER}" class="media-poster" 
               onerror="this.src='${DEFAULT_POSTER}'">
          ${rewatchHTML}
          ${categoryHTML}
          <div class="card-actions">
            <button class="card-btn" data-action="edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="card-btn" data-action="delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="media-info">
          <h3 class="media-title" title="${media.title}">${media.title}</h3>
          <div class="media-meta">
            ${media.year ? `<span>${media.year}</span>` : ''}
            ${media.runtime ? `<span>⏱️ ${media.runtime}</span>` : ''}
          </div>
          ${ratingsHTML}
        </div>
      `;

      // Aggiungi event listeners
      card.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        showContextMenu(media, e.clientX, e.clientY);
      });

      card.addEventListener("click", (e) => {
        if (isBulkMode && !e.target.closest('.card-actions') && !e.target.classList.contains('bulk-checkbox')) {
          const checkbox = card.querySelector('.bulk-checkbox');
          checkbox.checked = !checkbox.checked;
          toggleMediaSelection(media.id, checkbox.checked);
          e.preventDefault();
        }
      });

      card.querySelector("[data-action='edit']").addEventListener("click", (e) => {
        e.stopPropagation();
        editMedia(media.id);
      });

      card.querySelector("[data-action='delete']").addEventListener("click", (e) => {
        e.stopPropagation();
        deleteMedia(media.id);
      });

      const checkbox = card.querySelector('.bulk-checkbox');
      if (checkbox) {
        checkbox.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleMediaSelection(media.id, checkbox.checked);
        });
      }

      return card;
    }

    // Toggle selezione media per azioni multiple
    function toggleMediaSelection(mediaId, isSelected) {
      if (isSelected) {
        if (!selectedMediaIds.includes(mediaId)) {
          selectedMediaIds.push(mediaId);
        }
      } else {
        selectedMediaIds = selectedMediaIds.filter(id => id !== mediaId);
      }
      updateBulkModeUI();
    }

    // Aggiorna UI per modalità bulk
    function updateBulkModeUI() {
      if (selectedMediaIds.length > 0 || isBulkMode) {
        elements.bulkActionBtn.style.display = 'inline-flex';
        elements.bulkActions.classList.add('active');
      } else {
        elements.bulkActionBtn.style.display = 'none';
        elements.bulkActions.classList.remove('active');
      }
    }

    // Attiva/disattiva modalità bulk
    function toggleBulkMode() {
      isBulkMode = !isBulkMode;
      if (!isBulkMode) {
        selectedMediaIds = [];
      }
      document.body.classList.toggle('bulk-mode', isBulkMode);
      renderMedia();
      updateBulkModeUI();
    }

    // Esegui azione bulk
    function performBulkAction(action, value) {
      if (selectedMediaIds.length === 0) {
        showNotification("Nessun film selezionato", "warning");
        return;
      }

      if (action === 'move' && !value) {
        showNotification("Seleziona una categoria", "warning");
        return;
      }

      if (action === 'delete' && !confirm(`Eliminare ${selectedMediaIds.length} film selezionati?`)) {
        return;
      }

      selectedMediaIds.forEach(id => {
        const media = mediaList.find(m => m.id === id);
        if (!media) return;

        if (action === 'move') {
          media.category = value;
        } else if (action === 'delete') {
          mediaList = mediaList.filter(m => m.id !== id);
        }
      });

      saveMedia();
      renderMedia();
      
      const actionText = action === 'move' ? 'spostati' : 'eliminati';
      showNotification(`${selectedMediaIds.length} film ${actionText}`, "success");
      
      if (action === 'delete') {
        toggleBulkMode();
      } else {
        selectedMediaIds = [];
        updateBulkModeUI();
      }
    }

    // Corregge l'URL del poster
    function fixPosterUrl(url) {
      if (!url || url === "N/A") return null;
      if (url.startsWith("http://") || url.startsWith("https://")) {
        return url;
      }
      if (url.startsWith("//")) {
        return `https:${url}`;
      }
      return `https://${url}`;
    }

    // Mostra context menu
    function showContextMenu(media, x, y) {
      currentContextMedia = media;
      
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      const menuWidth = 200;
      const menuHeight = 150;
      
      const adjustedX = x + menuWidth > viewportWidth ? viewportWidth - menuWidth : x;
      const adjustedY = y + menuHeight > viewportHeight ? viewportHeight - menuHeight : y;
      
      elements.contextMenu.style.left = `${adjustedX}px`;
      elements.contextMenu.style.top = `${adjustedY}px`;
      elements.contextMenu.style.display = "block";
    }

    // Chiudi context menu
    function closeContextMenu() {
      elements.contextMenu.style.display = "none";
    }

    // Aggiungi una nuova categoria
    function addCategory(name) {
      if (!name) {
        showNotification("Inserisci un nome per la categoria", "warning");
        return false;
      }

      const normalizedName = name.trim();
      
      if (categories.some(cat => cat.toLowerCase() === normalizedName.toLowerCase())) {
        showNotification("Questa categoria esiste già", "warning");
        return false;
      }

      categories.push(normalizedName);
      saveCategories();
      renderMedia();
      showNotification(`Categoria "${normalizedName}" creata`, "success");
      return true;
    }

    // Elimina una categoria
    function deleteCategory(category) {
      if (DEFAULT_CATEGORIES.includes(category)) {
        showNotification("Non puoi eliminare questa categoria predefinita", "warning");
        return;
      }

      if (!confirm(`Eliminare la categoria "${category}"? Tutti i film verranno spostati in "Da Vedere".`)) return;
      
      mediaList.forEach(media => {
        if (media.category === category) {
          media.category = "watchlist";
        }
      });
      
      categories = categories.filter(c => c !== category);
      saveMedia();
      saveCategories();
      
      showNotification(`Categoria "${category}" eliminata`, "success");
    }

    // Sposta media tra categorie
    function moveMediaToCategory(mediaId, category) {
      const media = mediaList.find(m => m.id === mediaId);
      if (!media) return;

      // Animazione
      const card = document.querySelector(`.media-card[data-id="${mediaId}"]`);
      if (card) {
        card.style.transition = "all 0.3s";
        card.style.opacity = "0";
        card.style.transform = "scale(0.8)";
      }

      setTimeout(() => {
        // 1. Rimuovi dalla vecchia categoria
        const oldGrid = document.getElementById(`${media.category}Grid`);
        if (oldGrid) {
          const cardToRemove = oldGrid.querySelector(`.media-card[data-id="${mediaId}"]`);
          if (cardToRemove) cardToRemove.remove();
        }

        // 2. Aggiorna la categoria
        media.category = category;
        saveMedia();

        // 3. Aggiungi alla nuova categoria
        const newGrid = document.getElementById(`${category}Grid`);
        if (newGrid) {
          const newCard = createMediaCard(media);
          newCard.style.opacity = "0";
          newCard.style.transform = "scale(0.8)";
          newGrid.appendChild(newCard);
          
          // Animazione di entrata
          setTimeout(() => {
            newCard.style.opacity = "1";
            newCard.style.transform = "scale(1)";
          }, 10);
        }

        updateCounts();
        updateStats();
        showNotification(`Film spostato in "${category}"`, "success");
      }, 300);
    }

    // Segna rewatch
    function markRewatch(mediaId, count) {
      const media = mediaList.find(m => m.id === mediaId);
      if (!media) return;

      // Se non è nella categoria "watched", lo spostiamo
      if (media.category !== "watched") {
        media.category = "watched";
      }

      media.rewatchCount = count; // Sovrascriviamo il conteggio anziché incrementarlo
      saveMedia();
      
      refreshSingleMedia(mediaId);
      updateStats();
      showNotification(`Film visto ${count} ${count === 1 ? 'volta' : 'volte'}`, "success");
    }

    // Aggiorna singolo media
    function refreshSingleMedia(mediaId) {
      // Rimuovi da tutte le categorie
      document.querySelectorAll('.media-card').forEach(card => {
        if (card.dataset.id === mediaId) {
          card.remove();
        }
      });

      // Aggiungi nella categoria corretta
      const media = mediaList.find(m => m.id === mediaId);
      if (media) {
        const grid = document.getElementById(`${media.category}Grid`);
        if (grid) {
          grid.appendChild(createMediaCard(media));
        }
      }
      
      updateCounts();
    }

    // Modifica media
    function editMedia(mediaId) {
      const media = mediaList.find(m => m.id === mediaId);
      if (!media) return;

      elements.mediaTitle.value = media.title;
      elements.addMediaModal.style.display = "flex";
      document.body.classList.add("modal-open");

      elements.saveMediaBtn.textContent = "Aggiorna";
      elements.saveMediaBtn.onclick = () => {
        media.title = elements.mediaTitle.value.trim();
        saveMedia();
        closeModal(elements.addMediaModal);
        refreshSingleMedia(mediaId);
        showNotification("Film aggiornato", "success");
      };
    }

    // Elimina media
    function deleteMedia(id) {
      if (!confirm("Eliminare questo film dalla lista?")) return;
      
      mediaList = mediaList.filter(m => m.id !== id);
      saveMedia();
      renderMedia();
      showNotification("Film eliminato", "success");
    }

    // Chiudi modal
    function closeModal(modal) {
      modal.style.display = "none";
      document.body.classList.remove("modal-open");
      elements.mediaTitle.value = "";
      elements.omdbResults.innerHTML = "";
      currentOMDbSelection = null;
    }

    // Cerca su OMDb
    async function searchOMDb() {
      const title = elements.mediaTitle.value.trim();

      if (!title) {
        showNotification("Inserisci un titolo", "warning");
        return;
      }

      try {
        elements.omdbResults.innerHTML = "<p>Ricerca in corso...</p>";
        const response = await fetch(
          `https://www.omdbapi.com/?apikey=${OMDb_API_KEY}&s=${encodeURIComponent(title)}&type=movie`
        );
        const data = await response.json();

        if (data.Response === "False") {
          elements.omdbResults.innerHTML = `<p>${data.Error || "Nessun risultato trovato"}</p>`;
          return;
        }

        displayOMDbResults(data.Search);
      } catch (error) {
        showNotification("Errore nella ricerca", "error");
        console.error("OMDb error:", error);
        elements.omdbResults.innerHTML = "<p>Errore durante la ricerca</p>";
      }
    }

    // Mostra risultati OMDb
    function displayOMDbResults(results) {
      elements.omdbResults.innerHTML = results.map(movie => `
        <div class="omdb-result-item" data-id="${movie.imdbID}">
          <img src="${fixPosterUrl(movie.Poster)}" 
               class="omdb-poster-small"
               onerror="this.src='${DEFAULT_POSTER}'">
          <div>
            <div><strong>${movie.Title}</strong></div>
            <div>${movie.Year}</div>
          </div>
        </div>
      `).join("");

      document.querySelectorAll(".omdb-result-item").forEach(item => {
        item.addEventListener("click", async () => {
          const imdbID = item.dataset.id;
          const movie = await getOMDbMovieDetails(imdbID);
          if (movie) {
            currentOMDbSelection = movie;
            elements.mediaTitle.value = movie.Title;
            showNotification(`Dettagli di "${movie.Title}" pronti per il salvataggio`, "success");
          }
        });
      });
    }

    // Ottieni dettagli film da OMDb
    async function getOMDbMovieDetails(imdbID) {
      try {
        const response = await fetch(
          `https://www.omdbapi.com/?apikey=${OMDb_API_KEY}&i=${imdbID}`
        );
        const data = await response.json();
        
        if (data.Response === "False") {
          throw new Error(data.Error || "Dettagli non disponibili");
        }
        
        return data;
      } catch (error) {
        console.error("Error fetching movie details:", error);
        showNotification("Errore nel caricamento dei dettagli", "error");
        return null;
      }
    }

    // Aggiungi nuovo media
    function addNewMedia() {
      const title = elements.mediaTitle.value.trim();

      if (!title) {
        showNotification("Inserisci un titolo", "warning");
        return;
      }

      let mediaData = {
        id: Date.now().toString(),
        title,
        category: "watchlist",
        addedAt: new Date().toISOString(),
        poster: "",
        rewatchCount: 0,
        year: "",
        imdbRating: "",
        rottenTomatoes: "",
        runtime: ""
      };

      if (currentOMDbSelection) {
        mediaData = {
          ...mediaData,
          title: currentOMDbSelection.Title,
          year: currentOMDbSelection.Year,
          poster: fixPosterUrl(currentOMDbSelection.Poster),
          imdbRating: currentOMDbSelection.imdbRating,
          runtime: currentOMDbSelection.Runtime || "",
        };

        if (currentOMDbSelection.Ratings) {
          const rtRating = currentOMDbSelection.Ratings.find(r => r.Source === "Rotten Tomatoes");
          if (rtRating) {
            mediaData.rottenTomatoes = rtRating.Value;
          }
        }
      }

      mediaList.push(mediaData);
      saveMedia();
      closeModal(elements.addMediaModal);
      renderMedia();
      showNotification(`Film "${mediaData.title}" aggiunto!`, "success");
    }

    // Reset app
    function resetApp() {
      if (confirm("Resettare completamente l'applicazione? Tutti i dati verranno persi.")) {
        mediaList = [];
        categories = [...DEFAULT_CATEGORIES];
        saveMedia();
        saveCategories();
        elements.searchInput.value = "";
        elements.categoryFilter.value = "all";
        elements.sortFilter.value = "added";
        renderMedia();
        showNotification("Applicazione resettata", "success");
      }
    }

    // Esporta dati
    function exportData() {
      const data = {
        mediaList,
        categories,
        exportedAt: new Date().toISOString()
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `mediatracker_export_${new Date().toISOString().split("T")[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      showNotification("Dati esportati", "success");
    }

    // Importa dati
    function importData(file) {
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (!Array.isArray(data.mediaList)) throw new Error("Formato file non valido");

          if (confirm(`Importare ${data.mediaList.length} media? I dati attuali verranno sovrascritti.`)) {
            mediaList = data.mediaList;
            categories = data.categories || [...DEFAULT_CATEGORIES];
            saveMedia();
            saveCategories();
            renderMedia();
            showNotification("Dati importati con successo", "success");
          }
        } catch (error) {
          showNotification("Errore nell'importazione: " + error.message, "error");
        }
      };
      reader.readAsText(file);
    }

    // Mostra notifica
    function showNotification(message, type = "success") {
      elements.notificationText.textContent = message;
      elements.notification.className = `notification ${type}`;
      elements.notification.style.display = "block";

      setTimeout(() => {
        elements.notification.style.display = "none";
      }, 3000);
    }

    // Toggle tema
    function toggleTheme() {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      
      // Aggiorna l'icona e il testo del pulsante
      const icon = isDark ? "sun" : "moon";
      elements.themeToggle.innerHTML = `<i class="fas fa-${icon}"></i> Tema`;
      
      // Aggiorna eventuali altri elementi che dipendono dal tema
      updateThemeDependentElements();
    }

    // Aggiorna elementi che dipendono dal tema
    function updateThemeDependentElements() {
      const isDark = document.body.classList.contains("dark");
      
      // Esempio: cambia il colore di alcuni elementi specifici
      const specialElements = document.querySelectorAll('.theme-sensitive');
      specialElements.forEach(el => {
        el.style.color = isDark ? '#f0f0f0' : '#333';
      });
    }
    // Apri modal gestione categorie
    function openCategoryManagement() {
      renderCategoriesList();
      elements.categoryManagementModal.style.display = "flex";
      document.body.classList.add("modal-open");
    }

    // Setup event listeners
    function setupEventListeners() {
      // Aggiungi media
      elements.addMediaBtn.addEventListener("click", () => {
        elements.mediaTitle.value = "";
        elements.omdbResults.innerHTML = "";
        elements.saveMediaBtn.textContent = "Salva";
        elements.saveMediaBtn.onclick = addNewMedia;
        elements.addMediaModal.style.display = "flex";
        document.body.classList.add("modal-open");
      });

      // Gestione categorie
      elements.manageCategoriesBtn.addEventListener("click", openCategoryManagement);

      elements.addCategoryBtn.addEventListener("click", () => {
        if (addCategory(elements.newCategoryName.value)) {
          elements.newCategoryName.value = "";
        }
      });

      elements.saveCategoriesOrderBtn.addEventListener("click", saveCategoriesOrder);

      elements.closeCategoryManagementBtn.addEventListener("click", () => {
        closeModal(elements.categoryManagementModal);
      });

      elements.cancelMediaBtn.addEventListener("click", () => {
        closeModal(elements.addMediaModal);
      });

      // Cerca su OMDb
      elements.searchOMDbBtn.addEventListener("click", searchOMDb);

      // Context menu - Sposta in categoria
      document.addEventListener("click", (e) => {
        if (e.target.closest("[data-category]") && !e.target.closest("#categoriesList")) {
          const category = e.target.closest("[data-category]").dataset.category;
          if (currentContextMedia) {
            moveMediaToCategory(currentContextMedia.id, category);
          }
          closeContextMenu();
        }
      });

      elements.cmRewatch.addEventListener("click", () => {
        if (!currentContextMedia) return;
        currentRewatchMedia = currentContextMedia;
        elements.rewatchCount.value = currentRewatchMedia.rewatchCount || 1;
        elements.rewatchModal.style.display = "flex";
        document.body.classList.add("modal-open");
        closeContextMenu();
      });

      elements.cmDelete.addEventListener("click", () => {
        if (!currentContextMedia) return;
        deleteMedia(currentContextMedia.id);
        closeContextMenu();
      });

      elements.cmBulkSelect.addEventListener("click", () => {
        if (!currentContextMedia) return;
        toggleBulkMode();
        if (!selectedMediaIds.includes(currentContextMedia.id)) {
          selectedMediaIds.push(currentContextMedia.id);
        }
        renderMedia();
        closeContextMenu();
      });

      // Bulk actions
      elements.bulkActionBtn.addEventListener("click", toggleBulkMode);
      elements.bulkMoveBtn.addEventListener("click", () => {
        performBulkAction('move', elements.bulkCategorySelect.value);
      });
      elements.bulkDeleteBtn.addEventListener("click", () => {
        performBulkAction('delete');
      });
      elements.cancelBulkBtn.addEventListener("click", toggleBulkMode);

      // Rewatch modal
      elements.confirmRewatchBtn.addEventListener("click", () => {
        const count = parseInt(elements.rewatchCount.value) || 1;
        if (count <= 0) {
          showNotification("Inserisci un numero valido (almeno 1)", "warning");
          return;
        }
        markRewatch(currentRewatchMedia.id, count);
        closeModal(elements.rewatchModal);
      });

      elements.cancelRewatchBtn.addEventListener("click", () => {
        closeModal(elements.rewatchModal);
      });

      // Chiudi context menu cliccando altrove
      document.addEventListener("click", closeContextMenu);

      // Chiudi modal cliccando fuori
      elements.addMediaModal.addEventListener("click", (e) => {
        if (e.target === elements.addMediaModal) {
          closeModal(elements.addMediaModal);
        }
      });

      elements.categoryManagementModal.addEventListener("click", (e) => {
        if (e.target === elements.categoryManagementModal) {
          closeModal(elements.categoryManagementModal);
        }
      });

      elements.rewatchModal.addEventListener("click", (e) => {
        if (e.target === elements.rewatchModal) {
          closeModal(elements.rewatchModal);
        }
      });

      // Esporta/importa
      elements.exportBtn.addEventListener("click", exportData);
      elements.importBtn.addEventListener("click", () => elements.importFile.click());
      elements.importFile.addEventListener("change", (e) => importData(e.target.files[0]));

      // Reset
      elements.resetBtn.addEventListener("click", resetApp);

      // Toggle tema
      elements.themeToggle.addEventListener("click", toggleTheme);

      // Filtri e ricerca
      elements.searchInput.addEventListener("input", renderMedia);
      elements.categoryFilter.addEventListener("change", renderMedia);
      elements.sortFilter.addEventListener("change", renderMedia);
    }

    // Avvia l'app
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
